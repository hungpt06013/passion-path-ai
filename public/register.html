<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Đăng ký - Con đường đam mê</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
<style>
    :root {
      --bg: #f7faff;
      --card: #ffffff;
      --primary: #007bff;
      --primary-strong: #0056b3;
      --success: #28a745;
      --danger: #dc3545;
      --muted: #6c757d;
      --shadow: 0 6px 18px rgba(20,20,40,0.06);
      --radius: 12px;
      --gap: 14px;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      background: linear-gradient(135deg, #ffffff);
      color: #222;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .page-wrapper {
      min-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 28px;
    }

    .card {
      width: 100%;
      max-width: 520px;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 26px;
      border: 1px solid rgba(10,20,40,0.03);
    }

    h1 {
      margin: 0 0 10px 0;
      font-size: 20px;
      font-weight: 600;
      color: #0f1724;
    }

    p.lead {
      margin: 0 0 20px 0;
      color: var(--muted);
      font-size: 14px;
    }

    form {
      display: grid;
      gap: var(--gap);
    }

    .form-group {
      display: grid;
      gap: 8px;
    }

    label {
      font-size: 13px;
      color: #121212;
      font-weight: 600;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid rgba(10,20,40,0.08);
      font-size: 14px;
      background: #fff;
      transition: box-shadow .15s, border-color .15s;
    }

    input:focus {
      outline: none;
      box-shadow: 0 6px 18px rgba(0,123,255,0.08);
      border-color: var(--primary);
    }

    .small-note {
      font-size: 12px;
      color: var(--muted);
    }

    .error-message {
      font-size: 13px;
      color: var(--danger);
      margin-top: 4px;
    }

    .success-message {
      font-size: 13px;
      color: var(--success);
      margin-top: 4px;
    }

    .actions {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 6px;
    }

    button[type="submit"] {
      flex: 1;
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      font-size: 15px;
    }

    button[type="submit"]:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .secondary {
      background: transparent;
      border: 1px solid rgba(10,20,40,0.06);
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 14px;
      color: #222;
      cursor: pointer;
    }

    .field-inline {
      display:flex;
      gap:8px;
      align-items:center;
    }

    .password-toggle {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      font-weight: 600;
    }

    .form-footer {
      display: flex;
      justify-content: center;
      font-size: 13px;
      color: var(--muted);
      margin-top: 8px;
    }

    a.link {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
    }

    @media (max-width: 520px) {
      .page-wrapper {
        padding: 12px;
      }

      .card {
        padding: 18px;
        border-radius: 10px;
      }

      h1 {
        font-size: 18px;
      }

      input[type="text"],
      input[type="email"],
      input[type="password"] {
        font-size: 16px;
      }

      button[type="submit"] {
        font-size: 14px;
      }

      .actions {
        flex-direction: column;
      }

      .actions button {
        width: 100%;
      }
    }
    .back-btn {
  background: transparent;
  border: 1px solid rgba(10,20,40,0.12);
  padding: 10px 16px;
  border-radius: 8px;
  cursor: pointer;
  color: var(--muted);
  font-weight: 600;
  font-size: 14px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  transition: all 0.2s ease;
}

.back-btn:hover {
  background: rgba(10,20,40,0.04);
  border-color: rgba(10,20,40,0.18);
}
/* Fixed Bar Styles */
.fixed-bar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 80px;
    background: var(--primary);
    box-shadow: 0 6px 20px rgba(14, 30, 37, 0.12);
    z-index: 50;
}

.bar-inner {
    max-width: 1200px;
    height: 100%;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    box-sizing: border-box;
}

.brand {
    display: flex;
    align-items: center;
    gap: 12px;
}

.brand-icon {
    width: 48px;
    height: 48px;
    background: rgba(255,255,255,0.2);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 22px;
    flex-shrink: 0;
}

.brand-text {
    display: flex;
    flex-direction: column;
}

.brand-title {
    color: white;
    font-size: 20px;
    font-weight: 700;
}

.brand-sub {
    color: rgba(255,255,255,0.9);
    font-size: 12px;
    font-weight: 600;
}

.nav-buttons {
    display: flex;
    align-items: center;
}

.nav-btn {
    background: none;
    color: #fff;
    padding: 0;
    font-size: 15px;
    font-weight: 600;
    border-radius: 9999px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    border: none;
    padding: 10px 11px;
}

.nav-btn .fa {
    margin-right: 8px;
    opacity: 0.95;
}

.login-btn, .register-btn {
    font-family: 'Inter', sans-serif;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    border: none;
    border-radius: 9999px;
    padding: 10px 20px;
    font-size: 15px;
    font-weight: 600;
}

.userInfo {
    color: white;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
}

.login-btn {
    background: white;
    color: #333;
    box-shadow: 0 2px 5px rgba(0,0,0,0.12);
}

.login-btn:hover {
    background: #f0f0f0;
}

.register-btn {
    background: #28a745;
    color: white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.12);
}

.register-btn:hover {
    background: #218838;
}

.logout-btn {
    background: linear-gradient(135deg, #4b0ee5 0%, #0682d4 100%);
    color: white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.12);
    cursor: pointer;
    border: none;
    border-radius: 9999px;
    padding: 10px 20px;
    font-size: 15px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

/* Responsive */
@media (max-width:820px) {
    .bar-inner {
        flex-direction: column;
        height: auto;
        padding: 15px;
        gap: 10px;
    }

    .fixed-bar {
        height: auto;
    }

    .userInfo {
        flex-wrap: wrap;
        justify-content: center;
    }

    .footer-content {
        grid-template-columns: 1fr;
        gap: 24px;
    }
}

/* Điều chỉnh page-wrapper */
.page-wrapper {
    margin-top: 100px; /* Thêm margin-top để không bị bar che */
}
</style>
    <!-- Preload Font Awesome CSS -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" as="style">
    
    <!-- Load Font Awesome async -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"></noscript>
    
    <!-- Load Google Fonts async with display swap -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;600;700;900&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;600;700;900&display=swap" rel="stylesheet"></noscript>
    
    <!-- Load footer.css async (non-critical) -->
    <link rel="preload" href="footer.css" as="style">
    <link rel="stylesheet" href="footer.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="footer.css"></noscript>
</head>
<body>
  <!-- THÊM BAR GIỐNG MAIN.HTML -->
<div class="fixed-bar">
  <div class="bar-inner">
      <div class="brand">
          <div class="brand-icon">
              <i class="fa-solid fa-graduation-cap"></i>
          </div>
          <div class="brand-text">
              <div class="brand-title">Con đường đam mê</div>
              <div class="brand-sub">AI-Powered Learning Path</div>
          </div>
      </div>
      <div class="nav-buttons" id="mainNavButtons">
          <button class="nav-btn" id="btnHome"><i class="fa-solid fa-house"></i> Trang Chủ</button>
          <button class="nav-btn" id="btnPath"><i class="fa-solid fa-route"></i> Lộ Trình Học</button>
          <button class="nav-btn" id="btnProgress"><i class="fa-solid fa-chart-line"></i> Tiến Độ</button>
      </div>
      <div id="userArea" class="userInfo">
          <button class="login-btn"><i class="fa-solid fa-right-to-bracket"></i> Đăng nhập</button>
          <button class="register-btn"><i class="fa-solid fa-user-plus"></i> Đăng ký</button>
      </div>
  </div>
</div>
  <div class="page-wrapper">
    <section class="card" aria-labelledby="registration-heading">
      <div style="margin-bottom: 16px;">
  <button type="button" id="backButton" class="back-btn">
    ← Quay lại
  </button>
</div>
      <header>
        <h1 id="registration-heading">Đăng ký tài khoản</h1>
        <p class="lead">Tạo tài khoản để bắt đầu lộ trình học tập AI. Vui lòng điền đầy đủ thông tin.</p>
      </header>

      <!-- FORM -->
      <form id="registrationForm" novalidate>
        <div class="form-group">
          <label for="fullNameInput">Họ và tên</label>
          <input id="fullNameInput" name="fullName" type="text" autocomplete="name" inputmode="text" placeholder="Nguyễn Văn A" aria-describedby="fullNameHelp" required>
          <div id="fullNameError" class="error-message" role="alert" aria-live="polite" hidden></div>
        </div>

        <div class="form-group">
          <label for="userNameInput">Tên đăng nhập</label>
          <input id="userNameInput" name="userName" type="text" autocomplete="username" placeholder="ten_dang_nhap" aria-describedby="userNameHelp" required>
          <div id="userNameError" class="error-message" role="alert" aria-live="polite" hidden></div>
        </div>

        <div class="form-group">
          <label for="emailAddressInput">Email</label>
          <input id="emailAddressInput" name="emailAddress" type="email" autocomplete="email" placeholder="email@example.com" aria-describedby="emailHelp" required>
          <div id="emailAddressError" class="error-message" role="alert" aria-live="polite" hidden></div>
        </div>

        <div class="form-group">
          <label for="passwordInput">Mật khẩu</label>
          <div class="field-inline">
            <input id="passwordInput" name="password" type="password" autocomplete="new-password" placeholder="Ít nhất 8 ký tự" required>
            <button type="button" id="togglePasswordButton" class="password-toggle" aria-pressed="false" aria-label="Hiện mật khẩu">Hiện</button>
          </div>
          <div id="passwordError" class="error-message" role="alert" aria-live="polite" hidden></div>
          <div id="passwordHelp" class="small-note">
            Mật khẩu phải đủ các tiêu chí dưới: 
          </div>

          <div id="passwordCriteria" aria-hidden="false" style="margin-top:8px;">
            <div id="crit-length" class="small-note">❌ Ít nhất 8 ký tự</div>
            <div id="crit-upper" class="small-note">❌ Chữ hoa (A-Z)</div>
            <div id="crit-lower" class="small-note">❌ Chữ thường (a-z)</div>
            <div id="crit-digit" class="small-note">❌ Số (0-9)</div>
            <div id="crit-special" class="small-note">❌ Ký tự đặc biệt (!@#$%^&*)</div>
          </div>
        </div>

        <div class="form-group">
          <label for="confirmPasswordInput">Xác nhận mật khẩu</label>
          <input id="confirmPasswordInput" name="confirmPassword" type="password" autocomplete="new-password" placeholder="Nhập lại mật khẩu" required>
          <div id="confirmPasswordError" class="error-message" role="alert" aria-live="polite" hidden></div>
        </div>

        <div class="actions">
          <button id="submitButton" type="submit">Đăng ký</button>
          <button id="cancelButton" type="button" class="secondary">Huỷ</button>
        </div>

        <div id="generalMessage" role="status" aria-live="polite" style="min-height:1.2em; margin-top:6px;"></div>
      </form>

      <!-- LOGIN LINK PLACED OUTSIDE FORM -->
      <div class="form-footer" style="margin-top:12px;">
        <span>Đã có tài khoản? <a id="loginLink" class="link" href="/login.html">Đăng nhập</a></span>
      </div>
    </section>
  </div>
<div id="footer"></div>
  <script>
    // DOM
    const registrationFormElement = document.getElementById('registrationForm');
    const fullNameInputElement = document.getElementById('fullNameInput');
    const userNameInputElement = document.getElementById('userNameInput');
    const emailAddressInputElement = document.getElementById('emailAddressInput');
    const passwordInputElement = document.getElementById('passwordInput');
    const confirmPasswordInputElement = document.getElementById('confirmPasswordInput');

    const fullNameErrorElement = document.getElementById('fullNameError');
    const userNameErrorElement = document.getElementById('userNameError');
    const emailAddressErrorElement = document.getElementById('emailAddressError');
    const passwordErrorElement = document.getElementById('passwordError');
    const confirmPasswordErrorElement = document.getElementById('confirmPasswordError');

    const submitButtonElement = document.getElementById('submitButton');
    const cancelButtonElement = document.getElementById('cancelButton');
    const togglePasswordButtonElement = document.getElementById('togglePasswordButton');
    const loginLinkElement = document.getElementById('loginLink'); // <-- link

    const generalMessageElement = document.getElementById('generalMessage');

    // criteria DOM
    const critLength = document.getElementById('crit-length');
    const critUpper = document.getElementById('crit-upper');
    const critLower = document.getElementById('crit-lower');
    const critDigit = document.getElementById('crit-digit');
    const critSpecial = document.getElementById('crit-special');

    function isEmailValid(email) {
      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailPattern.test(email);
    }

    function clearFieldErrors() {
      fullNameErrorElement.hidden = true;
      userNameErrorElement.hidden = true;
      emailAddressErrorElement.hidden = true;
      passwordErrorElement.hidden = true;
      confirmPasswordErrorElement.hidden = true;
    }

    function showGeneralMessage(text, type) {
      generalMessageElement.textContent = text || '';
      generalMessageElement.className = type === 'error' ? 'error-message' : (type === 'success' ? 'success-message' : '');
    }
function updatePasswordCriteriaVisual(pw) {
  if (pw.length >= 8) { 
    critLength.innerHTML = '<i class="fas fa-check" style="color: #10b981; font-size: 12px;"></i> <span style="font-size: 13px;">Ít nhất 8 ký tự</span>'; 
    critLength.classList.remove('error-message'); 
    critLength.classList.add('success-message'); 
    critLength.style.lineHeight = '1.5';
    critLength.style.margin = '0';
  } else { 
    critLength.innerHTML = '<i class="fas fa-times" style="color: #dc2626; font-size: 14px;"></i> <span style="font-size: 13px;">Ít nhất 8 ký tự</span>'; 
    critLength.classList.remove('success-message'); 
    critLength.classList.add('small-note'); 
    critLength.style.lineHeight = '1.5';
    critLength.style.margin = '0';
  }

  if (/[A-Z]/.test(pw)) { 
    critUpper.innerHTML = '<i class="fas fa-check" style="color: #10b981; font-size: 12px;"></i> <span style="font-size: 13px;">Chữ hoa (A-Z)</span>'; 
    critUpper.classList.remove('error-message'); 
    critUpper.classList.add('success-message'); 
    critUpper.style.lineHeight = '1.5';
    critUpper.style.margin = '0';
  } else { 
    critUpper.innerHTML = '<i class="fas fa-times" style="color: #dc2626; font-size: 14px;"></i> <span style="font-size: 13px;">Chữ hoa (A-Z)</span>'; 
    critUpper.classList.remove('success-message'); 
    critUpper.classList.add('small-note'); 
    critUpper.style.lineHeight = '1.5';
    critUpper.style.margin = '0';
  }

  if (/[a-z]/.test(pw)) { 
    critLower.innerHTML = '<i class="fas fa-check" style="color: #10b981; font-size: 12px;"></i> <span style="font-size: 13px;">Chữ thường (a-z)</span>'; 
    critLower.classList.remove('error-message'); 
    critLower.classList.add('success-message'); 
    critLower.style.lineHeight = '1.5';
    critLower.style.margin = '0';
  } else { 
    critLower.innerHTML = '<i class="fas fa-times" style="color: #dc2626; font-size: 14px;"></i> <span style="font-size: 13px;">Chữ thường (a-z)</span>'; 
    critLower.classList.remove('success-message'); 
    critLower.classList.add('small-note'); 
    critLower.style.lineHeight = '1.5';
    critLower.style.margin = '0';
  }

  if (/[0-9]/.test(pw)) { 
    critDigit.innerHTML = '<i class="fas fa-check" style="color: #10b981; font-size: 12px;"></i> <span style="font-size: 13px;">Số (0-9)</span>'; 
    critDigit.classList.remove('error-message'); 
    critDigit.classList.add('success-message'); 
    critDigit.style.lineHeight = '1.5';
    critDigit.style.margin = '0';
  } else { 
    critDigit.innerHTML = '<i class="fas fa-times" style="color: #dc2626; font-size: 14px;"></i> <span style="font-size: 13px;">Số (0-9)</span>'; 
    critDigit.classList.remove('success-message'); 
    critDigit.classList.add('small-note'); 
    critDigit.style.lineHeight = '1.5';
    critDigit.style.margin = '0';
  }

  if (/[^A-Za-z0-9]/.test(pw)) { 
    critSpecial.innerHTML = '<i class="fas fa-check" style="color: #10b981; font-size: 12px;"></i> <span style="font-size: 13px;">Ký tự đặc biệt (!@#$...)</span>'; 
    critSpecial.classList.remove('error-message'); 
    critSpecial.classList.add('success-message'); 
    critSpecial.style.lineHeight = '1.5';
    critSpecial.style.margin = '0';
  } else { 
    critSpecial.innerHTML = '<i class="fas fa-times" style="color: #dc2626; font-size: 14px;"></i> <span style="font-size: 13px;">Ký tự đặc biệt (!@#$...)</span>'; 
    critSpecial.classList.remove('success-message'); 
    critSpecial.classList.add('small-note'); 
    critSpecial.style.lineHeight = '1.5';
    critSpecial.style.margin = '0';
  }
}

    function validateFormInputs() {
      let isFormValid = true;
      clearFieldErrors();
      showGeneralMessage('', undefined);

      const fullNameValue = fullNameInputElement.value.trim();
      const userNameValue = userNameInputElement.value.trim();
      const emailValue = emailAddressInputElement.value.trim();
      const passwordValue = passwordInputElement.value;
      const confirmPasswordValue = confirmPasswordInputElement.value;

      if (!fullNameValue) {
        fullNameErrorElement.textContent = 'Vui lòng nhập họ và tên.';
        fullNameErrorElement.hidden = false;
        isFormValid = false;
      } else if (fullNameValue.length < 2) {
        fullNameErrorElement.textContent = 'Họ và tên phải có ít nhất 2 ký tự.';
        fullNameErrorElement.hidden = false;
        isFormValid = false;
      }

      if (!userNameValue) {
        userNameErrorElement.textContent = 'Vui lòng nhập tên đăng nhập.';
        userNameErrorElement.hidden = false;
        isFormValid = false;
      } else if (!/^[a-zA-Z0-9._-]{3,30}$/.test(userNameValue)) {
        userNameErrorElement.textContent = 'Tên đăng nhập chỉ được chứa chữ, số, . _ - và 3–30 ký tự.';
        userNameErrorElement.hidden = false;
        isFormValid = false;
      }

      if (!emailValue) {
        emailAddressErrorElement.textContent = 'Vui lòng nhập địa chỉ email.';
        emailAddressErrorElement.hidden = false;
        isFormValid = false;
      } else if (!isEmailValid(emailValue)) {
        emailAddressErrorElement.textContent = 'Email không hợp lệ.';
        emailAddressErrorElement.hidden = false;
        isFormValid = false;
      }

      if (!passwordValue) {
        passwordErrorElement.textContent = 'Vui lòng nhập mật khẩu.';
        passwordErrorElement.hidden = false;
        isFormValid = false;
      } else {
        const hasUpper = /[A-Z]/.test(passwordValue);
        const hasLower = /[a-z]/.test(passwordValue);
        const hasDigit = /[0-9]/.test(passwordValue);
        const hasSpecial = /[^A-Za-z0-9]/.test(passwordValue);
        if (passwordValue.length < 8 || !hasUpper || !hasLower || !hasDigit || !hasSpecial) {
          passwordErrorElement.textContent = 'Mật khẩu phải có ít nhất 8 ký tự, bao gồm chữ hoa, chữ thường, số và ký tự đặc biệt.';
          passwordErrorElement.hidden = false;
          isFormValid = false;
        }
      }

      if (confirmPasswordValue !== passwordValue) {
        confirmPasswordErrorElement.textContent = 'Mật khẩu xác nhận không khớp.';
        confirmPasswordErrorElement.hidden = false;
        isFormValid = false;
      }

      return isFormValid;
    }

    function enableSubmitButton() {
      submitButtonElement.disabled = false;
      submitButtonElement.textContent = 'Đăng ký';
    }

    function disableSubmitButtonInProgress() {
      submitButtonElement.disabled = true;
      submitButtonElement.textContent = 'Đang gửi...';
    }

    async function submitRegistrationForm(event) {
      event.preventDefault();
      const isFormValid = validateFormInputs();
      if (!isFormValid) {
        showGeneralMessage('Vui lòng sửa các lỗi bên trên trước khi gửi.', 'error');
        return;
      }

      const payload = {
        name: fullNameInputElement.value.trim(),
        username: userNameInputElement.value.trim(),
        email: emailAddressInputElement.value.trim(),
        password: passwordInputElement.value
      };

      disableSubmitButtonInProgress();
      showGeneralMessage('', undefined);

      try {
        const response = await fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const responseBody = await response.json().catch(() => null);

        if (response.ok) {
          if (responseBody && responseBody.token) {
            localStorage.setItem('token', responseBody.token);
          }
          const roleFromServer = (responseBody && responseBody.role) ? responseBody.role : 'user';
          localStorage.setItem('role', roleFromServer);
          showGeneralMessage((responseBody && responseBody.message) ? responseBody.message : 'Đăng ký thành công. Chuyển tới Lộ Trình Học...', 'success');
          window.location.href = '/path.html';
        } else {
          let messageFromServer = 'Đã xảy ra lỗi khi đăng ký.';
          if (responseBody && responseBody.message) {
            messageFromServer = responseBody.message;
          } else if (response.status === 409) {
            messageFromServer = 'Tên đăng nhập hoặc email đã được sử dụng.';
          } else if (response.status === 422 || response.status === 400) {
            messageFromServer = 'Dữ liệu gửi lên không hợp lệ.';
          }
          showGeneralMessage(messageFromServer, 'error');

          if (responseBody && responseBody.errors && typeof responseBody.errors === 'object') {
            Object.keys(responseBody.errors).forEach(function(fieldName) {
              const message = responseBody.errors[fieldName];
              if (!message) return;
              if (fieldName === 'name') {
                fullNameErrorElement.textContent = message; fullNameErrorElement.hidden = false;
              } else if (fieldName === 'username') {
                userNameErrorElement.textContent = message; userNameErrorElement.hidden = false;
              } else if (fieldName === 'email') {
                emailAddressErrorElement.textContent = message; emailAddressErrorElement.hidden = false;
              } else if (fieldName === 'password') {
                passwordErrorElement.textContent = message; passwordErrorElement.hidden = false;
              }
            });
          }
        }
      } catch (networkError) {
        console.error('Lỗi khi gọi API đăng ký:', networkError);
        showGeneralMessage('Không thể kết nối tới server. Vui lòng kiểm tra mạng hoặc server.', 'error');
      } finally {
        enableSubmitButton();
      }
    }

    function togglePasswordVisibility() {
      const currentlyPassword = passwordInputElement.type === 'password';
      if (currentlyPassword) {
        passwordInputElement.type = 'text';
        confirmPasswordInputElement.type = 'text';
        togglePasswordButtonElement.textContent = 'Ẩn';
        togglePasswordButtonElement.setAttribute('aria-pressed', 'true');
        togglePasswordButtonElement.setAttribute('aria-label', 'Ẩn mật khẩu');
      } else {
        passwordInputElement.type = 'password';
        confirmPasswordInputElement.type = 'password';
        togglePasswordButtonElement.textContent = 'Hiện';
        togglePasswordButtonElement.setAttribute('aria-pressed', 'false');
        togglePasswordButtonElement.setAttribute('aria-label', 'Hiện mật khẩu');
      }
    }

    function cancelRegistration(event) {
      if (event) { event.preventDefault(); event.stopPropagation(); }
      registrationFormElement.reset();
      clearFieldErrors();
      showGeneralMessage('', undefined);
      enableSubmitButton();
      togglePasswordButtonElement.textContent = 'Hiện';
      togglePasswordButtonElement.setAttribute('aria-pressed', 'false');
      passwordInputElement.type = 'password';
      confirmPasswordInputElement.type = 'password';
      updatePasswordCriteriaVisual('');
    }

function attachQuickValidationOnBlur() {
  fullNameInputElement.addEventListener('blur', function() {
    if (fullNameInputElement.value.trim() || fullNameInputElement.dataset.touched) {
      fullNameInputElement.dataset.touched = 'true';
      const val = fullNameInputElement.value.trim();
      if (!val) {
        fullNameErrorElement.textContent = 'Vui lòng nhập họ và tên.';
        fullNameErrorElement.hidden = false;
      } else if (val.length < 2) {
        fullNameErrorElement.textContent = 'Họ và tên phải có ít nhất 2 ký tự.';
        fullNameErrorElement.hidden = false;
      } else {
        fullNameErrorElement.hidden = true;
      }
    }
  });

  userNameInputElement.addEventListener('blur', function() {
    if (userNameInputElement.value.trim() || userNameInputElement.dataset.touched) {
      userNameInputElement.dataset.touched = 'true';
      const val = userNameInputElement.value.trim();
      if (!val) {
        userNameErrorElement.textContent = 'Vui lòng nhập tên đăng nhập.';
        userNameErrorElement.hidden = false;
      } else if (!/^[a-zA-Z0-9._-]{3,30}$/.test(val)) {
        userNameErrorElement.textContent = 'Tên đăng nhập chỉ được chứa chữ, số, . _ - và 3–30 ký tự.';
        userNameErrorElement.hidden = false;
      } else {
        userNameErrorElement.hidden = true;
      }
    }
  });

  emailAddressInputElement.addEventListener('blur', function() {
    if (emailAddressInputElement.value.trim() || emailAddressInputElement.dataset.touched) {
      emailAddressInputElement.dataset.touched = 'true';
      const val = emailAddressInputElement.value.trim();
      if (!val) {
        emailAddressErrorElement.textContent = 'Vui lòng nhập địa chỉ email.';
        emailAddressErrorElement.hidden = false;
      } else if (!isEmailValid(val)) {
        emailAddressErrorElement.textContent = 'Email không hợp lệ.';
        emailAddressErrorElement.hidden = false;
      } else {
        emailAddressErrorElement.hidden = true;
      }
    }
  });

  passwordInputElement.addEventListener('blur', function() {
    if (passwordInputElement.value || passwordInputElement.dataset.touched) {
      passwordInputElement.dataset.touched = 'true';
      const val = passwordInputElement.value;
      if (!val) {
        passwordErrorElement.textContent = 'Vui lòng nhập mật khẩu.';
        passwordErrorElement.hidden = false;
      } else {
        const hasUpper = /[A-Z]/.test(val);
        const hasLower = /[a-z]/.test(val);
        const hasDigit = /[0-9]/.test(val);
        const hasSpecial = /[^A-Za-z0-9]/.test(val);
        if (val.length < 8 || !hasUpper || !hasLower || !hasDigit || !hasSpecial) {
          passwordErrorElement.textContent = 'Mật khẩu phải có ít nhất 8 ký tự, bao gồm chữ hoa, chữ thường, số và ký tự đặc biệt.';
          passwordErrorElement.hidden = false;
        } else {
          passwordErrorElement.hidden = true;
        }
      }
    }
  });

  confirmPasswordInputElement.addEventListener('blur', function() {
    if (confirmPasswordInputElement.value || confirmPasswordInputElement.dataset.touched) {
      confirmPasswordInputElement.dataset.touched = 'true';
      if (confirmPasswordInputElement.value !== passwordInputElement.value) {
        confirmPasswordErrorElement.textContent = 'Mật khẩu xác nhận không khớp.';
        confirmPasswordErrorElement.hidden = false;
      } else {
        confirmPasswordErrorElement.hidden = true;
      }
    }
  });

  passwordInputElement.addEventListener('input', function() {
    updatePasswordCriteriaVisual(passwordInputElement.value);
  });
}
    // --- IMPORTANT: ensure immediate navigation on first interaction ---
    // Pointerdown (or mousedown) fires BEFORE blur; navigate on primary pointer down.
    if (loginLinkElement) {
      loginLinkElement.addEventListener('pointerdown', function(ev) {
        // only handle primary button (avoid context menu / middle-click)
        if (ev.button !== 0) return;
        ev.preventDefault(); // stop default only for the pointerdown; we'll navigate explicitly
        // Navigate immediately before blur/validation can interfere
        window.location.href = loginLinkElement.href;
      });
    }

    // events
    registrationFormElement.addEventListener('submit', submitRegistrationForm);
    cancelButtonElement.addEventListener('click', cancelRegistration);
    togglePasswordButtonElement.addEventListener('click', function(event) { event.preventDefault(); event.stopPropagation(); togglePasswordVisibility(); });
    attachQuickValidationOnBlur();
    fullNameInputElement.focus();
    updatePasswordCriteriaVisual('');
    const backButton = document.getElementById('backButton');
if (backButton) {
  backButton.addEventListener('click', () => {
    window.location.href = '/main.html';
  });
}
// ========== THÊM JAVASCRIPT CHO BAR VÀ FOOTER ==========

// Xử lý click footer links khi chưa đăng nhập
document.addEventListener('DOMContentLoaded', function() {
    const createBtn = document.getElementById('createBtn');
    if (createBtn) {
        createBtn.addEventListener('click', function(e) {
            e.preventDefault();
            alert('Vui lòng đăng nhập!');
        });
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const pathBtn = document.getElementById('pathBtn');
    if (pathBtn) {
        pathBtn.addEventListener('click', function(e) {
            e.preventDefault();
            alert('Vui lòng đăng nhập!');
        });
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const progressBtn = document.getElementById('progressBtn');
    if (progressBtn) {
        progressBtn.addEventListener('click', function(e) {
            e.preventDefault();
            alert('Vui lòng đăng nhập!');
        });
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const openBtn = document.getElementById('openBtn');
    if (openBtn) {
        openBtn.addEventListener('click', function(e) {
            e.preventDefault();
            alert('Vui lòng đăng nhập!');
        });
    }
});

// Load user info và điều hướng
async function loadUser() {
    const token = localStorage.getItem('token');
    const userArea = document.getElementById('userArea');
    const navButtons = document.getElementById('mainNavButtons');
    
    // Thiết lập sự kiện cho các nút điều hướng
    document.getElementById('btnHome').addEventListener('click', () => {
        window.location.href = 'main.html';
    });
    
    document.getElementById('btnPath').addEventListener('click', () => {
        window.location.href = 'path.html';
    });
    
    document.getElementById('btnProgress').addEventListener('click', () => {
        window.location.href = 'progress.html';
    });
    
    // Nếu không có token
    if (!token) {
        userArea.innerHTML = '';
        
        const loginBtn = document.createElement('button');
        loginBtn.className = 'login-btn';
        loginBtn.innerHTML = '<i class="fa-solid fa-right-to-bracket"></i> Đăng nhập';
        loginBtn.addEventListener('click', () => window.location.href = 'login.html');
        
        const registerBtn = document.createElement('button');
        registerBtn.className = 'register-btn';
        registerBtn.innerHTML = '<i class="fa-solid fa-user-plus"></i> Đăng ký';
        registerBtn.addEventListener('click', () => window.location.href = 'register.html');
        
        userArea.appendChild(loginBtn);
        userArea.appendChild(registerBtn);
        return;
    }
    
    // Nếu có token, lấy thông tin user
    try {
        const apiBase = (window.location.protocol === 'file:') ? 'http://localhost:5000' : window.location.origin;
        const res = await fetch(apiBase.replace(/\/$/, '') + '/api/me', {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        
        if (res.ok) {
            const data = await res.json();
            const userName = data.user?.name || 'Người dùng';
            const userRole = data.user?.role || 'user';
            
            userArea.innerHTML = `
                <span>Xin chào <strong style="color:white;">${userName}</strong></span>
                <button id="logoutBtn" class="logout-btn">
                    <i class="fa-solid fa-right-from-bracket"></i> Đăng xuất
                </button>
            `;
            
            document.getElementById('logoutBtn').addEventListener('click', () => {
                localStorage.removeItem('token');
                localStorage.removeItem('role');
                window.location.href = 'main.html';
            });
            
            if (userRole === 'admin') {
                const adminBtn = document.createElement('button');
                adminBtn.className = 'nav-btn';
                adminBtn.id = 'btnAdmin';
                adminBtn.innerHTML = '<i class="fa-solid fa-user-shield"></i> Quản Trị';
                adminBtn.addEventListener('click', () => {
                    window.location.href = 'admin.html?page=admin';
                });
                navButtons.appendChild(adminBtn);
            }
        } else {
            localStorage.removeItem('token');
            localStorage.removeItem('role');
            loadUser();
        }
    } catch (err) {
        console.error('Error loading user:', err);
        localStorage.removeItem('token');
        localStorage.removeItem('role');
        loadUser();
    }
}

// Gọi hàm loadUser khi trang tải xong
document.addEventListener('DOMContentLoaded', loadUser);
  </script>
  <script src="footer.js"></script>
</body>
</html>
