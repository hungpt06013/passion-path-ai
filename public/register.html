<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Đăng ký - Con đường đam mê</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
<style>
    :root {
      --bg: #f7faff;
      --card: #ffffff;
      --primary: #007bff;
      --primary-strong: #0056b3;
      --success: #28a745;
      --danger: #dc3545;
      --muted: #6c757d;
      --shadow: 0 6px 18px rgba(20,20,40,0.06);
      --radius: 12px;
      --gap: 14px;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      background: linear-gradient(135deg, #ffffff);
      color: #222;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .page-wrapper {
      min-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 28px;
    }

    .card {
      width: 100%;
      max-width: 520px;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 26px;
      border: 1px solid rgba(10,20,40,0.03);
    }

    h1 {
      margin: 0 0 10px 0;
      font-size: 20px;
      font-weight: 600;
      color: #0f1724;
    }

    p.lead {
      margin: 0 0 20px 0;
      color: var(--muted);
      font-size: 14px;
    }

    form {
      display: grid;
      gap: var(--gap);
    }

    .form-group {
      display: grid;
      gap: 8px;
    }

    label {
      font-size: 13px;
      color: #121212;
      font-weight: 600;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid rgba(10,20,40,0.08);
      font-size: 14px;
      background: #fff;
      transition: box-shadow .15s, border-color .15s;
    }

    input:focus {
      outline: none;
      box-shadow: 0 6px 18px rgba(0,123,255,0.08);
      border-color: var(--primary);
    }

    .small-note {
      font-size: 12px;
      color: var(--muted);
    }

    .error-message {
      font-size: 13px;
      color: var(--danger);
      margin-top: 4px;
    }

    .success-message {
      font-size: 13px;
      color: var(--success);
      margin-top: 4px;
    }

    .actions {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 6px;
    }

    button[type="submit"] {
      width: 100%;
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      font-size: 15px;
    }

    button[type="submit"]:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .secondary {
      background: transparent;
      border: 1px solid rgba(10,20,40,0.06);
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 14px;
      color: #222;
      cursor: pointer;
    }

    .field-inline {
      display:flex;
      gap:8px;
      align-items:center;
    }

    .password-toggle {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 600;
      color: var(--muted);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .password-toggle:hover {
      background: rgba(0,0,0,0.05);
      color: var(--primary);
    }

    .form-footer {
      display: flex;
      justify-content: center;
      font-size: 13px;
      color: var(--muted);
      margin-top: 8px;
    }

    a.link {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      cursor: pointer;
    }
    /* VERIFICATION MODAL */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: var(--radius);
      padding: 24px;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }

    .close-modal {
      background: transparent;
      border: none;
      font-size: 24px;
      color: var(--muted);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .close-modal:hover {
      background: rgba(0,0,0,0.05);
    }

    .code-inputs {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      margin: 16px 0;
    }

    .code-input {
      width: 100%;
      height: 50px;
      text-align: center;
      font-size: 20px;
      font-weight: 700;
      border: 2px solid rgba(10,20,40,0.1);
      border-radius: 8px;
    }

    .code-input:focus {
      border-color: var(--primary);
      outline: none;
    }

    .timer {
      text-align: center;
      color: var(--danger);
      font-size: 14px;
      font-weight: 600;
      margin: 12px 0;
    }

    .btn-primary {
      width: 100%;
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      font-size: 15px;
      margin-top: 12px;
    }

    .btn-primary:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    @media (max-width: 520px) {
      .page-wrapper {
        padding: 12px;
      }

      .card {
        padding: 18px;
        border-radius: 10px;
      }

      h1 {
        font-size: 18px;
      }

      input[type="text"],
      input[type="email"],
      input[type="password"] {
        font-size: 16px;
      }

      button[type="submit"] {
        font-size: 14px;
      }

      .actions {
        flex-direction: column;
      }

      .actions button {
        width: 100%;
      }
    }
    .back-btn {
  background: transparent;
  border: 1px solid rgba(10,20,40,0.12);
  padding: 10px 16px;
  border-radius: 8px;
  cursor: pointer;
  color: var(--muted);
  font-weight: 600;
  font-size: 14px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  transition: all 0.2s ease;
}

.back-btn:hover {
  background: rgba(10,20,40,0.04);
  border-color: rgba(10,20,40,0.18);
}
/* Responsive */
@media (max-width:820px) {
    .bar-inner {
        flex-direction: column;
        height: auto;
        padding: 15px;
        gap: 10px;
    }

    .fixed-bar {
        height: auto;
    }

    .userInfo {
        flex-wrap: wrap;
        justify-content: center;
    }

    .footer-content {
        grid-template-columns: 1fr;
        gap: 24px;
    }
}

/* Điều chỉnh page-wrapper */
.page-wrapper {
    margin-top: 100px; /* Thêm margin-top để không bị bar che */
}
</style>
    <!-- Preload Font Awesome CSS -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" as="style">
    
    <!-- Load Font Awesome async -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"></noscript>
    
    <!-- Load Google Fonts async with display swap -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;600;700;900&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;600;700;900&display=swap" rel="stylesheet"></noscript>
    
    <!-- Load footer.css async (non-critical) -->
    <link rel="preload" href="footer.css" as="style">
    <link rel="stylesheet" href="footer.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="footer.css"></noscript>

    <link rel="preload" href="header.css" as="style">
    <link rel="stylesheet" href="header.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="header.css"></noscript>
</head>
<body>
<div id="header"></div>
<script>
  fetch('header.html')
    .then(res => res.text())
    .then(html => {
      document.getElementById('header').innerHTML = html;
      const script = document.createElement('script');
      script.src = 'header.js';
      document.body.appendChild(script);
    });
</script>
  <div class="page-wrapper">
    <section class="card" aria-labelledby="registration-heading">
      <div style="margin-bottom: 16px;">
  <button type="button" id="backButton" class="back-btn">
    ← Quay lại
  </button>
</div>
      <header>
        <h1 id="registration-heading">Đăng ký tài khoản</h1>
        <p class="lead">Tạo tài khoản để bắt đầu lộ trình học tập. Vui lòng điền đầy đủ thông tin.</p>
      </header>

      <!-- FORM -->
      <form id="registrationForm" novalidate>
        <div class="form-group">
          <label for="fullNameInput">Họ và tên</label>
          <input id="fullNameInput" name="fullName" type="text" autocomplete="name" inputmode="text" placeholder="Nguyễn Văn A" aria-describedby="fullNameHelp" maxlength="35" required>
          <div id="fullNameError" class="error-message" role="alert" aria-live="polite" hidden></div>
        </div>

        <div class="form-group">
          <label for="userNameInput">Tên đăng nhập</label>
          <input id="userNameInput" name="userName" type="text" autocomplete="username" placeholder="ten_dang_nhap" aria-describedby="userNameHelp" maxlength="35" required>
          <div id="userNameError" class="error-message" role="alert" aria-live="polite" hidden></div>
        </div>

        <div class="form-group">
          <label for="emailAddressInput">Email</label>
          <input id="emailAddressInput" name="emailAddress" type="email" autocomplete="email" placeholder="email@example.com" aria-describedby="emailHelp" required>
          <div id="emailAddressError" class="error-message" role="alert" aria-live="polite" hidden></div>
        </div>

        <div class="form-group">
          <label for="passwordInput">Mật khẩu</label>
          <div class="field-inline">
            <input id="passwordInput" name="password" type="password" autocomplete="new-password" placeholder="Ít nhất 8 ký tự" required style="flex:1;" oncopy="return false" oncut="return false" onpaste="return false">
            <button type="button" id="togglePasswordButton" class="password-toggle" aria-pressed="false" aria-label="Hiện mật khẩu">
              <i class="fa-solid fa-eye"></i>
            </button>
          </div>
          <div id="passwordError" class="error-message" role="alert" aria-live="polite" hidden></div>
          <div id="passwordHelp" class="small-note">
            Mật khẩu phải đủ các tiêu chí dưới: 
          </div>

          <div id="passwordCriteria" aria-hidden="false" style="margin-top:8px;">
            <div id="crit-length" class="small-note">❌ Ít nhất 8 ký tự</div>
            <div id="crit-upper" class="small-note">❌ Chữ hoa (A-Z)</div>
            <div id="crit-lower" class="small-note">❌ Chữ thường (a-z)</div>
            <div id="crit-digit" class="small-note">❌ Số (0-9)</div>
            <div id="crit-special" class="small-note">❌ Ký tự đặc biệt (!@#$%^&*)</div>
          </div>
        </div>

        <div class="form-group">
          <label for="confirmPasswordInput">Xác nhận mật khẩu</label>
          <div class="field-inline">
            <input id="confirmPasswordInput" name="confirmPassword" type="password" autocomplete="new-password" placeholder="Nhập lại mật khẩu" required style="flex:1;" oncopy="return false" oncut="return false" onpaste="return false">
            <button type="button" id="toggleConfirmPasswordButton" class="password-toggle" aria-pressed="false" aria-label="Hiện mật khẩu">
              <i class="fa-solid fa-eye"></i>
            </button>
          </div>
          <div id="confirmPasswordError" class="error-message" role="alert" aria-live="polite" hidden></div>
        </div>

        <div class="actions">
          <button id="submitButton" type="submit">Đăng ký</button>
        </div>

        <div id="generalMessage" role="status" aria-live="polite" style="min-height:1.2em; margin-top:6px;"></div>
      </form>

      <!-- LOGIN LINK PLACED OUTSIDE FORM -->
      <div class="form-footer" style="margin-top:12px;">
        <span>Đã có tài khoản? <a id="loginLink" class="link" href="/login.html">Đăng nhập</a></span>
      </div>
    </section>
  </div>
<!-- Email Verification Modal -->
<div id="verificationModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Xác thực Email</h2>
      <button class="close-modal" id="closeVerificationModal">&times;</button>
    </div>

    <p class="lead">Nhập mã 6 số đã được gửi đến email của bạn</p>
    
    <div class="code-inputs">
      <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
      <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
      <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
      <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
      <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
      <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
    </div>
    
    <div id="verificationTimer" class="timer"></div>
    <div id="verificationCodeError" class="error-message" hidden></div>
    
    <button id="verifyEmailBtn" class="btn-primary">Xác thực</button>
    <button id="resendVerificationBtn" class="secondary" style="width:100%;margin-top:8px;">
      Gửi lại mã
    </button>
    
    <div id="verificationMessage" class="info-text" style="margin-top:12px;text-align:center;"></div>
  </div>
</div>
<div id="footer"></div>
  <script>
    // DOM
    const registrationFormElement = document.getElementById('registrationForm');
    const fullNameInputElement = document.getElementById('fullNameInput');
    const userNameInputElement = document.getElementById('userNameInput');
    const emailAddressInputElement = document.getElementById('emailAddressInput');
    const passwordInputElement = document.getElementById('passwordInput');
    const confirmPasswordInputElement = document.getElementById('confirmPasswordInput');

    const fullNameErrorElement = document.getElementById('fullNameError');
    const userNameErrorElement = document.getElementById('userNameError');
    const emailAddressErrorElement = document.getElementById('emailAddressError');
    const passwordErrorElement = document.getElementById('passwordError');
    const confirmPasswordErrorElement = document.getElementById('confirmPasswordError');

    const submitButtonElement = document.getElementById('submitButton');
    const togglePasswordButtonElement = document.getElementById('togglePasswordButton');
    const loginLinkElement = document.getElementById('loginLink'); // <-- link

    const generalMessageElement = document.getElementById('generalMessage');

    // criteria DOM
    const critLength = document.getElementById('crit-length');
    const critUpper = document.getElementById('crit-upper');
    const critLower = document.getElementById('crit-lower');
    const critDigit = document.getElementById('crit-digit');
    const critSpecial = document.getElementById('crit-special');

    function isEmailValid(email) {
      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailPattern.test(email);
    }

    function clearFieldErrors() {
      fullNameErrorElement.hidden = true;
      userNameErrorElement.hidden = true;
      emailAddressErrorElement.hidden = true;
      passwordErrorElement.hidden = true;
      confirmPasswordErrorElement.hidden = true;
    }

    function showGeneralMessage(text, type) {
      generalMessageElement.textContent = text || '';
      generalMessageElement.className = type === 'error' ? 'error-message' : (type === 'success' ? 'success-message' : '');
    }
function updatePasswordCriteriaVisual(pw) {
  if (pw.length >= 8) { 
    critLength.innerHTML = '<i class="fas fa-check" style="color: #10b981; font-size: 12px;"></i> <span style="font-size: 13px;">Ít nhất 8 ký tự</span>'; 
    critLength.classList.remove('error-message'); 
    critLength.classList.add('success-message'); 
    critLength.style.lineHeight = '1.5';
    critLength.style.margin = '0';
  } else { 
    critLength.innerHTML = '<i class="fas fa-times" style="color: #dc2626; font-size: 14px;"></i> <span style="font-size: 13px;">Ít nhất 8 ký tự</span>'; 
    critLength.classList.remove('success-message'); 
    critLength.classList.add('small-note'); 
    critLength.style.lineHeight = '1.5';
    critLength.style.margin = '0';
  }

  if (/[A-Z]/.test(pw)) { 
    critUpper.innerHTML = '<i class="fas fa-check" style="color: #10b981; font-size: 12px;"></i> <span style="font-size: 13px;">Chữ hoa (A-Z)</span>'; 
    critUpper.classList.remove('error-message'); 
    critUpper.classList.add('success-message'); 
    critUpper.style.lineHeight = '1.5';
    critUpper.style.margin = '0';
  } else { 
    critUpper.innerHTML = '<i class="fas fa-times" style="color: #dc2626; font-size: 14px;"></i> <span style="font-size: 13px;">Chữ hoa (A-Z)</span>'; 
    critUpper.classList.remove('success-message'); 
    critUpper.classList.add('small-note'); 
    critUpper.style.lineHeight = '1.5';
    critUpper.style.margin = '0';
  }

  if (/[a-z]/.test(pw)) { 
    critLower.innerHTML = '<i class="fas fa-check" style="color: #10b981; font-size: 12px;"></i> <span style="font-size: 13px;">Chữ thường (a-z)</span>'; 
    critLower.classList.remove('error-message'); 
    critLower.classList.add('success-message'); 
    critLower.style.lineHeight = '1.5';
    critLower.style.margin = '0';
  } else { 
    critLower.innerHTML = '<i class="fas fa-times" style="color: #dc2626; font-size: 14px;"></i> <span style="font-size: 13px;">Chữ thường (a-z)</span>'; 
    critLower.classList.remove('success-message'); 
    critLower.classList.add('small-note'); 
    critLower.style.lineHeight = '1.5';
    critLower.style.margin = '0';
  }

  if (/[0-9]/.test(pw)) { 
    critDigit.innerHTML = '<i class="fas fa-check" style="color: #10b981; font-size: 12px;"></i> <span style="font-size: 13px;">Số (0-9)</span>'; 
    critDigit.classList.remove('error-message'); 
    critDigit.classList.add('success-message'); 
    critDigit.style.lineHeight = '1.5';
    critDigit.style.margin = '0';
  } else { 
    critDigit.innerHTML = '<i class="fas fa-times" style="color: #dc2626; font-size: 14px;"></i> <span style="font-size: 13px;">Số (0-9)</span>'; 
    critDigit.classList.remove('success-message'); 
    critDigit.classList.add('small-note'); 
    critDigit.style.lineHeight = '1.5';
    critDigit.style.margin = '0';
  }

  if (/[^A-Za-z0-9]/.test(pw)) { 
    critSpecial.innerHTML = '<i class="fas fa-check" style="color: #10b981; font-size: 12px;"></i> <span style="font-size: 13px;">Ký tự đặc biệt (!@#$...)</span>'; 
    critSpecial.classList.remove('error-message'); 
    critSpecial.classList.add('success-message'); 
    critSpecial.style.lineHeight = '1.5';
    critSpecial.style.margin = '0';
  } else { 
    critSpecial.innerHTML = '<i class="fas fa-times" style="color: #dc2626; font-size: 14px;"></i> <span style="font-size: 13px;">Ký tự đặc biệt (!@#$...)</span>'; 
    critSpecial.classList.remove('success-message'); 
    critSpecial.classList.add('small-note'); 
    critSpecial.style.lineHeight = '1.5';
    critSpecial.style.margin = '0';
  }
}

    function validateFormInputs() {
      let isFormValid = true;
      clearFieldErrors();
      showGeneralMessage('', undefined);

      const fullNameValue = fullNameInputElement.value.trim();
      const userNameValue = userNameInputElement.value.trim();
      const emailValue = emailAddressInputElement.value.trim();
      const passwordValue = passwordInputElement.value;
      const confirmPasswordValue = confirmPasswordInputElement.value;

      if (!fullNameValue) {
        fullNameErrorElement.textContent = 'Vui lòng nhập họ và tên.';
        fullNameErrorElement.hidden = false;
        isFormValid = false;
      } else if (fullNameValue.length < 2) {
        fullNameErrorElement.textContent = 'Họ và tên phải có ít nhất 2 ký tự.';
        fullNameErrorElement.hidden = false;
        isFormValid = false;
      }

      if (!userNameValue) {
        userNameErrorElement.textContent = 'Vui lòng nhập tên đăng nhập.';
        userNameErrorElement.hidden = false;
        isFormValid = false;
      } else if (!/^[a-zA-Z0-9._-]{3,35}$/.test(userNameValue)) {
        userNameErrorElement.textContent = 'Tên đăng nhập chỉ được chứa chữ (a-z, A-Z), số, . _ - và 3–35 ký tự.';
        userNameErrorElement.hidden = false;
        isFormValid = false;
      }

      if (!emailValue) {
        emailAddressErrorElement.textContent = 'Vui lòng nhập địa chỉ email.';
        emailAddressErrorElement.hidden = false;
        isFormValid = false;
      } else if (!isEmailValid(emailValue)) {
        emailAddressErrorElement.textContent = 'Email không hợp lệ.';
        emailAddressErrorElement.hidden = false;
        isFormValid = false;
      }

      if (!passwordValue) {
        passwordErrorElement.textContent = 'Vui lòng nhập mật khẩu.';
        passwordErrorElement.hidden = false;
        isFormValid = false;
      } else {
        const hasUpper = /[A-Z]/.test(passwordValue);
        const hasLower = /[a-z]/.test(passwordValue);
        const hasDigit = /[0-9]/.test(passwordValue);
        const hasSpecial = /[^A-Za-z0-9]/.test(passwordValue);
        if (passwordValue.length < 8 || !hasUpper || !hasLower || !hasDigit || !hasSpecial) {
          passwordErrorElement.textContent = 'Mật khẩu phải có ít nhất 8 ký tự, bao gồm chữ hoa, chữ thường, số và ký tự đặc biệt.';
          passwordErrorElement.hidden = false;
          isFormValid = false;
        }
      }

      if (confirmPasswordValue !== passwordValue) {
        confirmPasswordErrorElement.textContent = 'Mật khẩu xác nhận không khớp.';
        confirmPasswordErrorElement.hidden = false;
        isFormValid = false;
      }

      return isFormValid;
    }

    function enableSubmitButton() {
      submitButtonElement.disabled = false;
      submitButtonElement.textContent = 'Đăng ký';
    }

    function disableSubmitButtonInProgress() {
      submitButtonElement.disabled = true;
      submitButtonElement.textContent = 'Đang gửi...';
    }
    // ========== VERIFICATION MODAL LOGIC ==========
    const verificationModal = document.getElementById('verificationModal');
    const closeVerificationBtn = document.getElementById('closeVerificationModal');
    const verifyEmailBtn = document.getElementById('verifyEmailBtn');
    const resendVerificationBtn = document.getElementById('resendVerificationBtn');
    const verificationCodeInputs = document.querySelectorAll('.code-input');
    const verificationTimer = document.getElementById('verificationTimer');
    const verificationMessage = document.getElementById('verificationMessage');
    const verificationCodeError = document.getElementById('verificationCodeError');

    let verificationTimerInterval = null;
    let verificationExpiresAt = null;
    let pendingRegistrationData = null;

    function openVerificationModal() {
      verificationModal.classList.add('active');
      verificationCodeInputs[0].focus();
      startVerificationTimer();
    }

    function closeVerificationModal() {
      // Hiển thị cảnh báo
      const confirmClose = confirm('Bạn chưa hoàn tất xác thực email. Nếu đóng cửa sổ này, bạn sẽ phải đăng ký lại từ đầu. Bạn có chắc muốn đóng?');
      
      if (!confirmClose) {
        return; // Không đóng modal nếu user chọn Cancel
      }
      
      // Chỉ đóng khi user xác nhận
      verificationModal.classList.remove('active');
      clearVerificationTimer();
      verificationCodeInputs.forEach(input => input.value = '');
      verificationCodeError.hidden = true;
      verificationMessage.textContent = '';
      pendingRegistrationData = null;
    }

    function startVerificationTimer() {
      if (!verificationExpiresAt) return;
      
      clearVerificationTimer();
      
      verificationTimerInterval = setInterval(() => {
        const now = Date.now();
        const remaining = Math.max(0, Math.floor((verificationExpiresAt - now) / 1000));
        
        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;
        
        verificationTimer.textContent = `⏰ Mã hết hạn sau: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (remaining === 0) {
          clearVerificationTimer();
          verificationTimer.textContent = '❌ Mã đã hết hạn';
          setVerificationMessage('Mã xác thực đã hết hạn. Vui lòng gửi lại.', true);
        }
      }, 1000);
    }

    function clearVerificationTimer() {
      if (verificationTimerInterval) {
        clearInterval(verificationTimerInterval);
        verificationTimerInterval = null;
      }
      verificationTimer.textContent = '';
    }

    function setVerificationMessage(text, isError = false) {
      verificationMessage.textContent = text;
      verificationMessage.className = isError ? 'error-message' : 'success-message';
    }

    function getVerificationCode() {
      return Array.from(verificationCodeInputs).map(input => input.value).join('');
    }

    // Code Input Auto-Focus + Paste Support
    verificationCodeInputs.forEach((input, index) => {
      // Handle paste event
      input.addEventListener('paste', (e) => {
        e.preventDefault();
        const pastedData = e.clipboardData.getData('text').trim();
        const digits = pastedData.replace(/\D/g, '').slice(0, 6);
        
        if (digits.length > 0) {
          digits.split('').forEach((digit, i) => {
            if (verificationCodeInputs[i]) {
              verificationCodeInputs[i].value = digit;
            }
          });
          
          const lastFilledIndex = Math.min(digits.length - 1, 5);
          verificationCodeInputs[lastFilledIndex].focus();
        }
      });

      input.addEventListener('input', (e) => {
        if (e.target.value.length === 1 && index < verificationCodeInputs.length - 1) {
          verificationCodeInputs[index + 1].focus();
        }
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
          verificationCodeInputs[index - 1].focus();
        }
      });

      input.addEventListener('beforeinput', (e) => {
        if (e.data && !/[0-9]/.test(e.data)) {
          e.preventDefault();
        }
      });
    });
    // Close modal events
    closeVerificationBtn.addEventListener('click', closeVerificationModal);
    verificationModal.addEventListener('click', (e) => {
      if (e.target === verificationModal) closeVerificationModal();
    });

    // ========== API CALLS ==========
    const API_BASE = (window.location.protocol === 'file:') ? 'http://localhost:5000' : window.location.origin;

    async function requestVerificationCode(email) {
      try {
        const res = await fetch(`${API_BASE}/api/register/request-verification`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        
        const data = await res.json();
        
        if (res.ok) {
          verificationExpiresAt = Date.now() + (data.expiresIn * 1000);
          setVerificationMessage('Mã xác thực đã được gửi đến email của bạn', false);
          return true;
        } else {
          setVerificationMessage(data.error || 'Không thể gửi mã', true);
          return false;
        }
      } catch (err) {
        console.error('Send verification error:', err);
        setVerificationMessage('Lỗi kết nối. Vui lòng thử lại.', true);
        return false;
      }
    }

    async function verifyEmailCode(email, code) {
      verificationCodeError.hidden = true;
      verifyEmailBtn.disabled = true;
      verifyEmailBtn.textContent = 'Đang xác thực...';
      
      try {
        const res = await fetch(`${API_BASE}/api/register/verify-code`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, code })
        });
        
        const data = await res.json();
        
        if (res.ok) {
          setVerificationMessage('✅ Xác thực thành công!', false);
          
          // Proceed with registration
          setTimeout(async () => {
            await completeRegistration();
          }, 500);
          
          return true;
        } else {
          verificationCodeError.textContent = data.error || 'Mã xác thực không đúng';
          verificationCodeError.hidden = false;
          return false;
        }
      } catch (err) {
        console.error('Verify code error:', err);
        verificationCodeError.textContent = 'Lỗi kết nối. Vui lòng thử lại.';
        verificationCodeError.hidden = false;
        return false;
      } finally {
        verifyEmailBtn.disabled = false;
        verifyEmailBtn.textContent = 'Xác thực';
      }
    }

    async function completeRegistration() {
      if (!pendingRegistrationData) {
        showGeneralMessage('Lỗi: Không có dữ liệu đăng ký', 'error');
        closeVerificationModal();
        return;
      }

      disableSubmitButtonInProgress();
      
      try {
        const response = await fetch(`${API_BASE}/api/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(pendingRegistrationData)
        });

        const responseBody = await response.json().catch(() => null);

        if (response.ok) {
          if (responseBody && responseBody.token) {
            localStorage.setItem('token', responseBody.token);
          }
          const roleFromServer = (responseBody && responseBody.role) ? responseBody.role : 'user';
          localStorage.setItem('role', roleFromServer);
          
          // ✅ XÓA MODAL KHỎI DOM HOÀN TOÀN
          verificationModal.classList.remove('active');
          clearVerificationTimer();
          verificationModal.remove(); // XÓA KHỎI DOM
          
          showGeneralMessage((responseBody && responseBody.message) ? responseBody.message : 'Đăng ký thành công. Chuyển tới Lộ Trình Học...', 'success');
          
          setTimeout(() => {
            window.location.href = '/path.html';
          }, 1000);
        } else {
          closeVerificationModal();
          let messageFromServer = 'Đã xảy ra lỗi khi đăng ký.';
          if (responseBody && responseBody.message) {
            messageFromServer = responseBody.message;
          } else if (response.status === 409) {
            messageFromServer = 'Tên đăng nhập hoặc email đã được sử dụng.';
          } else if (response.status === 422 || response.status === 400) {
            messageFromServer = 'Dữ liệu gửi lên không hợp lệ.';
          }
          showGeneralMessage(messageFromServer, 'error');

          if (responseBody && responseBody.errors && typeof responseBody.errors === 'object') {
            Object.keys(responseBody.errors).forEach(function(fieldName) {
              const message = responseBody.errors[fieldName];
              if (!message) return;
              if (fieldName === 'name') {
                fullNameErrorElement.textContent = message; fullNameErrorElement.hidden = false;
              } else if (fieldName === 'username') {
                userNameErrorElement.textContent = message; userNameErrorElement.hidden = false;
              } else if (fieldName === 'email') {
                emailAddressErrorElement.textContent = message; emailAddressErrorElement.hidden = false;
              } else if (fieldName === 'password') {
                passwordErrorElement.textContent = message; passwordErrorElement.hidden = false;
              }
            });
          }
        }
      } catch (networkError) {
        console.error('Lỗi khi gửi API đăng ký:', networkError);
        closeVerificationModal();
        showGeneralMessage('Không thể kết nối tới server. Vui lòng kiểm tra mạng hoặc server.', 'error');
      } finally {
        enableSubmitButton();
      }
    }

    // Verify button click
    verifyEmailBtn.addEventListener('click', async () => {
      const code = getVerificationCode();
      
      if (code.length !== 6) {
        verificationCodeError.textContent = 'Vui lòng nhập đủ 6 số';
        verificationCodeError.hidden = false;
        return;
      }
      
      if (pendingRegistrationData && pendingRegistrationData.email) {
        await verifyEmailCode(pendingRegistrationData.email, code);
      }
    });

    // Resend button click
    resendVerificationBtn.addEventListener('click', async () => {
      if (pendingRegistrationData && pendingRegistrationData.email) {
        resendVerificationBtn.disabled = true;
        resendVerificationBtn.textContent = 'Đang gửi...';
        
        const success = await requestVerificationCode(pendingRegistrationData.email);
        
        if (success) {
          verificationCodeInputs.forEach(input => input.value = '');
          verificationCodeInputs[0].focus();
          startVerificationTimer();
        }
        
        resendVerificationBtn.disabled = false;
        resendVerificationBtn.textContent = 'Gửi lại mã';
      }
    });

    // ========== MODIFIED SUBMIT HANDLER ==========
    async function submitRegistrationForm(event) {
      event.preventDefault();
      const isFormValid = validateFormInputs();
      if (!isFormValid) {
        showGeneralMessage('Vui lòng sửa các lỗi bên trên trước khi gửi.', 'error');
        return;
      }

      // Store registration data
      pendingRegistrationData = {
        name: fullNameInputElement.value.trim(),
        username: userNameInputElement.value.trim(),
        email: emailAddressInputElement.value.trim(),
        password: passwordInputElement.value
      };

      disableSubmitButtonInProgress();
      showGeneralMessage('Đang gửi mã xác thực...', undefined);

      // Request verification code
      const success = await requestVerificationCode(pendingRegistrationData.email);
      
      enableSubmitButton();
      
      if (success) {
        showGeneralMessage('', undefined);
        openVerificationModal();
      } else {
        showGeneralMessage('Không thể gửi mã xác thực. Vui lòng thử lại.', 'error');
        pendingRegistrationData = null;
      }
    }
    function togglePasswordVisibility() {
      const currentlyPassword = passwordInputElement.type === 'password';
      if (currentlyPassword) {
        passwordInputElement.type = 'text';
        togglePasswordButtonElement.innerHTML = '<i class="fa-solid fa-eye-slash"></i>';
        togglePasswordButtonElement.setAttribute('aria-pressed', 'true');
        togglePasswordButtonElement.setAttribute('aria-label', 'Ẩn mật khẩu');
      } else {
        passwordInputElement.type = 'password';
        togglePasswordButtonElement.innerHTML = '<i class="fa-solid fa-eye"></i>';
        togglePasswordButtonElement.setAttribute('aria-pressed', 'false');
        togglePasswordButtonElement.setAttribute('aria-label', 'Hiện mật khẩu');
      }
    }

    function toggleConfirmPasswordVisibility() {
      const toggleConfirmBtn = document.getElementById('toggleConfirmPasswordButton');
      const currentlyPassword = confirmPasswordInputElement.type === 'password';
      if (currentlyPassword) {
        confirmPasswordInputElement.type = 'text';
        toggleConfirmBtn.innerHTML = '<i class="fa-solid fa-eye-slash"></i>';
        toggleConfirmBtn.setAttribute('aria-pressed', 'true');
        toggleConfirmBtn.setAttribute('aria-label', 'Ẩn mật khẩu');
      } else {
        confirmPasswordInputElement.type = 'password';
        toggleConfirmBtn.innerHTML = '<i class="fa-solid fa-eye"></i>';
        toggleConfirmBtn.setAttribute('aria-pressed', 'false');
        toggleConfirmBtn.setAttribute('aria-label', 'Hiện mật khẩu');
      }
    }

function attachQuickValidationOnBlur() {
  fullNameInputElement.addEventListener('blur', function() {
    if (fullNameInputElement.value.trim() || fullNameInputElement.dataset.touched) {
      fullNameInputElement.dataset.touched = 'true';
      const val = fullNameInputElement.value.trim();
      if (!val) {
        fullNameErrorElement.textContent = 'Vui lòng nhập họ và tên.';
        fullNameErrorElement.hidden = false;
      } else if (val.length < 2) {
        fullNameErrorElement.textContent = 'Họ và tên phải có ít nhất 2 ký tự.';
        fullNameErrorElement.hidden = false;
      } else {
        fullNameErrorElement.hidden = true;
      }
    }
  });

  userNameInputElement.addEventListener('blur', function() {
    if (userNameInputElement.value.trim() || userNameInputElement.dataset.touched) {
      userNameInputElement.dataset.touched = 'true';
      const val = userNameInputElement.value.trim();
      if (!val) {
        userNameErrorElement.textContent = 'Vui lòng nhập tên đăng nhập.';
        userNameErrorElement.hidden = false;
      } else if (!/^[a-zA-Z0-9._-]{3,35}$/.test(val)) {
        userNameErrorElement.textContent = 'Tên đăng nhập chỉ được chứa chữ (a-z, A-Z), số, . _ - và 3–35 ký tự.';
        userNameErrorElement.hidden = false;
      } else {
        userNameErrorElement.hidden = true;
      }
    }
  });

  emailAddressInputElement.addEventListener('blur', function() {
    if (emailAddressInputElement.value.trim() || emailAddressInputElement.dataset.touched) {
      emailAddressInputElement.dataset.touched = 'true';
      const val = emailAddressInputElement.value.trim();
      if (!val) {
        emailAddressErrorElement.textContent = 'Vui lòng nhập địa chỉ email.';
        emailAddressErrorElement.hidden = false;
      } else if (!isEmailValid(val)) {
        emailAddressErrorElement.textContent = 'Email không hợp lệ.';
        emailAddressErrorElement.hidden = false;
      } else {
        emailAddressErrorElement.hidden = true;
      }
    }
  });

  passwordInputElement.addEventListener('blur', function() {
    if (passwordInputElement.value || passwordInputElement.dataset.touched) {
      passwordInputElement.dataset.touched = 'true';
      const val = passwordInputElement.value;
      if (!val) {
        passwordErrorElement.textContent = 'Vui lòng nhập mật khẩu.';
        passwordErrorElement.hidden = false;
      } else {
        const hasUpper = /[A-Z]/.test(val);
        const hasLower = /[a-z]/.test(val);
        const hasDigit = /[0-9]/.test(val);
        const hasSpecial = /[^A-Za-z0-9]/.test(val);
        if (val.length < 8 || !hasUpper || !hasLower || !hasDigit || !hasSpecial) {
          passwordErrorElement.textContent = 'Mật khẩu phải có ít nhất 8 ký tự, bao gồm chữ hoa, chữ thường, số và ký tự đặc biệt.';
          passwordErrorElement.hidden = false;
        } else {
          passwordErrorElement.hidden = true;
        }
      }
    }
  });

  confirmPasswordInputElement.addEventListener('blur', function() {
    if (confirmPasswordInputElement.value || confirmPasswordInputElement.dataset.touched) {
      confirmPasswordInputElement.dataset.touched = 'true';
      if (confirmPasswordInputElement.value !== passwordInputElement.value) {
        confirmPasswordErrorElement.textContent = 'Mật khẩu xác nhận không khớp.';
        confirmPasswordErrorElement.hidden = false;
      } else {
        confirmPasswordErrorElement.hidden = true;
      }
    }
  });

  passwordInputElement.addEventListener('input', function() {
    updatePasswordCriteriaVisual(passwordInputElement.value);
  });
}
    // --- IMPORTANT: ensure immediate navigation on first interaction ---
    // Pointerdown (or mousedown) fires BEFORE blur; navigate on primary pointer down.
    if (loginLinkElement) {
      loginLinkElement.addEventListener('pointerdown', function(ev) {
        // only handle primary button (avoid context menu / middle-click)
        if (ev.button !== 0) return;
        ev.preventDefault(); // stop default only for the pointerdown; we'll navigate explicitly
        // Navigate immediately before blur/validation can interfere
        window.location.href = loginLinkElement.href;
      });
    }

    // events
    registrationFormElement.addEventListener('submit', submitRegistrationForm);
    togglePasswordButtonElement.addEventListener('click', function(event) { event.preventDefault(); event.stopPropagation(); togglePasswordVisibility(); });
    document.getElementById('toggleConfirmPasswordButton').addEventListener('click', function(event) { 
      event.preventDefault(); 
      event.stopPropagation(); 
      toggleConfirmPasswordVisibility(); 
    });
    attachQuickValidationOnBlur();
    fullNameInputElement.focus();
    updatePasswordCriteriaVisual('');
    const backButton = document.getElementById('backButton');
if (backButton) {
  backButton.addEventListener('click', () => {
    window.location.href = '/main.html';
  });
}
// Xử lý khi reload page trong lúc verification
window.addEventListener('beforeunload', (e) => {
  if (verificationModal.classList.contains('active')) {
    e.preventDefault();
    e.returnValue = 'Bạn chưa hoàn tất xác thực email. Nếu tải lại trang, bạn sẽ phải đăng ký lại từ đầu.';
    return e.returnValue;
  }
});
  </script>
  <script src="footer.js"></script>
</body>
</html>
