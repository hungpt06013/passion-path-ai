<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chi Ti·∫øt L·ªô Tr√¨nh - Con ƒë∆∞·ªùng ƒëam m√™</title>
  <script>
    const Token = localStorage.getItem('token');
    if (!Token) {alert('Vui l√≤ng ƒëƒÉng nh·∫≠p!'); window.location.href = 'login.html';}
  </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <style>
            :root {
        --primary:#007bff;
        --primary-dark: #1e6fe6;
        --muted: #6b7280;
        --bg: #f5f8fb;
        --header-height: 80px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #f5f7fa; color: #1f2937; }

html, body {
      height: 100%;
      margin: 0;
    }

    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden;
    }
.page-offset {
  flex: 1 0 auto;  /* Ph·∫ßn n·ªôi dung ch√≠nh s·∫Ω chi·∫øm h·∫øt kh√¥ng gian, ƒë·∫©y footer xu·ªëng d∆∞·ªõi */
  box-sizing: border-box;
  padding-top: 100px;  /* Gi·ªØ nguy√™n padding ƒë·ªÉ tr√°nh ch·ªìng header fixed */
}

    /* (rest of styles same as previous roadmap_details) */
    .analysis-section { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 30px; border-radius: 16px; margin-bottom: 30px; border-left: 5px solid #10b981; }
    .analysis-section h3 { color: #065f46; margin-bottom: 15px; font-size: 1.3rem; }
    .analysis-content { color: #374151; line-height: 1.8; white-space: pre-wrap; }
    .roadmap-section h3 { color: #1f2937; margin-bottom: 20px; font-size: 1.3rem; }
    table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 12px; overflow: hidden; margin-bottom: 40px; }
    thead { background: linear-gradient(135deg, #007bff, #1e40af); color: white; position: sticky; top: 0; z-index: 10; }
    th { padding: 15px; text-align: left; font-weight: 600; font-size: 0.9rem; }
    td { padding: 15px; border-bottom: 1px solid #e5e7eb; vertical-align: top; }
    tbody tr:hover { background: #f9fafb; }
    .day-cell { text-align: center; font-weight: 700; color: #007bff; background: #f0f9ff; }

    .breadcrumb { max-width: 1200px; margin: 24px auto 0; padding: 0 24px; display: flex; align-items: center; gap: 8px; font-size: 14px; color: #6b7280; }
    .breadcrumb a { color: #6b7280; text-decoration: none; }
    .breadcrumb a:hover { color: #007bff; }
    .container { max-width: 1200px; margin: 32px auto 80px; padding: 0 24px; }
    .roadmap-overview { background: white; border-radius: 20px; padding: 40px; margin-bottom: 32px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
    .overview-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; gap: 24px; }
    .overview-title h1 { font-size: 36px; font-weight: 700; margin-bottom: 16px; line-height: 1.2; }
    .overview-badges { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px; }
    .badge { padding: 8px 16px; border-radius: 10px; font-size: 13px; font-weight: 700; display: inline-flex; align-items: center; gap: 6px; }
    .badge-level { background: #dbeafe; color: #1e40af; }
    .badge-duration { background: #dcfdf4; color: #065f46; }
    .badge-learners { background: #fef3c7; color: #92400e; }
    .overview-stats { display: grid; grid-template-columns: repeat(5, 1fr); gap: 24px; padding-top: 24px; border-top: 2px solid #e5e7eb; }
    .stat-box { text-align: center; }
    .stat-value { font-size: 32px; font-weight: 700; color: #007bff; display: block; margin-bottom: 8px; }
    .stat-label { font-size: 14px; color: #6b7280; font-weight: 500; }
    .rating-box { display: flex; align-items: center; gap: 8px; font-size: 24px; }
    .rating-stars { color: #fbbf24; }
    .days-section { margin-top: 32px; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .section-header h2 { font-size: 28px; font-weight: 700; }
    .progress-indicator { display: flex; align-items: center; gap: 12px; padding: 12px 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .progress-bar-mini { width: 120px; height: 8px; background: #e5e7eb; border-radius: 10px; overflow: hidden; }
    .progress-fill-mini { height: 100%; background: linear-gradient(90deg, #007bff, #1e40af); }
    .day-card { background: white; border-radius: 16px; padding: 28px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 2px solid #e5e7eb; transition: all 0.3s; cursor: pointer; }
    .day-card:hover { border-color: #007bff; box-shadow: 0 8px 24px rgba(0, 123, 255, 0.15); }
    .day-card.completed { border-color: #10b981; background: linear-gradient(to right, #f0fdf4 0%, white 20%); }
    .day-card.in-progress { border-color: #f59e0b; background: linear-gradient(to right, #fffbeb 0%, white 20%); }
    .day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .day-number { display: flex; align-items: center; gap: 16px; }
    .day-badge { width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #007bff, #1e40af); color: white; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; }
    .day-card.completed .day-badge { background: linear-gradient(135deg, #10b981, #059669); }
    .day-card.in-progress .day-badge { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .day-info h3 { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
    .day-meta { display: flex; gap: 16px; font-size: 13px; color: #6b7280; }
    .meta-tag { display: flex; align-items: center; gap: 4px; }
    .status-badge { padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
    .status-completed { background: #dcfdf4; color: #065f46; }
    .status-progress { background: #fef3c7; color: #92400e; }
    .status-not-started { background: #f3f4f6; color: #6b7280; }
    .day-content { margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb; }
    .content-section { margin-bottom: 20px; }
    .content-section h4 { font-size: 15px; font-weight: 700; color: #4b5563; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
    .content-section p { font-size: 15px; line-height: 1.7; color: #1f2937; margin-bottom: 12px; }
    .content-section ul { list-style: none; padding-left: 0; }
    .content-section li { padding: 8px 0; padding-left: 24px; position: relative; font-size: 14px; line-height: 1.6; }
    .content-section li:before { content: "‚úì"; position: absolute; left: 0; color: #10b981; font-weight: 700; }
    .expand-btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: #f3f4f6; border: none; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s; margin-top: 12px; }
    .expand-btn:hover { background: #e5e7eb; }
    .create-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.create-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
}

.create-btn:active {
    transform: translateY(0);
}

.create-btn i {
    font-size: 16px;
}
    .loading { text-align: center; padding: 60px 24px; color: #6b7280; }
    .spinner { width: 48px; height: 48px; margin: 0 auto 20px; border: 4px solid #e5e7eb; border-top-color: #007bff; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width: 768px) {
      .overview-stats { grid-template-columns: repeat(2, 1fr); }
      .overview-header { flex-direction: column; }
      .day-meta { flex-direction: column; gap: 8px; }
    }
    /* Modal styles - CH·ªà D√ÄNH CHO DETAILS MODAL */
#detailsModal.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    backdrop-filter: blur(5px);
    padding: 20px;
    overflow-y: auto;
}

#detailsModal.modal-overlay.active {
    display: flex;
}

#detailsModal .modal-content {
    background: white;
    width: 95%;
    max-width: 1200px;
    max-height: 90vh;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 25px 50px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

#detailsModal .modal-header {
    background: linear-gradient(135deg, #007bff, #007bff);
    color: white;
    padding: 25px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#detailsModal .modal-header h2 {
    margin: 0 0 5px 0;
    font-size: 24px;
}

#detailsModal .modal-header p {
    margin: 0;
    opacity: 0.9;
    font-size: 14px;
}

#detailsModal .close-modal {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 5px 10px;
    transition: transform 0.2s;
}

#detailsModal .close-modal:hover {
    transform: scale(1.1);
}

#detailsModal .modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 30px;
}

    @media (max-width: 768px) {
      .page-header h1 { font-size: 28px; }
      .category-stats { flex-direction: column; align-items: flex-start; gap: 12px; }
      .roadmaps-grid { grid-template-columns: 1fr; }
      .footer-content { grid-template-columns: 1fr; gap: 32px; }
      .nav-menu { display: none; }
      .nav-buttons { gap: 12px; padding-right: 12px; }
    }
    /* ƒê·∫£m b·∫£o c√≥ c√°c style n√†y */
.analysis-section { 
  background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); 
  padding: 30px; 
  border-radius: 16px; 
  margin-bottom: 30px; 
  border-left: 5px solid #10b981; 
}

.analysis-section h3 { 
  color: #065f46; 
  margin-bottom: 15px; 
  font-size: 1.3rem; 
}

.analysis-content { 
  color: #374151; 
  line-height: 1.8; 
  white-space: pre-wrap; 
}

.roadmap-section h3 { 
  color: #1f2937; 
  margin-bottom: 20px; 
  font-size: 1.3rem; 
}

table { 
  width: 100%; 
  border-collapse: collapse; 
  background: white; 
  box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
  border-radius: 12px; 
  overflow: hidden; 
  margin-bottom: 40px; 
}

thead { 
  background: linear-gradient(135deg, #007bff, #1e40af); 
  color: white; 
  position: sticky; 
  top: 0; 
  z-index: 10; 
}

th { 
  padding: 15px; 
  text-align: left; 
  font-weight: 600; 
  font-size: 0.9rem; 
}

td { 
  padding: 15px; 
  border-bottom: 1px solid #e5e7eb; 
  vertical-align: top; 
}

tbody tr:hover { 
  background: #f9fafb; 
}

.day-cell { 
  text-align: center; 
  font-weight: 700; 
  color: #007bff; 
  background: #f0f9ff; 
}
.rating-display {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

.rating-display i {
    color: #fbbf24;
    font-size: 24px;
}

.rating-display .rating-value {
    font-size: 28px;
    font-weight: 700;
    color: #007bff;
}

.rating-display .rating-label {
    font-size: 13px;
    color: #6b7280;
    font-weight: 500;
}
.error-message {
  background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
  color: #991b1b;
  padding: 16px 24px;
  border-radius: 12px;
  margin: 20px 0;
  border-left: 4px solid #dc2626;
  font-weight: 600;
  animation: slideIn 0.3s ease-out;
}

.success-message {
  background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
  color: #065f46;
  padding: 16px 24px;
  border-radius: 12px;
  margin: 20px 0;
  border-left: 4px solid #10b981;
  font-weight: 600;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
  </style>
    <!-- Preload Font Awesome CSS -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" as="style">
    
    <!-- Load Font Awesome async -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"></noscript>
    
    <!-- Load Google Fonts async with display swap -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;600;700;900&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;600;700;900&display=swap" rel="stylesheet"></noscript>
    
    <!-- Load footer.css async (non-critical) -->
    <link rel="preload" href="footer.css" as="style">
    <link rel="stylesheet" href="footer.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="footer.css"></noscript>

    <link rel="preload" href="header.css" as="style">
    <link rel="stylesheet" href="header.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="header.css"></noscript>
</head>
<body>
<div id="header"></div>
<script>
  fetch('header.html')
    .then(res => res.text())
    .then(html => {
      document.getElementById('header').innerHTML = html;
      const script = document.createElement('script');
      script.src = 'header.js';
      document.body.appendChild(script);
    });
</script>

  <div class="page-offset">
    <div class="breadcrumb">
      <a href="main.html"><i class="fas fa-home"></i></a>
      <span>/</span>
      <a href="#" id="categoryLink">Lƒ©nh v·ª±c</a>
      <span>/</span>
      <span class="current">Chi ti·∫øt l·ªô tr√¨nh</span>
    </div>

    <div class="container">
      <div id="loadingState" class="loading">
        <div class="spinner"></div>
        <p>ƒêang t·∫£i th√¥ng tin l·ªô tr√¨nh...</p>
      </div>

      <div id="roadmapContent" style="display: none;">
        <div class="roadmap-overview">
          <!-- Th√™m ngay sau roadmap-overview v√† tr∆∞·ªõc days-section -->
          <div class="overview-header">
            <div class="overview-title">
              <h1 id="roadmapTitle">L·ªô Tr√¨nh H·ªçc</h1>
              <div class="overview-badges" id="badgesContainer"></div>
              <div class="day-meta" id="metaContainer"></div>
            </div>
          </div>

          <div class="overview-stats" id="statsContainer"></div>
        </div>
        
        <div id="promptMessage" role="status" aria-live="polite"></div>
        <div class="days-section">
          <div class="section-header">
            <h2>L·ªô Tr√¨nh Chi Ti·∫øt Theo Ng√†y</h2>
            <div class="progress-indicator">
              <button class="create-btn" onclick="createRoadmap()"><i class="fa-solid fa-plus"></i> H·ªçc l·ªô tr√¨nh n√†y</button>
              <span style="font-size: 14px; font-weight: 600; color: #4b5563;">Ti·∫øn ƒë·ªô:</span>
              <div class="progress-bar-mini"><div class="progress-fill-mini" id="progressFill" style="width: 0%"></div></div>
              <span style="font-size: 14px; font-weight: 700; color: #4f46e5;" id="progressText">0%</span>
            </div>
          </div>

          <div id="daysContainer"></div>

<div id="analysisAndDetails" style="display: none;">
  <!-- Ph√¢n t√≠ch AI -->
  <div class="analysis-section">
    <h3>üìä Ph√¢n T√≠ch AI</h3>
    <div class="analysis-content" id="analysisContent"></div>
  </div>
  
  <!-- B·∫£ng chi ti·∫øt -->
  <div class="roadmap-section">
    <h3>üìÖ L·ªô Tr√¨nh Chi Ti·∫øt</h3>
    <table>
      <thead>
        <tr>
          <th style="width: 60px;">Ng√†y</th>
          <th style="min-width: 150px;">M·ª•c ti√™u</th>
          <th style="min-width: 150px;">N·ªôi dung</th>
          <th style="min-width: 120px;">B√†i t·∫≠p</th>
          <th style="min-width: 100px;">T√†i li·ªáu</th>
          <th style="min-width: 100px;">H∆∞·ªõng d·∫´n</th>
          <th style="width: 80px;">Th·ªùi l∆∞·ª£ng</th>
          <th style="width: 120px;">Tr·∫°ng th√°i</th>
        </tr>
      </thead>
      <tbody id="detailsTableBody">
        <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JS -->
      </tbody>
    </table>
  </div>
</div>
          <!-- Modal chi ti·∫øt l·ªô tr√¨nh -->

        </div>
      </div>
    </div>
  </div>
<div id="footer"></div>
  <script>
const ADMIN_TOKEN = 'admin-token';

    const API_BASE_URL = 'http://localhost:3000/api';
    const urlParams = new URLSearchParams(window.location.search);
    const roadmapId = urlParams.get('id');
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }

    let roadmapData = null;
    let details = null;
    let daysData = [];
    const days = [];

    async function createRoadmap() {
      try {
        // Step 1: Check if user can create this roadmap
        const checkResponse = await fetch('/api/check-roadmap-exists', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify({
            roadmap_name: roadmapData.roadmap_name,
            category: roadmapData.category
          })
        });

        const checkResult = await checkResponse.json();

        // Step 2: Handle check result
        if (!checkResult.success) {
          if (checkResult.isCreator) {
            showMessage('‚ö†Ô∏è ' + checkResult.message, 'error');
            return;
          }
          
          if (checkResult.exists) {
            showMessage('‚ö†Ô∏è ' + checkResult.message + ' Vui l√≤ng xem trong danh s√°ch l·ªô tr√¨nh c·ªßa b·∫°n.', 'error');
            return;
          }
          
          showMessage('‚ùå ' + (checkResult.error || 'Kh√¥ng th·ªÉ ki·ªÉm tra l·ªô tr√¨nh'), 'error');
          return;
        }

        // Step 3: User can create - proceed with creation
        const roadmapDataSystem = {
          roadmap_name: roadmapData.roadmap_name,
          category: roadmapData.category,
          sub_category: roadmapData.sub_category || null,
          start_level: roadmapData.start_level,
          duration_days: roadmapData.duration_days,
          duration_hours: roadmapData.duration_hours,
          expected_outcome: roadmapData.expected_outcome,
          study_guide: roadmapData.usage_instructions,
          roadmap_analyst: roadmapData.roadmap_analyst
        };

        const days = [];
        details.forEach((onerow, idx) => {
          const dayData = {
            day_number: idx + 1,
            study_date: null,
            completion_status: 'NOT_STARTED',
            daily_goal: onerow.daily_goal || '',
            learning_content: onerow.learning_content || '',
            practice_exercises: onerow.practice_exercises || '',
            learning_materials: onerow.learning_materials || '',
            study_guide: onerow.usage_instructions || '',
            study_duration: onerow.study_duration || 2
          };
          days.push(dayData);
        });

        if (days.length > 0) roadmapDataSystem.days = days;

        const response = await fetch('/api/roadmap_from_system', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify({ roadmapDataSystem: roadmapDataSystem })
        });

        if (!response.ok) {
          const errData = await response.json().catch(() => ({}));
          throw new Error(errData.error || (`HTTP ${response.status}`));
        }

        showMessage('‚úÖ L·ªô tr√¨nh ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!', 'success');
        
        setTimeout(() => {
          if (window.opener) {
            window.opener.location.href = 'path.html';
            window.close();
          } else {
            window.location.href = 'path.html';
          }
        }, 1200);

      } catch (error) {
        console.error('createRoadmap error:', error);
        showMessage('‚ùå L·ªói: ' + error.message, 'error');
      }
    }
    function showMessage(message, type = 'info') {
      const msgDiv = document.createElement('div');
      msgDiv.className = type === 'success' ? 'success-message' : 'error-message';
      msgDiv.textContent = message;
      promptMessage.innerHTML = '';
      promptMessage.appendChild(msgDiv);
      setTimeout(() => { msgDiv.remove(); }, 3000);
    }

// THAY TH·∫æ h√†m viewRoadmapDetails hi·ªán t·∫°i b·∫±ng code n√†y:
async function viewRoadmapDetails(roadmapId, roadmap_analyst) {
  // Hi·ªÉn th·ªã loading
  document.getElementById('analysisContent').innerHTML = '<div class="loading"><div class="spinner"></div><br><br>ƒêang t·∫£i chi ti·∫øt...</div>';
  document.getElementById('detailsTableBody').innerHTML = '';
  document.getElementById('analysisAndDetails').style.display = 'block';
  
  try {
    const response = await fetch(`/api/roadmapsystem/${roadmapId}/details`, {
      method: 'GET', 
      headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
    });
    if (!response.ok) throw new Error('Failed to fetch roadmap details');
    const result = await response.json();
    details = result.data;
    displayRoadmapDetails(roadmap_analyst, details);
  } catch (error) {
    console.error('Error fetching details:', error);
    document.getElementById('analysisContent').innerHTML = `<div class="error">‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt: ${error.message}</div>`;
  }
}

function displayRoadmapDetails(roadmap, details) {
  document.getElementById('analysisContent').innerHTML = roadmap;
  
  const tbody = document.getElementById('detailsTableBody');
  tbody.innerHTML = details.map(d => `
    <tr>
      <td class="day-cell">${d.day_number}</td>
      <td><strong>${d.daily_goal}</strong></td>
      <td>${d.learning_content}</td>
      <td>${d.practice_exercises || '-'}</td>
      <td>
        ${d.learning_materials ? 
          `<a href="${d.learning_materials}" target="_blank" style="color: #4f46e5;">Xem</a>` : 
          '-'
        }
      </td>
      <td>${d.usage_instructions || '-'}</td>
      <td style="text-align: center;"><strong>${formatHours(d.study_duration)}</strong></td>
      <td>Ch∆∞a h·ªçc</td>
    </tr>
  `).join('');
  
  document.getElementById('analysisAndDetails').style.display = 'block';
}


async function loadRoadmapDetails() {
  if (!roadmapId) { alert('Kh√¥ng t√¨m th·∫•y ID l·ªô tr√¨nh'); window.location.href = 'main.html'; return; }
  try {
    const roadmapResponse = await fetch(`/api/roadmapsystem/${roadmapId}`, { 
      method: 'GET', 
      headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } 
    });
    const roadmapResult = await roadmapResponse.json();
    if (!roadmapResult.success) throw new Error('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin l·ªô tr√¨nh');
    roadmapData = roadmapResult.data;
    
    // ‚úÖ TH√äM DEBUG N√ÄY
    console.log('üîç roadmapData:', roadmapData);
    console.log('üîç roadmap_analyst:', roadmapData.roadmap_analyst);
    
    viewRoadmapDetails(roadmapId, roadmapData.roadmap_analyst);
    renderRoadmap();
  } catch (error) {
    console.error('Error:', error);
    alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: ' + error.message);
    window.location.href = 'main.html';
  } finally {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('roadmapContent').style.display = 'block';
  }
}

function renderRoadmap() {
  console.log('üîç roadmapData:', roadmapData);
  document.getElementById('roadmapTitle').textContent = roadmapData.roadmap_name;
  
  const categoryLink = document.getElementById('categoryLink');
  categoryLink.textContent = roadmapData.category;
  
  if (roadmapData.category_id) {
    categoryLink.href = `main_category.html?category=${roadmapData.category_id}`;
  } else {
    categoryLink.href = `main_category.html?category=${encodeURIComponent(roadmapData.category)}`;
  }
  
  const badgesHTML = `<span class="badge badge-level"><i class="fas fa-signal"></i> ${getLevelText(roadmapData.start_level)}</span><span class="badge badge-duration"><i class="fas fa-calendar"></i> ${roadmapData.duration_days} ng√†y</span><span class="badge badge-learners"><i class="fas fa-users"></i> ${roadmapData.total_user_learning || 0} h·ªçc vi√™n</span>`;
  document.getElementById('badgesContainer').innerHTML = badgesHTML;
  
  const metaHTML = `<div class="meta-tag"><i class="fas fa-clock"></i><span>${roadmapData.duration_hours} gi·ªù h·ªçc</span></div>${roadmapData.sub_category ? `<div class="meta-tag"><i class="fas fa-tag"></i><span>${escapeHtml(roadmapData.sub_category)}</span></div>` : ''}`;
document.getElementById('metaContainer').innerHTML = metaHTML;

// ‚úÖ BUILD TO√ÄN B·ªò STATS HTML C√ôNG L√öC
let statsHTML = `
  <div class="stat-box"><span class="stat-value">${roadmapData.duration_days}</span><span class="stat-label">Ng√†y h·ªçc</span></div>
  <div class="stat-box"><span class="stat-value">${roadmapData.duration_hours}h</span><span class="stat-label">T·ªïng th·ªùi gian</span></div>
  <div class="stat-box"><span class="stat-value">${roadmapData.total_user_learning}</span><span class="stat-label">H·ªçc vi√™n</span></div>

    <div class="stat-box">
      <div class="rating-box" style="display: flex; align-items: center; gap: 8px; justify-content: center;">
        
        <span class="stat-value" style="font-size: 28px;">${roadmapData.high_overall_rating_count || 0}</span><span class="stat-value" style="font-size: 20px; margin-top: 1px">h·ªçc vi√™n</span>
      </div>
      <span class="stat-label">ƒê√°nh gi√° T·ªïng th·ªÉ: ‚â•4‚≠ê</span>
    </div>

    <div class="stat-box">
      <div class="rating-box" style="display: flex; align-items: center; gap: 8px; justify-content: center;">
        
        <span class="stat-value" style="font-size: 28px;">${roadmapData.high_effectiveness_count || 0}</span><span class="stat-value" style="font-size: 20px; margin-top: 1px">h·ªçc vi√™n</span>
      </div>
      <span class="stat-label">ƒê√°nh gi√° Hi·ªáu qu·∫£: ‚â•4‚≠ê</span>
    </div>
  `;

// ‚úÖ G√ÅN 1 L·∫¶N DUY NH·∫§T
document.getElementById('statsContainer').innerHTML = statsHTML;
  }
// ‚úÖ H√ÄM FORMAT HOURS - M·ªöI
function formatHours(hours) {
    if (!hours || isNaN(hours)) return '0m';
    
    const totalMinutes = Math.round(hours * 60);
    const h = Math.floor(totalMinutes / 60);
    const m = totalMinutes % 60;
    
    // ‚úÖ CH·ªà C√ì PH√öT (< 1h)
    if (h === 0) return `${m}m`;
    
    // ‚úÖ CH·ªà C√ì GI·ªú (kh√¥ng c√≥ ph√∫t l·∫ª)
    if (m === 0) return `${h}h`;
    
    // ‚úÖ C√ì C·∫¢ GI·ªú V√Ä PH√öT
    return `${h}h ${m}m`;
}

function renderDays() {
    const container = document.getElementById('daysContainer');
    if (daysData.length === 0) { 
        container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px;">Ch∆∞a c√≥ th√¥ng tin chi ti·∫øt</p>'; 
        return; 
    }
    
    const completedDays = daysData.filter(d => d.completion_status === 'COMPLETED').length;
    const progressPercent = Math.round((completedDays / daysData.length) * 100);
    document.getElementById('progressFill').style.width = progressPercent + '%';
    document.getElementById('progressText').textContent = progressPercent + '%';
    
    container.innerHTML = daysData.map(day => {
        const statusClass = day.completion_status === 'COMPLETED' ? 'completed' : 
                          day.completion_status === 'IN_PROGRESS' ? 'in-progress' : '';
        const statusBadge = day.completion_status === 'COMPLETED' ? '<span class="status-badge status-completed">‚úì Ho√†n th√†nh</span>' : 
                           day.completion_status === 'IN_PROGRESS' ? '<span class="status-badge status-progress">ƒêang h·ªçc</span>' : 
                           '<span class="status-badge status-not-started">Ch∆∞a h·ªçc</span>';
        
        // ‚úÖ S·ª¨ D·ª§NG formatHours()
        const formattedDuration = formatHours(day.study_duration);
        
        return `
          <div class="day-card ${statusClass}" id="day-${day.detail_id}">
            <div class="day-header">
              <div class="day-number">
                <div class="day-badge">${day.day_number}</div>
                <div class="day-info">
                  <h3>Ng√†y ${day.day_number}: ${escapeHtml(day.daily_goal)}</h3>
                  <div class="day-meta">
                    <div class="meta-tag"><i class="fas fa-clock"></i><span>${formattedDuration} h·ªçc t·∫≠p</span></div>
                    ${day.study_date ? `<div class="meta-tag"><i class="fas fa-calendar"></i><span>${formatDate(day.study_date)}</span></div>` : ''}
                  </div>
                </div>
              </div>
              ${statusBadge}
            </div>
            <div class="day-content" id="content-${day.detail_id}" style="display: none;">
              <div class="content-section"><h4><i class="fas fa-bullseye"></i> M·ª•c ti√™u h·ªçc t·∫≠p</h4><p>${escapeHtml(day.daily_goal)}</p></div>
              <div class="content-section"><h4><i class="fas fa-book"></i> N·ªôi dung h·ªçc</h4><p>${escapeHtml(day.learning_content)}</p></div>
              ${day.practice_exercises ? `<div class="content-section"><h4><i class="fas fa-tasks"></i> B√†i t·∫≠p th·ª±c h√†nh</h4><p>${escapeHtml(day.practice_exercises)}</p></div>` : ''}
              ${day.learning_materials ? `<div class="content-section"><h4><i class="fas fa-folder-open"></i> T√†i li·ªáu h·ªçc t·∫≠p</h4><p>${escapeHtml(day.learning_materials)}</p></div>` : ''}
              ${day.usage_instructions ? `<div class="content-section"><h4><i class="fas fa-info-circle"></i> H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h4><p>${escapeHtml(day.usage_instructions)}</p></div>` : ''}
            </div>
            <button class="expand-btn" onclick="toggleDay(${day.detail_id})"><i class="fas fa-chevron-down" id="icon-${day.detail_id}"></i><span id="text-${day.detail_id}">Xem chi ti·∫øt</span></button>
          </div>
        `;
    }).join('');
}
    function toggleDay(dayId) {
      const content = document.getElementById(`content-${dayId}`);
      const icon = document.getElementById(`icon-${dayId}`);
      const text = document.getElementById(`text-${dayId}`);
      if (content.style.display === 'none') {
        content.style.display = 'block'; icon.className = 'fas fa-chevron-up'; text.textContent = 'Thu g·ªçn';
      } else {
        content.style.display = 'none'; icon.className = 'fas fa-chevron-down'; text.textContent = 'Xem chi ti·∫øt';
      }
    }

    function getLevelText(level) { const levels = { 'Beginner': 'C∆° b·∫£n', 'Intermediate': 'Trung c·∫•p', 'Advanced': 'N√¢ng cao' }; return levels[level] || level; }
    function formatDate(dateString) { 
        if (!dateString) return ''; 
        const date = new Date(dateString);
        const utc = date.getTime() + (date.getTimezoneOffset() * 60000);
        const vnTime = new Date(utc + (7 * 60 * 60 * 1000));
        return vnTime.toLocaleDateString('vi-VN', { year: 'numeric', month: 'long', day: 'numeric' }); 
    }
    function escapeHtml(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

    document.addEventListener('DOMContentLoaded', () => { loadRoadmapDetails(); });

    // Load navigation buttons based on user role ‚Äî updated to create actual Home button like main.html
    async function loadNavButtons() {
      const navButtons = document.getElementById('mainNavButtons');
      if (!navButtons) return;
      const token = localStorage.getItem('token');
      const role = localStorage.getItem('role') || 'user';
      let navHtml = `<button class="nav-btn" id="btnHome"><i class="fa-solid fa-house"></i> Trang Ch·ªß</button>`;
      if (token) {
        navHtml += `<button class="nav-btn" id="btnPath"><i class="fa-solid fa-route"></i> L·ªô Tr√¨nh H·ªçc</button>`;
        navHtml += `<button class="nav-btn" id="btnProgress"><i class="fa-solid fa-chart-line"></i> Ti·∫øn ƒê·ªô</button>`;
        if (role === 'admin') navHtml += `<button class="nav-btn" id="btnAdmin"><i class="fa-solid fa-user-shield"></i> Qu·∫£n Tr·ªã</button>`;
      } else {
        navHtml += `<button class="nav-btn" id="btnPath"><i class="fa-solid fa-route"></i> L·ªô Tr√¨nh H·ªçc</button>`;
        navHtml += `<button class="nav-btn" id="btnProgress"><i class="fa-solid fa-chart-line"></i> Ti·∫øn ƒê·ªô</button>`;
      }
      navButtons.innerHTML = navHtml;
      const btnHome = document.getElementById('btnHome'); if (btnHome) btnHome.addEventListener('click', () => { window.location.href = 'main.html'; });
      const btnPath = document.getElementById('btnPath'); if (btnPath) btnPath.addEventListener('click', () => { window.location.href = 'path.html'; });
      const btnProgress = document.getElementById('btnProgress'); if (btnProgress) btnProgress.addEventListener('click', () => { window.location.href = 'progress.html'; });
      const btnAdmin = document.getElementById('btnAdmin'); if (btnAdmin) btnAdmin.addEventListener('click', () => { window.location.href = 'admin.html?page=admin'; });
    }

    // Call on page load
    document.addEventListener('DOMContentLoaded', loadNavButtons);
        if (!token) {
      window.location.href = 'login.html';
    }

</script>
<script src="footer.js"></script>
</body>
</html>
