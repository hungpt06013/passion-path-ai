<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªô Tr√¨nh H·ªçc C·ªßa T√¥i - Con ƒë∆∞·ªùng ƒëam m√™</title>
    <script>
    const Token = localStorage.getItem('token');
    if (!Token) {alert('Vui l√≤ng ƒëƒÉng nh·∫≠p!'); window.location.href = 'login.html';}
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
 <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f5f5;
        min-height: 100vh;
        padding: 20px;
    }

    .container {
        min-width: 1200px;  /* ‚úÖ GI·ªÆ NGUY√äN cho trang ch√≠nh */
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }

    .header {
        background: linear-gradient(135deg, #007bff 0%, #007bff 100%);
        color: white;
        padding: 40px 30px;
        text-align: center;
        position: relative;
        border-radius: 20px 20px 0px 0px;
    }

    .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: 700;
    }

    .header p {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-bottom: 20px; /* ‚úÖ TH√äM margin ƒë·ªÉ t·∫°o kho·∫£ng c√°ch */
    }

    /* ‚úÖ CONTAINER CHO C√ÅC N√öT */
    .header-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 20px;
    }
    .create-btn,
    .upload-btn,
    .prompt-btn {
        padding: 12px 24px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        /* ‚úÖ X√ìA position: absolute */
    }

    .create-btn:hover,
    .upload-btn:hover,
    .prompt-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-2px);
    }

    @media (max-width: 768px) {
        .header-buttons {
            flex-direction: column;
            align-items: center;
        }

        .create-btn,
        .upload-btn,
        .prompt-btn {
            width: 90%;
        }
    }

    /* ‚úÖ MODAL STYLE CHO PROMPT */
    .prompt-modal-content {
        background: white;
        border-radius: 16px;
        padding: 30px;
        max-width: 900px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .prompt-display {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 20px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.6;
        white-space: pre-wrap;
        word-wrap: break-word;
        max-height: 500px;
        overflow-y: auto;
    }

    .copy-btn {
        background: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 15px;
        transition: all 0.3s ease;
    }

    .copy-btn:hover {
        background: #0056b3;
        transform: translateY(-2px);
    }
    .content {
        padding: 40px;
    }

    .roadmaps-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
        gap: 30px;
    }

    .roadmap-card {
        background: white;
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border: 2px solid #e5e7eb;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
    }

    .roadmap-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 30px rgba(0,0,0,0.15);
        border-color: #007bff;
    }

    .delete-roadmap-btn {
        position: absolute;
        top: 309px;
        right: 15px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 14px 13px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 5;
    }

    .delete-roadmap-btn:hover {
        background: #0056b3;
        transform: scale(1.05);
    }

    .roadmap-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
    }

    .roadmap-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #1f2937;
        flex: 1;
    }

    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        white-space: nowrap;
        margin-left: 10px;
    }

.status-not-started {
    background: #dc2626;
    color: #ffffff;
    font-weight: 700;
}

.status-active {
    background: #f59e0b;
    color: #ffffff;
    font-weight: 700;
}

.status-completed {
    background: #16a34a;
    color: #ffffff;
    font-weight: 700;
}
/* T√¨m ph·∫ßn status-badge CSS v√† th√™m: */
.status-skipped {
    background: #6b7280;
    color: #ffffff;
    font-weight: 700;
}
    .roadmap-meta {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
        font-size: 0.9rem;
        color: #6b7280;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .progress-section {
        margin: 15px 0;
    }

    .progress-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        color: #374151;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #007bff, #007bff);
        transition: width 0.3s ease;
    }

    .roadmap-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin: 20px 0;
        padding: 15px;
        background: #f9fafb;
        border-radius: 12px;
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        font-size: 1.4rem;
        font-weight: 700;
        color: #007bff;
    }

    .stat-label {
        font-size: 0.8rem;
        color: #6b7280;
        margin-top: 4px;
    }

    .view-details-btn {
        width: 85%;
        padding: 12px;
        background: linear-gradient(135deg, #007bff, #007bff);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 15px;
        display: block;
    }

    .view-details-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(79, 70, 229, 0.3);
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }

    .empty-icon {
        font-size: 4rem;
        margin-bottom: 20px;
    }

    .empty-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 10px;
    }

    .empty-text {
        color: #6b7280;
        margin-bottom: 30px;
        font-size: 1.05rem;
    }

    .empty-btn {
        padding: 12px 30px;
        background: linear-gradient(135deg, #007bff, #007bff);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .empty-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(79, 70, 229, 0.3);
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #6b7280;
    }

    .spinner {
        display: inline-block;
        width: 30px;
        height: 30px;
        border: 4px solid #e5e7eb;
        border-radius: 50%;
        border-top-color: #007bff;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(5px);
        padding: 20px;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-content {
        background: white;
        width: 95%;
        max-height: 95vh;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
        animation: slideIn 0.3s ease-out;
    }
    #modal-content-details {
        min-width: 1400px;
    }
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        background: linear-gradient(135deg, #007bff, #007bff);
        color: white;
        padding: 25px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .close-modal {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 5px 10px;
    }

    .modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 30px;
    }

    .analysis-section {
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        padding: 30px;
        border-radius: 16px;
        margin-bottom: 30px;
        border-left: 5px solid #10b981;
    }

    .analysis-section h3 {
        color: #065f46;
        margin-bottom: 15px;
        font-size: 1.3rem;
    }

    .analysis-content {
        color: #374151;
        line-height: 1.8;
        white-space: pre-wrap;
    }

    .roadmap-section h3 {
        color: #1f2937;
        margin-bottom: 20px;
        font-size: 1.3rem;
    }

    table {
        width: 100%;
        border-collapse: separate !important; /* ‚úÖ ƒê·ªîI: t·ª´ collapse sang separate */
        border-spacing: 0; /* ‚úÖ TH√äM: Gi·ªØ kho·∫£ng c√°ch = 0 */
        background: white;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-radius: 12px;
        overflow: visible !important; /* ‚úÖ ƒê·ªîI: t·ª´ hidden sang visible */
        margin-bottom: 40px;
        position: relative;
    }
    tbody {
        position: relative;
        z-index: 1;
    }

    tbody tr {
        position: relative;
    }
    thead {
        background: linear-gradient(135deg, #007bff, #007bff);
        color: white;
    }

    th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        font-size: 0.9rem;
    }

    td {
        padding: 15px;
        border-bottom: 1px solid #e5e7eb;
        vertical-align: top;
    }
    td.date-cell {
        text-align: center;
        font-weight: 600;
        color: #059669;
        background: #f0fdf4;
    }

    /* ‚úÖ TH√äM RULE M·ªöI: ∆Øu ti√™n vi·ªÅn v√†ng khi hover trong edit mode */
    .edit-mode-active td.date-cell.editable:hover {
        border-bottom: 2px solid #f59e0b !important;
    }
    tbody tr:hover {
        background: #f9fafb;
    }

    .day-cell {
        text-align: center;
        font-weight: 700;
        color: #007bff;
        background: #f0f9ff;
    }

    select {
        padding: 8px 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.85rem;
        cursor: pointer;
        width: 100%;
        transition: all 0.3s ease;
    }

    select:hover {
        border-color: #007bff;
    }

    .date-cell {
        text-align: center;
        font-weight: 600;
        color: #059669;
        background: #f0fdf4;
    }

    .evaluation-section {
        background: linear-gradient(135deg, #fef3c7 0%, #fef08a 100%);
        padding: 30px;
        border-radius: 16px;
        border-left: 5px solid #f59e0b;
        margin-top: 40px;
    }

    .evaluation-section h3 {
        color: #92400e;
        margin-bottom: 25px;
        font-size: 1.3rem;
    }

    .rating-group {
        margin-bottom: 25px;
        background: white;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #e5e7eb;
    }

    .rating-group label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 12px;
        font-size: 1rem;
    }

    .rating-stars {
        display: flex;
        gap: 8px;
        font-size: 2rem;
    }

    .star {
        cursor: pointer;
        color: #d1d5db;
        transition: all 0.2s ease;
    }

    .star:hover,
    .star.active {
        color: #fbbf24;
        transform: scale(1.2);
    }

    .rating-value {
        margin-top: 10px;
        font-size: 0.9rem;
        color: #6b7280;
        font-weight: 600;
    }

    .textarea-group {
        margin-bottom: 20px;
        background: white;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #e5e7eb;
    }

    .textarea-group label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 10px;
    }

    .textarea-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-family: inherit;
        font-size: 0.95rem;
        resize: vertical;
        min-height: 100px;
        transition: all 0.3s ease;
    }

    .textarea-group textarea:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .checkbox-group {
        margin-bottom: 20px;
        background: white;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .checkbox-group label {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        color: #374151;
        cursor: pointer;
        margin: 0;
    }

    .checkbox-group input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }

    .submit-evaluation-btn {
        width: 100%;
        padding: 16px 32px;
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 20px;
    }

    .submit-evaluation-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
    }

    .submit-evaluation-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
    }

    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 10000;
        transform: translateX(400px);
        transition: transform 0.3s ease;
    }

    .notification.show {
        transform: translateX(0);
    }

    .notification.success {
        background: #059669;
    }

    .notification.error {
        background: #dc2626;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #374151;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        font-family: 'Inter', sans-serif;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    .submit-btn {
        background: #007bff;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 600;
        width: 100%;
        margin-top: 10px;
        border: none;
        cursor: pointer;
    }

    .submit-btn:hover {
        background: #0056b3;
    }

    .submit-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }

    .info-box {
        background: #fff3cd;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #ffc107;
    }

    @media (max-width: 768px) {
        .roadmaps-grid {
            grid-template-columns: 1fr;
        }

        .header h1 {
            font-size: 2rem;
        }

        .create-btn {
            position: static;
            margin-top: 20px;
            width: 100%;
        }

        .modal-content {
            width: 98%;
            max-height: 98vh;
        }

        table {
            font-size: 0.8rem;
        }

        th, td {
            padding: 10px 6px;
        }
    }

.fixed-bar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 80px;
    background: var(--primary);
    box-shadow: 0 6px 20px rgba(14, 30, 37, 0.12);
    z-index: 50;
}

/* Layout container - keeps content centered but lets nav expand */
.bar-inner {
    max-width: 1200px;
    height: 100%;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    box-sizing: border-box;
    gap: 16px;
}

/* Brand (left) */
.brand {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 0 0 auto;
    min-width: 0;
}

.brand-icon {
    width: 48px;
    height: 48px;
    background: rgba(255,255,255,0.2);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 22px;
    flex-shrink: 0;
}

.brand-text {
    display: flex;
    flex-direction: column;
    gap: 3px;
    line-height: 1;
    min-width: 0;
}

.brand-title {
    color: white;
    font-size: 20px;
    font-weight: 700;
    white-space: normal;
    word-break: break-word;
    line-height: 1.05;
}

.brand-sub {
    color: rgba(255,255,255,0.9);
    font-size: 12px;
    font-weight: 600;
    white-space: normal;
    line-height: 1;
}

/* Nav buttons (center) - take remaining space */
.nav-buttons {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding: 4px 12px 4px 6px;
    min-width: 0;
    white-space: nowrap;
    flex-wrap: nowrap;
    gap: 22px;
}

.nav-buttons::-webkit-scrollbar { 
    height: 6px; 
}

.nav-buttons::-webkit-scrollbar-thumb { 
    background: rgba(0, 0, 0, 0.12); 
    border-radius: 6px; 
}

.nav-btn {
    background: none;
    color: #fff;
    padding: 6px 12px;
    font-size: 15px;
    font-weight: 600;
    border-radius: 9999px;
    white-space: nowrap;
    flex-shrink: 0;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.nav-btn .fa {
    margin-right: 4px;
    opacity: 0.95;
}

.nav-btn.active {
    color: #e6f2ff;
    text-decoration: underline;
}

/* User area (right) */
.userInfo {
    color: white;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 0 0 auto;
    min-width: 0;
}
    .toMain {
        background: #000;
        color: #fff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }

    .toMain:hover {
        background: #222;
    }
    @media (max-width: 768px) {
        .bar-inner {
            flex-direction: column;
            height: auto;
            padding: 15px;
            gap: 10px;
        }

        .fixed-bar {
            height: auto;
        }

        .nav-buttons {
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
    }

    @media (max-width: 480px) {
        .brand-title {
            font-size: 16px;
        }

        .brand-sub {
            font-size: 11px;
        }

        .nav-btn {
            font-size: 13px;
            padding: 8px 12px;
        }
    }

    body {
        font-family: 'Inter', sans-serif;
        margin-top: 80px;
    }

    button {
        font-family: 'Inter', sans-serif;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: none;
        border-radius: 9999px;
        padding: 10px 18px;
        font-size: 15px;
        font-weight: 600;
    }

    .nav-btn {
        background: none;
        color: #fff;
        padding: 0;
        font-size: 15px;
        font-weight: 600;
        border-radius: 9999px;
    }

    .nav-btn .fa {
        margin-right: 8px;
        opacity: 0.95;
    }

    .nav-btn.active {
        color: #e6f2ff;
        text-decoration: underline;
    }

    .toMain {
        background: #000;
        color: #fff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }

    .toMain:hover {
        background: #222;
    }

    :root {
        --primary: #007bff;
        --primary-dark: #1e6fe6;
        --muted: #6b7280;
        --bg: #f5f8fb;
    }

    html, body {
        height: 100%;
        overflow-x: hidden;
        overflow-y: auto;
    }

    body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        font-family: 'Inter', sans-serif;
        color: #0f172a;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    .userInfo {
        color: white;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .login-btn {
        background: white;
        color: #333;
        box-shadow: 0 2px 5px rgba(0,0,0,0.12);
    }

    .login-btn:hover {
        background: #f0f0f0;
    }

    .register-btn {
        background: #28a745;
        color: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.12);
    }

    .register-btn:hover {
        background: #218838;
    }

    .logout-btn {
        background: linear-gradient(135deg, #4b0ee5 0%, #0682d4 100%);
        color: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.12);
    }
    /*.logout-btn:hover {
        background: linear-gradient(135deg, #4b0ee5 0%, #0682d4 100%);
        opacity: 0.9;
    }*/
    .toApp-btn {
        background: #000;
        color: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.12);
    }

    .admin-btn {
        background: #6f42c1;
        color: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.12);
    }
.roadmap-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.edit-mode-btn {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.edit-mode-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3);
}

.edit-mode-btn.active {
    background: linear-gradient(135deg, #10b981, #059669);
}

.save-changes-btn {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 20px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.save-changes-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
}

.cancel-edit-btn {
    background: #6b7280;
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 20px;
    margin-left: 10px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.cancel-edit-btn:hover {
    background: #4b5563;
}
.add-day-btn {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.add-day-btn:hover {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
}
/* N√∫t x√≥a ng√†y */
.delete-day-btn {
    background: #266cdc;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.delete-day-btn:hover {
    background: #1c6ab9;
    transform: scale(1.05);
}
/* ·∫®n c·ªôt thao t√°c khi kh√¥ng edit mode */
table:not(.edit-mode-active) th:last-child,
table:not(.edit-mode-active) td:last-child {
    display: none;
}
/* Editable cell styles */
td.editable {
    position: relative;
    cursor: text;
}

td.editable:hover {
    background: #fef3c7;
    outline: 2px solid #f59e0b;
}
/* ‚úÖ TH√äM RULE M·ªöI: V√î HI·ªÜU H√ìA HOVER CHO √î EDITABLE TRONG D√íNG B·ªä X√ìA */
tbody tr.marked-for-deletion td.editable:hover {
    background: #fee2e2 !important; /* Gi·ªØ m√†u ƒë·ªè nh·∫°t */
    outline: none !important; /* Kh√¥ng c√≥ vi·ªÅn */
}
td.editable input,
td.editable textarea {
    width: 100%;
    padding: 8px;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    font-family: inherit;
    font-size: 0.9rem;
    background: white;
}

td.editable input:focus,
td.editable textarea:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

td.editable textarea {
    min-height: 80px;
    resize: vertical;
}

/* Drag and drop styles */
tbody tr.draggable {
    cursor: move;
}

tbody tr.dragging {
    opacity: 0.5;
    background: #f0f9ff;
}

tbody tr.drag-over {
    border-top: 3px solid #007bff;
}

.drag-handle {
    cursor: move;
    color: #9ca3af;
    font-size: 1.2rem;
    padding: 0 8px;
}

.drag-handle:hover {
    color: #007bff;
}

.edit-mode-active tbody tr {
    border-left: 3px solid transparent;
    transition: all 0.2s ease;
}

.edit-mode-active tbody tr:hover {
    border-left-color: #007bff;
    background: #f9fafb;
}
/* Placeholder kh√¥ng ƒë·∫≠m cho input ng√†y h·ªçc */
td.date-cell input::placeholder {
    font-weight: 400;
    opacity: 0.6;
    font-size: 0.8rem;
}
/* ‚úÖ ƒê·∫¢M B·∫¢O N√öT H·ª¶Y KH√îNG B·ªä M·ªú */
.undo-delete-btn {
    background: #10b981 !important; /* ‚úÖ M√ÄU XANH, KH√îNG PH·∫¢I ƒê·ªé */
    color: white !important;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    opacity: 1 !important; /* ‚úÖ LU√îN HI·ªÇN TH·ªä ƒê·∫¶Y ƒê·ª¶ */
    position: relative;
    z-index: 100; /* ‚úÖ TƒÇNG Z-INDEX ƒê·ªÇ N·ªîI TR√äN */
}

.undo-delete-btn:hover {
    background: #059669 !important;
    transform: scale(1.05);
}
/* ===== STYLE CHO D√íNG ƒê√ÅNH D·∫§U X√ìA ===== */

/* N·ªÅn ƒë·ªè nh·∫°t cho d√≤ng b·ªã x√≥a */
tbody tr.marked-for-deletion {
    background: #fee2e2 !important;
}

/* V√¥ hi·ªáu h√≥a input/textarea trong ng√†y b·ªã x√≥a */
tbody tr.marked-for-deletion input,
tbody tr.marked-for-deletion textarea,
tbody tr.marked-for-deletion select {
    pointer-events: none;
    opacity: 0.5;
    cursor: not-allowed;
    background: #fef2f2 !important;
}

/* ƒê·∫£m b·∫£o N√öT H·ª¶Y v·∫´n click ƒë∆∞·ª£c */
tbody tr.marked-for-deletion .undo-delete-btn {
    pointer-events: auto !important;
    opacity: 1 !important;
    cursor: pointer !important;
}

/* ‚úÖ G·∫†CH NGANG TO√ÄN B·ªò C√ÅC √î (tr·ª´ c·ªôt thao t√°c) */
tbody tr.marked-for-deletion td:not(:last-child) {
    text-decoration: line-through;
    color: #991b1b;
    position: relative;
}

/* ‚úÖ M√ÄU ƒê·ªé CHO C·ªòT NG√ÄY V√Ä NG√ÄY H·ªåC */
tbody tr.marked-for-deletion td.day-cell,
tbody tr.marked-for-deletion td.date-cell {
    background: #fee2e2 !important;
    color: #991b1b !important;
    font-weight: 700;
}

/* ‚úÖ G·∫°ch ngang m√†u ƒë·ªè to√†n b·ªô */
tbody tr.marked-for-deletion td:not(:last-child)::after {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    width: 100%;
    height: 2px;
    background: #dc2626;
    transform: translateY(-50%);
}

/* Icon drag handle khi b·ªã x√≥a */
tbody tr.marked-for-deletion .drag-handle {
    opacity: 0.3;
}

/* ‚úÖ ƒê·∫¢M B·∫¢O N√öT H·ª¶Y KH√îNG B·ªä M·ªú */
.undo-delete-btn {
    background: #10b981 !important;
    color: white !important;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    opacity: 1 !important;
    position: relative;
    z-index: 100;
}

.undo-delete-btn:hover {
    background: #059669 !important;
    transform: scale(1.05);
}
/* ‚úÖ TH√äM: Style cho select trong edit mode */
.edit-mode-active td.editable select {
    border: 2px solid #e5e7eb;
    transition: all 0.3s ease;
}

.edit-mode-active td.editable select:focus,
.edit-mode-active td.editable select:hover {
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}
/* ‚úÖ √î cu·ªëi trong d√≤ng b·ªã x√≥a */
tbody tr.marked-for-deletion td:last-child {
    position: relative;
    z-index: auto; /* ‚úÖ Reset z-index m·∫∑c ƒë·ªãnh */
}

/* ===== ‚úÖ HOVER STYLE - CH·ªà √î C√ì N√öT H·ª¶Y M·ªöI C√ì M√ÄU V√ÄNG ===== */

/* ‚úÖ X√ìA STYLE HOVER CHO T·∫§T C·∫¢ C√ÅC √î (tr·ª´ √¥ c√≥ n√∫t) */
tbody tr.marked-for-deletion:hover td:not(:last-child) {
    background: #fee2e2 !important;
    border-color: transparent !important;
}

/* ‚úÖ CH·ªà √î CU·ªêI (ch·ª©a n√∫t H·ªßy) m·ªõi c√≥ m√†u V√ÄNG khi hover */
tbody tr.marked-for-deletion td:last-child:hover {
    background: #fef3c7 !important;
    box-shadow: 
        inset 0 0 0 2px #f59e0b,  /* Vi·ªÅn b√™n trong */
        0 0 0 2px #f59e0b !important; /* ‚úÖ TH√äM: Vi·ªÅn b√™n ngo√†i */
    position: relative;
    z-index: 100 !important; /* ‚úÖ TƒÇNG: z-index r·∫•t cao */
}

/* ‚úÖ N√∫t H·ªßy GI·ªÆ NGUY√äN m√†u XANH */
tbody tr.marked-for-deletion .undo-delete-btn {
    background: #10b981 !important;
    color: white !important;
    position: relative;
    z-index: 101 !important; /* ‚úÖ TƒÇNG: Cao h∆°n √¥ ch·ª©a n√≥ */
}

/* ‚úÖ N√∫t H·ªßy hover th√¨ ƒë·∫≠m h∆°n */
tbody tr.marked-for-deletion .undo-delete-btn:hover {
    background: #059669 !important;
    transform: scale(1.05);
}
</style>
    <!-- Preload Font Awesome CSS -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" as="style">
    
    <!-- Load Font Awesome async -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"></noscript>
    
    <!-- Load Google Fonts async with display swap -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;600;700;900&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;600;700;900&display=swap" rel="stylesheet"></noscript>
    
    <!-- Load footer.css async (non-critical) -->
    <link rel="preload" href="footer.css" as="style">
    <link rel="stylesheet" href="footer.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="footer.css"></noscript>
</head>
<body>

<!-- ========== NAV BAR: REPLACED WITH main.html exact HTML ========== -->
<div class="fixed-bar">
    <div class="bar-inner">
        <div class="brand">
            <div class="brand-icon">
                <i class="fa-solid fa-graduation-cap"></i>
            </div>
            <div class="brand-text">
                <div class="brand-title">Con ƒë∆∞·ªùng ƒëam m√™</div>
                <div class="brand-sub">AI-Powered Learning Path</div>
            </div>
        </div>
        <div class="nav-buttons" id="mainNavButtons">
            <!-- Buttons s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript / ho·∫∑c gi·ªØ d·∫°ng tƒ©nh n·∫øu b·∫°n mu·ªën -->
            <button class="nav-btn" id="btnHome"><i class="fa-solid fa-house"></i> Trang Ch·ªß</button>
            <button class="nav-btn active" id="btnPath"><i class="fa-solid fa-route"></i> L·ªô Tr√¨nh H·ªçc</button>
            <button class="nav-btn" id="btnProgress"><i class="fa-solid fa-chart-line"></i> Ti·∫øn ƒê·ªô</button>
        </div>
        <div id="userArea" class="userInfo">
        <button class="login-btn"><i class="fa-solid fa-right-to-bracket"></i> ƒêƒÉng nh·∫≠p</button>
        <button class="register-btn"><i class="fa-solid fa-user-plus"></i> ƒêƒÉng k√Ω</button>
        </div>
    </div>
</div>
<!-- ========== END NAV BAR ========== -->

    <div class="container" style="margin-top:120px;">
        <div class="header">
            <h1>üõ£Ô∏è L·ªô Tr√¨nh H·ªçc C·ªßa T√¥i</h1>
            <p id="header-subtitle">ƒêang t·∫£i d·ªØ li·ªáu...</p>
            
            <!-- ‚úÖ N√öT M·ªöI - D∆Ø·ªöI SUBTITLE -->
            <div class="header-buttons">
                <button class="upload-btn" onclick="openUploadModal()">
                    üì§ Upload Excel
                </button>
                <button class="prompt-btn" onclick="openPromptModal()">
                    üìù Prompt M·∫´u
                </button>
                <button class="create-btn" onclick="goToCreateRoadmap()">
                    ‚ûï T·∫°o L·ªô Tr√¨nh M·ªõi
                </button>
            </div>
        </div>
        <div class="content" id="content-area">
            <div class="loading">
                <div class="spinner"></div>
                <br><br>
                ƒêang t·∫£i l·ªô tr√¨nh h·ªçc...
            </div>
        </div>
    </div>

    <!-- Modal xem chi ti·∫øt -->
    <div class="modal-overlay" id="detailsModal">
        <div class="modal-content" id="modal-content-details">
            <div class="modal-header">
                <div>
                    <h2 id="modal-title">Chi ti·∫øt l·ªô tr√¨nh</h2>
                    <p style="opacity: 0.9;">Ph√¢n t√≠ch AI, l·ªô tr√¨nh h·ªçc chi ti·∫øt v√† ƒë√°nh gi√°</p>
                </div>
                <button class="close-modal" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body" id="modal-body">
                <div class="loading">
                    <div class="spinner"></div>
                    <br><br>
                    ƒêang t·∫£i chi ti·∫øt...
                </div>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="promptModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div>
                    <h2>üìù Prompt M·∫´u</h2>
                    <p>Template prompt ƒë·ªÉ t·∫°o l·ªô tr√¨nh h·ªçc</p>
                </div>
                <button class="close-modal" onclick="closePromptModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="loading" id="promptLoading">
                    <div class="spinner"></div>
                    <br><br>
                    ƒêang t·∫£i prompt...
                </div>
                <div id="promptContent" style="display: none;">
                    <div style="background: #fee2e2; border-left: 4px solid #dc2626; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="color: #dc2626; font-weight: 600; margin: 0; line-height: 1.6;">
                            ‚ö†Ô∏è B·∫°n h√£y ƒëi·ªÅn c√¢u tr·∫£ l·ªùi v√†o nh·ªØng v·ªã tr√≠ &lt;...&gt; v√† t√πy bi·∫øn l·∫°i prompt m·∫´u theo nhu c·∫ßu c·ªßa b·∫°n, r·ªìi b·∫°n g·ª≠i prompt cho AI ƒë·ªÉ c√≥ ƒë∆∞·ª£c 1 k·∫øt qu·∫£ g·ªìm th√¥ng tin ƒë√°nh gi√° hi·ªán tr·∫°ng v√† b·∫£ng chi ti·∫øt l·ªô tr√¨nh h·ªçc g·ªìm 8 c·ªôt ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng "Upload Excel" t·∫°o l·ªô tr√¨nh h·ªçc c√° nh√¢n h√≥a.
                        </p>
                    </div>
                    <div class="prompt-display" id="promptText"></div>
                    <button class="copy-btn" onclick="copyPromptToClipboard()">
                        üìã Copy Prompt
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="footer" style="display: none;"></div>
<!-- ========== SCRIPTS: T·∫§T C·∫¢ GI·ªÆ NGUY√äN NH∆Ø TRONG path.html ========== -->
<script>
    const token = localStorage.getItem('token');
    // (Ph·∫ßn script gi·ªØ nguy√™n ho√†n to√†n t·ª´ path.html g·ªëc)
    // M√¨nh ch√®n nguy√™n c√°c h√†m ch√≠nh: fetchRoadmaps, renderRoadmaps, displayRoadmapDetails,
    // updateStatus, submitEvaluation, upload handling, setupNavigation, initApp, v.v.
    let currentRoadmapId = null;
    let evaluationData = {};
    let allRoadmaps = [];
// Th√™m v√†o ph·∫ßn <script>, sau ph·∫ßn khai b√°o bi·∫øn global

let isEditMode = false;
let originalDetails = [];
let currentEditingRoadmapId = null;
function toggleEditMode() {
    if (isEditMode) {
        // ‚úÖ N·∫æU ƒêANG EDIT, G·ªåI H√ÄM SAVE (GI·ªêNG N√öT "L∆ØU THAY ƒê·ªîI")
        saveChanges();
    } else {
        // B·∫≠t edit mode
        isEditMode = true;
        const btn = document.querySelector('.edit-mode-btn');
        const table = document.querySelector('.roadmap-section table');
        
        btn.innerHTML = '<i class="fa-solid fa-check"></i> ƒêang ch·ªânh s·ª≠a';
        btn.classList.add('active');
        enableEditMode(table);
        showEditButtons();
    }
}
function enableEditMode(table) {
    const displayDiv = document.getElementById('analysis-content-display');
    const editTextarea = document.getElementById('analysis-content-edit');
    if (displayDiv && editTextarea) {
        displayDiv.style.display = 'none';
        editTextarea.style.display = 'block';
    }
    if (!table) return;
    
    table.classList.add('edit-mode-active');
    const tbody = table.querySelector('tbody');
    const rows = tbody.querySelectorAll('tr');
    
    rows.forEach((row, index) => {
        // Add drag handle
        const dayCell = row.querySelector('td:first-child');
        if (dayCell && !dayCell.querySelector('.drag-handle')) {
            const currentNumber = dayCell.textContent.trim();
            dayCell.innerHTML = `<span class="drag-handle">‚ò∞</span><br>${currentNumber}`;
        }
        
        // Make row draggable
        row.draggable = true;
        row.classList.add('draggable');
        
        // Add drag event listeners
        row.addEventListener('dragstart', handleDragStart);
        row.addEventListener('dragend', handleDragEnd);
        row.addEventListener('dragover', handleDragOver);
        row.addEventListener('drop', handleDrop);
        row.addEventListener('dragleave', handleDragLeave);
        
        // Make cells editable (except day number (0) and status (8))
        const cells = row.querySelectorAll('td');
        cells.forEach((cell, cellIndex) => {
            if (cellIndex === 0) return;
            
            cell.classList.add('editable');
            const originalContent = cell.innerHTML;
            
            // ‚úÖ NG√ÄY H·ªåC (index 1) - date input (V·∫™N CHO EDIT)
            if (cellIndex === 1) {
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = 'dd/mm/yyyy';
                
                const dateText = cell.textContent.trim();
                if (dateText !== 'N/A') {
                    const parts = dateText.split('/');
                    if (parts.length === 3) {
                        input.value = `${parts[0].padStart(2, '0')}/${parts[1].padStart(2, '0')}/${parts[2]}`;
                    }
                }
                
                input.dataset.originalContent = originalContent;
                input.style.width = '100%';
                cell.innerHTML = '';
                cell.appendChild(input);
                return;
            }
            
            // Multi-line fields: goal (2), content (3), exercises (4), instructions (6)
            if (cellIndex === 2 || cellIndex === 3 || cellIndex === 4 || cellIndex === 6) {
                const textarea = document.createElement('textarea');
                textarea.value = cell.textContent.trim();
                textarea.dataset.originalContent = originalContent;
                cell.innerHTML = '';
                cell.appendChild(textarea);
                return;
            }
            
            // ‚úÖ MATERIALS (index 5) - Extract FULL URLs
            if (cellIndex === 5) {
                const textarea = document.createElement('textarea');
                
                // Extract all full URLs from links
                const links = cell.querySelectorAll('a');
                const fullUrls = Array.from(links).map(link => link.href).filter(Boolean);
                
                if (fullUrls.length > 0) {
                    textarea.value = fullUrls.join('\n');
                } else {
                    textarea.value = cell.textContent.trim();
                }
                
                textarea.dataset.originalContent = originalContent;
                textarea.placeholder = 'Nh·∫≠p URL (m·ªói link m·ªôt d√≤ng)';
                cell.innerHTML = '';
                cell.appendChild(textarea);
                return;
            }
            
            // Duration (index 7) - text input
            if (cellIndex === 7) {
                const input = document.createElement('input');
                input.type = 'text';
                input.value = cell.textContent.trim();
                input.dataset.originalContent = originalContent;
                input.placeholder = 'VD: 1.5h, 90m';
                cell.innerHTML = '';
                cell.appendChild(input);
                return;
            }
            if (cellIndex === 8) {
                cell.classList.add('editable'); // ‚úÖ Th√™m class editable
                const select = cell.querySelector('select');
                if (select) {
                    select.dataset.originalContent = originalContent;
                    // Gi·ªØ nguy√™n select, ch·ªâ th√™m styling
                }
                return;
            }
        });
    });
    window.onbeforeunload = function(e) {
        if (isEditMode) {
            e.preventDefault();
            e.returnValue = 'B·∫°n c√≥ thay ƒë·ªïi ch∆∞a l∆∞u. B·∫°n c√≥ ch·∫Øc mu·ªën r·ªùi kh·ªèi trang?';
            return 'B·∫°n c√≥ thay ƒë·ªïi ch∆∞a l∆∞u. B·∫°n c√≥ ch·∫Øc mu·ªën r·ªùi kh·ªèi trang?';
        }
    };
}

// Thay th·∫ø h√†m disableEditMode() ho√†n to√†n
function disableEditMode(table) {
    const displayDiv = document.getElementById('analysis-content-display');
    const editTextarea = document.getElementById('analysis-content-edit');
    if (displayDiv && editTextarea) {
        displayDiv.style.display = 'block';
        editTextarea.style.display = 'none';
    }
    if (!table) return;
    
    table.classList.remove('edit-mode-active');
    const tbody = table.querySelector('tbody');
    const rows = tbody.querySelectorAll('tr');
    
    rows.forEach(row => {
        // Remove drag handle
        const handle = row.querySelector('.drag-handle');
        if (handle) handle.remove();
        
        // Remove drag capabilities
        row.draggable = false;
        row.classList.remove('draggable', 'dragging', 'drag-over');
        
        // Remove event listeners
        row.removeEventListener('dragstart', handleDragStart);
        row.removeEventListener('dragend', handleDragEnd);
        row.removeEventListener('dragover', handleDragOver);
        row.removeEventListener('drop', handleDrop);
        row.removeEventListener('dragleave', handleDragLeave);
        
        // Restore cells
        const cells = row.querySelectorAll('td.editable');
        cells.forEach(cell => {
            const input = cell.querySelector('input, textarea');
            if (input && input.dataset.originalContent) {
                cell.innerHTML = input.dataset.originalContent;
            }
            cell.classList.remove('editable');
        });
    });
}
function showEditButtons() {
    const section = document.querySelector('.roadmap-section');
    if (!section) return;
    
    if (!document.querySelector('.edit-actions')) {
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'edit-actions';
        actionsDiv.style.textAlign = 'center';
        actionsDiv.style.marginTop = '20px';
        actionsDiv.innerHTML = `
            <div class="info-box" style="text-align: left; margin-bottom: 20px; background: #fee2e2; border-left: 4px solid #dc2626;">
                <strong>‚ö†Ô∏è L∆∞u √Ω khi ch·ªânh s·ª≠a:</strong>
                <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                    <li>ƒê·ªãnh d·∫°ng c·ªßa <code>Ng√†y h·ªçc</code> l√† d∆∞·ªõi d·∫°ng <strong>dd/mm/yyyy</strong>.</li>
                    <li><code>Th·ªùi l∆∞·ª£ng</code> ph·∫£i c√≥ ƒë∆°n v·ªã l√† <strong>m</strong> HO·∫∂C/V√Ä <strong>h</strong>.</li>
                    <li><code>T√†i li·ªáu</code> ph·∫£i l√† URL ƒë·∫ßy ƒë·ªß. N·∫øu c√≥ nhi·ªÅu URL t√†i li·ªáu, th√¨ m·ªói URL ph·∫£i ƒë·ªÉ tr√™n m·ªôt d√≤ng ri√™ng.</li>
                    <li>K√©o th·∫£ c√°c d√≤ng ƒë·ªÉ <strong>s·∫Øp x·∫øp l·∫°i th·ª© t·ª±</strong>.</li>
                    <li><strong>Ng√†y ƒë√°nh d·∫•u x√≥a</strong> s·∫Ω ch·ªâ b·ªã x√≥a khi b·∫°n nh·∫•n "L∆∞u thay ƒë·ªïi".</li>
                    <li>Nh·∫•n n√∫t <strong>"H·ªßy"</strong> b√™n c·∫°nh ng√†y ƒë·ªÉ kh√¥i ph·ª•c ng√†y ƒë√£ x√≥a.</li>
                </ul>
            </div>
            
            <!-- ‚úÖ HI·ªÇN TH·ªä S·ªê NG√ÄY ƒê√ÅNH D·∫§U X√ìA -->
            <div id="deleteWarning" style="display: none; background: #fef2f2; border: 2px solid #dc2626; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <strong style="color: #dc2626;">‚ö†Ô∏è C·∫£nh b√°o:</strong> 
                <span id="deleteCount">0</span> ng√†y s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn khi b·∫°n nh·∫•n "L∆∞u thay ƒë·ªïi"
            </div>
            
            <button class="add-day-btn" onclick="addNewDay()">
                <i class="fa-solid fa-plus"></i> Th√™m ng√†y
            </button>
            
            <button class="save-changes-btn" onclick="saveChanges()" style="margin-left: 10px;">
                <i class="fa-solid fa-save"></i> L∆∞u thay ƒë·ªïi
            </button>
            <button class="cancel-edit-btn" onclick="cancelEdit()">
                <i class="fa-solid fa-times"></i> H·ªßy
            </button>
        `;
        section.appendChild(actionsDiv);
    }
    
    // ‚úÖ THEO D√ïI S·ªê L∆Ø·ª¢NG NG√ÄY ƒê√ÅNH D·∫§U X√ìA
    updateDeleteWarning();
}
// ‚úÖ H√ÄM M·ªöI: C·∫≠p nh·∫≠t c·∫£nh b√°o x√≥a
function updateDeleteWarning() {
    const markedRows = document.querySelectorAll('tbody tr.marked-for-deletion');
    const warning = document.getElementById('deleteWarning');
    const countSpan = document.getElementById('deleteCount');
    
    if (!warning || !countSpan) return;
    
    if (markedRows.length > 0) {
        warning.style.display = 'block';
        countSpan.textContent = markedRows.length;
    } else {
        warning.style.display = 'none';
    }
}
function getVietnamDate() {
  const now = new Date();
  const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
  return new Date(utc + (7 * 60 * 60 * 1000));
}
// ‚úÖ H√ÄM TH√äM NG√ÄY M·ªöI
function addNewDay() {
    const vnToday = getVietnamDate();
    const defaultDate = vnToday.toLocaleDateString('vi-VN').split('/').reverse().join('-'); // YYYY-MM-DD
    const tbody = document.querySelector('.roadmap-section tbody');
    if (!tbody) return;
    
    // ‚úÖ T·∫†O ROW M·ªöI R·ªñNG
    const newRow = document.createElement('tr');
    newRow.draggable = true;
    newRow.classList.add('draggable');
    newRow.dataset.detailId = 'new_' + Date.now(); // Temporary ID
    
    newRow.innerHTML = `
        <td class="day-cell">
            <span class="drag-handle">‚ò∞</span><br> 1
        </td>
        <td class="date-cell editable">
        <input type="text" 
            placeholder="dd/mm/yyyy" 
            value="${defaultDate.split('-').reverse().join('/')}" 
            style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; font-family: inherit; font-size: 0.9rem; background: #f0fdf4; text-align: center; font-weight: 600; color: #059669;">
        </td>
        <td class="editable">
            <textarea placeholder="Nh·∫≠p m·ª•c ti√™u ng√†y..." required style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; font-family: inherit; font-size: 0.9rem; background: white; min-height: 80px; resize: vertical;"></textarea>
        </td>
        <td class="editable">
            <textarea placeholder="Nh·∫≠p n·ªôi dung h·ªçc..." required style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; font-family: inherit; font-size: 0.9rem; background: white; min-height: 80px; resize: vertical;"></textarea>
        </td>
        <td class="editable">
            <textarea placeholder="Nh·∫≠p b√†i t·∫≠p..." required style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; font-family: inherit; font-size: 0.9rem; background: white; min-height: 80px; resize: vertical;"></textarea>
        </td>
        <td class="editable">
            <textarea placeholder="Nh·∫≠p URL (m·ªói link m·ªôt d√≤ng)" required style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; font-family: inherit; font-size: 0.9rem; background: white; min-height: 80px; resize: vertical;"></textarea>
        </td>
        <td class="editable">
            <textarea placeholder="Nh·∫≠p h∆∞·ªõng d·∫´n..." required style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; font-family: inherit; font-size: 0.9rem; background: white; min-height: 80px; resize: vertical;"></textarea>
        </td>
        <td class="editable">
            <input type="text" placeholder="VD: 1.5h, 90m" required style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; font-family: inherit; font-size: 0.9rem; background: white;">
        </td>
    <td>
        <select style="padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.85rem; cursor: pointer; width: 100%; transition: all 0.3s ease;">
            <option value="NOT_STARTED" selected>Ch∆∞a h·ªçc</option>
            <option value="IN_PROGRESS">ƒêang h·ªçc</option>
            <option value="COMPLETED">Ho√†n th√†nh</option>
            <option value="SKIPPED">B·ªè qua</option>
        </select>
    </td>
    <td style="text-align: center;">
        <button class="delete-day-btn" onclick="deleteDay(this)">
            <i class="fa-solid fa-trash"></i> X√≥a
        </button>
    </td>
    `;
    // ‚úÖ TH√äM V√ÄO ƒê·∫¶U TBODY
    tbody.appendChild(newRow);
    
    // ‚úÖ TH√äM DRAG & DROP EVENT LISTENERS
    newRow.addEventListener('dragstart', handleDragStart);
    newRow.addEventListener('dragend', handleDragEnd);
    newRow.addEventListener('dragover', handleDragOver);
    newRow.addEventListener('drop', handleDrop);
    newRow.addEventListener('dragleave', handleDragLeave);
    
    // ‚úÖ UPDATE DAY NUMBERS
    updateDayNumbers();
    
    showNotification('‚úÖ ƒê√£ th√™m ng√†y m·ªõi! Vui l√≤ng ƒëi·ªÅn th√¥ng tin.', 'success');
}
// ‚úÖ H√ÄM X√ìA NG√ÄY
function deleteDay(button) {
    const row = button.closest('tr');
    const dayCell = row.querySelector('.day-cell');
    
    // ‚úÖ L·∫§Y S·ªê NG√ÄY HI·ªÜN T·∫†I (b·ªè ‚ò∞ v√† kho·∫£ng tr·∫Øng)
    const dayNumber = dayCell.textContent.trim().replace(/‚ò∞/g, '').replace(/\s+/g, ' ').split(' ').pop();
    
    if (row.classList.contains('marked-for-deletion')) {
        // H·ª¶Y X√ìA
        row.classList.remove('marked-for-deletion');
        button.innerHTML = '<i class="fa-solid fa-trash"></i> X√≥a';
        button.classList.remove('undo-delete-btn');
        button.classList.add('delete-day-btn');
        
        // ‚úÖ PH·ª§C H·ªíI HTML ƒê√öNG (CH·ªà 1 ‚ò∞)
        dayCell.innerHTML = `<span class="drag-handle">‚ò∞</span><br>${dayNumber}`;
        
        showNotification(`‚Ü©Ô∏è ƒê√£ h·ªßy x√≥a ng√†y ${dayNumber}`, 'success');
    } else {
        // ƒê√ÅNH D·∫§U X√ìA
        row.classList.add('marked-for-deletion');
        button.innerHTML = '<i class="fa-solid fa-undo"></i> H·ªßy';
        button.classList.remove('delete-day-btn');
        button.classList.add('undo-delete-btn');
        
        // ‚úÖ GI·ªÆ NGUY√äN HTML (CH·ªà 1 ‚ò∞, M·ªú ƒêI)
        dayCell.innerHTML = `<span class="drag-handle" style="opacity: 0.3;">‚ò∞</span><br>${dayNumber}`;
        
        showNotification(`üóëÔ∏è Ng√†y ${dayNumber} s·∫Ω b·ªã x√≥a khi l∆∞u`, 'info');
    }
    
    updateDayNumbers();
    updateDeleteWarning();
}
function hideEditButtons() {
    const actions = document.querySelector('.edit-actions');
    if (actions) actions.remove();
}

// Drag and drop handlers
let draggedElement = null;

function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    
    // Remove all drag-over classes
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(row => row.classList.remove('drag-over'));
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    
    e.dataTransfer.dropEffect = 'move';
    
    if (this !== draggedElement) {
        this.classList.add('drag-over');
    }
    
    return false;
}

function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    
    if (draggedElement !== this) {
        const tbody = this.parentNode;
        const allRows = Array.from(tbody.querySelectorAll('tr'));
        const draggedIndex = allRows.indexOf(draggedElement);
        const targetIndex = allRows.indexOf(this);
        
        if (draggedIndex < targetIndex) {
            this.parentNode.insertBefore(draggedElement, this.nextSibling);
        } else {
            this.parentNode.insertBefore(draggedElement, this);
        }
        
        // Update day numbers after reordering
        updateDayNumbers();
    }
    
    this.classList.remove('drag-over');
    return false;
}

function handleDragLeave(e) {
    this.classList.remove('drag-over');
}
// ‚úÖ THAY TH·∫æ H√ÄM updateDayNumbers() HO√ÄN TO√ÄN:
function updateDayNumbers() {
    const tbody = document.querySelector('.roadmap-section tbody');
    if (!tbody) return;
    
    const rows = tbody.querySelectorAll('tr');
    let validDayNumber = 1;
    
    rows.forEach((row) => {
        const dayCell = row.querySelector('td:first-child');
        if (!dayCell) return;
        
        // ‚úÖ L·∫§Y S·ªê NG√ÄY HI·ªÜN T·∫†I (lo·∫°i b·ªè T·∫§T C·∫¢ ‚ò∞ v√† kho·∫£ng tr·∫Øng)
        const currentText = dayCell.textContent || '';
        const currentNumber = currentText.replace(/‚ò∞/g, '').replace(/\s+/g, ' ').trim();
        
        if (row.classList.contains('marked-for-deletion')) {
            // NG√ÄY B·ªä X√ìA - Gi·ªØ s·ªë c≈©, m·ªù ƒëi
            dayCell.innerHTML = `<span class="drag-handle" style="opacity: 0.3;">‚ò∞</span><br>${currentNumber}`;
        } else {
            // NG√ÄY B√åNH TH∆Ø·ªúNG - ƒê√°nh s·ªë l·∫°i
            dayCell.innerHTML = `<span class="drag-handle">‚ò∞</span><br>${validDayNumber}`;
            validDayNumber++;
        }
    });
}
async function saveChanges() {
    const confirmSave = confirm('B·∫°n c√≥ ch·∫Øc mu·ªën l∆∞u c√°c thay ƒë·ªïi?');
    if (!confirmSave) return;
    
    const table = document.querySelector('.roadmap-section table');
    if (!table) return;
    
    const analysisTextarea = document.getElementById('analysis-content-edit');
    const updatedAnalysis = analysisTextarea ? analysisTextarea.value.trim() : null;
    
    const tbody = table.querySelector('tbody');
    const allRows = tbody.querySelectorAll('tr');
    
    // ‚úÖ PH√ÇN LO·∫†I: Existing IDs vs New IDs vs Deleted IDs
    const existingRows = [];
    const newRows = [];
    const deletedIds = [];
    
    // ‚úÖ B·ªò S∆ØU T·∫¨P T·∫§T C·∫¢ ROWS (bao g·ªìm c·∫£ marked-for-deletion)
    const allDataRows = [];
    
    allRows.forEach((row) => {
        const detailId = row.dataset.detailId;
        const isMarkedForDeletion = row.classList.contains('marked-for-deletion');
        const isNewRow = String(detailId).startsWith('new_');
        
        if (isMarkedForDeletion) {
            // Ch·ªâ DELETE nh·ªØng row C≈® (kh√¥ng ph·∫£i new_*)
            if (!isNewRow) {
                deletedIds.push(parseInt(detailId));
            }
            return; // Skip processing
        }
        
        const cells = row.querySelectorAll('td');
        
        // ‚úÖ X·ª≠ l√Ω STUDY DATE
        let studyDate = null;
        const dateInput = cells[1].querySelector('input');
        if (dateInput && dateInput.value.trim()) {
            const dateStr = dateInput.value.trim();
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]);
                const year = parseInt(parts[2]);
                
                if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                    studyDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                }
            }
        }
        
        // ‚úÖ X·ª≠ l√Ω MATERIALS
        let materials = '';
        const materialsTextarea = cells[5].querySelector('textarea');
        if (materialsTextarea) {
            materials = materialsTextarea.value
                .split('\n')
                .map(line => line.trim())
                .filter(line => line)
                .join('; ');
        }
        
        const detail = {
            detail_id: detailId,
            study_date: studyDate,
            daily_goal: cells[2].querySelector('textarea')?.value || cells[2].textContent.trim(),
            learning_content: cells[3].querySelector('textarea')?.value || cells[3].textContent.trim(),
            practice_exercises: cells[4].querySelector('textarea')?.value || cells[4].textContent.trim(),
            learning_materials: materials,
            usage_instructions: cells[6].querySelector('textarea')?.value || cells[6].textContent.trim(),
            study_duration: cells[7].querySelector('input')?.value || cells[7].textContent.trim(),
            completion_status: cells[8].querySelector('select')?.value || 'NOT_STARTED'
        };
        
        // ‚úÖ THU TH·∫¨P T·∫§T C·∫¢ (ƒë·ªÉ sort sau)
        allDataRows.push(detail);
        
        if (isNewRow) {
            newRows.push(detail);
        } else {
            existingRows.push(detail);
        }
    });
    
    // ‚úÖ ‚úÖ ‚úÖ SORT THEO STUDY_DATE (ng√†y h·ªçc)
    allDataRows.sort((a, b) => {
        // X·ª≠ l√Ω NULL/undefined dates (ƒë∆∞a xu·ªëng cu·ªëi)
        if (!a.study_date && !b.study_date) return 0;
        if (!a.study_date) return 1;
        if (!b.study_date) return -1;
        
        // So s√°nh dates
        const dateA = new Date(a.study_date);
        const dateB = new Date(b.study_date);
        
        return dateA - dateB; // TƒÉng d·∫ßn (ng√†y c≈© l√™n tr√™n)
    });
    
    console.log(`üìä Sorted by study_date:`, allDataRows.map(d => d.study_date));
    
    // ‚úÖ ƒê√ÅNH S·ªê L·∫†I day_number THEO TH·ª® T·ª∞ SAU KHI SORT
    let dayCounter = 1;
    
    allDataRows.forEach(detail => {
        detail.day_number = dayCounter++;
    });
    
    // ‚úÖ PH√ÇN LO·∫†I L·∫†I SAU KHI SORT
    const sortedExistingRows = allDataRows.filter(d => !String(d.detail_id).startsWith('new_'));
    const sortedNewRows = allDataRows.filter(d => String(d.detail_id).startsWith('new_'));
    
    console.log(`üìä Changes summary:`, {
        existing: sortedExistingRows.length,
        new: sortedNewRows.length,
        deleted: deletedIds.length,
        total_after: allDataRows.length
    });
    
    try {
        const response = await fetch(`/api/roadmaps/${currentEditingRoadmapId}/update-details`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({ 
                existingRows: sortedExistingRows,
                newRows: sortedNewRows,
                deletedIds: deletedIds,
                roadmap_analyst: updatedAnalysis
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to save changes');
        }
        
        const result = await response.json();
        
        // ‚úÖ HI·ªÇN TH·ªä TH·ªêNG K√ä
        let message = '‚úÖ ƒê√£ l∆∞u thay ƒë·ªïi th√†nh c√¥ng!';
        if (result.stats) {
            const parts = [];
            if (result.stats.updated > 0) parts.push(`${result.stats.updated} c·∫≠p nh·∫≠t`);
            if (result.stats.inserted > 0) parts.push(`${result.stats.inserted} th√™m m·ªõi`);
            if (result.stats.deleted > 0) parts.push(`${result.stats.deleted} x√≥a`);
            
            if (parts.length > 0) {
                message += ` (${parts.join(', ')})`;
            }
        }
        
        showNotification(message, 'success');
        
        // Exit edit mode and refresh
        isEditMode = false;
        setTimeout(() => {
            window.location.reload();
        }, 1000);
        
    } catch (error) {
        console.error('Error saving changes:', error);
        showNotification('‚ùå ' + error.message, 'error');
    }
}
function cancelEdit() {
    const confirmCancel = confirm('H·ªßy t·∫•t c·∫£ thay ƒë·ªïi?');
    if (!confirmCancel) return;
    
    // ‚úÖ RESET T·∫§T C·∫¢ "marked-for-deletion"
    const markedRows = document.querySelectorAll('tbody tr.marked-for-deletion');
    markedRows.forEach(row => {
        row.classList.remove('marked-for-deletion');
    });
    
    isEditMode = false;
    const btn = document.querySelector('.edit-mode-btn');
    btn.innerHTML = '<i class="fa-solid fa-pen"></i> Ch·ªânh s·ª≠a';
    btn.classList.remove('active');
    hideEditButtons();
    openDetails(currentEditingRoadmapId);
}

// S·ª≠a l·∫°i h√†m displayRoadmapDetails ƒë·ªÉ th√™m n√∫t Edit v√† l∆∞u detail_id
function displayRoadmapDetails(roadmap, details) {
    currentEditingRoadmapId = roadmap.roadmap_id;
    originalDetails = JSON.parse(JSON.stringify(details));
    
    const analysisHTML = `
        <div class="analysis-section">
            <h3>üìä Ph√¢n T√≠ch AI</h3>
            <div class="analysis-content" id="analysis-content-display" style="white-space: pre-wrap;">${roadmap.roadmap_analyst || 'Kh√¥ng c√≥ ph√¢n t√≠ch'}</div>
            <textarea id="analysis-content-edit" rows="4" style="display: none; width: 100%; padding: 15px; border: 2px solid #10b981; border-radius: 8px; font-family: inherit; font-size: 0.95rem; margin-top: 10px; resize: vertical; line-height: 1.6;">${roadmap.roadmap_analyst || ''}</textarea>
        </div>
    `;

    const tableHTML = `
        <div class="roadmap-section">
            <div class="roadmap-section-header">
                <h3>üìÖ L·ªô Tr√¨nh Chi Ti·∫øt</h3>
                <button class="edit-mode-btn" onclick="toggleEditMode()">
                    <i class="fa-solid fa-pen"></i> Ch·ªânh s·ª≠a
                </button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th style="width: 60px;">Ng√†y</th>
                        <th style="width: 130px;">Ng√†y h·ªçc</th>
                        <th style="min-width: 130px;">M·ª•c ti√™u</th>
                        <th style="min-width: 150px;">N·ªôi dung</th>
                        <th style="min-width: 120px;">B√†i t·∫≠p</th>
                        <th style="min-width: 100px;">T√†i li·ªáu</th>
                        <th style="min-width: 110px;">H∆∞·ªõng d·∫´n</th>
                        <th style="width: 80px;">Th·ªùi l∆∞·ª£ng</th>
                        <th style="min-width: 150px;">Tr·∫°ng th√°i</th>
                        <th style="width: 100px;">Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    ${details.map(d => {
                        let materialsHTML = 'N/A';
                        if (d.learning_materials) {
                            const links = d.learning_materials
                                .split(/[;\n]/)
                                .map(link => link.trim())
                                .filter(link => link && link.match(/^https?:\/\//i));
                            
                            if (links.length > 0) {
                                materialsHTML = links.map((link, idx) => {
                                    try {
                                        const domain = new URL(link).hostname.replace(/^www\./, '');
                                        return `<a href="${link}" target="_blank" style="color: #007bff; display: block; margin: 2px 0; font-size: 0.85rem;">${domain}</a>`;
                                    } catch (e) {
                                        return `<span style="color: #6b7280; font-size: 0.85rem;">Link ${idx + 1}</span>`;
                                    }
                                }).join('');
                            } else if (d.learning_materials.trim()) {
                                materialsHTML = `<span style="font-size: 0.85rem;">${d.learning_materials}</span>`;
                            }
                        }

                        return `
                        <tr data-detail-id="${d.detail_id}">
                            <td class="day-cell">${d.day_number}</td>
                            <td class="date-cell">${d.study_date ? new Date(d.study_date).toLocaleDateString('vi-VN') : 'N/A'}</td>
                            <td><strong>${d.daily_goal || 'N/A'}</strong></td>
                            <td>${d.learning_content || 'N/A'}</td>
                            <td>${d.practice_exercises || 'N/A'}</td>
                            <td>${materialsHTML}</td>
                            <td>${d.usage_instructions || 'N/A'}</td>
                            <td style="text-align: center;"><strong>${formatHours(d.study_duration)}</strong></td>
                            <td>
                                <select onchange="updateStatus(${roadmap.roadmap_id}, ${d.detail_id}, this.value)">
                                    <option value="NOT_STARTED" ${d.completion_status === 'NOT_STARTED' ? 'selected' : ''}>Ch∆∞a h·ªçc</option>
                                    <option value="IN_PROGRESS" ${d.completion_status === 'IN_PROGRESS' ? 'selected' : ''}>ƒêang h·ªçc</option>
                                    <option value="COMPLETED" ${d.completion_status === 'COMPLETED' ? 'selected' : ''}>Ho√†n th√†nh</option>
                                    <option value="SKIPPED" ${d.completion_status === 'SKIPPED' ? 'selected' : ''}>B·ªè qua</option>
                                </select>
                            </td>
                            <td style="text-align: center;">
                                <button class="delete-day-btn" onclick="deleteDay(this)">
                                    <i class="fa-solid fa-trash"></i> X√≥a
                                </button>
                            </td>
                        </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;

    const evaluationHTML = buildEvaluationForm(roadmap);

    document.getElementById('modal-body').innerHTML = analysisHTML + tableHTML + evaluationHTML;
    
    evaluationData = {
        overall_rating: roadmap.overall_rating || 0,
        learning_effectiveness: roadmap.learning_effectiveness || 0,
        difficulty_suitability: roadmap.difficulty_suitability || 0,
        content_relevance: roadmap.content_relevance || 0,
        engagement_level: roadmap.engagement_level || 0,
        detailed_feedback: roadmap.detailed_feedback || '',
        actual_learning_outcomes: roadmap.actual_learning_outcomes || '',
        improvement_suggestions: roadmap.improvement_suggestions || '',
        would_recommend: roadmap.would_recommend || false
    };
}
    // ‚úÖ H√ÄM FORMAT GI·ªú: Chuy·ªÉn s·ªë th·∫≠p ph√¢n th√†nh "X gi·ªù Y ph√∫t"
    function formatHours(hours) {
        if (!hours || isNaN(hours)) return '0m';
        
        const totalMinutes = Math.round(hours * 60);
        const h = Math.floor(totalMinutes / 60);
        const m = totalMinutes % 60;
        
        if (h === 0) return `${m}m`;
        if (m === 0) return `${h}h`;
        return `${h}h ${m}m`;
    }
    // Utility functions
    function getAuthHeaders() {
        const token = localStorage.getItem('token');
        return {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        };
    }

    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => notification.classList.add('show'), 100);
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // ====================================================
    // FETCH ALL ROADMAPS FROM API
    // ====================================================
    async function fetchRoadmaps() {
        try {
            const response = await fetch('/api/roadmap', {
                method: 'GET',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                 showNotification('‚ùå C√≥ l·ªói x·∫£y ra khi load page' || response.statuss, 'error');
                if (response.status === 401) {
                    window.location.href = 'login.html';
                    return;
                }
            }

            const contentType = response.headers.get('content-type') || '';
            const text = await response.text();

            if (!contentType.includes('application/json')) {
                console.error('API did not return JSON. body:', text);
                throw new Error('Server did not return JSON: ' + (text.slice(0,200) || ''));
            }

            let result;
            try {
                result = JSON.parse(text);
            } catch (e) {
                console.error('Failed to parse JSON from API. raw body:', text);
                throw new Error('Invalid JSON response from server');
            }

            allRoadmaps = result.data || [];
            renderRoadmaps(allRoadmaps);

        } catch (error) {
            console.error('Error fetching roadmaps:', error);
            showNotification('‚ùå C√≥ l·ªói x·∫£y ra khi load page', 'error');
        }
    }

// T√¨m h√†m n√†y (kho·∫£ng d√≤ng 370-385):
function getStatusBadge(roadmap) {
    const progress = parseFloat(roadmap.progress_percentage || 0);
    const status = roadmap.status; // ‚úÖ Nh·∫≠n status ƒë√£ ƒë∆∞·ª£c t√≠nh to√°n t·ª´ backend
    
    if (progress >= 100 || status === 'COMPLETED') {
        return `<span class="status-badge status-completed">Ho√†n th√†nh</span>`;
    }
    
    // ‚úÖ TH√äM CHECK CHO SKIPPED
    if (status === 'SKIPPED') {
        return `<span class="status-badge status-skipped">B·ªè qua</span>`;
    }
    
    if (progress > 0 || status === 'IN_PROGRESS') {
        return `<span class="status-badge status-active">ƒêang h·ªçc</span>`;
    }
    
    return `<span class="status-badge status-not-started">Ch∆∞a h·ªçc</span>`;
}
// ‚úÖ H√ÄM T√çNH TRUNG B√åNH ƒê√ÅNH GI√Å 5 TI√äU CH√ç
// ‚úÖ H√ÄM T√çNH TRUNG B√åNH ƒê√ÅNH GI√Å 5 TI√äU CH√ç
function calculateAverageRating(roadmap) {
    const ratings = [
        parseFloat(roadmap.overall_rating) || 0,
        parseFloat(roadmap.learning_effectiveness) || 0,
        parseFloat(roadmap.difficulty_suitability) || 0,
        parseFloat(roadmap.content_relevance) || 0,
        parseFloat(roadmap.engagement_level) || 0
    ];

    // ‚úÖ L·ªåC CH·ªà L·∫§Y C√ÅC GI√Å TR·ªä > 0
    const validRatings = ratings.filter(r => r > 0);
    
    // ‚úÖ N·∫æU KH√îNG C√ì ƒê√ÅNH GI√Å N√ÄO
    if (validRatings.length === 0) {
        return '-';
    }
    
    // ‚úÖ T√çNH TRUNG B√åNH CH·ªà V·ªöI C√ÅC GI√Å TR·ªä H·ª¢P L·ªÜ
    const sum = validRatings.reduce((a, b) => a + b, 0);
    const average = (sum / validRatings.length).toFixed(1);
    
    return `${average}‚≠ê`;
}
function renderRoadmaps(roadmaps) {
  const contentArea = document.getElementById('content-area');
  const headerSubtitle = document.getElementById('header-subtitle');
  
  if (!roadmaps || roadmaps.length === 0) {
    contentArea.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üìö</div>
        <div class="empty-title">Ch∆∞a c√≥ l·ªô tr√¨nh h·ªçc n√†o</div>
        <div class="empty-text">H√£y t·∫°o l·ªô tr√¨nh ƒë·∫ßu ti√™n c·ªßa b·∫°n!</div>
        <button class="empty-btn" onclick="goToCreateRoadmap()">
          ‚ûï T·∫°o L·ªô Tr√¨nh M·ªõi
        </button>
      </div>
    `;
    headerSubtitle.textContent = 'B·∫°n ch∆∞a c√≥ l·ªô tr√¨nh h·ªçc n√†o';
    return;
  }
  
  headerSubtitle.textContent = `B·∫°n c√≥ ${roadmaps.length} l·ªô tr√¨nh h·ªçc`;
  
  const cardsHTML = roadmaps.map(roadmap => {
    // ‚úÖ T√çNH TRUNG B√åNH 5 TI√äU CH√ç
    const avgRating = calculateAverageRating(roadmap);
    
    // ‚úÖ HTML CHO RATING
    const ratingHTML = avgRating !== '-' 
      ? `<div class="stat-item">
           <div class="stat-value">${avgRating}</div>
           <div class="stat-label">ƒê√°nh gi√°</div>
         </div>`
      : `<div class="stat-item">
           <div class="stat-value" style="color: #9ca3af;">-</div>
           <div class="stat-label">Ch∆∞a ƒë√°nh gi√°</div>
         </div>`;
    
    return `
      <div class="roadmap-card">
        <div class="roadmap-header">
          <div class="roadmap-title">${roadmap.roadmap_name}</div>
          ${getStatusBadge(roadmap)}
        </div>
        
        <div class="roadmap-meta">
          <div class="meta-item">üìÅ ${roadmap.category}</div>
          ${roadmap.sub_category ? `<div class="meta-item">üìÇ ${roadmap.sub_category}</div>` : ''}
        </div>
        
        <div class="progress-section">
          <div class="progress-label">
            <span>Ti·∫øn ƒë·ªô h·ªçc t·∫≠p</span>
            <span>${Math.round(roadmap.progress_percentage)}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${roadmap.progress_percentage}%"></div>
          </div>
        </div>
        
        <div class="roadmap-stats">
          <div class="stat-item">
            <div class="stat-value">${roadmap.duration_days}</div>
            <div class="stat-label">Ng√†y</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${formatHours(roadmap.duration_hours)}</div>
            <div class="stat-label">T·ªïng th·ªùi gian</div>
          </div>
          ${ratingHTML}
          <div class="stat-item">
            <div class="stat-value">${Math.round(roadmap.progress_percentage)}%</div>
            <div class="stat-label">Ti·∫øn ƒë·ªô</div>
          </div>
        </div>
        
        <button class="view-details-btn" onclick="openDetails(${roadmap.roadmap_id})">
          üëÅÔ∏è Xem Chi Ti·∫øt
        </button>
        
        <button class="delete-roadmap-btn" onclick="confirmDeleteRoadmap(${roadmap.roadmap_id}, '${roadmap.roadmap_name.replace(/'/g, "\\'")}')">
          üóëÔ∏è X√≥a
        </button>
      </div>
    `;
  }).join('');
  
  contentArea.innerHTML = `<div class="roadmaps-grid">${cardsHTML}</div>`;
}
async function openDetails(roadmapId) {
    currentRoadmapId = roadmapId;
    
    // ‚úÖ Th√™m roadmap_id v√†o URL
    const newUrl = `${window.location.pathname}?roadmap=${roadmapId}`;
    window.history.pushState({ roadmapId }, '', newUrl);
    
    document.getElementById('detailsModal').classList.add('active');
    const modalBody = document.getElementById('modal-body');
    modalBody.innerHTML = `
        <div class="loading">
        <div class="spinner"></div>
        <br><br>
        ƒêang t·∫£i chi ti·∫øt...
        </div>
    `;

    try {
        const response = await fetch(`/api/roadmaps/${roadmapId}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });

        // ‚úÖ X·ª¨ L√ù 403 FORBIDDEN
        if (response.status === 403) {
            console.error('‚ùå Access denied for roadmap:', roadmapId);
            modalBody.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üö´</div>
                    <div class="empty-title">Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p</div>
                    <div class="empty-text">B·∫°n kh√¥ng c√≥ quy·ªÅn xem l·ªô tr√¨nh n√†y</div>
                    <button class="empty-btn" onclick="closeModal()">ƒê√≥ng</button>
                </div>
            `;
            showNotification('‚ö†Ô∏è B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p l·ªô tr√¨nh n√†y', 'error');
            
            // ‚úÖ X√≥a roadmap_id kh·ªèi URL
            window.history.replaceState({}, '', window.location.pathname);
            return;
        }

        if (!response.ok) {
            throw new Error('Failed to fetch roadmap details');
        }

        const result = await response.json();
        const roadmap = result.data.roadmap;
        const details = result.data.details;

        document.getElementById('modal-title').textContent = roadmap.roadmap_name;

        displayRoadmapDetails(roadmap, details);

    } catch (error) {
        console.error('Error fetching details:', error);
        modalBody.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">‚ö†Ô∏è</div>
                <div class="empty-title">Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt</div>
                <div class="empty-text">${error.message || 'ƒê√£ x·∫£y ra l·ªói'}</div>
                <button class="empty-btn" onclick="closeModal()">ƒê√≥ng</button>
            </div>
        `;
    }
}

function buildEvaluationForm(roadmap) {
    // ‚úÖ H√†m helper ƒë·ªÉ render stars v·ªõi gi√° tr·ªã hi·ªán t·∫°i
    const renderRatingGroup = (fieldName, label, currentValue) => {
        const value = currentValue || 0;
        const starsHtml = [1,2,3,4,5].map(i => 
            `<span class="star ${value >= i ? 'active' : ''}" onclick="setRating('${fieldName}', ${i})">‚òÖ</span>`
        ).join('');
        
        return `
            <div class="rating-group">
                <label>${label} *</label>
                <div class="rating-stars" id="${fieldName}">
                    ${starsHtml}
                </div>
                <div class="rating-value">Ch·ªçn: <span id="${fieldName}-value">${value}</span>/5</div>
            </div>
        `;
    };

    return `
        <div class="evaluation-section">
            <h3>‚≠ê ƒê√°nh Gi√° L·ªô Tr√¨nh</h3>
            
            ${renderRatingGroup('overall_rating', 'ƒê√°nh gi√° t·ªïng th·ªÉ l·ªô tr√¨nh (1-5 sao)', roadmap.overall_rating)}
            ${renderRatingGroup('learning_effectiveness', 'Hi·ªáu qu·∫£ h·ªçc t·∫≠p (1-5 sao)', roadmap.learning_effectiveness)}
            ${renderRatingGroup('difficulty_suitability', 'ƒê·ªô kh√≥ ph√π h·ª£p (1-5 sao)', roadmap.difficulty_suitability)}
            ${renderRatingGroup('content_relevance', 'T√≠nh li√™n quan n·ªôi dung (1-5 sao)', roadmap.content_relevance)}
            ${renderRatingGroup('engagement_level', 'T√≠nh h·∫•p d·∫´n l·ªô tr√¨nh (1-5 sao)', roadmap.engagement_level)}

            <div class="textarea-group">
                <label>Nh·∫≠n x√©t chi ti·∫øt v·ªÅ l·ªô tr√¨nh</label>
                <textarea id="detailed_feedback" placeholder="Chia s·∫ª nh·∫≠n x√©t c·ªßa b·∫°n..." onchange="evaluationData['detailed_feedback'] = this.value">${roadmap.detailed_feedback || ''}</textarea>
            </div>

            <div class="textarea-group">
                <label>K·∫øt qu·∫£ h·ªçc ƒë∆∞·ª£c th·ª±c t·∫ø sau ho√†n th√†nh</label>
                <textarea id="actual_learning_outcomes" placeholder="M√¥ t·∫£ k·ªπ nƒÉng b·∫°n ƒë√£ h·ªçc ƒë∆∞·ª£c..." onchange="evaluationData['actual_learning_outcomes'] = this.value">${roadmap.actual_learning_outcomes || ''}</textarea>
            </div>

            <div class="textarea-group">
                <label>ƒê·ªÅ xu·∫•t c·∫£i thi·ªán l·ªô tr√¨nh</label>
                <textarea id="improvement_suggestions" placeholder="G·ª£i √Ω c·∫£i thi·ªán..." onchange="evaluationData['improvement_suggestions'] = this.value">${roadmap.improvement_suggestions || ''}</textarea>
            </div>

            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="would_recommend" ${roadmap.would_recommend ? 'checked' : ''} onchange="evaluationData['would_recommend'] = this.checked">
                    <span>T√¥i s·∫Ω gi·ªõi thi·ªáu l·ªô tr√¨nh n√†y cho ng∆∞·ªùi kh√°c</span>
                </label>
            </div>

            <button class="submit-evaluation-btn" onclick="submitEvaluation()">
                üíæ L∆∞u ƒê√°nh Gi√°
            </button>
        </div>
    `;
}
    // SET RATING
function setRating(fieldName, value) {
    evaluationData[fieldName] = value;
    
    const starContainer = document.getElementById(fieldName);
    if (starContainer) {
        const stars = starContainer.querySelectorAll('.star');
        stars.forEach((star, index) => {
            if (index < value) {
                star.classList.add('active');
            } else {
                star.classList.remove('active');
            }
        });
    }
    
    // ‚úÖ C·∫¨P NH·∫¨T TEXT HI·ªÇN TH·ªä
    const valueSpan = document.getElementById(`${fieldName}-value`);
    if (valueSpan) {
        valueSpan.textContent = value;
    }
}

async function updateStatus(roadmapId, detailId, status) {
    try {
        console.log(`üîÑ Updating status: roadmap=${roadmapId}, detail=${detailId}, status=${status}`);
        
        const response = await fetch(`/api/roadmap/${roadmapId}/update-status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({
                detailId: detailId,
                status: status,
                studyDate: status === 'COMPLETED' ? getVietnamDate().toISOString().split('T')[0] : null
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to update status');
        }

        const result = await response.json();
        
        console.log('‚úÖ Status updated:', result);
        
        // ‚úÖ HI·ªÇN TH·ªä TH√îNG B√ÅO
        showNotification('‚úÖ ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i!', 'success');
        
        // ‚úÖ C·∫¨P NH·∫¨T L·∫†I DANH S√ÅCH ROADMAPS
        await fetchRoadmaps();

    } catch (error) {
        console.error('‚ùå Error updating status:', error);
        showNotification('‚ùå Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i: ' + error.message, 'error');
    }
}
// SUBMIT EVALUATION
async function submitEvaluation() {
    // ‚úÖ CH·ªà KI·ªÇM TRA C√ÅC FIELD CH∆ØA C√ì GI√Å TR·ªä
    const requiredFields = ['overall_rating', 'learning_effectiveness', 'difficulty_suitability', 'content_relevance', 'engagement_level'];
    const missingFields = requiredFields.filter(field => !evaluationData[field]);
    
    if (missingFields.length > 0) {
        showNotification(`‚ö† Vui l√≤ng ƒë√°nh gi√° t·∫•t c·∫£ 5 ti√™u ch√≠!`, 'error');
        return;
    }

    const submitBtn = document.querySelector('.submit-evaluation-btn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<div class="loading"><div class="spinner"></div> ƒêang l∆∞u...</div>';

    try {
        const payload = {
            overall_rating: evaluationData.overall_rating,
            learning_effectiveness: evaluationData.learning_effectiveness,
            difficulty_suitability: evaluationData.difficulty_suitability,
            content_relevance: evaluationData.content_relevance,
            engagement_level: evaluationData.engagement_level,
            detailed_feedback: document.getElementById('detailed_feedback').value || '',
            actual_learning_outcomes: document.getElementById('actual_learning_outcomes').value || '',
            improvement_suggestions: document.getElementById('improvement_suggestions').value || '',
            would_recommend: document.getElementById('would_recommend').checked
        };

        const response = await fetch(`/api/roadmap/${currentRoadmapId}/submit-evaluation`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error('Failed to submit evaluation');
        }

        showNotification('‚úì ƒê√°nh gi√° ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!', 'success');
        
        setTimeout(() => {
            closeModal();
            fetchRoadmaps();
        }, 1500);

    } catch (error) {
        console.error('Error submitting evaluation:', error);
        showNotification('‚úó C√≥ l·ªói x·∫£y ra khi l∆∞u ƒë√°nh gi√°', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'üíæ L∆∞u ƒê√°nh Gi√°';
    }
}
    // T√¨m h√†m closeModal() v√† s·ª≠a l·∫°i:
function closeModal() {
    // ‚úÖ KI·ªÇM TRA N·∫æU ƒêANG EDIT MODE - CONFIRM TR∆Ø·ªöC KHI ƒê√ìNG
    if (isEditMode) {
        const confirmClose = confirm('B·∫°n ƒëang ch·ªânh s·ª≠a. H·ªßy t·∫•t c·∫£ thay ƒë·ªïi?');
        if (!confirmClose) {
            return; // Kh√¥ng ƒë√≥ng n·∫øu user kh√¥ng confirm
        }
        
        // Reset edit mode
        isEditMode = false;
        const btn = document.querySelector('.edit-mode-btn');
        if (btn) {
            btn.innerHTML = '<i class="fa-solid fa-pen"></i> Ch·ªânh s·ª≠a';
            btn.classList.remove('active');
        }
        hideEditButtons();
    }
    
    document.getElementById('detailsModal').classList.remove('active');
    
    // ‚úÖ X√≥a roadmap_id kh·ªèi URL khi ƒë√≥ng modal
    const newUrl = window.location.pathname;
    window.history.pushState({}, '', newUrl);
    
    // ‚úÖ X√ìA WARNING KHI ƒê√ìNG MODAL
    window.onbeforeunload = null;
}
    function goToCreateRoadmap() {
        window.location.href = 'create_roadmap_page.html';
    }

    // Close modal when clicking outside
    document.getElementById('detailsModal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });

    // Navigation setup (gi·ªØ nguy√™n behavior path.html)
    function setupNavigation() {
      const btnPath = document.getElementById('btnPath');
      const btnProgress = document.getElementById('btnProgress');
      const btnHome = document.getElementById('btnHome');

      if (btnPath) {
        btnPath.addEventListener('click', () => { 
          window.location.href = 'path.html';
        });
      }

      if (btnProgress) {
        btnProgress.addEventListener('click', () => { 
          window.location.href = 'progress.html';
        });
      }

      if (btnHome) {
        btnHome.addEventListener('click', () => { 
          window.location.href = 'main.html'; 
        });
      }

      // Check for admin role and add admin button
      const role = localStorage.getItem('role');
      if (role === 'admin') {
        const navButtons = document.getElementById('navButtons') || document.getElementById('mainNavButtons');
        if (navButtons) {
            const adminBtn = document.createElement('button');
            adminBtn.className = 'nav-btn';
            adminBtn.id = 'btnAdmin';
            adminBtn.innerHTML = '<i class="fa-solid fa-user-shield"></i> Qu·∫£n Tr·ªã';
            adminBtn.addEventListener('click', () => { 
              window.location.href = 'admin.html?page=admin'; 
            });
            navButtons.appendChild(adminBtn);
        }
      }

      // Set active state based on current page
      const params = new URLSearchParams(window.location.search);
      const page = params.get('page') || 'path';
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      const idMap = { path: 'btnPath', progress: 'btnProgress', admin: 'btnAdmin', home: 'btnHome' };
      const btnId = idMap[page];
      if (btnId) {
        const el = document.getElementById(btnId);
        if (el) el.classList.add('active');
      }
    }
let isClosingModal = false;

// ‚úÖ H√ÄM M·ªû MODAL
function openUploadModal() {
    console.log('üìÇ Opening upload modal...');
    const modal = document.getElementById('uploadModal');
    const form = document.getElementById('uploadForm');
    
    if (modal) {
        isClosingModal = false;
        if (form) form.reset();
        modal.classList.add('active');
        console.log('‚úÖ Modal opened');
    } else {
        console.error('‚ùå uploadModal element not found!');
    }
}

// ‚úÖ H√ÄM ƒê√ìNG MODAL
function closeUploadModal(force = false) {
    // ‚úÖ NGƒÇN G·ªåI 2 L·∫¶N
    if (isClosingModal && !force) {
        console.log('‚ö†Ô∏è Already closing, skip...');
        return;
    }
    
    const modal = document.getElementById('uploadModal');
    const form = document.getElementById('uploadForm');
    
    if (!modal || !form) {
        console.warn('‚ö†Ô∏è Modal or form not found');
        return;
    }
    
    // ‚úÖ N·∫æU FORCE (upload th√†nh c√¥ng), ƒê√ìNG NGAY
    if (force) {
        console.log('‚úÖ Force closing modal (upload success)');
        modal.classList.remove('active');
        form.reset();
        isClosingModal = false;
        return;
    }
    
    // ‚úÖ SET FLAG
    isClosingModal = true;
    
    // ‚úÖ KI·ªÇM TRA D·ªÆ LI·ªÜU
    const roadmapName = form.querySelector('input[name="roadmap_name"]')?.value.trim();
    const category = form.querySelector('input[name="category"]')?.value.trim();
    const subCategory = form.querySelector('input[name="sub_category"]')?.value.trim();
    const startLevel = form.querySelector('select[name="start_level"]')?.value;
    const expectedOutcome = form.querySelector('textarea[name="expected_outcome"]')?.value.trim();
    const file = form.querySelector('input[name="file"]')?.files.length;
    
    const hasData = !!(roadmapName || category || subCategory || startLevel || expectedOutcome || file > 0);
    
    console.log('üîç Form data check:', {
        roadmapName: roadmapName || '(empty)',
        category: category || '(empty)',
        file: file || 0,
        hasData
    });
    
    // ‚úÖ N·∫æU KH√îNG C√ì DATA, ƒê√ìNG LU√îN
    if (!hasData) {
        console.log('‚úÖ No data, closing without confirm');
        modal.classList.remove('active');
        form.reset();
        isClosingModal = false;
        return;
    }
    
    // ‚úÖ C√ì DATA, HI·ªÜN CONFIRM
    const confirmClose = confirm('H·ªßy upload Excel?\n\nD·ªØ li·ªáu b·∫°n ƒë√£ nh·∫≠p s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u.');
    
    if (confirmClose) {
        console.log('‚úÖ User confirmed, closing modal');
        modal.classList.remove('active');
        form.reset();
    } else {
        console.log('‚ùå User cancelled, keep modal open');
    }
    
    // ‚úÖ RESET FLAG
    isClosingModal = false;
}
async function openPromptModal() {
    const modal = document.getElementById('promptModal');
    const loading = document.getElementById('promptLoading');
    const content = document.getElementById('promptContent');
    const promptText = document.getElementById('promptText');
    
    modal.classList.add('active');
    loading.style.display = 'block';
    content.style.display = 'none';
    
    try {
        // ‚úÖ G·ªåI API L·∫§Y MANUAL PROMPT
        const response = await fetch('/api/admin/manual-prompt', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Kh√¥ng th·ªÉ t·∫£i prompt');
        }
        
        const result = await response.json();
        
        if (result.success && result.data.manual_prompt_template) {
            promptText.textContent = result.data.manual_prompt_template;
        } else {
            throw new Error('Kh√¥ng t√¨m th·∫•y prompt template');
        }
        
        loading.style.display = 'none';
        content.style.display = 'block';
        
    } catch (error) {
        console.error('Error loading prompt:', error);
        promptText.textContent = 'Kh√¥ng th·ªÉ t·∫£i prompt. Vui l√≤ng th·ª≠ l·∫°i sau.';
        loading.style.display = 'none';
        content.style.display = 'block';
        showNotification('‚ö†Ô∏è ' + error.message, 'error');
    }
}

function closePromptModal() {
    document.getElementById('promptModal').classList.remove('active');
}

function copyPromptToClipboard() {
    const promptText = document.getElementById('promptText').textContent;
    
    navigator.clipboard.writeText(promptText).then(() => {
        showNotification('‚úÖ ƒê√£ copy prompt v√†o clipboard!', 'success');
    }).catch(err => {
        console.error('Copy failed:', err);
        
        // ‚úÖ FALLBACK: D√πng textarea t·∫°m
        const textarea = document.createElement('textarea');
        textarea.value = promptText;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        
        try {
            document.execCommand('copy');
            showNotification('‚úÖ ƒê√£ copy prompt v√†o clipboard!', 'success');
        } catch (e) {
            showNotification('‚ùå Kh√¥ng th·ªÉ copy. Vui l√≤ng copy th·ªß c√¥ng.', 'error');
        }
        
        document.body.removeChild(textarea);
    });
}

// ‚úÖ ƒê√ìNG MODAL KHI CLICK B√äN NGO√ÄI
document.addEventListener('DOMContentLoaded', function() {
    const promptModal = document.getElementById('promptModal');
    if (promptModal) {
        promptModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closePromptModal();
            }
        });
    }
});

    async function confirmDeleteRoadmap(roadmapId, roadmapName) {
        if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·ªô tr√¨nh "${roadmapName}"?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/roadmaps/${roadmapId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });
            
            if (!response.ok) throw new Error('Delete failed');
            
            showNotification('‚úÖ ƒê√£ x√≥a l·ªô tr√¨nh th√†nh c√¥ng!', 'success');
            await fetchRoadmaps();
        } catch (error) {
            console.error('Error deleting roadmap:', error);
            showNotification('‚ùå Kh√¥ng th·ªÉ x√≥a l·ªô tr√¨nh', 'error');
        }
    }

    // Init
    function checkAuth() {
        const token = localStorage.getItem('token');
        if (!token) {
            // N·∫øu b·∫°n mu·ªën redirect non-auth users, gi·ªØ behavior g·ªëc path.html
            // window.location.href = 'login.html';
            return false;
        }
        return true;
    }
    // Th√™m v√†o cu·ªëi ph·∫ßn <script> trong path.html, tr∆∞·ªõc initApp()

    async function checkAndOpenRoadmapFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const roadmapId = urlParams.get('roadmap');
    
    if (roadmapId && !isNaN(roadmapId)) {
        console.log('üîó Opening roadmap from URL:', roadmapId);
        
        // ‚úÖ ƒê·ª£i fetchRoadmaps() load xong tr∆∞·ªõc
        await new Promise(resolve => {
        const interval = setInterval(() => {
            if (allRoadmaps.length > 0) {
            clearInterval(interval);
            resolve();
            }
        }, 100);
        
        // Timeout sau 5s
        setTimeout(() => {
            clearInterval(interval);
            resolve();
        }, 5000);
        });
        
        // ‚úÖ Ki·ªÉm tra roadmap c√≥ t·ªìn t·∫°i kh√¥ng
        const roadmapExists = allRoadmaps.some(r => r.roadmap_id === parseInt(roadmapId));
        
        if (roadmapExists) {
        openDetails(parseInt(roadmapId));
        } else {
        console.warn('‚ö†Ô∏è Roadmap not found:', roadmapId);
        showNotification('‚ö†Ô∏è L·ªô tr√¨nh kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã x√≥a', 'error');
        
        // X√≥a param kh·ªèi URL
        window.history.replaceState({}, '', window.location.pathname);
        }
    }
    }
    // S·ª≠a l·∫°i h√†m initApp() ƒë·ªÉ g·ªçi checkAndOpenRoadmapFromURL
    function initApp() {
        setupNavigation();
        fetchRoadmaps();
        
        // ‚úÖ Th√™m d√≤ng n√†y
        checkAndOpenRoadmapFromURL();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initApp);
    } else {
        initApp();
    }

    // Upload modal close on overlay click
document.addEventListener('DOMContentLoaded', function() {
    const uploadForm = document.getElementById('uploadForm');
    if (uploadForm) {
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner"></div> ƒêang upload...';
            
            const formData = new FormData(e.target);
            
            // ‚úÖ VALIDATE FORM TR∆Ø·ªöC KHI G·ª¨I
            const roadmap_name = formData.get('roadmap_name');
            const category = formData.get('category');
            const start_level = formData.get('start_level');
            const expected_outcome = formData.get('expected_outcome');
            const file = formData.get('file');
            
            console.log('üì§ Form validation:', {
                roadmap_name: roadmap_name ? `"${roadmap_name}"` : '‚ùå EMPTY',
                category: category ? `"${category}"` : '‚ùå EMPTY',
                start_level: start_level ? `"${start_level}"` : '‚ùå EMPTY',
                expected_outcome: expected_outcome ? `"${expected_outcome}"` : '‚ùå EMPTY',
                file: file ? `‚úÖ ${file.name}` : '‚ùå NO FILE'
            });
            
            // ‚úÖ CHECK VALIDATION
            if (!roadmap_name || !category || !start_level || !expected_outcome || !file) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                
                const missing = [];
                if (!roadmap_name) missing.push('T√™n l·ªô tr√¨nh');
                if (!category) missing.push('Danh m·ª•c');
                if (!start_level) missing.push('Tr√¨nh ƒë·ªô');
                if (!expected_outcome) missing.push('K·∫øt qu·∫£ mong ƒë·ª£i');
                if (!file) missing.push('File Excel');
                
                showNotification(`‚ùå Thi·∫øu th√¥ng tin: ${missing.join(', ')}`, 'error');
                return;
            }
            
            try {
                console.log('üöÄ Sending upload request...');
                
                const response = await fetch('/api/roadmaps/upload', {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: formData
                });
                
                console.log('üì• Response status:', response.status);
                
                const result = await response.json();
                console.log('üì• Response data:', result);
                
                if (result.success) {
                    showNotification('‚úÖ ' + result.message, 'success');
                    closeUploadModal(true);
                    setTimeout(() => fetchRoadmaps(), 500);
                } else {
                    console.error('‚ùå Upload failed:', result);
                    showNotification('‚ùå ' + (result.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'), 'error');
                }
            } catch (error) {
                console.error('‚ùå Upload error:', error);
                showNotification('‚ùå L·ªói khi upload file: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });
    }
    
    // ƒê√≥ng modal khi click b√™n ngo√†i
    const uploadModal = document.getElementById('uploadModal');
    if (uploadModal) {
        uploadModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeUploadModal();
            }
        });
    }
});
</script>

<!-- Modal Upload Excel -->
<div class="modal-overlay" id="uploadModal">
    <div class="modal-content">
        <div class="modal-header">
            <div>
                <h2>üì§ Upload L·ªô Tr√¨nh t·ª´ Excel</h2>
                <p>File Excel ph·∫£i c√≥ ƒë√∫ng 8 c·ªôt theo th·ª© t·ª±</p>
            </div>
            <button class="close-modal" onclick="closeUploadModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="info-box">
                B·∫°n c√≥ th·ªÉ t·∫£i file template Excel b√™n d∆∞·ªõi ƒë·ªÉ upload l·ªô tr√¨nh v√†o h·ªá th·ªëng. 
                <br>
                <a href="/Data/roadmap_template.xlsx" 
                download="roadmap_template.xlsx"
                style="color: #007bff; text-decoration: underline; font-weight: 600;">
                    <i class="fa-solid fa-download"></i> Nh·∫•n v√†o ƒë√¢y ƒë·ªÉ t·∫£i file Excel m·∫´u
                </a>

            </div>

            <form id="uploadForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label>T√™n l·ªô tr√¨nh *</label>
                    <input type="text" name="roadmap_name" required placeholder="V√≠ d·ª•: H·ªçc Python c∆° b·∫£n">
                </div>
                
                <div class="form-group">
                    <label>Danh m·ª•c *</label>
                    <input type="text" name="category" required placeholder="V√≠ d·ª•: L·∫≠p tr√¨nh">
                </div>
                
                <div class="form-group">
                    <label>Danh m·ª•c chi ti·∫øt</label>
                    <input type="text" name="sub_category" placeholder="V√≠ d·ª•: Python Programming">
                </div>
                
                <div class="form-group">
                    <label>Tr√¨nh ƒë·ªô *</label>
                    <select name="start_level" required>
                        <option value="">-- Ch·ªçn tr√¨nh ƒë·ªô --</option>
                        <option value="M·ªõi b·∫Øt ƒë·∫ßu">M·ªõi b·∫Øt ƒë·∫ßu</option>
                        <option value="C∆° b·∫£n">C∆° b·∫£n</option>
                        <option value="Trung b√¨nh">Trung b√¨nh</option>
                        <option value="Kh√° t·ªët">Kh√° t·ªët</option>
                        <option value="N√¢ng cao">N√¢ng cao</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>K·∫øt qu·∫£ mong ƒë·ª£i *</label>
                    <textarea name="expected_outcome" required placeholder="M√¥ t·∫£ nh·ªØng g√¨ b·∫°n mu·ªën ƒë·∫°t ƒë∆∞·ª£c sau khi ho√†n th√†nh l·ªô tr√¨nh n√†y..." rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label>File Excel * (.xlsx ho·∫∑c .xls)</label>
                    <input type="file" name="file" accept=".xlsx,.xls" required>
                </div>
                
                <button type="submit" class="submit-btn">
                    <i class="fa-solid fa-upload"></i> Upload L·ªô Tr√¨nh
                </button>
            </form>
            <br>
                <div class="info-box">
                File Excel c·∫ßn c√≥:
                <ol style="margin: 10px 0 0 20px; line-height: 1.8;">
                    <li>Ph√¢n t√≠ch hi·ªán tr·∫°ng (kh√¥ng b·∫Øt bu·ªôc)</li>
                    <li>B·∫£ng l·ªô tr√¨nh chi ti·∫øt theo ng√†y:</li>
                </ol>
                <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                    <li><code>day_number</code> - S·ªë th·ª© t·ª± ng√†y</li>
                    <li><code>day_study</code> - Ng√†y h·ªçc</li>
                    <li><code>daily_goal</code> - M·ª•c ti√™u ng√†y</li>
                    <li><code>learning_content</code> - N·ªôi dung h·ªçc</li>
                    <li><code>practice_exercises</code> - B√†i t·∫≠p</li>
                    <li><code>learning_materials</code> - T√†i li·ªáu</li>
                    <li><code>guide_learning</code> - H∆∞·ªõng d·∫´n h·ªçc t·∫≠p</li>
                    <li><code>study_duration</code> - Th·ªùi gian h·ªçc m·ªói ng√†y</li>
                </ul>
                <br>


                <p style="margin-top: 10px; color: #856404;">
                    <strong>L∆∞u √Ω th√™m:</strong>
                    <ul style="margin: 10px 0 0 20px; line-height: 1.8; ">
                        <li>Ti√™u ƒë·ªÅ c·ªßa 8 c·ªôt ph·∫£i theo th·ª© t·ª± v√† kh√¥ng ƒë∆∞·ª£c ƒë·ªïi t√™n</li>
                        <li><code>day_number</code> ph·∫£i c√≥ gi√° tr·ªã tƒÉng 1 ƒë∆°n v·ªã t·ª´ 1 tr·ªü ƒëi (v√≠ d·ª• 1, 2, 3...)</li>
                        <li>N·∫øu c√≥ nhi·ªÅu URL t√†i li·ªáu, th√¨ m·ªói URL ph·∫£i ƒë·ªÉ tr√™n <strong>m·ªôt d√≤ng ri√™ng</strong></li>
                        <li>ƒê·ªãnh d·∫°ng c·ªßa <code>day_study</code> l√† d∆∞·ªõi d·∫°ng dd/mm/yyyy</li>
                        <li><code>study_duration</code> ph·∫£i c√≥ ƒë∆°n v·ªã l√† m HO·∫∂C/V√Ä h</li>
                        <li>File ƒë·ªãnh d·∫°ng ph·∫£i l√† .xlsx ho·∫∑c .xls</li>
                    </ul>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- ========== END FOOTER ========== -->
<script>
/* ---------- b·∫Øt ch∆∞·ªõc behavior t·ª´ main.html (d√°n v√†o path.html) ---------- */
const ADMIN_TOKEN = 'admin-token';

function showAuthButtons(userArea, loginBtn, registerBtn) {
  if (loginBtn) loginBtn.style.display = "inline-flex";
  if (registerBtn) registerBtn.style.display = "inline-flex";

  if (userArea) {
    const children = Array.from(userArea.children);
    children.forEach(c => {
      if (!c.classList.contains('login-btn') && !c.classList.contains('register-btn')) {
        try { userArea.removeChild(c); } catch (e) {}
      }
    });
  }
}

function wireLogoutAndNav(logoutEl) {
  if (!logoutEl) return;
  logoutEl.addEventListener('click', () => {
    localStorage.removeItem('token');
    localStorage.removeItem('role');
    
    // ‚úÖ REDIRECT V·ªÄ MAIN.HTML NGAY L·∫¨P T·ª®C
    window.location.href = 'main.html';
  });
}

async function loadUser() {
  const token = localStorage.getItem('token');

  // h·ªó tr·ª£ c·∫£ 2 id navButtons (mainNavButtons trong main.html) v√† navButtons (trong path.html g·ªëc)
  const navButtons = document.getElementById('mainNavButtons') || document.getElementById('navButtons');
  const userArea = document.getElementById('userArea') || document.querySelector('.userInfo');

  // Ensure nav exists (so nav buttons visible)
  if (navButtons) {
    // n·∫øu b·∫°n mu·ªën gi·ªØ c·∫•u tr√∫c nav gi·ªëng main, uncomment/adjust theo needs:
    // navButtons.innerHTML = `...` (kh√¥ng b·∫Øt bu·ªôc)
  }

  const loginBtn = userArea ? userArea.querySelector('.login-btn') : document.querySelector('.login-btn');
  const registerBtn = userArea ? userArea.querySelector('.register-btn') : document.querySelector('.register-btn');

  // lu√¥n show 2 n√∫t tr∆∞·ªõc, n·∫øu login kh√¥ng t·ªìn t·∫°i s·∫Ω t·∫°o
  showAuthButtons(userArea, loginBtn, registerBtn);

  if (!token) return;

  let name = 'Ng∆∞·ªùi d√πng';
  let serverRole = 'user';

  if (token === ADMIN_TOKEN) {
    name = 'Admin';
    serverRole = 'admin';
    localStorage.setItem('role', 'admin');
  } else {
    try {
      const res = await fetch('/api/me', { headers: { 'Authorization': 'Bearer ' + token }});
      if (!res.ok) {
        // token h·ªèng => show n√∫t auth v√† exit
        showAuthButtons(userArea, loginBtn, registerBtn);
        return;
      }
      const data = await res.json();
      serverRole = (data && (data.role || (data.user && data.user.role))) ? (data.role || data.user.role) : 'user';
      name = (data && data.user && data.user.name) ? data.user.name : name;
      localStorage.setItem('role', serverRole);
    } catch (err) {
      console.error('loadUser error', err);
      showAuthButtons(userArea, loginBtn, registerBtn);
      return;
    }
  }

  // ·∫©n 2 n√∫t login/register n·∫øu c√≥
  if (loginBtn) loginBtn.style.display = 'none';
  if (registerBtn) registerBtn.style.display = 'none';

  if (userArea) {
    userArea.innerHTML = `
      <span>Xin ch√†o <strong style="color:white;">${name}</strong></span>
      <button id="logout" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i> ƒêƒÉng xu·∫•t</button>
    `;
    const logoutEl = document.getElementById('logout');
    wireLogoutAndNav(logoutEl);
  }

  // n·∫øu l√† admin th√¨ th√™m n√∫t admin v√†o nav
  if (serverRole === 'admin' && navButtons) {
    if (!document.getElementById('btnAdmin')) {
      const adminBtn = document.createElement('button');
      adminBtn.className = 'nav-btn';
      adminBtn.id = 'btnAdmin';
      adminBtn.innerHTML = '<i class="fa-solid fa-user-shield"></i> Qu·∫£n tr·ªã';
      adminBtn.addEventListener('click', () => { window.location.href = 'admin.html?page=admin'; });
      navButtons.appendChild(adminBtn);
    }
  }
}
// ‚úÖ H√ÄM LOAD FOOTER - G·ªåI T·ª™ B√äN NGO√ÄI
window.loadFooterContent = function() {
  const footerDiv = document.getElementById('footer');
  if (!footerDiv) return;
  
  fetch('footer.html')
    .then(response => response.text())
    .then(html => {
      footerDiv.innerHTML = html;
      footerDiv.style.display = 'block'; // ‚úÖ Hi·ªÉn th·ªã footer sau khi load xong

      // Attach form submit event
      const feedbackForm = document.getElementById('feedbackForm');
      if (feedbackForm) {
        feedbackForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          // Validate all 8 ratings are filled
          for (let i = 1; i <= 8; i++) {
              if (!feedbackRatings[`rating_${i}`]) {
                  showNotification(`‚ö†Ô∏è Vui l√≤ng ƒë√°nh gi√° t·∫•t c·∫£ 8 ti√™u ch√≠!`, 'error');
                  return;
              }
          }
          
          const submitBtn = this.querySelector('button[type="submit"]');
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<div class="spinner"></div> ƒêang g·ª≠i...';
          
          try {
              const payload = {
                  rating_1: feedbackRatings.rating_1,
                  rating_2: feedbackRatings.rating_2,
                  rating_3: feedbackRatings.rating_3,
                  rating_4: feedbackRatings.rating_4,
                  rating_5: feedbackRatings.rating_5,
                  rating_6: feedbackRatings.rating_6,
                  rating_7: feedbackRatings.rating_7,
                  rating_8: feedbackRatings.rating_8,
                  question_1: document.getElementById('question_1').value.trim(),
                  question_2: document.getElementById('question_2').value.trim(),
                  question_3: document.getElementById('question_3').value.trim()
              };
              
              const response = await fetch('/api/feedback/submit', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'Authorization': `Bearer ${localStorage.getItem('token')}`
                  },
                  body: JSON.stringify(payload)
              });
              
              const result = await response.json();
              
              if (result.success) {
                  showNotification('‚úÖ C·∫£m ∆°n b·∫°n ƒë√£ g·ª≠i ph·∫£n h·ªìi!', 'success');
                  setTimeout(() => {
                      closeFeedbackModal();
                  }, 1500);
              } else {
                  throw new Error(result.error || 'Kh√¥ng th·ªÉ g·ª≠i ph·∫£n h·ªìi');
              }
              
          } catch (error) {
              console.error('Error submitting feedback:', error);
              showNotification('‚úó ' + error.message, 'error');
          } finally {
              submitBtn.disabled = false;
              submitBtn.innerHTML = 'üíæ G·ª≠i Ph·∫£n H·ªìi';
          }
        });
      }

      // Close modal when clicking outside
      const feedbackModal = document.getElementById('feedbackModal');
      if (feedbackModal) {
        feedbackModal.addEventListener('click', function(e) {
            if (e.target === this) closeFeedbackModal();
        });
      }
    })
    .catch(error => console.error('Error loading footer:', error));
}

// ‚úÖ CH·ªà T·ª∞ ƒê·ªòNG LOAD CHO C√ÅC TRANG KH√ÅC (KH√îNG PH·∫¢I path.html)
document.addEventListener('DOMContentLoaded', () => {
  const currentPage = window.location.pathname.split('/').pop();
  if (currentPage !== 'path.html') {
    loadFooterContent();
  }
});
/* g·ªçi loadUser khi DOM s·∫µn s√†ng */
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', loadUser);
} else {
  loadUser();
}
</script>
<script src="footer.js"></script>
<script>
window.addEventListener('load', function() {
    // ƒê·ª£i 800ms ƒë·ªÉ ƒë·∫£m b·∫£o roadmaps ƒë√£ hi·ªÉn th·ªã
    setTimeout(() => {
        if (typeof window.loadFooterContent === 'function') {
            window.loadFooterContent();
        }
    }, 3500);
});
</script>
</body>
</html>

