<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Đăng nhập - Con đường theo đuổi đam mê</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <style>
    :root {
      --bg: #f7faff;
      --card: #ffffff;
      --primary: #007bff;
      --muted: #6c757d;
      --danger: #dc3545;
      --success: #28a745;
      --radius: 10px;
      --shadow: 0 6px 18px rgba(20,20,40,0.06);
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      background: linear-gradient(135deg, #ffffff);
      color: #111;
      -webkit-font-smoothing: antialiased;
    }

    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    main {
      flex: 1 0 auto;
      box-sizing: border-box;
      max-width: 1200px;
      width: 100%;
      margin-left: auto;
      margin-right: auto;
      padding-top: calc(var(--header-height) + 20px);
      padding-left: 20px;
      padding-right: 20px;
      padding-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card {
      width: 100%;
      max-width: 520px;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 22px;
      border: 1px solid rgba(10,20,40,0.03);
    }

    h1 {
      margin: 0 0 6px 0;
      font-size: 20px;
      font-weight: 600;
    }

    p.lead {
      margin: 0 0 18px 0;
      color: var(--muted);
      font-size: 13px;
    }

    form {
      display: grid;
      gap: 12px;
    }

    .form-row {
      display: grid;
      gap: 8px;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      color: #111;
    }

    input[type="text"],
    input[type="password"],
    input[type="email"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid rgba(10,20,40,0.08);
      font-size: 14px;
    }

    input:focus {
      outline: none;
      box-shadow: 0 6px 18px rgba(0,0,0,0.05);
      border-color: rgba(0,0,0,0.12);
    }

    .inline {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .password-toggle {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      font-weight: 600;
      color: var(--muted);
    }

    .actions {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 6px;
    }

    button[type="submit"],
    .btn-primary {
      flex: 1;
      background: var(--primary);
      color: white;
      border: none;
      padding: 11px 14px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      font-size: 14px;
    }

    button[type="submit"]:disabled,
    .btn-primary:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .secondary {
      background: transparent;
      border: 1px solid rgba(10,20,40,0.06);
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
    }

    .error-text {
      color: var(--danger);
      font-size: 13px;
      margin-top: 4px;
    }

    .success-text {
      color: var(--success);
      font-size: 13px;
      margin-top: 4px;
    }

    .info-text {
      color: var(--muted);
      font-size: 13px;
    }

    .footer {
      text-align: center;
      margin-top: 12px;
      font-size: 13px;
      color: var(--muted);
    }

    a.link {
      color: var(--primary);
      text-decoration: none;
      font-weight: 700;
      cursor: pointer;
    }

    .back-btn {
      background: transparent;
      border: 1px solid rgba(10,20,40,0.12);
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      color: var(--muted);
      font-weight: 600;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease;
    }

    .back-btn:hover {
      background: rgba(10,20,40,0.04);
      border-color: rgba(10,20,40,0.18);
    }
    /* FORGOT PASSWORD MODAL */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: var(--radius);
      padding: 24px;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }

    .close-modal {
      background: transparent;
      border: none;
      font-size: 24px;
      color: var(--muted);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .close-modal:hover {
      background: rgba(0,0,0,0.05);
    }

    .code-inputs {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      margin: 16px 0;
    }

    .code-input {
      width: 100%;
      height: 50px;
      text-align: center;
      font-size: 20px;
      font-weight: 700;
      border: 2px solid rgba(10,20,40,0.1);
      border-radius: 8px;
    }

    .code-input:focus {
      border-color: var(--primary);
      outline: none;
    }

    .timer {
      text-align: center;
      color: var(--danger);
      font-size: 14px;
      font-weight: 600;
      margin: 12px 0;
    }
/* ✅ THÊM STYLE MỚI cho password-toggle */
.password-toggle {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 8px 12px;
  border-radius: 8px;
  font-weight: 600;
  color: var(--muted);
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px; /* ✅ THÊM để icon có size đẹp */
}

.password-toggle:hover {
  background: rgba(10,20,40,0.05);
  color: var(--primary);
}
@media (max-width: 900px) {
  body {
    padding-top: 200px; /* ✅ Đẩy xuống 200px */
  }

  main {
    padding-top: 20px; /* ✅ Giảm padding vì body đã có */
    padding-left: 15px;
    padding-right: 15px;
  }

  .card {
    padding: 20px;
    border-radius: 12px;
  }

  h1 {
    font-size: 22px;
  }

  p.lead {
    font-size: 14px;
  }

  input[type="text"],
  input[type="password"],
  input[type="email"] {
    font-size: 16px; /* ✅ Prevent zoom on iOS */
    padding: 12px 14px;
  }

  .actions {
    flex-direction: column;
    gap: 10px;
  }

  .actions button {
    width: 100%;
  }

  button[type="submit"],
  .btn-primary {
    padding: 14px 18px;
    font-size: 15px;
  }

  .back-btn {
    width: 100%;
    justify-content: center;
    padding: 12px 16px;
  }

  .modal-content {
    width: 95%;
    padding: 20px;
  }

  .modal-title {
    font-size: 20px;
  }

  .code-inputs {
    gap: 6px;
  }

  .code-input {
    height: 48px;
    font-size: 18px;
  }

  .footer {
    font-size: 14px;
  }
}

@media (max-width: 480px) {
  body {
    padding-top: 180px;
  }

  .card {
    padding: 16px;
    border-radius: 10px;
  }

  h1 {
    font-size: 20px;
  }

  p.lead {
    font-size: 13px;
  }

  input[type="text"],
  input[type="password"],
  input[type="email"] {
    font-size: 16px;
    padding: 10px 12px;
  }

  button[type="submit"],
  .btn-primary {
    font-size: 14px;
    padding: 12px 16px;
  }

  .back-btn {
    padding: 10px 14px;
    font-size: 13px;
  }

  .modal-content {
    width: 98%;
    padding: 16px;
  }

  .modal-title {
    font-size: 18px;
  }

  .code-inputs {
    gap: 4px;
  }

  .code-input {
    height: 45px;
    font-size: 16px;
  }

  .footer {
    font-size: 13px;
  }

  .password-toggle {
    padding: 6px 10px;
    font-size: 14px;
  }
}
  </style>
    <!-- Preload Font Awesome CSS -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" as="style">
    
    <!-- Load Font Awesome async -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"></noscript>
    
    <!-- Load Google Fonts async with display swap -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;600;700;900&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;600;700;900&display=swap" rel="stylesheet"></noscript>
    
    <!-- Load footer.css async (non-critical) -->
    <link rel="preload" href="footer.css" as="style">
    <link rel="stylesheet" href="footer.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="footer.css"></noscript>
    <!-- Load header.css -->
    <link rel="preload" href="header.css" as="style">
    <link rel="stylesheet" href="header.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="header.css"></noscript>
</head>
<body>
<div id="header"></div>
<script>
  fetch('header.html')
    .then(res => res.text())
    .then(html => {
      document.getElementById('header').innerHTML = html;
      const script = document.createElement('script');
      script.src = 'header.js';
      document.body.appendChild(script);
    });
</script>

  <!-- Main Content -->
  <main class="page">
    <section class="card" aria-labelledby="login-heading">
      <header>
        <div style="margin-bottom: 16px;">
          <button type="button" id="backButton" class="back-btn">
            ← Quay lại
          </button>
        </div>
        <h1 id="login-heading">Đăng nhập</h1>
        <p class="lead">Đăng nhập bằng tên đăng nhập hoặc email và mật khẩu.</p>
      </header>

      <form id="loginForm" novalidate>
        <div class="form-row">
          <label for="loginIdentifierInput">Tên đăng nhập / Email</label>
          <input id="loginIdentifierInput" name="identifier" type="text" autocomplete="username" placeholder="Tên đăng nhập hoặc email">
          <div id="identifierError" class="error-text" role="alert" aria-live="polite" hidden></div>
        </div>

        <div class="form-row">
          <label for="loginPasswordInput">Mật khẩu</label>
          <div class="inline">
            <input id="loginPasswordInput" name="password" type="password" autocomplete="current-password" placeholder="Mật khẩu" style="flex:1;" required>
            <button type="button" id="toggleLoginPasswordButton" class="password-toggle" aria-pressed="false" aria-label="Hiện mật khẩu">
              <i class="fa-solid fa-eye"></i>
            </button>
          </div>
          <div id="passwordError" class="error-text" role="alert" aria-live="polite" hidden></div>
        </div>

        <div class="actions">
          <button id="loginSubmitButton" type="submit">Đăng nhập</button>
        </div>

        <div id="loginGeneralMessage" class="info-text" role="status" aria-live="polite" style="min-height:1.2em;"></div>

        <div class="footer">
          <div style="margin-bottom:8px;text-align:center;">
            <a id="forgotPasswordLink" class="link">Quên mật khẩu?</a>
          </div>
          <span>Bạn chưa có tài khoản? <a id="registerLink" class="link" href="/register.html">Đăng ký</a></span>
        </div>
      </form>
    </section>
  </main>

  <!-- Forgot Password Modal -->
  <div id="forgotPasswordModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Quên mật khẩu</h2>
        <button class="close-modal" id="closeModal">&times;</button>
      </div>

      <!-- Step 1: Email Input -->
      <div id="step1" style="display:block;">
        <p class="lead">Nhập email của bạn để nhận mã xác thực</p>
        <div class="form-row">
          <label for="resetEmail">Email</label>
          <input id="resetEmail" type="email" placeholder="email@example.com">
          <div id="resetEmailError" class="error-text" hidden></div>
        </div>
        <button id="sendCodeBtn" class="btn-primary" style="width:100%;margin-top:12px;">
          Gửi mã xác thực
        </button>
      </div>

      <!-- Step 2: Code Verification -->
      <div id="step2" style="display:none;">
        <p class="lead">Nhập mã 6 số đã được gửi đến email của bạn</p>
        <div class="code-inputs">
          <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
          <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
          <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
          <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
          <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
          <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
        </div>
        <div id="timer" class="timer"></div>
        <div id="codeError" class="error-text" hidden></div>
        <button id="verifyCodeBtn" class="btn-primary" style="width:100%;margin-top:12px;">
          Xác thực
        </button>
        <button id="resendCodeBtn" class="secondary" style="width:100%;margin-top:8px;">
          Gửi lại mã
        </button>
      </div>

      <!-- Step 3: New Password -->
      <div id="step3" style="display:none;">
        <p class="lead">Đặt mật khẩu mới</p>
        <div class="form-row">
          <label for="newPassword">Mật khẩu mới</label>
          <input id="newPassword" type="password" placeholder="Ít nhất 8 ký tự">
          <div id="newPasswordError" class="error-text" hidden></div>
        </div>
        <div class="form-row" style="margin-top:12px;">
          <label for="confirmPassword">Xác nhận mật khẩu</label>
          <input id="confirmPassword" type="password" placeholder="Nhập lại mật khẩu">
          <div id="confirmPasswordError" class="error-text" hidden></div>
        </div>
        <button id="resetPasswordBtn" class="btn-primary" style="width:100%;margin-top:12px;">
          Đặt lại mật khẩu
        </button>
      </div>

      <div id="modalMessage" class="info-text" style="margin-top:12px;text-align:center;"></div>
    </div>
  </div>

  <div id="footer"></div>

  <script>
    const API_BASE = (window.location.protocol === 'file:') ? 'http://localhost:5000' : window.location.origin;
    
    // Login Form Elements
    const loginForm = document.getElementById('loginForm');
    const inpIdentifier = document.getElementById('loginIdentifierInput');
    const inpPass = document.getElementById('loginPasswordInput');
    const errIdentifier = document.getElementById('identifierError');
    const errPass = document.getElementById('passwordError');
    const submitBtn = document.getElementById('loginSubmitButton');
    const toggleBtn = document.getElementById('toggleLoginPasswordButton');
    const genMsg = document.getElementById('loginGeneralMessage');
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    // Forgot Password Elements
    const modal = document.getElementById('forgotPasswordModal');
    const forgotLink = document.getElementById('forgotPasswordLink');
    const closeModalBtn = document.getElementById('closeModal');
    
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    
    const resetEmail = document.getElementById('resetEmail');
    const sendCodeBtn = document.getElementById('sendCodeBtn');
    const verifyCodeBtn = document.getElementById('verifyCodeBtn');
    const resendCodeBtn = document.getElementById('resendCodeBtn');
    const resetPasswordBtn = document.getElementById('resetPasswordBtn');
    
    const codeInputs = document.querySelectorAll('.code-input');
    const newPassword = document.getElementById('newPassword');
    const confirmPassword = document.getElementById('confirmPassword');
    
    const modalMessage = document.getElementById('modalMessage');
    const timerDiv = document.getElementById('timer');
    
    let timerInterval = null;
    let expiresAt = null;

    // ========== LOGIN FUNCTIONS ==========
    function clearErrors(){
      errIdentifier.hidden = true; errIdentifier.textContent = '';
      errPass.hidden = true; errPass.textContent = '';
      genMsg.textContent = ''; genMsg.className = 'info-text';
    }

    function setGeneralMessage(text, isError=false){
      genMsg.textContent = text || '';
      genMsg.className = isError ? 'error-text' : 'info-text';
    }
    function validateForm(){
      clearErrors();
      let ok = true;
      const identifier = (inpIdentifier.value||'').trim();
      const password = inpPass.value || '';

      if (!identifier){
        errIdentifier.textContent = 'Vui lòng nhập tên đăng nhập hoặc email.'; 
        errIdentifier.hidden = false;
        ok = false;
      }

      if (!password){
        errPass.textContent = 'Vui lòng nhập mật khẩu.'; 
        errPass.hidden = false;
        ok = false;
      }

      return ok;
    }
    function disableSubmit(){ submitBtn.disabled = true; submitBtn.textContent = 'Đang đăng nhập...'; }
    function enableSubmit(){ submitBtn.disabled = false; submitBtn.textContent = 'Đăng nhập'; }

    async function submitHandler(e){
      e.preventDefault();
      if (!validateForm()){
        setGeneralMessage('Vui lòng sửa các lỗi trước khi đăng nhập.', true);
        return;
      }
      disableSubmit();
      setGeneralMessage('', false);

      const identifier = (inpIdentifier.value||'').trim();
      const payload = {
        password: inpPass.value || ''
      };
      
      // Kiểm tra xem identifier có phải email không
      if (emailRegex.test(identifier)) {
        payload.email = identifier;
      } else {
        payload.username = identifier;
      }

      try {
        const res = await fetch(`${API_BASE}/api/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        // ... rest of code (giữ nguyên phần còn lại)

        const body = await res.json().catch(() => null);

        if (res.ok){
          if (body && body.token) localStorage.setItem('token', body.token);
          setGeneralMessage('Đăng nhập thành công. Đang chuyển...', false);

          try {
            const token = body && body.token ? body.token : localStorage.getItem('token');
            if (token){
              const me = await fetch(`${API_BASE}/api/me`, { 
                headers: { Authorization: 'Bearer ' + token }
              });
              if (me.ok){
                const meBody = await me.json().catch(()=>null);
                if (meBody && meBody.user && meBody.user.role) {
                  localStorage.setItem('role', meBody.user.role);
                } else {
                  localStorage.setItem('role','user');
                }
              }
            }
          } catch(e){ 
            localStorage.setItem('role','user');
          }

          window.location.href = '/path.html';
          return;
        } else {
          const serverMsg = (body && body.message) ? body.message : 'Đăng nhập thất bại.';
          setGeneralMessage(serverMsg, true);
        }
      } catch(err){
        console.error('Network error during login', err);
        setGeneralMessage('Không thể kết nối tới server.', true);
      } finally {
        enableSubmit();
      }
    }

    function togglePassword(e){
      e && e.preventDefault();
      const isPass = inpPass.type === 'password';
      if (isPass){
        inpPass.type = 'text';
        toggleBtn.innerHTML = '<i class="fa-solid fa-eye-slash"></i>';
        toggleBtn.setAttribute('aria-pressed', 'true');
        toggleBtn.setAttribute('aria-label', 'Ẩn mật khẩu');
      } else {
        inpPass.type = 'password';
        toggleBtn.innerHTML = '<i class="fa-solid fa-eye"></i>';
        toggleBtn.setAttribute('aria-pressed', 'false');
        toggleBtn.setAttribute('aria-label', 'Hiện mật khẩu');
      }
    }

    // ========== FORGOT PASSWORD FUNCTIONS ==========
    function openModal(){
      modal.classList.add('active');
      resetToStep1();
    }

    let isCompletingReset = false;

    // Sửa lại hàm closeModal()
    function closeModal(){
      // Chỉ hiện cảnh báo khi:
      // 1. Chưa hoàn thành reset password (isCompletingReset = false)
      // 2. Đang ở step 2 hoặc 3
      if (!isCompletingReset && (step2.style.display === 'block' || step3.style.display === 'block')) {
        const confirmClose = confirm('Bạn chưa hoàn tất đặt lại mật khẩu. Nếu đóng cửa sổ này, bạn sẽ phải bắt đầu lại từ đầu. Bạn có chắc muốn đóng?');
        
        if (!confirmClose) {
          return; // Không đóng modal nếu user chọn Cancel
        }
      }
      
      modal.classList.remove('active');
      resetToStep1();
      clearTimer();
      isCompletingReset = false; // Reset flag
    }

    function resetToStep1(){
      step1.style.display = 'block';
      step2.style.display = 'none';
      step3.style.display = 'none';
      document.getElementById('modalTitle').textContent = 'Quên mật khẩu';
      modalMessage.textContent = '';
      modalMessage.className = 'info-text';
      resetEmail.value = '';
      codeInputs.forEach(input => input.value = '');
      newPassword.value = '';
      confirmPassword.value = '';
      document.getElementById('resetEmailError').hidden = true;
      document.getElementById('codeError').hidden = true;
      document.getElementById('newPasswordError').hidden = true;
      document.getElementById('confirmPasswordError').hidden = true;
    }

    function goToStep2(){
      step1.style.display = 'none';
      step2.style.display = 'block';
      step3.style.display = 'none';
      document.getElementById('modalTitle').textContent = 'Xác thực mã';
      codeInputs[0].focus();
      startTimer();
    }

    function goToStep3(){
      step1.style.display = 'none';
      step2.style.display = 'none';
      step3.style.display = 'block';
      document.getElementById('modalTitle').textContent = 'Đặt lại mật khẩu';
      clearTimer();
      newPassword.focus();
    }

    function setModalMessage(text, isError = false){
      modalMessage.textContent = text;
      modalMessage.className = isError ? 'error-text' : 'success-text';
    }

    function startTimer(){
      if (!expiresAt) return;
      
      clearTimer();
      
      timerInterval = setInterval(() => {
        const now = Date.now();
        const remaining = Math.max(0, Math.floor((expiresAt - now) / 1000));
        
        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;
        
        timerDiv.textContent = `⏰ Mã hết hạn sau: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (remaining === 0) {
          clearTimer();
          timerDiv.textContent = '❌ Mã đã hết hạn';
          setModalMessage('Mã xác thực đã hết hạn. Vui lòng gửi lại.', true);
        }
      }, 1000);
    }

    function clearTimer(){
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      timerDiv.textContent = '';
    }

    // Code Input Auto-Focus + Paste Support
    codeInputs.forEach((input, index) => {
      // Handle paste event
      input.addEventListener('paste', (e) => {
        e.preventDefault();
        const pastedData = e.clipboardData.getData('text').trim();
        const digits = pastedData.replace(/\D/g, '').slice(0, 6);
        
        if (digits.length > 0) {
          digits.split('').forEach((digit, i) => {
            if (codeInputs[i]) {
              codeInputs[i].value = digit;
            }
          });
          
          const lastFilledIndex = Math.min(digits.length - 1, 5);
          codeInputs[lastFilledIndex].focus();
        }
      });

      input.addEventListener('input', (e) => {
        if (e.target.value.length === 1 && index < codeInputs.length - 1) {
          codeInputs[index + 1].focus();
        }
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
          codeInputs[index - 1].focus();
        }
      });

      // Only allow numbers
      input.addEventListener('beforeinput', (e) => {
        if (e.data && !/[0-9]/.test(e.data)) {
          e.preventDefault();
        }
      });
    });
    function getCodeFromInputs(){
      return Array.from(codeInputs).map(input => input.value).join('');
    }

    // ========== API CALLS ==========
    async function sendResetCode(){
      const email = resetEmail.value.trim();
      const errorDiv = document.getElementById('resetEmailError');
      
      if (!email || !emailRegex.test(email)) {
        errorDiv.textContent = 'Vui lòng nhập email hợp lệ';
        errorDiv.hidden = false;
        return;
      }
      
      errorDiv.hidden = true;
      sendCodeBtn.disabled = true;
      sendCodeBtn.textContent = 'Đang gửi...';
      setModalMessage('', false);
      
      try {
        const res = await fetch(`${API_BASE}/api/password-reset/request`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        
        const data = await res.json();
        
        if (res.ok) {
          expiresAt = Date.now() + (data.expiresIn * 1000);
          setModalMessage('Mã xác thực đã được gửi đến email của bạn', false);
          goToStep2();
        } else {
          errorDiv.textContent = data.error || 'Không thể gửi mã';
          errorDiv.hidden = false;
        }
      } catch (err) {
        console.error('Send code error:', err);
        errorDiv.textContent = 'Lỗi kết nối. Vui lòng thử lại.';
        errorDiv.hidden = false;
      } finally {
        sendCodeBtn.disabled = false;
        sendCodeBtn.textContent = 'Gửi mã xác thực';
      }
    }

    async function verifyCode(){
      const email = resetEmail.value.trim();
      const code = getCodeFromInputs();
      const errorDiv = document.getElementById('codeError');
      
      if (code.length !== 6) {
        errorDiv.textContent = 'Vui lòng nhập đủ 6 số';
        errorDiv.hidden = false;
        return;
      }
      
      errorDiv.hidden = true;
      verifyCodeBtn.disabled = true;
      verifyCodeBtn.textContent = 'Đang xác thực...';
      setModalMessage('', false);
      
      try {
        const res = await fetch(`${API_BASE}/api/password-reset/verify`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, code })
        });
        
        const data = await res.json();
        
        if (res.ok) {
          setModalMessage('Xác thực thành công!', false);
          setTimeout(() => goToStep3(), 500);
        } else {
          errorDiv.textContent = data.error || 'Mã xác thực không đúng';
          errorDiv.hidden = false;
        }
      } catch (err) {
        console.error('Verify code error:', err);
        errorDiv.textContent = 'Lỗi kết nối. Vui lòng thử lại.';
        errorDiv.hidden = false;
      } finally {
        verifyCodeBtn.disabled = false;
        verifyCodeBtn.textContent = 'Xác thực';
      }
    }

    async function resetPassword(){
      const email = resetEmail.value.trim();
      const code = getCodeFromInputs();
      const newPass = newPassword.value;
      const confirmPass = confirmPassword.value;
      
      const newPassError = document.getElementById('newPasswordError');
      const confirmPassError = document.getElementById('confirmPasswordError');
      
      newPassError.hidden = true;
      confirmPassError.hidden = true;
      setModalMessage('', false);
      
      let hasError = false;
      
      if (newPass.length < 8) {
        newPassError.textContent = 'Mật khẩu phải có ít nhất 8 ký tự';
        newPassError.hidden = false;
        hasError = true;
      }
      
      if (newPass !== confirmPass) {
        confirmPassError.textContent = 'Mật khẩu xác nhận không khớp';
        confirmPassError.hidden = false;
        hasError = true;
      }
      
      if (hasError) return;
      
      resetPasswordBtn.disabled = true;
      resetPasswordBtn.textContent = 'Đang xử lý...';
      
      try {
        const res = await fetch(`${API_BASE}/api/password-reset/reset`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            email, 
            code, 
            newPassword: newPass 
          })
        });
        
        const data = await res.json();
        
        if (res.ok) {
          isCompletingReset = true;
          setModalMessage('✅ Đặt lại mật khẩu thành công!', false);
          setTimeout(() => {
            closeModal();
            setGeneralMessage('Mật khẩu đã được đặt lại. Vui lòng đăng nhập.', false);
          }, 2000);
        } else {
          setModalMessage(data.error || 'Không thể đặt lại mật khẩu', true);
        }
      } catch (err) {
        console.error('Reset password error:', err);
        setModalMessage('Lỗi kết nối. Vui lòng thử lại.', true);
      } finally {
        resetPasswordBtn.disabled = false;
        resetPasswordBtn.textContent = 'Đặt lại mật khẩu';
      }
    }

    // ========== EVENT LISTENERS ==========
    loginForm.addEventListener('submit', submitHandler);
    toggleBtn.addEventListener('click', togglePassword);
    
    forgotLink.addEventListener('click', (e) => {
      e.preventDefault();
      openModal();
    });
    
    closeModalBtn.addEventListener('click', closeModal);
    
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });
    
    sendCodeBtn.addEventListener('click', sendResetCode);
    verifyCodeBtn.addEventListener('click', verifyCode);
    resendCodeBtn.addEventListener('click', sendResetCode);
    resetPasswordBtn.addEventListener('click', resetPassword);
    
    document.getElementById('registerLink').addEventListener('click', (e) => {
      e.preventDefault();
      window.location.href = '/register.html';
    });
    
    document.getElementById('backButton').addEventListener('click', () => {
      window.location.href = '/main.html';
    });
    // Xử lý khi reload page trong lúc forgot password
    window.addEventListener('beforeunload', (e) => {
      if (modal.classList.contains('active') && (step2.style.display === 'block' || step3.style.display === 'block')) {
        e.preventDefault();
        e.returnValue = 'Bạn chưa hoàn tất đặt lại mật khẩu. Nếu tải lại trang, bạn sẽ phải bắt đầu lại từ đầu.';
        return e.returnValue;
      }
    });
    inpIdentifier.focus();
  </script>
  <script src="footer.js"></script>
</body>
</html>
