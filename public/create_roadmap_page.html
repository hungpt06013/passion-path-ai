<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·∫°o L·ªô Tr√¨nh H·ªçc M·ªõi</title>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #85ccff);
        min-height: 100vh;
        padding: 20px;
    }

    .analysis-section {
            background: #f0fdf4;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 4px solid #10b981;
        }

        .analysis-section h3 {
            color: #065f46;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .analysis-content {
            color: #374151;
            line-height: 1.8;
            white-space: pre-wrap;
        }

    .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .header {
        background: linear-gradient(135deg,  #007bff 0%,  #007bff 100%);
        color: white;
        padding: 30px;
        text-align: center;
        position: relative;
    }

    .back-btn {
        position: absolute;
        left: 30px;
        top: 50%;
        transform: translateY(-50%);
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        backdrop-filter: blur(10px);
    }

    .back-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
    }

    .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: 700;
    }

    .header p {
        font-size: 1.1rem;
        opacity: 0.9;
    }

    .form-container {
        padding: 40px;
    }

    .form-section {
        margin-bottom: 30px;
        padding: 25px;
        background: #f9fafb;
        border-radius: 16px;
        border: 2px solid #e5e7eb;
        transition: all 0.3s ease;
    }

    .form-section:hover {
        border-color:  #007bff;
    }

    .section-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
        font-size: 0.95rem;
    }

    .form-input,
    .form-select,
    .form-textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #d1d5db;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
        outline: none;
        border-color:  #007bff;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .form-textarea {
        resize: vertical;
        min-height: 100px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }

    .checkbox-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 10px;
    }

    .checkbox-group label {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .checkbox-group label:hover {
        border-color: #4f46e5;
        background: #f0f9ff;
    }

    .checkbox-group input[type="checkbox"],
    .checkbox-group input[type="radio"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color:#007bff;
    }

    .checkbox-group input[type="checkbox"]:checked + span,
    .checkbox-group input[type="radio"]:checked + span {
        font-weight: 700;
        color:#007bff;
    }
    
    .ai-generate-section {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border: 2px solid #0ea5e9;
    }

    .ai-notice {
        background: #fff3cd;
        color: #856404;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 1px solid #ffeaa7;
        font-size: 0.9rem;
    }

    .ai-notice strong {
        font-weight: 700;
    }

    .ai-btn, .prompt-btn {
        padding: 15px 30px;
        background: linear-gradient(135deg,#007bff,#007bff);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 15px;
        width: 100%;
        box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
    }

    .ai-btn:hover, .prompt-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
        background: linear-gradient(135deg, #007bff, #007bff);
    }

    .ai-btn:disabled, .prompt-btn:disabled {
        background: linear-gradient(135deg, #9ca3af, #6b7280);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
        opacity: 0.6;
    }

    .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .prompt-btn {
        width: 50%;
    }

    .days-container {
        max-height: 400px;
        overflow-y: auto;
        padding: 10px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        background: white;
    }

    .day-item {
        background: #f9fafb;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        border: 2px solid #e5e7eb;
        transition: all 0.3s ease;
    }

    .day-item:hover {
        border-color: #007bff;
    }

    .day-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .day-number {
        background: #007bff;
        color: white;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
    }

    .remove-day-btn {
        background: #ef4444;
        color: white;
        border: none;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .remove-day-btn:hover {
        background: #dc2626;
        transform: scale(1.1);
    }

    .add-day-btn {
        width: 100%;
        padding: 15px;
        background: #10b981;
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 15px;
    }

    .add-day-btn:hover {
        background: #059669;
        transform: translateY(-1px);
    }

    .submit-section {
        text-align: center;
        padding: 30px;
        background: #f9fafb;
        border-radius: 16px;
        margin-top: 30px;
    }

    .submit-btn {
        padding: 18px 40px;
        background: linear-gradient(135deg, #007bff, #007bff);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1.2rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 200px;
    }

    .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(79, 70, 229, 0.4);
    }

    .submit-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
    }

    .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        color: #6b7280;
    }

    .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #e5e7eb;
        border-radius: 50%;
        border-top-color: #007bff;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .success-message {
        background: #dcfdf4;
        color: #065f46;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 2px solid #10b981;
    }

    .error-message {
        background: #fee2e2;
        color: #991b1b;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 2px solid #ef4444;
    }

    /* ======================== */
    /* Styles for "Kh√°c" box   */
    /* ======================== */
    .other-box {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 10px;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      min-width: 160px;
      box-sizing: border-box;
    }

    .other-box .other-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .other-box .other-input {
      display: none;
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      font-size: 0.95rem;
      box-sizing: border-box;
      background: white;
      transition: border-color 0.2s, box-shadow 0.15s;
    }

    .other-box .other-input:focus {
      outline: none;
      border-color:#007bff;
      box-shadow: 0 0 0 3px rgba(79,70,229,0.08);
    }

    .other-box:hover {
      border-color: #007bff;
      background: #f0f9ff;
    }
    /* Q4 - Main Purpose */
    #q4_other_text {
        margin-top: 10px;
    }

    /* Q12 - Learning Styles */
    #q12_other_text {
        margin-top: 10px;
    }

    /* Q13 - Learning Combinations */
    #q13_other_text {
        margin-top: 10px;
    }

    /* Q14 - Challenges */
    #q14_other_text {
        margin-top: 10px;
    }

    /* Q15 - Motivation */
    #q15_other_text {
        margin-top: 10px;
    }

    /* Q16 - Material Types */
    #q16_other_text {
        margin-top: 10px;
    }

    /* Q20 - Assessment Frequency */
    #q20_other_text {
        margin-top: 10px;
    }
    /* =============== MODAL STYLES =============== */
    .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 20px;
    }

    .modal.show {
    display: flex;
    }

    .modal-content {
    background: white;
    width: 90%;
    max-width: 900px;
    max-height: 90vh;
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
    background: linear-gradient(135deg,#007bff, #007bff);
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
    }

    .modal-header h2 {
    margin: 0;
    font-size: 1.3rem;
    font-weight: 700;
    }

    .modal-body {
    padding: 20px;
    overflow-y: auto;
    flex: 1;
    }

    .close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s;
    }

    .close-btn:hover {
    opacity: 0.8;
    }

    pre {
    background: #f3f4f6;
    padding: 15px;
    border-radius: 8px;
    overflow-x: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 13px;
    line-height: 1.4;
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #e5e7eb;
    }

    #customPromptContent {
    width: 100%;
    min-height: 400px;
    padding: 15px;
    border: 2px solid #d1d5db;
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    resize: vertical;
    box-sizing: border-box;
    }

    #customPromptContent:focus {
    outline: none;
    border-color:#007bff;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    @media (max-width: 768px) {
        body {
            padding: 10px;
        }

        .header {
            padding: 20px 15px;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-top: 50px;
        }

        .header p {
            font-size: 0.95rem;
        }

        .back-btn {
            position: static;
            margin-bottom: 15px;
            display: block;
            width: 100%;
            text-align: center;
            transform: none;
        }

        .form-container {
            padding: 20px;
        }

        .form-section {
            padding: 15px;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .checkbox-group {
            grid-template-columns: 1fr;
        }

        .section-title {
            font-size: 1.1rem;
        }

        .submit-btn {
            width: 100%;
            font-size: 1rem;
            padding: 15px 20px;
        }

        .ai-btn {
            font-size: 1rem;
        }
    }

    @media (max-width: 480px) {
        .header h1 {
            font-size: 1.5rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            font-size: 14px;
            padding: 10px 12px;
        }

        .day-item {
            padding: 15px;
        }

        .days-container {
            max-height: 300px;
        }
    }

    @media (max-width: 768px) {
        body {
            padding: 10px;
        }

        .header {
            padding: 20px 15px;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-top: 50px;
        }

        .header p {
            font-size: 0.95rem;
        }

        .back-btn {
            position: static;
            margin-bottom: 15px;
            display: block;
            width: 100%;
            text-align: center;
            transform: none;
        }

        .form-container {
            padding: 20px;
        }

        .form-section {
            padding: 15px;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .checkbox-group {
            grid-template-columns: 1fr;
        }

        .section-title {
            font-size: 1.1rem;
        }

        .submit-btn {
            width: 100%;
            font-size: 1rem;
            padding: 15px 20px;
        }

        .ai-btn {
            font-size: 1rem;
        }

        .modal-content {
            width: 95%;
            max-height: 95vh;
        }

        .modal-body {
            max-height: 70vh;
        }
    }

    @media (max-width: 480px) {
        .header h1 {
            font-size: 1.5rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            font-size: 14px;
            padding: 10px 12px;
        }

        .day-item {
            padding: 15px;
        }

        .days-container {
            max-height: 300px;
        }

        .modal-header h2 {
            font-size: 1.1rem;
        }

        .btn {
            font-size: 0.9rem;
            padding: 10px 15px;
        }
    }
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="path.html" class="back-btn">‚Üê Quay l·∫°i</a>
            <h1>T·∫°o L·ªô Tr√¨nh H·ªçc M·ªõi</h1>
            <p>S·ª≠ d·ª•ng AI ƒë·ªÉ t·∫°o l·ªô tr√¨nh h·ªçc c√° nh√¢n h√≥a cho b·∫°n</p>
        </div>

        <div class="form-container">
            <form id="roadmapForm">
                <!-- =============== PH·∫¶N H·ªéI 20 C√ÇU =============== -->

                <!-- PH·∫¶N 1: TH√îNG TIN C∆† B·∫¢N -->
                <div class="form-section">
                    <h3 class="section-title">üõ£Ô∏è Th√¥ng Tin C∆° B·∫£n</h3>
                    
                    <!-- Q1: T√™n l·ªô tr√¨nh -->
                    <div class="form-group">
                        <label class="form-label">T√™n l·ªô tr√¨nh *</label>
                        <input type="text" class="form-input" name="q1_roadmap_name" required 
                            placeholder="VD: H·ªçc Python t·ª´ c∆° b·∫£n ƒë·∫øn n√¢ng cao">
                    </div>

                    <!-- Q2: Danh m·ª•c (Radio, ch·ªâ 1 ch·ªçn) - L·∫§Y T·ª™ API -->
                    <div class="form-group">
                        <label class="form-label">Danh m·ª•c *</label>
                        <div class="checkbox-group" id="q2_categoryGroup">
                            <div class="loading">
                                <div class="spinner"></div>
                                <span>ƒêang t·∫£i danh m·ª•c...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Q3: Danh m·ª•c chi ti·∫øt (ghi r√µ) -->
                    <div class="form-group">
                        <label class="form-label">Danh m·ª•c chi ti·∫øt (ghi r√µ) *</label>
                        <input type="text" name="q3_category_detail" class="form-input" required
                            placeholder="M√¥ t·∫£ chi ti·∫øt danh m·ª•c...">
                    </div>
                </div>
                <div class="form-section">
                    <h3 class="section-title">üìã Ph·∫ßn 1: M·ª•c ti√™u h·ªçc t·∫≠p</h3>
                    <!-- Q1: M·ª•c ƒë√≠ch ch√≠nh -->
                    <div class="form-group">
                        <label class="form-label">1. M·ª•c ƒë√≠ch ch√≠nh c·ªßa b·∫°n l√† g√¨? *</label>
                        <div class="checkbox-group">
                            <label><input type="radio" name="q4_main_purpose" value="Giao ti·∫øp h√†ng ng√†y" required> Giao ti·∫øp h√†ng ng√†y</label>
                            <label><input type="radio" name="q4_main_purpose" value="C√¥ng vi·ªác"> C√¥ng vi·ªác</label>
                            <label><input type="radio" name="q4_main_purpose" value="H·ªçc t·∫≠p"> H·ªçc t·∫≠p</label>
                            <label><input type="radio" name="q4_main_purpose" value="Thi ch·ª©ng ch·ªâ"> Thi ch·ª©ng ch·ªâ</label>
                            <label><input type="radio" name="q4_main_purpose" value="Du l·ªãch-ƒë·ªãnh c∆∞"> Du l·ªãch-ƒë·ªãnh c∆∞</label>
                            <label><input type="radio" name="q4_main_purpose" value="Kh√°c" id="q4_other_radio"> Kh√°c</label>
                        </div>
                        <input type="text" id="q4_other_text" class="form-input other-input" name="q4_main_purpose_other"
                            placeholder="Ghi r√µ m·ª•c ƒë√≠ch...">
                    </div>

                    <!-- Q2: M·ª•c ti√™u c·ª• th·ªÉ -->
                    <div class="form-group">
                        <label class="form-label">2. M·ª•c ti√™u c·ª• th·ªÉ c·ªßa b·∫°n? *</label>
                        <textarea class="form-textarea" name="q5_specific_goal" required
                                placeholder="VD: IELTS 6.5 sau 1 nƒÉm, TOEIC 800 trong 6 th√°ng..."></textarea>
                    </div>
                </div>

                <!-- PH·∫¶N 2: TR√åNH ƒê·ªò HI·ªÜN T·∫†I -->
                <div class="form-section">
                    <h3 class="section-title">üìä Ph·∫ßn 2: Tr√¨nh ƒê·ªô Hi·ªán T·∫°i</h3>
                    <!-- Q3: C√¥ng vi·ªác hi·ªán t·∫°i -->
                    <div class="form-group">
                        <label class="form-label">3. C√¥ng vi·ªác hi·ªán t·∫°i c·ªßa b·∫°n? *</label>
                        <input type="text"  name="q5_current_job" class="form-input" required
                            placeholder="VD: Nh√¢n vi√™n vƒÉn ph√≤ng, Gi√°o vi√™n, K·ªπ s∆∞...">        
                    </div>
                    <!-- Q4: Th·ªùi gian ƒë√£ h·ªçc -->
                    <div class="form-group">
                        <label class="form-label">4. B·∫°n ƒë√£ h·ªçc lƒ©nh v·ª±c n√†y ƒë∆∞·ª£c bao l√¢u? *</label>
                        <select class="form-select" name="q6_learning_duration" required>
                            <option value="">---- Ch·ªçn --</option>
                            <option value="Ch∆∞a t·ª´ng">Ch∆∞a t·ª´ng</option>
                            <option value="<6 th√°ng">D∆∞·ªõi 6 th√°ng</option>
                            <option value="6 th√°ng-2 nƒÉm">6 th√°ng - 2 nƒÉm</option>
                            <option value=">2 nƒÉm">Tr√™n 2 nƒÉm</option>
                        </select>
                    </div>

                    <!-- Q5: Tr√¨nh ƒë·ªô hi·ªán t·∫°i -->
                    <div class="form-group">
                        <label class="form-label">5. Tr√¨nh ƒë·ªô hi·ªán t·∫°i c·ªßa b·∫°n? *</label>
                        <select class="form-select" name="q7_current_level" required>
                            <option value="">-- Ch·ªçn --</option>
                            <option value="M·ªõi b·∫Øt ƒë·∫ßu">M·ªõi b·∫Øt ƒë·∫ßu</option>
                            <option value="C∆° b·∫£n">C∆° b·∫£n</option>
                            <option value="Trung b√¨nh">Trung b√¨nh</option>
                            <option value="Kh√° t·ªët">Kh√° t·ªët</option>
                            <option value="N√¢ng cao">N√¢ng cao</option>
                        </select>
                    </div>

                    <!-- Q6: K·ªπ nƒÉng mu·ªën c·∫£i thi·ªán -->
                    <div class="form-group">
                        <label class="form-label">6. K·ªπ nƒÉng n√†o b·∫°n mu·ªën c·∫£i thi·ªán? (ghi r√µ) *</label>
                        <input type="text" name="q8_skills_text" class="form-input" required
                            placeholder="VD: Nghe, N√≥i, Vi·∫øt, L·∫≠p tr√¨nh Python...">
                    </div>
                </div>

                <!-- PH·∫¶N 3: CAM K·∫æT TH·ªúI GIAN -->
                <div class="form-section">
                    <h3 class="section-title">‚è∞ Ph·∫ßn 3: Cam K·∫øt Th·ªùi Gian</h3>

                    <!-- Q7: Th·ªùi gian h·ªçc m·ªói ng√†y -->
                    <div class="form-group">
                        <label class="form-label">7. B·∫°n c√≥ th·ªÉ d√†nh bao nhi√™u th·ªùi gian h·ªçc m·ªói ng√†y? *</label>
                        <select class="form-select" name="q9_daily_time" required>
                            <option value="">-- Ch·ªçn --</option>
                            <option value="30 ph√∫t">30 ph√∫t</option>
                            <option value="60 ph√∫t">60 ph√∫t</option>
                            <option value="2 gi·ªù">2 gi·ªù</option>
                            <option value=">2 gi·ªù">Tr√™n 2 gi·ªù</option>
                        </select>
                    </div>

                    <!-- Q8: S·ªë bu·ªïi m·ªói tu·∫ßn -->
                    <div class="form-group">
                        <label class="form-label">8. B·∫°n h·ªçc bao nhi√™u bu·ªïi m·ªói tu·∫ßn? *</label>
                        <select class="form-select" name="q10_weekly_sessions" required>
                            <option value="">-- Ch·ªçn --</option>
                            <option value="1 bu·ªïi">1 bu·ªïi</option>
                            <option value="2 bu·ªïi">2 bu·ªïi</option>
                            <option value="3 bu·ªïi">3 bu·ªïi</option>
                            <option value="4 bu·ªïi">4 bu·ªïi</option>
                            <option value="5 bu·ªïi">5 bu·ªïi</option>
                            <option value="6 bu·ªïi">6 bu·ªïi</option>
                            <option value="7 bu·ªïi">7 bu·ªïi</option>
                        </select>
                    </div>

                    <!-- Q9: Th·ªùi gian l·ªô tr√¨nh (ng√†y) -->
                    <div class="form-group">
                        <label class="form-label">9. Th·ªùi gian (ng√†y) c·ªßa l·ªô tr√¨nh (15 - 180 ng√†y) *</label>
                        <input type="number" id="q11_program_days" name="q11_program_days" class="form-input" min="15" max="180" required
                            placeholder="Nh·∫≠p s·ªë ng√†y (15 - 180)">
                        <small id="daysWarning" style="color: #ef4444; font-size: 0.8rem; margin-top: 5px; display: none;">
                            ‚ö†Ô∏è AI ch·ªâ h·ªó tr·ª£ t·ªëi ƒëa 180 ng√†y. N·∫øu b·∫°n mu·ªën h∆°n 180 ng√†y, vui l√≤ng t·∫°o th·ªß c√¥ng.
                        </small>
                    </div>
                </div>

                <!-- PH·∫¶N 4: PHONG C√ÅCH H·ªåC T·∫¨P -->
                <div class="form-section">
                    <h3 class="section-title">üé® Ph·∫ßn 4: Phong C√°ch H·ªçc T·∫≠p</h3>

                    <!-- Q10: Ph∆∞∆°ng ph√°p h·ªçc -->
                    <div class="form-group">
                        <label class="form-label">10. Ph∆∞∆°ng ph√°p h·ªçc b·∫°n th√≠ch (ch·ªçn n·∫øu ph√π h·ª£p) *</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="q12_learning_styles[]" value="Truy·ªÅn th·ªëng (ƒê·ªçc t√†i li·ªáu, b√†i ki·ªÉm tra ng·∫Øn)"> Truy·ªÅn th·ªëng (ƒê·ªçc t√†i li·ªáu, b√†i ki·ªÉm tra ng·∫Øn)</label>
                            <label><input type="checkbox" name="q12_learning_styles[]" value="H√¨nh ·∫£nh (S∆° ƒë·ªì, infographic, video tr·ª±c quan)"> H√¨nh ·∫£nh (S∆° ƒë·ªì, infographic, video tr·ª±c quan)</label>
                            <label><input type="checkbox" name="q12_learning_styles[]" value="√Çm thanh (Podcast, gi·∫£ng b√†i, th·∫£o lu·∫≠n)"> √Çm thanh (Podcast, gi·∫£ng b√†i, th·∫£o lu·∫≠n)</label>
                            <label><input type="checkbox" name="q12_learning_styles[]" value="Th·ª±c h√†nh (L√†m d·ª± √°n, th√≠ nghi·ªám, coding)"> Th·ª±c h√†nh (L√†m d·ª± √°n, th√≠ nghi·ªám, coding)</label>
                            <label><input type="checkbox" name="q12_learning_styles[]" value="Kh√°c" id="q12_other_checkbox"> Kh√°c</label>
                        </div>
                        <input type="text" id="q12_other_text" class="form-input other-input" name="q12_learning_styles_other"
                            placeholder="Ghi r√µ ph∆∞∆°ng ph√°p...">
                    </div>

                    <!-- Q11: K·∫øt h·ª£p h·ªçc -->
                    <div class="form-group">
                        <label class="form-label">11. B·∫°n th√≠ch k·∫øt h·ª£p h·ªçc nh∆∞ th·∫ø n√†o? *</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="q13_learning_combinations[]" value="Active Recall (Nh·ªõ l·∫°i ch·ªß ƒë·ªông)"> Active Recall (Nh·ªõ l·∫°i ch·ªß ƒë·ªông)</label>
                            <label><input type="checkbox" name="q13_learning_combinations[]" value="Spaced Repetition (L·∫∑p l·∫°i ng·∫Øt qu√£ng)"> Spaced Repetition (L·∫∑p l·∫°i ng·∫Øt qu√£ng)</label>
                            <label><input type="checkbox" name="q13_learning_combinations[]" value="Interleaving (Xen k·∫Ω ƒëa d·∫°ng ch·ªß ƒë·ªÅ)"> Interleaving (Xen k·∫Ω ƒëa d·∫°ng ch·ªß ƒë·ªÅ)</label>
                            <label><input type="checkbox" name="q13_learning_combinations[]" value="Dual Coding (M√£ h√≥a k√©p)"> Dual Coding (M√£ h√≥a k√©p)</label>
                            <label><input type="checkbox" name="q13_learning_combinations[]" value="Pomodoro Technique (K·ªπ thu·∫≠t Pomodoro)"> Pomodoro Technique (K·ªπ thu·∫≠t Pomodoro)</label>
                            <label><input type="checkbox" name="q13_learning_combinations[]" value="Metacognitive Reflection (T·ª± nh·∫≠n th·ª©c v·ªÅ h·ªçc t·∫≠p)"> Metacognitive Reflection (T·ª± nh·∫≠n th·ª©c v·ªÅ h·ªçc t·∫≠p)</label>
                            <label><input type="checkbox" name="q13_learning_combinations[]" value="Kh√°c" id="q13_other_checkbox"> Kh√°c</label>
                        </div>
                        <input type="text" id="q13_other_text" class="form-input other-input" name="q13_learning_combinations_other"
                            placeholder="Ghi r√µ...">
                    </div>
                </div>
                 <!-- PH·∫¶N 5: KH√ì KHƒÇN & ƒê·ªòNG L·ª∞C -->
                <div class="form-section">
                    <h3 class="section-title">üìÖ Ph·∫ßn 5: Kh√≥ KhƒÉn & ƒê·ªông L·ª±c</h3>
                    <!-- Q12: Th√°ch th·ª©c -->
                    <div class="form-group">
                        <label class="form-label">12. Th√°ch th·ª©c b·∫°n g·∫∑p ph·∫£i? *</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="q14_challenges[]" value="Thi·∫øu ƒë·ªông l·ª±c"> Thi·∫øu ƒë·ªông l·ª±c</label>
                            <label><input type="checkbox" name="q14_challenges[]" value="Thi·∫øu th·ªùi gian"> Thi·∫øu th·ªùi gian</label>
                            <label><input type="checkbox" name="q14_challenges[]" value="T√†i li·ªáu kh√≥"> T√†i li·ªáu kh√≥</label>
                            <label><input type="checkbox" name="q14_challenges[]" value="Kh√≥ t·∫≠p trung"> Kh√≥ t·∫≠p trung</label>
                            <label><input type="checkbox" name="q14_challenges[]" value="Kh√°c" id="q14_other_checkbox"> Kh√°c</label>
                        </div>
                        <input type="text" id="q14_other_text" class="form-input other-input" name="q14_challenges_other"
                            placeholder="Ghi r√µ...">
                    </div>

                    <!-- Q13: ƒê·ªông l·ª±c -->
                    <div class="form-group">
                        <label class="form-label">13. ƒêi·ªÅu g√¨ gi·ªØ ƒë·ªông l·ª±c cho b·∫°n? *</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="q15_motivation[]" value="Ph·∫ßn th∆∞·ªüng"> Ph·∫ßn th∆∞·ªüng</label>
                            <label><input type="checkbox" name="q15_motivation[]" value="Ti·∫øn b·ªô r√µ r√†ng"> Ti·∫øn b·ªô r√µ r√†ng</label>
                            <label><input type="checkbox" name="q15_motivation[]" value="M·ª•c ti√™u l·ªõn"> M·ª•c ti√™u l·ªõn</label>
                            <label><input type="checkbox" name="q15_motivation[]" value="C·ªông ƒë·ªìng h·ªçc t·∫≠p"> C·ªông ƒë·ªìng h·ªçc t·∫≠p</label>
                            <label><input type="checkbox" name="q15_motivation[]" value="Kh√°c" id="q15_other_checkbox"> Kh√°c</label>
                        </div>
                        <input type="text" id="q15_other_text" class="form-input other-input" name="q15_motivation_other"
                            placeholder="Ghi r√µ...">
                    </div>
                </div>     
                 <!-- PH·∫¶N 6: T√ÄI LI·ªÜU & ƒê√ÅNH GI√Å -->
                <div class="form-section">
                    <h3 class="section-title">üìä Ph·∫ßn 6: T√†i Li·ªáu & ƒê√°nh Gi√°</h3>   
                    <!-- Q14: Lo·∫°i t√†i li·ªáu -->
                    <div class="form-group">
                        <label class="form-label">14. Lo·∫°i t√†i li·ªáu b·∫°n th√≠ch? *</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="q16_material_types[]" value="S√°ch"> S√°ch</label>
                            <label><input type="checkbox" name="q16_material_types[]" value="Video h∆∞·ªõng d·∫´n"> Video h∆∞·ªõng d·∫´n</label>
                            <label><input type="checkbox" name="q16_material_types[]" value="B√†i t·∫≠p online"> B√†i t·∫≠p online</label>
                            <label><input type="checkbox" name="q16_material_types[]" value="Podcast"> Podcast</label>
                            <label><input type="checkbox" name="q16_material_types[]" value="App h·ªçc t·∫≠p"> App h·ªçc t·∫≠p</label>
                            <label><input type="checkbox" name="q16_material_types[]" value="T√†i li·ªáu theo ch·ªß ƒë·ªÅ"> T√†i li·ªáu theo ch·ªß ƒë·ªÅ</label>
                            <label><input type="checkbox" name="q16_material_types[]" value="Phim ·∫£nh"> Phim ·∫£nh</label>
                            <label><input type="checkbox" name="q16_material_types[]" value="Nh·∫°c"> Nh·∫°c</label>
                            <label><input type="checkbox" name="q16_material_types[]" value="Kh√≥a h·ªçc online"> Kh√≥a h·ªçc online</label>
                            <label><input type="checkbox" name="q16_material_types[]" value="Kh√°c" id="q16_other_checkbox"> Kh√°c</label>
                        </div>
                        <input type="text" id="q16_other_text" class="form-input other-input" name="q16_material_types_other"
                            placeholder="B·∫°n h√£y ghi r√µ t√™n s√°ch & t√°c gi·∫£/link d·∫´n ƒë·∫øn ngu·ªìn t√†i li·ªáu c·ª• th·ªÉ">
                    </div>

                    <!-- Q15: Ng√¥n ng·ªØ t√†i li·ªáu -->
                    <div class="form-group">
                        <label class="form-label">15. Ng√¥n ng·ªØ t√†i li·ªáu? *</label>
                        <select class="form-select" name="q17_material_language" required>
                            <option value="">-- Ch·ªçn --</option>
                            <option value="Vi·ªát Nam">Vi·ªát Nam</option>
                            <option value="English">English</option>
                            <option value="Vi·ªát Nam & English">Vi·ªát Nam & English</option>
                        </select>
                    </div>

                    <!-- Q16: Lo·∫°i ƒë√°nh gi√° -->
                    <div class="form-group">
                        <label class="form-label">16. Lo·∫°i ƒë√°nh gi√° b·∫°n th√≠ch? *</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="q18_assessment_types[]" value="Quiz ng·∫Øn"> Quiz ng·∫Øn</label>
                            <label><input type="checkbox" name="q18_assessment_types[]" value="D·ª± √°n nh·ªè"> D·ª± √°n nh·ªè</label>
                            <label><input type="checkbox" name="q18_assessment_types[]" value="B√†i ki·ªÉm tra"> B√†i ki·ªÉm tra</label>
                            <label><input type="checkbox" name="q18_assessment_types[]" value="ƒê·ªÅ thi chu·∫©n"> ƒê·ªÅ thi chu·∫©n</label>
                        </div>
                    </div>

                    <!-- Q17: Hi·ªÉn th·ªã k·∫øt qu·∫£ -->
                    <div class="form-group">
                        <label class="form-label">17. Hi·ªÉn th·ªã k·∫øt qu·∫£ nh∆∞ th·∫ø n√†o? *</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="q19_result_display[]" value="Bi·ªÉu ƒë·ªì"> Ti·∫øn ƒë·ªô</label>
                            <label><input type="checkbox" name="q19_result_display[]" value="Bi·ªÉu ƒë·ªì"> Bi·ªÉu ƒë·ªì</label>
                            <label><input type="checkbox" name="q19_result_display[]" value="S·ªë ƒëi·ªÉm"> S·ªë ƒëi·ªÉm</label>
                            <label><input type="checkbox" name="q19_result_display[]" value="Ph·∫£n h·ªìi chi ti·∫øt"> Ph·∫£n h·ªìi chi ti·∫øt</label>
                        </div>
                    </div>

                    <!-- Q18: T·∫ßn su·∫•t ƒë√°nh gi√° -->
                    <div class="form-group">
                        <label class="form-label">18. T·∫ßn su·∫•t ƒë√°nh gi√°? *</label>
                        <div class="checkbox-group">
                            <label><input type="radio" name="q20_assessment_frequency" value="H√†ng tu·∫ßn"> H√†ng tu·∫ßn</label>
                            <label><input type="radio" name="q20_assessment_frequency" value="H√†ng th√°ng"> H√†ng th√°ng</label>
                            <label><input type="radio" name="q20_assessment_frequency" value="2 tu·∫ßn/l·∫ßn"> 2 tu·∫ßn/l·∫ßn</label>
                            <label><input type="radio" name="q20_assessment_frequency" value="Kh√°c" id="q20_other_radio"> Kh√°c</label>
                        </div>
                        <input type="text" id="q20_other_text" class="form-input other-input" name="q20_assessment_frequency_other"
                            placeholder="Ghi r√µ...">
                    </div>
                </div>

                <!-- PH·∫¶N T·∫†O V·ªöI AI -->
                <div class="form-section ai-generate-section">
                    <h3 class="section-title">ü§ñ T·∫°o V·ªõi AI</h3>
                    <div class="ai-notice">
                        <strong>L∆∞u √Ω:</strong> AI s·∫Ω t·∫°o l·ªô tr√¨nh d·ª±a tr√™n c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n. B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a sau.
                    </div>
                    <button type="button" id="generateAI" class="ai-btn">ü§ñ T·∫°o l·ªô tr√¨nh v·ªõi AI</button>
                    <!--<div class="btn-group">
                        <button type="button" id="viewPromptBtn" class="prompt-btn">üëÅÔ∏è Xem Prompt</button>
                        <button type="button" id="customizePromptBtn" class="prompt-btn">‚úèÔ∏è S·ª≠a Prompt</button>
                    </div>-->
                </div>
                <div class="analysis-section">
                    <h3>üìä 1. PH√ÇN T√çCH HI·ªÜN TR·∫†NG</h3>
                    <div class="analysis-content" id="analysisContent">
                        <!-- AI generated analysis will be displayed here -->
                    </div>
                </div>
                <!-- PH·∫¶N CHI TI·∫æT NG√ÄY H·ªåC -->
                <div class="form-section">
                    <h3 class="section-title">üìÖ Chi Ti·∫øt L·ªô Tr√¨nh</h3>
                    <div id="daysContainer" class="days-container"></div>
                    <button type="button" id="addDayBtn" class="add-day-btn">‚ûï Th√™m Ng√†y H·ªçc</button>
                </div>

                <!-- N√öT SUBMIT -->
                <div class="submit-section">
                    <button type="submit" class="submit-btn" id="submitBtn">
                        <span id="submit-btn-text">&#127881; T·∫°o L·ªô Tr√¨nh</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL XEM PROMPT -->
    <div id="promptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Prompt AI</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <pre id="promptContent"></pre>
            </div>
            <div class="btn-group" style="padding: 20px; display: flex; gap: 10px;">
                <button onclick="copyPrompt()" class="prompt-btn">üìã Copy Prompt</button>
            </div>
        </div>
    </div>

    <!-- MODAL S·ª¨A PROMPT -->
    <div id="customizeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>S·ª≠a Prompt AI</h2>
                <button class="close-btn" onclick="closeCustomizeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <textarea id="customPromptContent"></textarea>
            </div>
            <div class="btn-group" style="padding: 20px; display: flex; gap: 10px;">
                <button onclick="resetPrompt()" class="prompt-btn">üîÑ Kh√¥i Ph·ª•c M·∫∑c ƒê·ªãnh</button>
                <button onclick="saveCustomPrompt()" class="prompt-btn">üíæ L∆∞u Prompt</button>
            </div>
        </div>
    </div>
    <script>
        //document.getElementById('viewPromptBtn').addEventListener('click', viewPrompt);
        //document.getElementById('customizePromptBtn').addEventListener('click', customizePrompt);
function attachOtherEventsForQ2() {
    const q2_other_radio = document.getElementById('q2_other_radio');
    const q2_other_text = document.getElementById('q2_other_text');
    
    if (!q2_other_radio || !q2_other_text) {
        console.warn('Q2 elements not found');
        return;
    }

    // Ban ƒë·∫ßu ·∫©n input
    q2_other_text.style.display = 'none';
    
    // Khi ch·ªçn "Kh√°c" - hi·ªÉn th·ªã input
    q2_other_radio.addEventListener('change', () => {
        if (q2_other_radio.checked) {
            q2_other_text.style.display = 'block';
            setTimeout(() => q2_other_text.focus(), 60);
        }
    });
    
    // Khi ch·ªçn radio kh√°c - ·∫©n input v√† clear
    document.querySelectorAll('input[name="q2_category"]').forEach(radio => {
        if (radio !== q2_other_radio) {
            radio.addEventListener('change', () => {
                q2_other_text.style.display = 'none';
                q2_other_text.value = '';
            });
        }
    });
}
        const MAX_AI_DAYS = 180;
        let dayCount = 0;
        let isGenerating = false;
        let categoriesData = [];

        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = `Bearer ${token}`;
            return headers;
        }
async function loadCategories() {
    const categoryGroup = document.getElementById('q2_categoryGroup');
    categoryGroup.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <span>ƒêang t·∫£i danh m·ª•c...</span>
        </div>
    `;

    try {
        const response = await fetch('/api/categories', getAuthHeaders());
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status} - ${response.statusText}`);
        }
        const data = await response.json();
        
        if (!data?.success || !Array.isArray(data.data)) {
            throw new Error('D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá t·ª´ server');
        }

        let html = '';
        if (data.data.length === 0) {
            html += '<div class="error-message">‚ö†Ô∏è Kh√¥ng c√≥ danh m·ª•c n√†o. Vui l√≤ng li√™n h·ªá admin.</div>';
        } else {
            data.data.forEach(cat => {
                html += `<label><input type="radio" name="q2_category" value="${escapeHtmlAttr(cat.name)}" required> ${escapeHtml(cat.name)}</label>`;
            });
        }

        // Th√™m "Kh√°c" v·ªõi format gi·ªëng Q4, Q12, etc.
        html += `
            <label><input type="radio" name="q2_category" value="Kh√°c" id="q2_other_radio" required> Kh√°c</label>
        `;
        
        categoryGroup.innerHTML = html;
        
        // Th√™m input "Kh√°c" b√™n ngo√†i checkbox-group (sau)
        const otherInput = document.createElement('input');
        otherInput.type = 'text';
        otherInput.id = 'q2_other_text';
        otherInput.className = 'form-input other-input';
        otherInput.name = 'q2_category_other';
        otherInput.placeholder = 'Ghi r√µ danh m·ª•c...';
        otherInput.style.display = 'none';
        
        categoryGroup.appendChild(otherInput);

        // Attach events cho "Kh√°c"
        attachOtherEventsForQ2();

    } catch (err) {
        console.error('L·ªói t·∫£i danh m·ª•c:', err.message || err);
        categoryGroup.innerHTML = `<div class="error-message">‚ùå Kh√¥ng th·ªÉ t·∫£i danh m·ª•c: ${err.message || 'Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng ho·∫∑c ƒëƒÉng nh·∫≠p l·∫°i.'}. Th·ª≠ l·∫°i sau.</div>`;
    }
}
function renderCategories(categories) {
    const container = document.getElementById('q2_categoryGroup'); // ‚úÖ FIXED: ƒê√∫ng ID
    
    if (!categories || categories.length === 0) {
        container.innerHTML = '<p style="color: #6b7280;">Ch∆∞a c√≥ danh m·ª•c n√†o</p>';
        container.insertAdjacentHTML('beforeend', `
          <label>
            <input type="radio" name="q2_category" value="Kh√°c" id="q2_other_radio">
            <span>Kh√°c</span>
          </label>
          <input type="text" id="q2_other_text" class="form-input other-input" 
                 placeholder="Ghi r√µ danh m·ª•c..." style="display:none; margin-top:10px;">
        `);
        setupCategoryOtherToggle(); // ‚úÖ FIXED: Setup ri√™ng cho Q2
        return;
    }
    
    // ‚úÖ FIXED: T·∫°o RADIO (kh√¥ng ph·∫£i checkbox)
    const html = categories.map(cat => `
        <label>
            <input type="radio" name="q2_category" value="${escapeHtml(cat.name)}" required>
            <span>${escapeHtml(cat.name)}</span>
        </label>
    `).join('');
    
    container.innerHTML = html;

    // ‚úÖ FIXED: Th√™m radio "Kh√°c" cho Q2
    container.insertAdjacentHTML('beforeend', `
      <label>
        <input type="radio" name="q2_category" value="Kh√°c" id="q2_other_radio">
        <span>Kh√°c</span>
      </label>
      <input type="text" id="q2_other_text" class="form-input other-input" 
             placeholder="Ghi r√µ danh m·ª•c..." style="display:none; margin-top:10px;">
    `);

    setupCategoryOtherToggle(); // ‚úÖ FIXED
}
function setupCategoryOtherToggle() {
    const otherRadio = document.getElementById('q2_other_radio');
    const otherInput = document.getElementById('q2_other_text');
    if (!otherRadio || !otherInput) return;
    
    // Khi ch·ªçn "Kh√°c" ‚Üí hi·ªán input
    otherRadio.addEventListener('change', () => {
        if (otherRadio.checked) {
            otherInput.style.display = 'block';
            setTimeout(() => otherInput.focus(), 60);
        }
    });
    
    // Khi ch·ªçn option kh√°c ‚Üí ·∫©n input
    document.querySelectorAll('input[name="q2_category"]').forEach(radio => {
        if (radio !== otherRadio) {
            radio.addEventListener('change', () => {
                otherInput.style.display = 'none';
                otherInput.value = '';
            });
        }
    });
}

// --- START replace validateDays function ---
function validateDays() {
    const daysInput = document.getElementById('q11_program_days');
    // robust fetch for the AI/generate button: th·ª≠ nhi·ªÅu id/class c√≥ th·ªÉ xu·∫•t hi·ªán
    const aiBtn = document.getElementById('aiGenerateBtn')
                || document.getElementById('generateAI')
                || document.getElementById('generateBtn')
                || document.querySelector('.ai-btn')
                || null;
    const warning = document.getElementById('daysWarning');

    // Check ri√™ng l·∫ª
    if (!daysInput) {
        console.warn('daysInput not found');
        return;
    }

    // N·∫øu kh√¥ng t√¨m th·∫•y n√∫t AI th√¨ ch·ªâ warn (KH√îNG return) ‚Äî ƒë·ªÉ c√°c validations kh√°c v·∫´n ch·∫°y
    if (!aiBtn) {
        console.warn('aiBtn not found (expected ids: aiGenerateBtn | generateAI | generateBtn | .ai-btn)');
        // don't return; allow other validations to continue
    }
    if (!warning) {
        console.warn('warning not found');
        // continue ‚Äî kh√¥ng c·∫ßn abort to√†n b·ªô
    }

    const days = parseInt(daysInput.value, 10);
    if (isNaN(days) || days < 15 || days > 180) {
        if (aiBtn) aiBtn.disabled = true;
        if (warning) {
            warning.style.display = 'block';
            if (days > 180) warning.textContent = '‚ö†Ô∏è AI ch·ªâ h·ªó tr·ª£ t·ªëi ƒëa 180 ng√†y. N·∫øu b·∫°n mu·ªën h∆°n 180 ng√†y, vui l√≤ng t·∫°o th·ªß c√¥ng.';
            else if (days < 15) warning.textContent = '‚ö†Ô∏è Vui l√≤ng nh·∫≠p s·ªë ng√†y t·ª´ 15 ƒë·∫øn 180.';
            else warning.textContent = '';
        }
    } else {
        if (aiBtn) aiBtn.disabled = false;
        if (warning) warning.style.display = 'none';
    }
}
// --- END replace validateDays function ---


function updateTotalHours() {
        const daysInput = document.getElementById('q11_program_days');
        const hoursInput = document.querySelector('select[name="q9_daily_time"]');

        if (daysInput && daysInput.value && hoursInput && hoursInput.value) {
            const hours = parseFloat(hoursInput.value.split('-')[0] || '2');
            const total = parseInt(daysInput.value) * hours;
            console.log(`Total hours: ${total}`);
        }
    }
async function generateRoadmapWithAI() {
    const generateBtn = document.getElementById('generateAI');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submit-btn-text');

    // Disable buttons
    generateBtn.disabled = true;
    submitBtn.disabled = true;  // Unclickable khi ƒëang generate
    generateBtn.innerHTML = '<div class="loading"><div class="spinner"></div> ƒêang t·∫°o...</div>';
    submitText.innerHTML = '<div class="loading"><div class="spinner"></div> ƒêang ch·ªù AI...</div>';
    
    if (typeof isGenerating !== 'undefined' && isGenerating) return;

    const form = document.getElementById('roadmapForm');
    if (!form) {
        showNotification('Kh√¥ng t√¨m th·∫•y form roadmap.', 'error');
        return;
    }

    const formData = new FormData(form);

    // helpers
    const getField = (fd, name, fallback = '') => {
        const v = fd.get(name);
        return v == null ? fallback : String(v).trim();
    };
    const extractFirstNumber = (str, fallback = 2) => {
        if (!str) return fallback;
        const s = String(str).trim();
        const m = s.match(/(\d+(?:\.\d+)?)/);
        if (m) {
            const num = parseFloat(m[1]);
            if (s.toLowerCase().includes('ph√∫t')) return num / 60;
            return num;
        }
        return fallback;
    };
    const collectChecked = (selectorNames) => {
        const values = [];
        selectorNames.forEach(sel => {
            document.querySelectorAll(sel).forEach(cb => {
                if (cb.checked) values.push(cb.value);
            });
        });
        return values;
    };
    const collectCheckedWithOther = (selectorNames, otherInputId) => {
        const values = [];
        let other = '';
        selectorNames.forEach(sel => {
            document.querySelectorAll(sel).forEach(cb => {
                if (!cb.checked) return;
                if (cb.value === 'Kh√°c' || cb.value === 'Khac' || cb.value === 'Other') {
                    const el = document.getElementById(otherInputId);
                    if (el) other = (el.value || '').trim();
                } else {
                    values.push(cb.value);
                }
            });
        });
        return { values, other };
    };

    // THU TH·∫¨P & X·ª¨ L√ù C√ÅC TR∆Ø·ªúNG (Q1..Q20)
    
    // Q1
    const q1_roadmap_name = getField(formData, 'q1_roadmap_name');

    // Q2 category (radio single) + other
    let q2_category = getField(formData, 'q2_category');
    let q2_category_other = '';
    if (q2_category === 'Kh√°c' || q2_category === 'Khac' || q2_category === 'Other') {
        const otherInput = document.getElementById('q2_other_text');
        q2_category_other = otherInput ? (otherInput.value || '').trim() : '';
        if (!q2_category_other) {
            showNotification('Vui l√≤ng nh·∫≠p danh m·ª•c khi ch·ªçn "Kh√°c"', 'error');
            generateBtn.disabled = false;
            submitBtn.disabled = false;
            generateBtn.innerHTML = 'ü§ñ T·∫°o l·ªô tr√¨nh v·ªõi AI';
            submitText.innerHTML = 'üéâ T·∫°o L·ªô Tr√¨nh';
            return;
        }
        q2_category = q2_category_other;
    }

    // Q3
    const q3_category_detail = getField(formData, 'q3_category_detail');

    // Q4 main purpose + other
    let q4_main_purpose = getField(formData, 'q4_main_purpose');
    let q4_main_purpose_other = '';
    if (q4_main_purpose === 'Kh√°c' || q4_main_purpose === 'Khac' || q4_main_purpose === 'Other') {
        q4_main_purpose_other = getField(formData, 'q4_main_purpose_other');
    }

    // Q5
    const q5_specific_goal = getField(formData, 'q5_specific_goal');
    const q5_current_job = getField(formData, 'q5_current_job');

    // Q6-Q8
    const q6_learning_duration = getField(formData, 'q6_learning_duration');
    const q7_current_level = getField(formData, 'q7_current_level');
    const q8_skills_text = getField(formData, 'q8_skills_text');

    // Q9-Q11
    const q9_daily_time = getField(formData, 'q9_daily_time');
    const q10_weekly_sessions = getField(formData, 'q10_weekly_sessions');
    const q11_program_days = parseInt(getField(formData, 'q11_program_days') || '0', 10) || 0;

    // Q12..Q16 (checkbox groups with possible "Kh√°c")
    const q12 = collectCheckedWithOther(['input[name="q12_learning_styles[]"]', 'input[name="q12_learning_styles"]'], 'q12_other_text');
    const q12_learning_styles = q12.values;
    const q12_learning_styles_other = q12.other;

    const q13 = collectCheckedWithOther(['input[name="q13_learning_combinations[]"]', 'input[name="q13_learning_combinations"]'], 'q13_other_text');
    const q13_learning_combinations = q13.values;
    const q13_learning_combinations_other = q13.other;

    const q14 = collectCheckedWithOther(['input[name="q14_challenges[]"]', 'input[name="q14_challenges"]'], 'q14_other_text');
    const q14_challenges = q14.values;
    const q14_challenges_other = q14.other;

    const q15 = collectCheckedWithOther(['input[name="q15_motivation[]"]', 'input[name="q15_motivation"]'], 'q15_other_text');
    const q15_motivation = q15.values;
    const q15_motivation_other = q15.other;

    const q16 = collectCheckedWithOther(['input[name="q16_material_types[]"]', 'input[name="q16_material_types"]'], 'q16_other_text');
    const q16_material_types = q16.values;
    const q16_material_types_other = q16.other;

    // Q17-Q19
    const q17_material_language = getField(formData, 'q17_material_language');
    const q18_assessment_types = collectChecked(['input[name="q18_assessment_types[]"]', 'input[name="q18_assessment_types"]']);
    const q19_result_display = collectChecked(['input[name="q19_result_display[]"]', 'input[name="q19_result_display"]']);

    // Q20
    let q20_assessment_frequency = getField(formData, 'q20_assessment_frequency');
    let q20_assessment_frequency_other = '';
    if (q20_assessment_frequency === 'Kh√°c' || q20_assessment_frequency === 'Khac' || q20_assessment_frequency === 'Other') {
        q20_assessment_frequency_other = getField(formData, 'q20_assessment_frequency_other');
    }

    // VALIDATION C∆† B·∫¢N TR∆Ø·ªöC KHI G·ªåI AI
    console.log('üîç Validation Check:', {
        q1_roadmap_name,
        q2_category,
        q5_specific_goal,
        q7_current_level,
        q9_daily_time,
        q11_program_days
    });

    if (!q1_roadmap_name) {
        alert('‚ùå Thi·∫øu: T√™n l·ªô tr√¨nh');
        generateBtn.disabled = false;
        submitBtn.disabled = false;
        generateBtn.innerHTML = 'ü§ñ T·∫°o l·ªô tr√¨nh v·ªõi AI';
        submitText.innerHTML = 'üéâ T·∫°o L·ªô Tr√¨nh';
        return;
    }
    if (!q2_category) {
        alert('‚ùå Thi·∫øu: Danh m·ª•c');
        generateBtn.disabled = false;
        submitBtn.disabled = false;
        generateBtn.innerHTML = 'ü§ñ T·∫°o l·ªô tr√¨nh v·ªõi AI';
        submitText.innerHTML = 'üéâ T·∫°o L·ªô Tr√¨nh';
        return;
    }
    if (!q5_specific_goal) {
        alert('‚ùå Thi·∫øu: M·ª•c ti√™u c·ª• th·ªÉ (Q2)');
        generateBtn.disabled = false;
        submitBtn.disabled = false;
        generateBtn.innerHTML = 'ü§ñ T·∫°o l·ªô tr√¨nh v·ªõi AI';
        submitText.innerHTML = 'üéâ T·∫°o L·ªô Tr√¨nh';
        return;
    }
    if (!q5_current_job) {
        alert('‚ùå Thi·∫øu: C√¥ng vi·ªác hi·ªán t·∫°i (Q3)');
        generateBtn.disabled = false;
        submitBtn.disabled = false;
        generateBtn.innerHTML = 'ü§ñ T·∫°o l·ªô tr√¨nh v·ªõi AI';
        submitText.innerHTML = 'üéâ T·∫°o L·ªô Tr√¨nh';
        return;
    }
    if (!q7_current_level) {
        alert('‚ùå Thi·∫øu: Tr√¨nh ƒë·ªô hi·ªán t·∫°i (Q5)');
        generateBtn.disabled = false;
        submitBtn.disabled = false;
        generateBtn.innerHTML = 'ü§ñ T·∫°o l·ªô tr√¨nh v·ªõi AI';
        submitText.innerHTML = 'üéâ T·∫°o L·ªô Tr√¨nh';
        return;
    }
    if (!q9_daily_time) {
        alert('‚ùå Thi·∫øu: Th·ªùi gian h·ªçc m·ªói ng√†y (Q7)');
        generateBtn.disabled = false;
        submitBtn.disabled = false;
        generateBtn.innerHTML = 'ü§ñ T·∫°o l·ªô tr√¨nh v·ªõi AI';
        submitText.innerHTML = 'üéâ T·∫°o L·ªô Tr√¨nh';
        return;
    }
    if (!q11_program_days || q11_program_days < 15 || q11_program_days > 180) {
        alert('‚ùå Thi·∫øu ho·∫∑c kh√¥ng h·ª£p l·ªá: S·ªë ng√†y (Q9) - ph·∫£i t·ª´ 15-180');
        generateBtn.disabled = false;
        submitBtn.disabled = false;
        generateBtn.innerHTML = 'ü§ñ T·∫°o l·ªô tr√¨nh v·ªõi AI';
        submitText.innerHTML = 'üéâ T·∫°o L·ªô Tr√¨nh';
        return;
    }

    console.log('‚úÖ Validation passed!');

    // days limit
    const MAX = (typeof MAX_AI_DAYS !== 'undefined') ? MAX_AI_DAYS : 60;
    if (q11_program_days > MAX) {
        showNotification(`AI ch·ªâ c√≥ th·ªÉ t·∫°o l·ªô tr√¨nh t·ªëi ƒëa ${MAX} ng√†y. Vui l√≤ng gi·∫£m s·ªë ng√†y ho·∫∑c t·∫°o th·ªß c√¥ng.`, 'error');
        generateBtn.disabled = false;
        submitBtn.disabled = false;
        generateBtn.innerHTML = 'ü§ñ T·∫°o l·ªô tr√¨nh v·ªõi AI';
        submitText.innerHTML = 'üéâ T·∫°o L·ªô Tr√¨nh';
        return;
    }

    // UI: b·∫≠t tr·∫°ng th√°i ƒëang t·∫°o
    isGenerating = true;

    try {
        // T·∫°o payload ƒë·∫ßy ƒë·ªß
        const roadmapData = {
            roadmap_name: q1_roadmap_name,
            category: q2_category,
            sub_category: q3_category_detail || null,
            start_level: q7_current_level,
            // √©p ki·ªÉu ngay khi build payload
            duration_days: parseInt(q11_program_days, 10) || 0,
            duration_hours: (function(){
                const perDay = Number(extractFirstNumber(q9_daily_time, 2)) || 0;
                const days = parseInt(q11_program_days, 10) || 0;
                return perDay * days;
            })(),
            expected_outcome: q5_specific_goal,

            // full Qs
            q1_roadmap_name,
            q2_category,
            q3_category_detail,
            q4_main_purpose,
            q4_main_purpose_other,
            q5_specific_goal,
            q5_current_job,
            q6_learning_duration,
            q7_current_level,
            q8_skills_text,
            q9_daily_time,
            q10_weekly_sessions,
            q11_program_days,
            q12_learning_styles,
            q12_learning_styles_other,
            q13_learning_combinations,
            q13_learning_combinations_other,
            q14_challenges,
            q14_challenges_other,
            q15_motivation,
            q15_motivation_other,
            q16_material_types,
            q16_material_types_other,
            q17_material_language,
            q18_assessment_types,
            q19_result_display,
            q20_assessment_frequency,
            q20_assessment_frequency_other
        };

        // prepare API URL
        const apiBase = (window.location.protocol === 'file:') ? 'http://localhost:5000' : window.location.origin;
        const apiUrl = apiBase.replace(/\/$/, '') + '/api/generate-roadmap-ai';

        // prepare headers
        let headers = {};
        try {
            const h = (typeof getAuthHeaders === 'function') ? getAuthHeaders() : {};
            if (h instanceof Headers) {
                h.set('Content-Type', 'application/json');
                headers = h;
            } else {
                headers = Object.assign({}, h || {}, { 'Content-Type': 'application/json' });
            }
        } catch (err) {
            headers = { 'Content-Type': 'application/json' };
        }

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers,
            body: JSON.stringify(roadmapData)
        });

        console.log('üì° API Response Status:', response.status);
        console.log('üì° API Response OK?:', response.ok);

        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå API Error Response:', errorText);
            alert('L·ªñI API: ' + errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const result = await response.json().catch(() => ({}));
        if (!result || !result.success || !result.data) {
            throw new Error('AI response kh√¥ng h·ª£p l·ªá');
        }

        // CLEAR EXISTING DAYS & RENDER AI DAYS
        if (typeof dayCount !== 'undefined') dayCount = 0;
        const daysContainer = document.getElementById('daysContainer');
        if (daysContainer) daysContainer.innerHTML = '';

        result.data.forEach((aiDay, index) => {
            const dayData = {
                day_number: aiDay.day_number || aiDay.day || (index + 1),
                study_date: aiDay.study_date || aiDay.study_date_iso || null,
                study_date_iso: aiDay.study_date || aiDay.study_date_iso || null,
                daily_goal: aiDay.daily_goal || aiDay.goal || '',
                learning_content: aiDay.learning_content || aiDay.content || '',
                practice_exercises: aiDay.practice_exercises || aiDay.exercises || '',
                learning_materials: aiDay.learning_materials || aiDay.materials || '',
                study_guide: aiDay.study_guide || '',
                study_duration_hours: (typeof aiDay.study_duration_hours !== 'undefined') ? aiDay.study_duration_hours : (aiDay.hours || 2),
                completion_status: aiDay.completion_status || 'NOT_STARTED'
            };
            
            if (typeof addDay === 'function') {
                addDay(dayData);
            } else {
                const container = document.getElementById('daysContainer');
                if (container) {
                    const row = document.createElement('div');
                    row.className = 'day-item';
                    row.textContent = `Ng√†y ${dayData.day_number}: ${dayData.daily_goal}`;
                    container.appendChild(row);
                }
            }
        });
        
         // Display analysis
        document.getElementById('analysisContent').textContent = result.analysis;
        submitBtn.disabled = false;
        submitText.innerHTML = 'üéâ T·∫°o L·ªô Tr√¨nh';
        showNotification('‚ú® AI ƒë√£ t·∫°o l·ªô tr√¨nh th√†nh c√¥ng! B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a n·∫øu c·∫ßn.', 'success');

    } catch (error) {
        console.error('‚ùå AI ERROR FULL:', error);
        console.error('‚ùå Error message:', error.message);
        console.error('‚ùå Error stack:', error.stack);
        alert('L·ªñI AI: ' + (error.message || 'Unknown error'));
        showNotification(`‚ö†Ô∏è ${error.message || 'C√≥ l·ªói x·∫£y ra khi g·ªçi AI. Vui l√≤ng th·ª≠ l·∫°i.'}`, 'error');
        submitBtn.disabled = false;
        submitText.innerHTML = 'üéâ T·∫°o L·ªô Tr√¨nh';
    } finally {
        isGenerating = false;
        generateBtn.disabled = false;
        generateBtn.innerHTML = 'ü§ñ T·∫°o l·ªô tr√¨nh v·ªõi AI';
        
        if (typeof validateDays === 'function') validateDays();
    }
}
document.getElementById('generateAI').addEventListener('click', generateRoadmapWithAI);
function addDay(dayData = null) {
    dayCount++;
    const container = document.getElementById('daysContainer');

    if (container.querySelector('p')) {
        container.innerHTML = '';
    }

    // ‚úÖ T√≠nh study_date (ng√†y th·ª±c t·∫ø)
    const today = new Date();
    const studyDate = new Date(today);
    studyDate.setDate(today.getDate() + (dayCount - 1));
    const formattedDate = studyDate.toLocaleDateString('vi-VN', { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric' 
    });

    const dayElement = document.createElement('div');
    dayElement.className = 'day-item';
    dayElement.innerHTML = `
        <div class="day-header">
            <div style="display: flex; gap: 15px; align-items: center;">
                <div class="day-number">${dayData?.day_number || dayCount}</div>
                <div style="color: #6b7280; font-size: 0.9rem;">
                    üìÖ ${dayData?.study_date || formattedDate}
                </div>
            </div>
            <button type="button" class="remove-day-btn" onclick="removeDay(this)">‚úï</button>
        </div>
        
        <!-- Hidden field: study_date ISO -->
        <input type="hidden" name="days[${dayCount-1}][study_date]" 
               value="${dayData?.study_date_iso || studyDate.toISOString().split('T')[0]}">
        
        <!-- Hidden field: completion_status -->
        <input type="hidden" name="days[${dayCount-1}][completion_status]" 
               value="${dayData?.completion_status || 'NOT_STARTED'}">
        
        <div class="form-group">
            <label class="form-label">M·ª•c ti√™u ng√†y ${dayData?.day_number || dayCount}</label>
            <input type="text" class="form-input" name="days[${dayCount-1}][goal]" required
                   placeholder="M·ª•c ti√™u c·∫ßn ƒë·∫°t ƒë∆∞·ª£c trong ng√†y n√†y"
                   value="${escapeHtmlAttr(dayData?.daily_goal || '')}">
        </div>
        
        <div class="form-group">
            <label class="form-label">N·ªôi dung h·ªçc t·∫≠p</label>
            <textarea class="form-textarea" name="days[${dayCount-1}][content]" required
                      placeholder="Chi ti·∫øt n·ªôi dung ki·∫øn th·ª©c s·∫Ω h·ªçc">${escapeHtmlAttr(dayData?.learning_content || '')}</textarea>
        </div>
        
        <div class="form-group">
            <label class="form-label">B√†i t·∫≠p th·ª±c h√†nh</label>
            <textarea class="form-textarea" name="days[${dayCount-1}][exercises]"
                      placeholder="B√†i t·∫≠p ƒë·ªÉ r√®n luy·ªán k·ªπ nƒÉng">${escapeHtmlAttr(dayData?.practice_exercises || '')}</textarea>
        </div>
        
        <div class="form-group">
            <label class="form-label">C√¥ng c·ª•/T√†i li·ªáu h·ªçc t·∫≠p</label>
            <input type="text" class="form-input" name="days[${dayCount-1}][materials]"
                   placeholder="C√¥ng c·ª•, t√†i li·ªáu c·∫ßn thi·∫øt"
                   value="${escapeHtmlAttr(dayData?.learning_materials || '')}">
        </div>
        
        <div class="form-group">
            <label class="form-label">H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</label>
            <textarea class="form-textarea" name="days[${dayCount-1}][study_guide]"
                      placeholder="H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng t√†i li·ªáu v√† c√°ch h·ªçc">${escapeHtmlAttr(dayData?.study_guide || '')}</textarea>
        </div>
        
        <div class="form-group">
            <label class="form-label">Th·ªùi gian h·ªçc (gi·ªù)</label>
            <input type="number" class="form-input" name="days[${dayCount-1}][hours]" required
                   min="0.5" max="12" step="0.5"
                   value="${escapeHtmlAttr(dayData?.study_duration_hours || 2)}">
        </div>
        
        <div class="form-group">
            <label class="form-label">Tr·∫°ng th√°i</label>
            <select class="form-select" name="days[${dayCount-1}][completion_status_display]" disabled>
                <option value="NOT_STARTED" ${(!dayData || dayData.completion_status === 'NOT_STARTED') ? 'selected' : ''}>
                    Ch∆∞a ho√†n th√†nh
                </option>
                <option value="IN_PROGRESS" ${dayData?.completion_status === 'IN_PROGRESS' ? 'selected' : ''}>
                    ƒêang th·ª±c hi·ªán
                </option>
                <option value="COMPLETED" ${dayData?.completion_status === 'COMPLETED' ? 'selected' : ''}>
                    ƒê√£ ho√†n th√†nh
                </option>
                <option value="SKIPPED" ${dayData?.completion_status === 'SKIPPED' ? 'selected' : ''}>
                    Kh√¥ng l√†m
                </option>
            </select>
            <small style="color: #6b7280; font-size: 0.85rem; display: block; margin-top: 5px;">
                ‚ÑπÔ∏è Tr·∫°ng th√°i s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t khi b·∫°n h·ªçc
            </small>
        </div>
    `;

    container.appendChild(dayElement);
}
        function removeDay(button) {
            const dayItem = button.closest('.day-item');
            if (!dayItem) return;
            dayItem.remove();

            const remainingDays = document.querySelectorAll('.day-item');
            if (remainingDays.length === 0) {
                document.getElementById('daysContainer').innerHTML = `
                    <p style="text-align: center; color: #6b7280; padding: 20px;">
                        Ch∆∞a c√≥ ng√†y h·ªçc n√†o. H√£y s·ª≠ d·ª•ng AI ho·∫∑c th√™m th·ªß c√¥ng.
                    </p>
                `;
                dayCount = 0;
            } else {
                remainingDays.forEach((day, index) => {
                    const dayNumber = day.querySelector('.day-number');
                    const inputs = day.querySelectorAll('input, textarea');

                    dayNumber.textContent = index + 1;
                    inputs.forEach(input => {
                        if (input.name) {
                            input.name = input.name.replace(/\[\d+\]/, `[${index}]`);
                        }
                    });
                });
                dayCount = remainingDays.length;
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = type === 'success' ? 'success-message' : 'error-message';
            notification.textContent = message;

            const form = document.getElementById('roadmapForm');
            form.insertBefore(notification, form.firstChild);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }
document.getElementById('roadmapForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const form = this;
  const submitBtn = document.querySelector('.submit-btn');
  const btnText = document.getElementById('submit-btn-text');

  // UI: disable + loading
  if (submitBtn) submitBtn.disabled = true;
  if (btnText) btnText.innerHTML = '<div class="loading"><div class="spinner"></div> ƒêang t·∫°o...</div>';

  // helpers
  const getField = (fd, name) => {
    const v = fd.get(name);
    return v == null ? '' : String(v).trim();
  };
  const getCheckedList = (names) => {
    // names: array of possible name attributes, e.g. ['q12_learning_styles[]','q12_learning_styles']
    const values = [];
    names.forEach(name => {
      document.querySelectorAll(`input[name="${name}"]:checked`).forEach(cb => values.push(cb.value));
    });
    return values;
  };
  const getCheckedListWithOther = (names, otherInputId) => {
    const vals = [];
    let other = '';
    names.forEach(name => {
      document.querySelectorAll(`input[name="${name}"]:checked`).forEach(cb => {
        if (cb.value === 'Kh√°c' || cb.value === 'Khac' || cb.value === 'Other') {
          const el = document.getElementById(otherInputId);
          other = el ? (el.value || '').trim() : other;
        } else {
          vals.push(cb.value);
        }
      });
    });
    return { values: vals, other: other };
  };
  const extractFirstNumber = (str, fallback = 2) => {
    if (!str) return fallback;
    const s = String(str).trim();
    const m = s.match(/(\d+(?:\.\d+)?)/);
    if (m) {
      const num = parseFloat(m[1]);
      if (s.toLowerCase().includes('ph√∫t')) return num / 60;
      return num;
    }
    return fallback;
  };

  try {
    const formData = new FormData(form);

    // =========================================
    // B∆Ø·ªöC 1: THU TH·∫¨P D·ªÆ LI·ªÜU T·ª™ FORM (Q1..Q20)
    // =========================================

    // Q1
    const q1_roadmap_name = getField(formData, 'q1_roadmap_name');

    // Q2 (category) - x·ª≠ l√Ω "Kh√°c"
    let q2_category = getField(formData, 'q2_category');
    if (q2_category === 'Kh√°c' || q2_category === 'Khac' || q2_category === 'Other') {
      const other = document.getElementById('q2_other_text');
      q2_category = other ? (other.value || '').trim() : '';
    }

    // Q3
    const q3_category_detail = getField(formData, 'q3_category_detail');

    // Q4 main purpose (radio/select) + other
    let q4_main_purpose = getField(formData, 'q4_main_purpose');
    let q4_main_purpose_other = '';
    if (q4_main_purpose === 'Kh√°c' || q4_main_purpose === 'Khac' || q4_main_purpose === 'Other') {
      q4_main_purpose_other = getField(formData, 'q4_main_purpose_other');
      if (!q4_main_purpose_other) q4_main_purpose_other = '';
    }

    // Q5
    const q5_specific_goal = getField(formData, 'q5_specific_goal');
    const q5_current_job = getField(formData, 'q5_current_job');

    // Q6-Q8
    const q6_learning_duration = getField(formData, 'q6_learning_duration'); // e.g., "3 months"
    const q7_current_level = getField(formData, 'q7_current_level');
    const q8_skills_text = getField(formData, 'q8_skills_text');

    // Q9-Q11
    const q9_daily_time = getField(formData, 'q9_daily_time'); // e.g., "2-3 gi·ªù"
    const q10_weekly_sessions = getField(formData, 'q10_weekly_sessions');
    const q11_program_days = Number(getField(formData, 'q11_program_days')) || 0;

    // Q12 (learning styles) - checkbox array + other
    const q12 = getCheckedListWithOther(['q12_learning_styles[]','q12_learning_styles'], 'q12_other_text');
    const q12_learning_styles = q12.values;
    const q12_learning_styles_other = q12.other;

    // Q13 (learning combinations)
    const q13 = getCheckedListWithOther(['q13_learning_combinations[]','q13_learning_combinations'], 'q13_other_text');
    const q13_learning_combinations = q13.values;
    const q13_learning_combinations_other = q13.other;

    // Q14 (challenges)
    const q14 = getCheckedListWithOther(['q14_challenges[]','q14_challenges'], 'q14_other_text');
    const q14_challenges = q14.values;
    const q14_challenges_other = q14.other;

    // Q15 (motivation)
    const q15 = getCheckedListWithOther(['q15_motivation[]','q15_motivation'], 'q15_other_text');
    const q15_motivation = q15.values;
    const q15_motivation_other = q15.other;

    // Q16 (material types)
    const q16 = getCheckedListWithOther(['q16_material_types[]','q16_material_types'], 'q16_other_text');
    const q16_material_types = q16.values;
    const q16_material_types_other = q16.other;

    // Q17-Q19
    const q17_material_language = getField(formData, 'q17_material_language');

    const q18_assessment_types = getCheckedList(['q18_assessment_types[]','q18_assessment_types']);
    const q19_result_display = getCheckedList(['q19_result_display[]','q19_result_display']);

    // Q20 - assessment frequency (other)
    let q20_assessment_frequency = getField(formData, 'q20_assessment_frequency');
    let q20_assessment_frequency_other = '';
    if (q20_assessment_frequency === 'Kh√°c' || q20_assessment_frequency === 'Khac' || q20_assessment_frequency === 'Other') {
      q20_assessment_frequency_other = getField(formData, 'q20_assessment_frequency_other');
    }

    // =========================================
    // B∆Ø·ªöC 2: VALIDATION C∆† B·∫¢N
    // =========================================
    console.log('üîç Validation Check:', {
      q1_roadmap_name, 
      q2_category, 
      q3_category_detail,
      q5_specific_goal, 
      q7_current_level, 
      q9_daily_time,
      q11_program_days
    });

    if (!q1_roadmap_name) throw new Error('‚ùå Vui l√≤ng nh·∫≠p t√™n l·ªô tr√¨nh ');
    if (!q2_category) throw new Error('‚ùå Vui l√≤ng ch·ªçn danh m·ª•c');
    if (!q3_category_detail) throw new Error('‚ùå Vui l√≤ng nh·∫≠p danh m·ª•c chi ti·∫øt ');
    if (!q5_specific_goal) throw new Error('‚ùå Vui l√≤ng nh·∫≠p m·ª•c ti√™u c·ª• th·ªÉ (Q2)');
    if (!q7_current_level) throw new Error('‚ùå Vui l√≤ng ch·ªçn tr√¨nh ƒë·ªô hi·ªán t·∫°i (Q5)');
    if (!q9_daily_time) throw new Error('‚ùå Vui l√≤ng ch·ªçn th·ªùi gian h·ªçc m·ªói ng√†y (Q7)');
    if (!q11_program_days || q11_program_days < 15 || q11_program_days > 180) {
      throw new Error('‚ùå S·ªë ng√†y ph·∫£i t·ª´ 15 ƒë·∫øn 180 (Q9)');
    }

    // =========================================
    // B∆Ø·ªöC 3: T·∫†O OBJECT G·ª¨I L√äN SERVER
    // =========================================

    // =========================================
    // B∆Ø·ªöC 4: THU TH·∫¨P DAYS (9 tr∆∞·ªùng m·ªói day)
    // =========================================
    const days = [];
    const dayItems = document.querySelectorAll('.day-item');
    dayItems.forEach((dayItem, idx) => {
      const inputs = dayItem.querySelectorAll('input, textarea, select');
      const dayData = {
        day_number: idx + 1,
        study_date: null,
        completion_status: 'NOT_STARTED',
        daily_goal: '',
        learning_content: '',
        practice_exercises: '',
        learning_materials: '',
        study_guide: '',
        study_duration_hours: 2
      };

      inputs.forEach(input => {
        // match last bracket name like name="day[goal]" -> capture 'goal'
        const m = input.name ? input.name.match(/\[(\w+)\]$/) : null;
        const fieldName = m ? m[1] : (input.name || '');
        if (!fieldName) return;

        const val = (input.type === 'checkbox' || input.type === 'radio') ? (input.checked ? input.value : null) : (input.value || '');

        switch (fieldName) {
          case 'goal':
            dayData.daily_goal = val || dayData.daily_goal;
            break;
          case 'content':
            dayData.learning_content = val || dayData.learning_content;
            break;
          case 'exercises':
            dayData.practice_exercises = val || dayData.practice_exercises;
            break;
          case 'materials':
            dayData.learning_materials = val || dayData.learning_materials;
            break;
          case 'study_guide':
            dayData.study_guide = val || dayData.study_guide;
            break;
          case 'hours':
            dayData.study_duration_hours = parseFloat(val) || dayData.study_duration_hours;
            break;
          case 'study_date':
            dayData.study_date = val || dayData.study_date;
            break;
          case 'completion_status':
            dayData.completion_status = val || dayData.completion_status;
            break;
          default:
            // ignore unknown
            break;
        }
      });

      // only push if minimal useful content
      if ((dayData.daily_goal && dayData.learning_content) || dayData.study_date) {
        days.push(dayData);
      }
    });

    // =========================================
    // T√çNH duration_hours
    // - n·∫øu c√≥ days: t·ªïng study_duration_hours
    // - else: l·∫•y s·ªë ƒë·∫ßu ti√™n trong q9_daily_time √ó q11_program_days
    // =========================================
    let duration_hours = 0;
    if (days.length > 0) {
      duration_hours = days.reduce((s, d) => s + (Number(d.study_duration_hours) || 0), 0);
    } else {
      const hoursPerDay = extractFirstNumber(q9_daily_time, 2);
      duration_hours = hoursPerDay * q11_program_days;
    }
    
    // ‚úÖ Final check for duration_hours
    if (isNaN(duration_hours) || duration_hours <= 0) {
      console.error('‚ùå Duration calculation failed:', {
        q9_daily_time,
        q11_program_days,
        hoursPerDay: extractFirstNumber(q9_daily_time, 2),
        calculated: duration_hours
      });
      throw new Error('‚ùå Kh√¥ng th·ªÉ t√≠nh t·ªïng gi·ªù h·ªçc. Vui l√≤ng ch·ªçn th·ªùi gian h·ªçc m·ªói ng√†y (Q9)');
    }

    // build payload
// --- START ensure numeric fields in roadmapData ---
const roadmapData = {
  roadmap_name: q1_roadmap_name,
  category: q2_category,
  sub_category: q3_category_detail || null,
  start_level: q7_current_level,
  // ƒë·∫£m b·∫£o √©p ki·ªÉu ngay t·∫°i ƒë√¢y
  duration_days: parseInt(q11_program_days, 10) || 0,
  duration_hours: (function(){
      // n·∫øu b·∫°n ƒë√£ c√≥ days array th√¨ duration_hours c√≥ th·ªÉ ƒë∆∞·ª£c t√≠nh t·ª´ ƒë√≥;
      // n·∫øu kh√¥ng, l·∫•y s·ªë ƒë·∫ßu ti√™n t·ª´ q9_daily_time * q11_program_days
      const perDay = Number(extractFirstNumber(q9_daily_time, 2)) || 0;
      const days = parseInt(q11_program_days, 10) || 0;
      return perDay * days;
  })(),
  expected_outcome: q5_specific_goal,

  // full Qs (gi·ªØ nguy√™n)
  q1_roadmap_name,
  q2_category,
  q3_category_detail,
  q4_main_purpose,
  q4_main_purpose_other,
  q5_specific_goal,
  q5_current_job,
  q6_learning_duration,
  q7_current_level,
  q8_skills_text,
  q9_daily_time,
  q10_weekly_sessions,
  q11_program_days,
  q12_learning_styles,
  q12_learning_styles_other,
  q13_learning_combinations,
  q13_learning_combinations_other,
  q14_challenges,
  q14_challenges_other,
  q15_motivation,
  q15_motivation_other,
  q16_material_types,
  q16_material_types_other,
  q17_material_language,
  q18_assessment_types,
  q19_result_display,
  q20_assessment_frequency,
  q20_assessment_frequency_other
};

if (days.length > 0) roadmapData.days = days;
// --- END ensure numeric fields in roadmapData ---

// ƒë·∫£m b·∫£o c√°c tr∆∞·ªùng numeric cu·ªëi c√πng tr∆∞·ªõc khi g·ª≠i
roadmapData.duration_days = parseInt(roadmapData.duration_days, 10) || 0;
roadmapData.duration_hours = Number(roadmapData.duration_hours) || 0;

// debug types & values tr∆∞·ªõc khi g·ª≠i
console.log('‚úÖ payload types:', {
  duration_days_type: typeof roadmapData.duration_days,
  duration_hours_type: typeof roadmapData.duration_hours,
  duration_days_value: roadmapData.duration_days,
  duration_hours_value: roadmapData.duration_hours
});

console.log('üì§ Sending data:', roadmapData);



    // =========================================
    // B∆Ø·ªöC 5: G·ª¨I REQUEST (g·ªôp headers)
    // =========================================
    // getAuthHeaders may return object or Headers instance
    let headers = {};
    try {
      const h = typeof getAuthHeaders === 'function' ? getAuthHeaders() : {};
      if (h instanceof Headers) {
        h.set('Content-Type', 'application/json');
        headers = h;
      } else {
        headers = Object.assign({}, h, { 'Content-Type': 'application/json' });
      }
    } catch (err) {
      headers = { 'Content-Type': 'application/json' };
    }

    const response = await fetch('/api/roadmaps', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        roadmapData: roadmapData,
                        roadmap_analyst_text: document.getElementById('analysisContent').textContent
                    })
                })

    if (!response.ok) {
      const errData = await response.json().catch(() => ({}));
      throw new Error(errData.error || (`HTTP ${response.status}`));
    }

    const result = await response.json().catch(() => ({}));
    showNotification('‚úÖ L·ªô tr√¨nh ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!', 'success');

    // redirect/close: gi·ªØ h√†nh vi c≈©
    setTimeout(() => {
      if (window.opener) {
        window.opener.location.href = 'path.html';
        window.close();
      } else {
        window.location.href = 'path.html';
      }
    }, 1200);

  } catch (error) {
    console.error('‚ùå Error creating roadmap:', error);
    window.scrollTo({ top: 0, behavior: 'smooth' });
    showNotification(`‚ö†Ô∏è ${error.message || 'C√≥ l·ªói x·∫£y ra khi t·∫°o l·ªô tr√¨nh. Vui l√≤ng th·ª≠ l·∫°i.'}`, 'error');
  } finally {
    if (submitBtn) submitBtn.disabled = false;
    if (btnText) btnText.innerHTML = '&#127881; T·∫°o L·ªô Tr√¨nh';
  }
});

function updateTotalHours() {
    const daysInput = document.querySelector('input[name="q11_program_days"]');
    const hoursInput = document.querySelector('select[name="q9_daily_time"]');

    if (daysInput?.value && hoursInput?.value) {
        const str = String(hoursInput.value).trim();
        const m = str.match(/(\d+(?:\.\d+)?)/);
        let hours = 2; // default
        if (m) {
            hours = parseFloat(m[1]);
            if (str.toLowerCase().includes('ph√∫t')) {
                hours = hours / 60;
            }
        }
        const total = parseInt(daysInput.value) * hours;
        console.log(`‚úÖ Total hours: ${total.toFixed(2)} (${hours}h/day √ó ${daysInput.value} days)`);
    }
}

const daysInputEl = document.querySelector('input[name="q11_program_days"]');
if (daysInputEl) {
    daysInputEl.addEventListener('input', function() {
        updateTotalHours();
        validateDays();
    });
}

const hoursInputEl = document.querySelector('select[name="q9_daily_time"]');
if (hoursInputEl) {
    hoursInputEl.addEventListener('change', updateTotalHours);
}
// ============ MODAL FUNCTIONS ============
    let customizedPrompt = null;

    function viewPrompt() {
        const prompt = customizedPrompt || generatePrompt();
        document.getElementById('promptContent').textContent = prompt;
        document.getElementById('promptModal').classList.add('show');
    }

    function closeModal() {
        document.getElementById('promptModal').classList.remove('show');
    }

    function copyPrompt() {
        const text = document.getElementById('promptContent').textContent || '';
        navigator.clipboard.writeText(text)
            .then(() => alert('‚úÖ ƒê√£ copy prompt v√†o clipboard!'))
            .catch(() => alert('‚ùå Kh√¥ng th·ªÉ copy.'));
    }

    function customizePrompt() {
        const prompt = customizedPrompt || generatePrompt();
        document.getElementById('customPromptContent').value = prompt;
        document.getElementById('customizeModal').classList.add('show');
    }

    function closeCustomizeModal() {
        document.getElementById('customizeModal').classList.remove('show');
    }

    function resetPrompt() {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën kh√¥i ph·ª•c prompt m·∫∑c ƒë·ªãnh?')) {
            customizedPrompt = null;
            document.getElementById('customPromptContent').value = generatePrompt();
            alert('‚úÖ ƒê√£ kh√¥i ph·ª•c prompt m·∫∑c ƒë·ªãnh!');
        }
    }

    function saveCustomPrompt() {
        customizedPrompt = document.getElementById('customPromptContent').value;
        alert('‚úÖ ƒê√£ l∆∞u prompt t√πy bi·∫øn!');
        closeCustomizeModal();
    }

    // Close modals khi click outside
    window.addEventListener('click', function(e) {
        const promptModal = document.getElementById('promptModal');
        const customizeModal = document.getElementById('customizeModal');
        
        if (e.target === promptModal) closeModal();
        if (e.target === customizeModal) closeCustomizeModal();
    });
window.addEventListener('load', function() {
    const token = localStorage.getItem('token');
    if (!token) {
        alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ t·∫°o l·ªô tr√¨nh h·ªçc');
        window.location.href = 'login.html';
        return;
    }
    
    loadCategories();
    validateDays();

    const daysInputEl = document.getElementById('q11_program_days');
    if (daysInputEl) {
        daysInputEl.addEventListener('input', function() {
            updateTotalHours();
            validateDays();
        });
    }

    const hoursInputEl = document.querySelector('select[name="q9_daily_time"]');
    if (hoursInputEl) {
        hoursInputEl.addEventListener('change', updateTotalHours);
    }

    // ‚úÖ TH√äM SAU C√ôNG - ƒë·∫£m b·∫£o ·∫©n t·∫•t c·∫£ "Kh√°c"
    setTimeout(() => {
        ['q2_other_text', 'q4_other_text', 'q12_other_text', 'q13_other_text', 
         'q14_other_text', 'q15_other_text', 'q16_other_text', 'q20_other_text'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
        });
    }, 100);
    setTimeout(() => {
        attachOtherEventsForQ2();
    }, 500);
});

        function escapeHtmlAttr(s) {
            if (s === null || s === undefined) return '';
            return String(s)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }
    // Q4 - Main Purpose
const q4_other_radio = document.getElementById('q4_other_radio');
const q4_other_text = document.getElementById('q4_other_text');
if (q4_other_radio && q4_other_text) {
    q4_other_radio.addEventListener('change', () => {
        if (q4_other_radio.checked) {
            q4_other_text.style.display = 'block';
            setTimeout(() => q4_other_text.focus(), 60);
        }
    });
    document.querySelectorAll('input[name="q4_main_purpose"]').forEach(radio => {
        if (radio !== q4_other_radio) {
            radio.addEventListener('change', () => {
                q4_other_text.style.display = 'none';
                q4_other_text.value = '';
            });
        }
    });
}

// Q12 - Learning Styles
const q12_other_checkbox = document.getElementById('q12_other_checkbox');
const q12_other_text = document.getElementById('q12_other_text');
if (q12_other_checkbox && q12_other_text) {
    q12_other_checkbox.addEventListener('change', () => {
        if (q12_other_checkbox.checked) {
            q12_other_text.style.display = 'block';
            setTimeout(() => q12_other_text.focus(), 60);
        } else {
            q12_other_text.style.display = 'none';
            q12_other_text.value = '';
        }
    });
}

// Q13 - Learning Combinations
const q13_other_checkbox = document.getElementById('q13_other_checkbox');
const q13_other_text = document.getElementById('q13_other_text');
if (q13_other_checkbox && q13_other_text) {
    q13_other_checkbox.addEventListener('change', () => {
        if (q13_other_checkbox.checked) {
            q13_other_text.style.display = 'block';
            setTimeout(() => q13_other_text.focus(), 60);
        } else {
            q13_other_text.style.display = 'none';
            q13_other_text.value = '';
        }
    });
}

// Q14 - Challenges
const q14_other_checkbox = document.getElementById('q14_other_checkbox');
const q14_other_text = document.getElementById('q14_other_text');
if (q14_other_checkbox && q14_other_text) {
    q14_other_checkbox.addEventListener('change', () => {
        if (q14_other_checkbox.checked) {
            q14_other_text.style.display = 'block';
            setTimeout(() => q14_other_text.focus(), 60);
        } else {
            q14_other_text.style.display = 'none';
            q14_other_text.value = '';
        }
    });
}

// Q15 - Motivation
const q15_other_checkbox = document.getElementById('q15_other_checkbox');
const q15_other_text = document.getElementById('q15_other_text');
if (q15_other_checkbox && q15_other_text) {
    q15_other_checkbox.addEventListener('change', () => {
        if (q15_other_checkbox.checked) {
            q15_other_text.style.display = 'block';
            setTimeout(() => q15_other_text.focus(), 60);
        } else {
            q15_other_text.style.display = 'none';
            q15_other_text.value = '';
        }
    });
}

// Q16 - Material Types
const q16_other_checkbox = document.getElementById('q16_other_checkbox');
const q16_other_text = document.getElementById('q16_other_text');
if (q16_other_checkbox && q16_other_text) {
    q16_other_checkbox.addEventListener('change', () => {
        if (q16_other_checkbox.checked) {
            q16_other_text.style.display = 'block';
            setTimeout(() => q16_other_text.focus(), 60);
        } else {
            q16_other_text.style.display = 'none';
            q16_other_text.value = '';
        }
    });
}

// Q20 - Assessment Frequency
const q20_other_radio = document.getElementById('q20_other_radio');
const q20_other_text = document.getElementById('q20_other_text');
if (q20_other_radio && q20_other_text) {
    q20_other_radio.addEventListener('change', () => {
        if (q20_other_radio.checked) {
            q20_other_text.style.display = 'block';
            setTimeout(() => q20_other_text.focus(), 60);
        }
    });
    document.querySelectorAll('input[name="q20_assessment_frequency"]').forEach(radio => {
        if (radio !== q20_other_radio) {
            radio.addEventListener('change', () => {
                q20_other_text.style.display = 'none';
                q20_other_text.value = '';
            });
        }
    });
}
    </script>
</body>
</html>
