<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·∫°o L·ªô Tr√¨nh H·ªçc M·ªõi - Con ƒë∆∞·ªùng ƒëam m√™</title>
    <script>
        const Token = localStorage.getItem('token');
        if (!Token) {alert('Vui l√≤ng ƒëƒÉng nh·∫≠p!'); window.location.href = 'login.html';}
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

body {
    font-family: Inter, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #ffffff);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    padding: 0;  /* X√ìA padding: 20px; */
    margin: 0;
}
.container {
    max-width: 1000px;
    margin: 100px auto 0 auto; /* Th√™m margin-top ƒë·ªÉ tr√°nh b·ªã header che */
    width: 1000px;
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
}

    .analysis-section {
            background: #f0fdf4;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 4px solid #10b981;
        }

        .analysis-section h3 {
            color: #065f46;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .analysis-content {
            color: #374151;
            line-height: 1.8;
            white-space: pre-wrap;
        }




    .form-container {
        padding: 40px;
    }

    .form-section {
        margin-bottom: 30px;
        padding: 25px;
        background: #f9fafb;
        border-radius: 16px;
        border: 2px solid #e5e7eb;
        transition: all 0.3s ease;
    }

    .form-section:hover {
        border-color:  #007bff;
    }

    .section-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
        font-size: 0.95rem;
    }

    .form-input,
    .form-select,
    .form-textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #d1d5db;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
        outline: none;
        border-color:  #007bff;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .form-textarea {
        resize: vertical;
        min-height: 100px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }

/* ‚úÖ STYLE M·∫∂C ƒê·ªäNH - FLEXIBLE CHO C√ÅC C√ÇU KH√ÅC */
.checkbox-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
}

/* ‚úÖ STYLE ƒê·∫∂C BI·ªÜT CHO C√ÇU 10 V√Ä 11 - 2 C·ªòT C·ªê ƒê·ªäNH */
.checkbox-group-two-columns {
    display: grid;
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 10px;
}

.checkbox-group label {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px;
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    box-sizing: border-box;
    min-width: 0;
}

.checkbox-group label:hover {
    border-color: #4f46e5;
    background: #f0f9ff;
}

    .checkbox-group input[type="checkbox"],
    .checkbox-group input[type="radio"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color:#007bff;
    }

    .checkbox-group input[type="checkbox"]:checked + span,
    .checkbox-group input[type="radio"]:checked + span {
        font-weight: 700;
        color:#007bff;
    }
    
    .ai-generate-section {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border: 2px solid #0ea5e9;
    }

    .ai-notice {
        background: #fff3cd;
        color: #856404;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 1px solid #ffeaa7;
        font-size: 0.9rem;
    }

    .ai-notice strong {
        font-weight: 700;
    }

    .ai-btn, .prompt-btn {
        padding: 15px 30px;
        background: linear-gradient(135deg,#007bff,#007bff);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 15px;
        width: 100%;
        box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
    }

    .ai-btn:hover, .prompt-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
        background: linear-gradient(135deg, #007bff, #007bff);
    }

    .ai-btn:disabled, .prompt-btn:disabled {
        background: linear-gradient(135deg, #9ca3af, #6b7280);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
        opacity: 0.6;
    }

    .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .prompt-btn {
        background: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        margin: 15px auto 0; /* ‚úÖ TH√äM auto ƒë·ªÉ cƒÉn gi·ªØa */
        transition: all 0.3s ease;
        display: block; /* ‚úÖ TH√äM block ƒë·ªÉ margin auto ho·∫°t ƒë·ªông */
    }

    .prompt-btn:hover {
        background: #0056b3;
        transform: translateY(-2px);
    }

    .days-container {
        max-height: 400px;
        overflow-y: auto;
        padding: 10px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        background: white;
    }

    .day-item {
        background: #f9fafb;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        border: 2px solid #e5e7eb;
        transition: all 0.3s ease;
    }

    .day-item:hover {
        border-color: #007bff;
    }

    .day-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .day-number {
        background: #007bff;
        color: white;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
    }

    .remove-day-btn {
        background: #ef4444;
        color: white;
        border: none;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .remove-day-btn:hover {
        background: #dc2626;
        transform: scale(1.1);
    }

    .add-day-btn {
        width: 100%;
        padding: 15px;
        background: #10b981;
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 15px;
    }

    .add-day-btn:hover {
        background: #059669;
        transform: translateY(-1px);
    }

    .submit-section {
        text-align: center;
        padding: 30px;
        background: #f9fafb;
        border-radius: 16px;
        margin-top: 30px;
    }

    .submit-btn {
        padding: 18px 40px;
        background: linear-gradient(135deg, #007bff, #007bff);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1.2rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 200px;
    }

    .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(79, 70, 229, 0.4);
    }

    .submit-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
        opacity: 0.6;
    }

    .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        color: #6b7280;
    }

    .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #e5e7eb;
        border-radius: 50%;
        border-top-color: #007bff;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .success-message {
        background: #dcfdf4;
        color: #065f46;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 2px solid #10b981;
    }

    .error-message {
        background: #fee2e2;
        color: #991b1b;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 2px solid #ef4444;
    }

    /* ======================== */
    /* Styles for "Kh√°c" box   */
    /* ======================== */
/*
.other-box {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 10px;
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  min-width: 160px;
  box-sizing: border-box;
}

.other-box .other-row {
  display: flex;
  align-items: center;
  gap: 8px;
}

.other-box .other-input {
  display: none;
  width: 100%;
  padding: 10px 12px;
  border: 2px solid #d1d5db;
  border-radius: 8px;
  font-size: 0.95rem;
  box-sizing: border-box;
  background: white;
  transition: border-color 0.2s, box-shadow 0.15s;
}

.other-box .other-input:focus {
  outline: none;
  border-color:#007bff;
  box-shadow: 0 0 0 3px rgba(79,70,229,0.08);
}

.other-box:hover {
  border-color: #007bff;
  background: #f0f9ff;
}
*/
/* ‚úÖ INPUT "KH√ÅC" - ·∫®N M·∫∂C ƒê·ªäNH, HI·ªÇN TH·ªä KHI CHECKED */
.other-input {
    display: none;
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #d1d5db;
    border-radius: 8px;
    font-size: 1rem;
    box-sizing: border-box;
    margin-top: 10px;
    background: white;
    transition: all 0.3s ease;
}

.other-input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}
    /* Q4 - Main Purpose */
    #q4_other_text {
        margin-top: 10px;
    }

    /* Q12 - Learning Styles */
    #q12_other_text {
        margin-top: 10px;
    }

    /* Q13 - Learning Combinations */
    #q13_other_text {
        margin-top: 10px;
    }

    /* Q14 - Challenges */
    #q14_other_text {
        margin-top: 10px;
    }

    /* Q15 - Motivation */
    #q15_other_text {
        margin-top: 10px;
    }

    /* Q16 - Material Types */
    #q16_other_text {
        margin-top: 10px;
    }

    /* Q20 - Assessment Frequency */
    #q20_other_text {
        margin-top: 10px;
    }

    .back-btn {
        position: absolute;
        left: 30px;
        top: 50%;
        transform: translateY(-50%);
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        backdrop-filter: blur(10px);
    }

    .back-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
    }


    .close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s;
    }

    .close-btn:hover {
    opacity: 0.8;
    }/* =============== MODAL STYLES =============== */
.modal {
    display: none; /* ‚úÖ ·∫®n m·∫∑c ƒë·ªãnh */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.modal.show {
    display: flex; /* ‚úÖ Ch·ªâ hi·ªán khi c√≥ class 'show' */
}

    pre {
    background: #f3f4f6;
    padding: 15px;
    border-radius: 8px;
    overflow-x: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 13px;
    line-height: 1.4;
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #e5e7eb;
    }

    #customPromptContent {
    width: 100%;
    min-height: 400px;
    padding: 15px;
    border: 2px solid #d1d5db;
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    resize: vertical;
    box-sizing: border-box;
    }

    #customPromptContent:focus {
    outline: none;
    border-color:#007bff;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    /* Modal styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    backdrop-filter: blur(5px);
    padding: 20px;
    overflow-y: auto;
}

.modal-overlay.active {
    display: flex;
}

.close-modal {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 5px 10px;
    transition: transform 0.2s;
}

.close-modal:hover {
    transform: scale(1.1);
}

.info-box {
    background: #fff3cd;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #ffc107;
}

.rating-group {
    margin-bottom: 25px;
    background: white;
    padding: 20px;
    border-radius: 12px;
    border: 2px solid #e5e7eb;
}

.rating-group label {
    display: block;
    font-weight: 600;
    color: #374151;
    margin-bottom: 12px;
    font-size: 14px;
}

.rating-stars {
    display: flex;
    gap: 8px;
    font-size: 32px;
}

.star {
    cursor: pointer;
    color: #d1d5db;
    transition: all 0.2s ease;
}

.star:hover,
.star.active {
    color: #fbbf24;
    transform: scale(1.2);
}

.rating-value {
    margin-top: 10px;
    font-size: 14px;
    color: #6b7280;
    font-weight: 600;
}

.textarea-group {
    margin-bottom: 20px;
    background: white;
    padding: 20px;
    border-radius: 12px;
    border: 2px solid #e5e7eb;
}

.textarea-group label {
    display: block;
    font-weight: 600;
    color: #374151;
    margin-bottom: 10px;
    font-size: 14px;
}

.textarea-group textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-family: inherit;
    font-size: 14px;
    resize: vertical;
    min-height: 80px;
    transition: all 0.3s ease;
}

.textarea-group textarea:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

.submit-evaluation-btn {
    width: 100%;
    padding: 16px 32px;
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
}

.submit-evaluation-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
}

.submit-evaluation-btn:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
}
    @media (max-width: 768px) {
        body {
            padding: 10px;
        }

        .header {
            padding: 20px 15px;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-top: 50px;
        }

        .header p {
            font-size: 0.95rem;
        }

        .back-btn {
            position: static;
            margin-bottom: 15px;
            display: block;
            width: 100%;
            text-align: center;
            transform: none;
        }

        .form-container {
            padding: 20px;
        }

        .form-section {
            padding: 15px;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .checkbox-group {
            grid-template-columns: 1fr;
        }

        .section-title {
            font-size: 1.1rem;
        }

        .submit-btn {
            width: 100%;
            font-size: 1rem;
            padding: 15px 20px;
        }

        .ai-btn {
            font-size: 1rem;
        }
    }

    @media (max-width: 480px) {
        .header h1 {
            font-size: 1.5rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            font-size: 14px;
            padding: 10px 12px;
        }

        .day-item {
            padding: 15px;
        }

        .days-container {
            max-height: 300px;
        }
    }

    @media (max-width: 768px) {
        body {
            padding: 10px;
        }

        .header {
            padding: 20px 15px;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-top: 50px;
        }

        .header p {
            font-size: 0.95rem;
        }

        .back-btn {
            position: static;
            margin-bottom: 15px;
            display: block;
            width: 100%;
            text-align: center;
            transform: none;
        }

        .form-container {
            padding: 20px;
        }

        .form-section {
            padding: 15px;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .checkbox-group {
            grid-template-columns: 1fr;
        }

        .section-title {
            font-size: 1.1rem;
        }

        .submit-btn {
            width: 100%;
            font-size: 1rem;
            padding: 15px 20px;
        }

        .ai-btn {
            font-size: 1rem;
        }

        .modal-content {
            width: 95%;
            max-height: 95vh;
        }

        .modal-body {
            max-height: 70vh;
        }
    }

    @media (max-width: 480px) {
        .header h1 {
            font-size: 1.5rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            font-size: 14px;
            padding: 10px 12px;
        }

        .day-item {
            padding: 15px;
        }

        .days-container {
            max-height: 300px;
        }

        .modal-header h2 {
            font-size: 1.1rem;
        }

        .btn {
            font-size: 0.9rem;
            padding: 10px 15px;
        }
    }
/* ============ CUSTOM DROPDOWN CHO CATEGORY ============ */
.custom-select-wrapper {
    position: relative;
    width: 100%;
}

.custom-select-trigger {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #d1d5db;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    background: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
}

.custom-select-trigger:hover {
    border-color: #007bff;
}

.custom-select-trigger.active {
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

.custom-select-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid #007bff;
    border-radius: 8px;
    margin-top: 4px;
    max-height: 300px;
    overflow: hidden; /* ‚úÖ S·ª¨A: ƒê·ªïi t·ª´ visible sang hidden */
    display: none;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.custom-select-dropdown.active {
    display: block;
}

.custom-select-search {
    padding: 8px;
    border-bottom: 2px solid #e5e7eb;
    position: sticky;
    top: 0;
    background: #f0f9ff;
    z-index: 1;
}

.custom-select-search input {
    width: 100%;
    padding: 8px 12px;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    font-size: 14px;
    outline: none;
}

.custom-select-search input:focus {
    border-color: #007bff;
}

.custom-select-options {
    max-height: 250px;
    overflow-y: auto;
}

.custom-select-option {
    padding: 12px; /* ‚úÖ S·ª¨A: ƒê·ªïi t·ª´ 10px 12px th√†nh 12px ƒë·ªÉ ƒë·ªìng nh·∫•t */
    cursor: pointer;
    transition: background 0.2s;
    font-size: 14px;
    min-height: 30px; /* ‚úÖ TH√äM: ƒê·∫£m b·∫£o chi·ªÅu cao t·ªëi thi·ªÉu */
    display: flex; /* ‚úÖ TH√äM: CƒÉn gi·ªØa n·ªôi dung */
    align-items: center; /* ‚úÖ TH√äM: CƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
    box-sizing: border-box; /* ‚úÖ TH√äM: T√≠nh padding v√†o chi·ªÅu cao */
}

.custom-select-option:hover {
    background: #f0f9ff;
}

.custom-select-option.selected {
    background: #dbeafe;
    font-weight: 600;
    color: #007bff;
}

.custom-select-option.disabled {
    color: #9ca3af;
    cursor: not-allowed;
    background: #f9fafb;
}

.custom-select-wrapper input[type="hidden"] {
    display: none;
}
</style>
    <!-- Preload Font Awesome CSS -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" as="style">
    
    <!-- Load Font Awesome async -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"></noscript>
    
    <!-- Load Google Fonts async with display swap -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;600;700;900&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;600;700;900&display=swap" rel="stylesheet"></noscript>
    
    <!-- Load footer.css async (non-critical) -->
    <link rel="preload" href="footer.css" as="style">
    <link rel="stylesheet" href="footer.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="footer.css"></noscript>

    <!-- Load header.css -->
    <link rel="preload" href="header.css" as="style">
    <link rel="stylesheet" href="header.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="header.css"></noscript>
</head>
<body>
<div id="header"></div>
<script>
  fetch('header.html')
    .then(res => res.text())
    .then(html => {
      document.getElementById('header').innerHTML = html;
      const script = document.createElement('script');
      script.src = 'header.js';
      document.body.appendChild(script);
    });
</script>
<div class="container">
<div class="form-container">
    <div style="background: #007bff; padding: 40px; margin: -40px -40px 30px -40px; border-radius: 20px 20px 0 0; position: relative;">
        <a href="path.html" class="back-btn" style="color: white; margin-left: 40px;">‚Üê Quay l·∫°i</a>
        <h1 style="text-align: center; margin-bottom: 10px; color: white;">T·∫°o L·ªô Tr√¨nh H·ªçc M·ªõi</h1>
        <p style="text-align: center; color: rgba(255,255,255,0.9); margin-bottom: 0;">S·ª≠ d·ª•ng AI ƒë·ªÉ t·∫°o l·ªô tr√¨nh h·ªçc c√° nh√¢n h√≥a cho b·∫°n</p>
    </div>
        <form id="roadmapForm">
                <!-- =============== PH·∫¶N H·ªéI 20 C√ÇU =============== -->

                <!-- PH·∫¶N 1: TH√îNG TIN C∆† B·∫¢N -->
                <div class="form-section">
                    <h3 class="section-title">üõ£Ô∏è Th√¥ng Tin C∆° B·∫£n</h3>
                    
                    <!-- Q1: T√™n l·ªô tr√¨nh -->
                    <div class="form-group">
                        <label class="form-label">T√™n l·ªô tr√¨nh *</label>
                        <input type="text" class="form-input" name="q1_roadmap_name" required 
                            placeholder="VD: H·ªçc Python t·ª´ c∆° b·∫£n ƒë·∫øn n√¢ng cao">
                    </div>

                    <!-- Q2: Danh m·ª•c - CUSTOM DROPDOWN -->
                    <div class="form-group" id="q2_category_container">
                        <label class="form-label">Danh m·ª•c *</label>
                        <!-- Placeholder s·∫Ω ƒë∆∞·ª£c thay b·∫±ng custom dropdown khi load -->
                        <div style="padding: 12px; background: #f9fafb; border-radius: 8px; color: #6b7280;">
                            ƒêang t·∫£i danh m·ª•c...
                        </div>
                    </div>

                    <!-- Q3: Danh m·ª•c chi ti·∫øt (ƒë·ªông) -->
                    <div class="form-group">
                        <label class="form-label">Danh m·ª•c chi ti·∫øt *</label>
                        <div id="q3_subCategoryContainer">
                            Vui l√≤ng ch·ªçn danh m·ª•c tr∆∞·ªõc
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h3 class="section-title">üìã Ph·∫ßn 1: M·ª•c ti√™u h·ªçc t·∫≠p</h3>
                    <!-- Q1: M·ª•c ƒë√≠ch ch√≠nh -->
                    <div class="form-group">
                        <label class="form-label">1. M·ª•c ƒë√≠ch ch√≠nh c·ªßa b·∫°n l√† g√¨? *</label>
                        <div class="checkbox-group">
                            <label><input type="radio" name="q4_main_purpose" value="Giao ti·∫øp h√†ng ng√†y" required> Giao ti·∫øp h√†ng ng√†y</label>
                            <label><input type="radio" name="q4_main_purpose" value="C√¥ng vi·ªác"> C√¥ng vi·ªác</label>
                            <label><input type="radio" name="q4_main_purpose" value="H·ªçc t·∫≠p"> H·ªçc t·∫≠p</label>
                            <label><input type="radio" name="q4_main_purpose" value="Thi ch·ª©ng ch·ªâ"> Thi ch·ª©ng ch·ªâ</label>
                            <label><input type="radio" name="q4_main_purpose" value="Du l·ªãch-ƒë·ªãnh c∆∞"> Du l·ªãch-ƒë·ªãnh c∆∞</label>
                            <label><input type="radio" name="q4_main_purpose" value="Kh√°c" id="q4_other_radio"> Kh√°c</label>
                        </div>
                        <input type="text" id="q4_other_text" class="form-input other-input" name="q4_main_purpose_other"
                            placeholder="Ghi r√µ m·ª•c ƒë√≠ch...">
                    </div>

                    <!-- Q2: M·ª•c ti√™u c·ª• th·ªÉ -->
                    <div class="form-group">
                        <label class="form-label">2. M·ª•c ti√™u c·ª• th·ªÉ c·ªßa b·∫°n? *</label>
                        <textarea class="form-textarea" name="q5_specific_goal" required
                                placeholder="VD: IELTS 6.5 sau 1 nƒÉm, TOEIC 800 trong 6 th√°ng..."></textarea>
                    </div>
                </div>

                <!-- PH·∫¶N 2: TR√åNH ƒê·ªò HI·ªÜN T·∫†I -->
                <div class="form-section">
                    <h3 class="section-title">üìä Ph·∫ßn 2: Tr√¨nh ƒê·ªô Hi·ªán T·∫°i</h3>
                    <!-- Q3: C√¥ng vi·ªác hi·ªán t·∫°i -->
                    <div class="form-group">
                        <label class="form-label">3. C√¥ng vi·ªác hi·ªán t·∫°i c·ªßa b·∫°n? *</label>
                        <input type="text"  name="q5_current_job" class="form-input" required
                            placeholder="VD: Nh√¢n vi√™n vƒÉn ph√≤ng, Gi√°o vi√™n, K·ªπ s∆∞...">        
                    </div>
                    <!-- Q4: Th·ªùi gian ƒë√£ h·ªçc -->
                    <div class="form-group">
                        <label class="form-label">4. B·∫°n ƒë√£ h·ªçc lƒ©nh v·ª±c n√†y ƒë∆∞·ª£c bao l√¢u? *</label>
                        <select class="form-select" name="q6_learning_duration" required>
                            <option value="">---- Ch·ªçn --</option>
                            <option value="Ch∆∞a t·ª´ng">Ch∆∞a t·ª´ng</option>
                            <option value="<6 th√°ng">D∆∞·ªõi 6 th√°ng</option>
                            <option value="6 th√°ng-2 nƒÉm">6 th√°ng - 2 nƒÉm</option>
                            <option value=">2 nƒÉm">Tr√™n 2 nƒÉm</option>
                        </select>
                    </div>

                    <!-- Q5: Tr√¨nh ƒë·ªô hi·ªán t·∫°i -->
                    <div class="form-group">
                        <label class="form-label">5. Tr√¨nh ƒë·ªô hi·ªán t·∫°i c·ªßa b·∫°n? *</label>
                        <select class="form-select" name="q7_current_level" required>
                            <option value="">-- Ch·ªçn --</option>
                            <option value="M·ªõi b·∫Øt ƒë·∫ßu">M·ªõi b·∫Øt ƒë·∫ßu</option>
                            <option value="C∆° b·∫£n">C∆° b·∫£n</option>
                            <option value="Trung b√¨nh">Trung b√¨nh</option>
                            <option value="Kh√° t·ªët">Kh√° t·ªët</option>
                            <option value="N√¢ng cao">N√¢ng cao</option>
                        </select>
                    </div>

                    <!-- Q6: K·ªπ nƒÉng mu·ªën c·∫£i thi·ªán -->
                    <div class="form-group">
                        <label class="form-label">6. K·ªπ nƒÉng n√†o b·∫°n mu·ªën c·∫£i thi·ªán? (ghi r√µ) *</label>
                        <input type="text" name="q8_skills_text" class="form-input" required
                            placeholder="VD: Nghe, N√≥i, Vi·∫øt, L·∫≠p tr√¨nh Python...">
                    </div>
                </div>

                <!-- PH·∫¶N 3: CAM K·∫æT TH·ªúI GIAN -->
                <div class="form-section">
                    <h3 class="section-title">‚è∞ Ph·∫ßn 3: Cam K·∫øt Th·ªùi Gian</h3>

                    <!-- Q7: Th·ªùi gian h·ªçc m·ªói ng√†y -->
                    <div class="form-group">
                        <label class="form-label">7. B·∫°n c√≥ th·ªÉ d√†nh bao nhi√™u th·ªùi gian h·ªçc m·ªói ng√†y? (ph√∫t) *</label>
                        <input 
                            type="number" 
                            class="form-input" 
                            name="q9_daily_time" 
                            id="q9_daily_time_input"
                            min="15" 
                            max="720" 
                            step="15"
                            required
                            placeholder="Nh·∫≠p s·ªë ph√∫t (15 - 720)"
                        >
                        <small id="minutesWarning" style="color: #ef4444; font-size: 0.8rem; margin-top: 5px; display: none;">
                            ‚ö†Ô∏è Vui l√≤ng nh·∫≠p t·ª´ 15 ƒë·∫øn 720 ph√∫t (15 ph√∫t - 12 gi·ªù).
                        </small>
                    </div>

                    <!-- Q8: S·ªë bu·ªïi m·ªói tu·∫ßn -->
                    <div class="form-group">
                        <label class="form-label">8. B·∫°n h·ªçc bao nhi√™u bu·ªïi m·ªói tu·∫ßn? *</label>
                        <select class="form-select" name="q10_weekly_sessions" required>
                            <option value="">-- Ch·ªçn --</option>
                            <option value="1 bu·ªïi">1 bu·ªïi</option>
                            <option value="2 bu·ªïi">2 bu·ªïi</option>
                            <option value="3 bu·ªïi">3 bu·ªïi</option>
                            <option value="4 bu·ªïi">4 bu·ªïi</option>
                            <option value="5 bu·ªïi">5 bu·ªïi</option>
                            <option value="6 bu·ªïi">6 bu·ªïi</option>
                            <option value="7 bu·ªïi">7 bu·ªïi</option>
                        </select>
                    </div>

                    <!-- Q9: Th·ªùi gian l·ªô tr√¨nh (ng√†y) -->
                    <div class="form-group">
                        <label class="form-label" id="q11_label">9. Th·ªùi gian (ng√†y) c·ªßa l·ªô tr√¨nh (15 - 60 ng√†y) *</label>
                        <input type="number" id="q11_program_days" name="q11_program_days" class="form-input" min="15" max="60" required
                            placeholder="Nh·∫≠p s·ªë ng√†y (15 - 60)">
                        <small id="daysWarning" style="color: #ef4444; font-size: 0.8rem; margin-top: 5px; display: none;">
                            ‚ö†Ô∏è S·ªë ng√†y t·ªëi ƒëa: 60. N·∫øu b·∫°n mu·ªën h∆°n 60 ng√†y, vui l√≤ng t·∫°o th·ªß c√¥ng.
                        </small>
                    </div>
                </div>

                <!-- PH·∫¶N 4: PHONG C√ÅCH H·ªåC T·∫¨P -->
                <div class="form-section">
                    <h3 class="section-title">üé® Ph·∫ßn 4: Phong C√°ch H·ªçc T·∫≠p</h3>

                    <!-- Q10: Ph∆∞∆°ng ph√°p h·ªçc -->
                    <div class="form-group">
                        <label class="form-label">10. Ph∆∞∆°ng ph√°p h·ªçc b·∫°n th√≠ch (ch·ªçn n·∫øu ph√π h·ª£p) *</label>
                        <div class="checkbox-group checkbox-group-two-columns">
                            <label><input type="checkbox" name="q12_learning_styles[]" value="Truy·ªÅn th·ªëng (ƒê·ªçc t√†i li·ªáu, b√†i ki·ªÉm tra ng·∫Øn)"> Truy·ªÅn th·ªëng (ƒê·ªçc t√†i li·ªáu, b√†i ki·ªÉm tra ng·∫Øn)</label>
                            <label><input type="checkbox" name="q12_learning_styles[]" value="H√¨nh ·∫£nh (S∆° ƒë·ªì, infographic, video tr·ª±c quan)"> H√¨nh ·∫£nh (S∆° ƒë·ªì, infographic, video tr·ª±c quan)</label>
                            <label><input type="checkbox" name="q12_learning_styles[]" value="√Çm thanh (Podcast, gi·∫£ng b√†i, th·∫£o lu·∫≠n)"> √Çm thanh (Podcast, gi·∫£ng b√†i, th·∫£o lu·∫≠n)</label>
                            <label><input type="checkbox" name="q12_learning_styles[]" value="Th·ª±c h√†nh (L√†m d·ª± √°n, th√≠ nghi·ªám, coding)"> Th·ª±c h√†nh (L√†m d·ª± √°n, th√≠ nghi·ªám, coding)</label>
                            <label><input type="checkbox" name="q12_learning_styles[]" value="Kh√°c" id="q12_other_checkbox"> Kh√°c</label>
                        </div>
                        <input type="text" id="q12_other_text" class="form-input other-input" name="q12_learning_styles_other"
                            placeholder="Ghi r√µ ph∆∞∆°ng ph√°p..." style="margin-top: 10px;">
                    </div>

                    <!-- Q11: K·∫øt h·ª£p h·ªçc - 2 C·ªòT C·ªê ƒê·ªäNH -->
                    <div class="form-group">
                        <label class="form-label">11. B·∫°n th√≠ch k·∫øt h·ª£p h·ªçc nh∆∞ th·∫ø n√†o? *</label>
                        <div class="checkbox-group checkbox-group-two-columns">
                            <label><input type="checkbox" name="q13_learning_combinations[]" value="Active Recall (Nh·ªõ l·∫°i ch·ªß ƒë·ªông)"> Active Recall (Nh·ªõ l·∫°i ch·ªß ƒë·ªông)</label>
                            <label><input type="checkbox" name="q13_learning_combinations[]" value="Spaced Repetition (L·∫∑p l·∫°i ng·∫Øt qu√£ng)"> Spaced Repetition (L·∫∑p l·∫°i ng·∫Øt qu√£ng)</label>
                            <label><input type="checkbox" name="q13_learning_combinations[]" value="Interleaving (Xen k·∫Ω ƒëa d·∫°ng ch·ªß ƒë·ªÅ)"> Interleaving (Xen k·∫Ω ƒëa d·∫°ng ch·ªß ƒë·ªÅ)</label>
                            <label><input type="checkbox" name="q13_learning_combinations[]" value="Kh√°c" id="q13_other_checkbox"> Kh√°c</label>
                        </div>
                        <input type="text" id="q13_other_text" class="form-input other-input" name="q13_learning_combinations_other"
                            placeholder="Ghi r√µ..." style="margin-top: 10px;">
                    </div>
                </div>
                 <!-- PH·∫¶N 5: KH√ì KHƒÇN & ƒê·ªòNG L·ª∞C -->
                <div class="form-section">
                    <h3 class="section-title">üìÖ Ph·∫ßn 5: Kh√≥ KhƒÉn & ƒê·ªông L·ª±c</h3>
                    <!-- Q12: Th√°ch th·ª©c -->
                    <div class="form-group">
                        <label class="form-label">12. Th√°ch th·ª©c b·∫°n g·∫∑p ph·∫£i? *</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="q14_challenges[]" value="Thi·∫øu ƒë·ªông l·ª±c"> Thi·∫øu ƒë·ªông l·ª±c</label>
                            <label><input type="checkbox" name="q14_challenges[]" value="Thi·∫øu th·ªùi gian"> Thi·∫øu th·ªùi gian</label>
                            <label><input type="checkbox" name="q14_challenges[]" value="T√†i li·ªáu kh√≥"> T√†i li·ªáu kh√≥</label>
                            <label><input type="checkbox" name="q14_challenges[]" value="Kh√≥ t·∫≠p trung"> Kh√≥ t·∫≠p trung</label>
                            <label><input type="checkbox" name="q14_challenges[]" value="Kh√°c" id="q14_other_checkbox"> Kh√°c</label>
                        </div>
                        <input type="text" id="q14_other_text" class="form-input other-input" name="q14_challenges_other"
                            placeholder="Ghi r√µ...">
                    </div>

                    <!-- Q13: ƒê·ªông l·ª±c -->
                    <div class="form-group">
                        <label class="form-label">13. ƒêi·ªÅu g√¨ gi·ªØ ƒë·ªông l·ª±c cho b·∫°n? *</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="q15_motivation[]" value="Ph·∫ßn th∆∞·ªüng"> Ph·∫ßn th∆∞·ªüng</label>
                            <label><input type="checkbox" name="q15_motivation[]" value="Ti·∫øn b·ªô r√µ r√†ng"> Ti·∫øn b·ªô r√µ r√†ng</label>
                            <label><input type="checkbox" name="q15_motivation[]" value="M·ª•c ti√™u l·ªõn"> M·ª•c ti√™u l·ªõn</label>
                            <label><input type="checkbox" name="q15_motivation[]" value="C·ªông ƒë·ªìng h·ªçc t·∫≠p"> C·ªông ƒë·ªìng h·ªçc t·∫≠p</label>
                            <label><input type="checkbox" name="q15_motivation[]" value="Kh√°c" id="q15_other_checkbox"> Kh√°c</label>
                        </div>
                        <input type="text" id="q15_other_text" class="form-input other-input" name="q15_motivation_other"
                            placeholder="Ghi r√µ...">
                    </div>
                </div>     
                 <!-- PH·∫¶N 6: T√ÄI LI·ªÜU & ƒê√ÅNH GI√Å -->
                <div class="form-section">
                    <h3 class="section-title">üìä Ph·∫ßn 6: T√†i Li·ªáu & ƒê√°nh Gi√°</h3>   
                    <!-- Q14: Lo·∫°i t√†i li·ªáu -->
                    <div class="form-group">
                        <label class="form-label">14. Lo·∫°i t√†i li·ªáu b·∫°n th√≠ch? *</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="q16_material_types[]" value="S√°ch"> S√°ch</label>
                            <label><input type="checkbox" name="q16_material_types[]" value="Video h∆∞·ªõng d·∫´n"> Video h∆∞·ªõng d·∫´n</label>
                            <label><input type="checkbox" name="q16_material_types[]" value="B√†i t·∫≠p online"> B√†i t·∫≠p online</label>
                            <label><input type="checkbox" name="q16_material_types[]" value="Podcast"> Podcast</label>
                            <label><input type="checkbox" name="q16_material_types[]" value="App h·ªçc t·∫≠p"> App h·ªçc t·∫≠p</label>
                            <label><input type="checkbox" name="q16_material_types[]" value="T√†i li·ªáu theo ch·ªß ƒë·ªÅ"> T√†i li·ªáu theo ch·ªß ƒë·ªÅ</label>
                            <label><input type="checkbox" name="q16_material_types[]" value="Phim ·∫£nh"> Phim ·∫£nh</label>
                            <label><input type="checkbox" name="q16_material_types[]" value="Nh·∫°c"> Nh·∫°c</label>
                            <label><input type="checkbox" name="q16_material_types[]" value="Kh√≥a h·ªçc online"> Kh√≥a h·ªçc online</label>
                            <label><input type="checkbox" name="q16_material_types[]" value="Kh√°c" id="q16_other_checkbox"> Kh√°c</label>
                        </div>
                        <input type="text" id="q16_other_text" class="form-input other-input" name="q16_material_types_other"
                            placeholder="B·∫°n h√£y ghi r√µ t√™n s√°ch & t√°c gi·∫£/link d·∫´n ƒë·∫øn ngu·ªìn t√†i li·ªáu c·ª• th·ªÉ">
                    </div>

                    <!-- Q15: Ng√¥n ng·ªØ t√†i li·ªáu -->
                    <div class="form-group">
                        <label class="form-label">15. Ng√¥n ng·ªØ t√†i li·ªáu? *</label>
                        <select class="form-select" name="q17_material_language" required>
                            <option value="">-- Ch·ªçn --</option>
                            <option value="Vi·ªát Nam">Vi·ªát Nam</option>
                            <option value="English">English</option>
                            <option value="Vi·ªát Nam & English">Vi·ªát Nam & English</option>
                        </select>
                    </div>

                    <!-- Q16: Lo·∫°i ƒë√°nh gi√° -->
                    <div class="form-group">
                        <label class="form-label">16. Lo·∫°i ƒë√°nh gi√° b·∫°n th√≠ch? *</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="q18_assessment_types[]" value="Quiz ng·∫Øn"> Quiz ng·∫Øn</label>
                            <label><input type="checkbox" name="q18_assessment_types[]" value="D·ª± √°n nh·ªè"> D·ª± √°n nh·ªè</label>
                            <label><input type="checkbox" name="q18_assessment_types[]" value="B√†i ki·ªÉm tra"> B√†i ki·ªÉm tra</label>
                            <label><input type="checkbox" name="q18_assessment_types[]" value="ƒê·ªÅ thi chu·∫©n"> ƒê·ªÅ thi chu·∫©n</label>
                        </div>
                    </div>

                    <!-- Q17: Hi·ªÉn th·ªã k·∫øt qu·∫£ -->
                    <div class="form-group">
                        <label class="form-label">17. Hi·ªÉn th·ªã k·∫øt qu·∫£ nh∆∞ th·∫ø n√†o? *</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="q19_result_display[]" value="Bi·ªÉu ƒë·ªì"> Ti·∫øn ƒë·ªô</label>
                            <label><input type="checkbox" name="q19_result_display[]" value="Bi·ªÉu ƒë·ªì"> Bi·ªÉu ƒë·ªì</label>
                            <label><input type="checkbox" name="q19_result_display[]" value="S·ªë ƒëi·ªÉm"> S·ªë ƒëi·ªÉm</label>
                            <label><input type="checkbox" name="q19_result_display[]" value="Ph·∫£n h·ªìi chi ti·∫øt"> Ph·∫£n h·ªìi chi ti·∫øt</label>
                        </div>
                    </div>

                    <!-- Q18: T·∫ßn su·∫•t ƒë√°nh gi√° -->
                    <div class="form-group">
                        <label class="form-label">18. T·∫ßn su·∫•t ƒë√°nh gi√°? *</label>
                        <div class="checkbox-group">
                            <label><input type="radio" name="q20_assessment_frequency" value="H√†ng tu·∫ßn"> H√†ng tu·∫ßn</label>
                            <label><input type="radio" name="q20_assessment_frequency" value="H√†ng th√°ng"> H√†ng th√°ng</label>
                            <label><input type="radio" name="q20_assessment_frequency" value="2 tu·∫ßn/l·∫ßn"> 2 tu·∫ßn/l·∫ßn</label>
                            <label><input type="radio" name="q20_assessment_frequency" value="Kh√°c" id="q20_other_radio"> Kh√°c</label>
                        </div>
                        <input type="text" id="q20_other_text" class="form-input other-input" name="q20_assessment_frequency_other"
                            placeholder="Ghi r√µ...">
                    </div>
                </div>

                <!-- PH·∫¶N T·∫†O V·ªöI AI -->
                <div class="form-section ai-generate-section">
                    <h3 class="section-title">ü§ñ T·∫°o L·ªô Tr√¨nh</h3>
                    <div class="ai-notice">
                        <strong>‚ö†Ô∏è B·∫Øt bu·ªôc:</strong> B·∫°n PH·∫¢I nh·∫•n n√∫t n√†y tr∆∞·ªõc khi c√≥ th·ªÉ t·∫°o l·ªô tr√¨nh.
                    </div>
                    <button type="button" id="generateAI" class="ai-btn">
                    <span id="generateBtnText">ü§ñ T·∫°o l·ªô tr√¨nh v·ªõi AI</span>
                    </button>
                </div>
                <div class="analysis-section">
                    <h3>üìä PH√ÇN T√çCH HI·ªÜN TR·∫†NG</h3>
                    <div class="analysis-content" id="analysisContent">
                        <!-- AI generated analysis will be displayed here -->
                    </div>
                </div>
                <!-- PH·∫¶N CHI TI·∫æT NG√ÄY H·ªåC -->
                <div class="form-section">
                    <h3 class="section-title">üìÖ Chi Ti·∫øt L·ªô Tr√¨nh</h3>
                    <div id="daysContainer" class="days-container"></div>
                    <button type="button" id="addDayBtn" class="add-day-btn">‚ûï Th√™m Ng√†y H·ªçc</button>
                </div>

                <!-- N√öT SUBMIT -->
                <div class="submit-section">
                    <button type="submit" class="submit-btn" id="submitBtn" disabled>
                        <span id="submit-btn-text">‚è≥ Vui l√≤ng t·∫°o v·ªõi AI tr∆∞·ªõc</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL XEM PROMPT -->
    <div id="promptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Prompt AI</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>

            <div class="modal-body">
                <div style="background: #fee2e2; border-left: 4px solid #dc2626; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="color: #dc2626; font-weight: 600; margin: 0; line-height: 1.6;">
                        ‚ö†Ô∏è B·∫°n h√£y t√πy bi·∫øn l·∫°i prompt m·∫´u theo nhu c·∫ßu c·ªßa b·∫°n, r·ªìi b·∫°n g·ª≠i prompt cho AI ƒë·ªÉ c√≥ ƒë∆∞·ª£c 1 k·∫øt qu·∫£ g·ªìm th√¥ng tin ƒë√°nh gi√° hi·ªán tr·∫°ng v√† b·∫£ng chi ti·∫øt l·ªô tr√¨nh h·ªçc g·ªìm 8 c·ªôt ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng "Upload Excel" t·∫°o l·ªô tr√¨nh h·ªçc c√° nh√¢n h√≥a.
                    </p>
                </div>
                <pre id="promptContent"></pre>
                
                <!-- ‚úÖ DI CHUY·ªÇN N√öT V√ÄO ƒê√ÇY -->
                <div style="margin-top: 20px;">
                    <button onclick="copyPrompt()" class="prompt-btn" style="width: auto; padding: 12px 24px;">
                        üìã Copy Prompt
                    </button>
                </div>
            </div>
        </div>
    </div>

<div id="footer"></div>
</body>
    <script>
// ‚úÖ TH√äM H√ÄM N√ÄY NGAY SAU KHAI B√ÅO BI·∫æN GLOBAL (sau d√≤ng let categoriesData = [];)
function removeDiacritics(str) {
    return str.normalize('NFD')
              .replace(/[\u0300-\u036f]/g, '')
              .toLowerCase();
}
function validateAllQuestions() {
    const errors = [];
    
    // Q1: T√™n l·ªô tr√¨nh
    const q1 = document.querySelector('input[name="q1_roadmap_name"]');
    if (!q1 || !q1.value.trim()) {
        errors.push('C√¢u t√™n l·ªô tr√¨nh');
    }
    
    // Q2: Danh m·ª•c
    const q2 = document.querySelector('input[name="q2_category"]:checked');
    if (!q2 || ((q2.value === 'Kh√°c' || q2.value === 'Other') && !document.getElementById('q2_other_text')?.value.trim())) {
        errors.push('C√¢u danh m·ª•c');
    }
    
    // Q3: Danh m·ª•c chi ti·∫øt (radio ho·∫∑c text)
    const q3_radio = document.querySelector('input[name="q3_category_detail"]:checked');
    const q3_text = document.querySelector('input[name="q3_category_detail"][type="text"]');
    const q3_other = document.getElementById('q3_other_text');

    let q3_valid = false;

    if (q3_radio) {
        // ‚úÖ Ch·ªçn radio
        if (q3_radio.value === 'Kh√°c') {
            // ‚úÖ Ch·ªçn "Kh√°c" ‚Üí ph·∫£i ƒëi·ªÅn input
            q3_valid = q3_other && q3_other.value.trim() !== '';
        } else {
            // ‚úÖ Ch·ªçn sub-category c√≥ s·∫µn
            q3_valid = true;
        }
    } else if (q3_text) {
        // ‚úÖ Input text tr·ª±c ti·∫øp (khi kh√¥ng c√≥ sub-categories)
        q3_valid = q3_text.value.trim() !== '';
    }

    if (!q3_valid) {
        errors.push('C√¢u danh m·ª•c chi ti·∫øt');
    }
    
    // Q4: M·ª•c ƒë√≠ch ch√≠nh
    const q4 = document.querySelector('input[name="q4_main_purpose"]:checked');
    if (!q4 || ((q4.value === 'Kh√°c' || q4.value === 'Other') && !document.getElementById('q4_other_text')?.value.trim())) {
        errors.push('C√¢u m·ª•c ƒë√≠ch ch√≠nh');
    }
    // Q5: M·ª•c ti√™u c·ª• th·ªÉ
    const q5_goal = document.querySelector('textarea[name="q5_specific_goal"]');
    if (!q5_goal || !q5_goal.value.trim()) {
        errors.push('C√¢u m·ª•c ti√™u c·ª• th·ªÉ');
    }
    
    // Q5: C√¥ng vi·ªác hi·ªán t·∫°i
    const q5_job = document.querySelector('input[name="q5_current_job"]');
    if (!q5_job || !q5_job.value.trim()) {
        errors.push('C√¢u c√¥ng vi·ªác hi·ªán t·∫°i');
    }
    
    // Q6: Th·ªùi gian ƒë√£ h·ªçc
    const q6 = document.querySelector('select[name="q6_learning_duration"]');
    if (!q6 || !q6.value) {
        errors.push('C√¢u th·ªùi gian ƒë√£ h·ªçc');
    }
    
    // Q7: Tr√¨nh ƒë·ªô hi·ªán t·∫°i
    const q7 = document.querySelector('select[name="q7_current_level"]');
    if (!q7 || !q7.value) {
        errors.push('C√¢u tr√¨nh ƒë·ªô hi·ªán t·∫°i');
    }
    
    // Q8: K·ªπ nƒÉng mu·ªën c·∫£i thi·ªán
    const q8 = document.querySelector('input[name="q8_skills_text"]');
    if (!q8 || !q8.value.trim()) {
        errors.push('C√¢u k·ªπ nƒÉng mu·ªën c·∫£i thi·ªán');
    }
    
    // Q9: Th·ªùi gian h·ªçc m·ªói ng√†y
    const q9 = document.getElementById('q9_daily_time_input');
    if (!q9 || !q9.value || parseInt(q9.value) < 15 || parseInt(q9.value) > 720) {
        errors.push('C√¢u th·ªùi gian h·ªçc m·ªói ng√†y');
    }
    
    // Q10: S·ªë bu·ªïi m·ªói tu·∫ßn
    const q10 = document.querySelector('select[name="q10_weekly_sessions"]');
    if (!q10 || !q10.value) {
        errors.push('C√¢u s·ªë bu·ªïi m·ªói tu·∫ßn');
    }
    
    // Q11: Th·ªùi gian l·ªô tr√¨nh
    const q11 = document.getElementById('q11_program_days');
    if (!q11 || !q11.value || parseInt(q11.value) < 15 || parseInt(q11.value) > 90) {
        errors.push('C√¢u th·ªùi gian l·ªô tr√¨nh');
    }
    
    // Q12: Ph∆∞∆°ng ph√°p h·ªçc
    const q12 = document.querySelectorAll('input[name="q12_learning_styles[]"]:checked, input[name="q12_learning_styles"]:checked');
    if (q12.length === 0) {
        errors.push('C√¢u ph∆∞∆°ng ph√°p h·ªçc');
    }
    // Q13: K·∫øt h·ª£p h·ªçc
    const q13 = document.querySelectorAll('input[name="q13_learning_combinations[]"]:checked, input[name="q13_learning_combinations"]:checked');
    const q13Other = document.getElementById('q13_other_text');
    if (q13.length === 0 && !(q13Other && q13Other.value.trim())) {
        errors.push('C√¢u k·∫øt h·ª£p h·ªçc');
    }

    // Q14: Th√°ch th·ª©c
    const q14 = document.querySelectorAll('input[name="q14_challenges[]"]:checked, input[name="q14_challenges"]:checked');
    const q14Other = document.getElementById('q14_other_text');
    if (q14.length === 0 && !(q14Other && q14Other.value.trim())) {
        errors.push('C√¢u th√°ch th·ª©c');
    }

    // Q15: ƒê·ªông l·ª±c
    const q15 = document.querySelectorAll('input[name="q15_motivation[]"]:checked, input[name="q15_motivation"]:checked');
    const q15Other = document.getElementById('q15_other_text');
    if (q15.length === 0 && !(q15Other && q15Other.value.trim())) {
        errors.push('C√¢u ƒë·ªông l·ª±c');
    }

    // Q16: Lo·∫°i t√†i li·ªáu
    const q16 = document.querySelectorAll('input[name="q16_material_types[]"]:checked, input[name="q16_material_types"]:checked');
    const q16Other = document.getElementById('q16_other_text');
    if (q16.length === 0 && !(q16Other && q16Other.value.trim())) {
        errors.push('C√¢u lo·∫°i t√†i li·ªáu');
    }

    // Q17: Ng√¥n ng·ªØ t√†i li·ªáu
    const q17 = document.querySelector('select[name="q17_material_language"]');
    if (!q17 || !q17.value) {
        errors.push('C√¢u ng√¥n ng·ªØ t√†i li·ªáu');
    }

    // Q18: Lo·∫°i ƒë√°nh gi√°
    const q18 = document.querySelectorAll('input[name="q18_assessment_types[]"]:checked, input[name="q18_assessment_types"]:checked');
    if (q18.length === 0) {
        errors.push('C√¢u lo·∫°i ƒë√°nh gi√°');
    }

    // Q19: Hi·ªÉn th·ªã k·∫øt qu·∫£
    const q19 = document.querySelectorAll('input[name="q19_result_display[]"]:checked, input[name="q19_result_display"]:checked');
    if (q19.length === 0) {
        errors.push('C√¢u hi·ªÉn th·ªã k·∫øt qu·∫£');
    }

    // Q20: T·∫ßn su·∫•t ƒë√°nh gi√°
    const q20 = document.querySelector('input[name="q20_assessment_frequency"]:checked');
    const q20Other = document.getElementById('q20_other_text');
    if (!q20) {
        errors.push('C√¢u t·∫ßn su·∫•t ƒë√°nh gi√°');
    } else if ((q20.value === 'Kh√°c' || q20.value === 'Khac' || q20.value === 'Other') && !(q20Other && q20Other.value.trim())) {
        errors.push('C√¢u t·∫ßn su·∫•t ƒë√°nh gi√° (vui l√≤ng ƒëi·ªÅn "Kh√°c")');
    }

    // Cu·ªëi c√πng: hi·ªÉn th·ªã c√°c l·ªói n·∫øu c√≥
    if (errors.length > 0) {
        // Alert ra c√°c value trong m·∫£ng errors (m·ªói d√≤ng 1 l·ªói)
        alert('Vui l√≤ng ki·ªÉm tra c√°c c√¢u sau:\n' + errors.join('\n'));
        return errors;
    }

    return [];
}
function attachOtherEventsForQ2() {
    const q2_other_radio = document.getElementById('q2_other_radio');
    const q2_other_text = document.getElementById('q2_other_text');
    
    if (!q2_other_radio || !q2_other_text) {
        console.warn('Q2 elements not found');
        return;
    }

    // Ban ƒë·∫ßu ·∫©n input
    q2_other_text.style.display = 'none';
    
    // Khi ch·ªçn "Kh√°c" - hi·ªÉn th·ªã input
    q2_other_radio.addEventListener('change', () => {
        if (q2_other_radio.checked) {
            q2_other_text.style.display = 'block';
            setTimeout(() => q2_other_text.focus(), 60);
        }
    });
    
    // Khi ch·ªçn radio kh√°c - ·∫©n input v√† clear
    document.querySelectorAll('input[name="q2_category"]').forEach(radio => {
        if (radio !== q2_other_radio) {
            radio.addEventListener('change', () => {
                q2_other_text.style.display = 'none';
                q2_other_text.value = '';
            });
        }
    });
}
        const MAX_AI_DAYS = 90;
        let dayCount = 0;
        let isGenerating = false;
        let categoriesData = [];

        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = `Bearer ${token}`;
            return headers;
        }
async function loadCategories() {
    const container = document.getElementById('q2_category_container');
    if (!container) return;
    
    // T·∫°o custom dropdown
    container.innerHTML = `
        <label class="form-label">Danh m·ª•c *</label>
        <div class="custom-select-wrapper">
            <div class="custom-select-trigger" id="category-trigger">
                <span id="category-selected">-- Ch·ªçn danh m·ª•c --</span>
                <span>‚ñº</span>
            </div>
            <div class="custom-select-dropdown" id="category-dropdown">
                <div class="custom-select-search">
                    <input type="text" placeholder="üîç T√¨m ki·∫øm danh m·ª•c..." id="category-search-input">
                </div>
                <div class="custom-select-options" id="category-options">
                    <div class="custom-select-option disabled">ƒêang t·∫£i...</div>
                </div>
            </div>
            <input type="hidden" name="q2_category" id="q2_category_hidden" required>
            <input type="hidden" id="q2_category_name">
        </div>
    `;
    
    try {
        const response = await fetch('/api/categories', getAuthHeaders());
        if (!response.ok) throw new Error('Failed to load');
        
        const data = await response.json();
        if (!data?.success || !Array.isArray(data.data)) throw new Error('Invalid data');
        
        const categories = data.data;
        
        // Render options
        renderCategoryOptionsForCreate(categories, categories);
        
        // Setup events
        setupCustomSelectForCreate(
            'category-trigger',
            'category-dropdown',
            'category-search-input',
            'category-options',
            'category-selected',
            'q2_category_hidden',
            'q2_category_name',
            categories,
            renderCategoryOptionsForCreate,
            (categoryId) => {
                if (categoryId === 'Kh√°c') {
                    const subContainer = document.getElementById('q3_subCategoryContainer');
                    if (subContainer) {
                        subContainer.innerHTML = '<input type="text" name="q3_category_detail" class="form-input" required placeholder="Nh·∫≠p danh m·ª•c chi ti·∫øt...">';
                    }
                } else {
                    loadSubCategoriesForCreate(categoryId);
                }
            }
        );
        
    } catch (err) {
        console.error('Error loading categories:', err);
        document.getElementById('category-options').innerHTML = 
            '<div class="custom-select-option disabled">‚ùå L·ªói t·∫£i danh m·ª•c</div>';
    }
}

function renderCategoryOptionsForCreate(allCategories, filteredCategories) {
    const optionsContainer = document.getElementById('category-options');
    
    // ‚úÖ FIX: B·ªè d·∫•u khi so s√°nh
    const searchInput = document.getElementById('category-search-input');
    const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
    const showKhac = !searchTerm || removeDiacritics('kh√°c').includes(removeDiacritics(searchTerm));
    
    if (filteredCategories.length === 0 && !showKhac) {
        optionsContainer.innerHTML = '<div class="custom-select-option disabled">‚ùå Kh√¥ng t√¨m th·∫•y</div>';
        return;
    }
    
    let html = '';
    filteredCategories.forEach(cat => {
        html += `
            <div class="custom-select-option" 
                 data-value="${cat.id}" 
                 data-name="${escapeHtml(cat.name)}">
                ${escapeHtml(cat.name)}
            </div>
        `;
    });
    
    // ‚úÖ CH·ªà TH√äM N·∫æU MATCH
    if (showKhac) {
        html += `
            <div class="custom-select-option" 
                 data-value="Kh√°c" 
                 data-name="Kh√°c">
                Kh√°c
            </div>
        `;
    }
    
    optionsContainer.innerHTML = html;
}
function setupCustomSelectForCreate(triggerId, dropdownId, searchInputId, optionsId, selectedId, hiddenInputId, hiddenNameId, allData, renderFunction, onSelectCallback) {
    const trigger = document.getElementById(triggerId);
    const dropdown = document.getElementById(dropdownId);
    const searchInput = document.getElementById(searchInputId);
    const optionsContainer = document.getElementById(optionsId);
    const selectedSpan = document.getElementById(selectedId);
    const hiddenInput = document.getElementById(hiddenInputId);
    const hiddenName = document.getElementById(hiddenNameId);
    
    if (!trigger || !dropdown) return;
    
    // Toggle dropdown
    trigger.addEventListener('click', () => {
        dropdown.classList.toggle('active');
        trigger.classList.toggle('active');
        
        if (dropdown.classList.contains('active')) {
            searchInput.focus();
        }
    });
    
    // Close khi click ngo√†i
    document.addEventListener('click', (e) => {
        if (!trigger.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.remove('active');
            trigger.classList.remove('active');
        }
    });
    
    // T√¨m ki·∫øm
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        
        if (!searchTerm) {
            renderFunction(allData, allData);
            return;
        }
        
        // ‚úÖ FIX: B·ªè d·∫•u khi t√¨m ki·∫øm
        const normalizedSearch = removeDiacritics(searchTerm);
        
        const filtered = allData.filter(item => 
            removeDiacritics(item.name.toLowerCase()).includes(normalizedSearch)
        );
        
        renderFunction(allData, filtered);
    });
    
    // Ch·ªçn option
    optionsContainer.addEventListener('click', (e) => {
        const option = e.target.closest('.custom-select-option');
        
        if (!option || option.classList.contains('disabled')) return;
        
        const value = option.dataset.value;
        const name = option.dataset.name;
        
        // Update UI
        selectedSpan.textContent = name;
        hiddenInput.value = value;
        if (hiddenName) hiddenName.value = name;
        
        // Highlight selected
        optionsContainer.querySelectorAll('.custom-select-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        option.classList.add('selected');
        
        // Close dropdown
        dropdown.classList.remove('active');
        trigger.classList.remove('active');
        
        // Reset search
        searchInput.value = '';
        renderFunction(allData, allData);
        
        // Callback
        if (onSelectCallback) {
            onSelectCallback(value);
        }
    });
}

// ============ H√ÄM LOAD SUB-CATEGORIES ============
// TH√äM SAU h√†m loadCategories()

async function loadSubCategories(categoryId) {
  const container = document.getElementById('q3_subCategoryContainer');
  
  if (!categoryId || categoryId === 'Kh√°c' || categoryId === 'Other') {
    // ‚úÖ N·∫øu ch·ªçn "Kh√°c" ·ªü Q2 ‚Üí ch·ªâ hi·ªán input text
    container.innerHTML = `
      <input type="text" 
             name="q3_category_detail" 
             class="form-input" 
             required
             placeholder="Nh·∫≠p danh m·ª•c chi ti·∫øt...">
    `;
    return;
  }
  
  // ‚úÖ Hi·ªán loading
  container.innerHTML = `
    <div class="loading">
      <div class="spinner"></div>
      <span>ƒêang t·∫£i danh m·ª•c con...</span>
    </div>
  `;
  
  try {
    const response = await fetch(`/api/categories/${categoryId}/sub-categories`, {
      headers: getAuthHeaders()
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    
    if (!data?.success) {
      throw new Error('D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá');
    }
    
    const subCategories = data.data || [];
    
    if (subCategories.length === 0) {
      // ‚úÖ Kh√¥ng c√≥ danh m·ª•c con ‚Üí ch·ªâ hi·ªán input text
      container.innerHTML = `
        <input type="text" 
               name="q3_category_detail" 
               class="form-input" 
               required
               placeholder="Nh·∫≠p danh m·ª•c chi ti·∫øt...">
      `;
      return;
    }
    
    // ‚úÖ C√≥ danh m·ª•c con ‚Üí hi·ªán radio buttons
    let html = '<div class="checkbox-group">';
    
    subCategories.forEach(sub => {
      html += `
        <label>
          <input type="radio" 
                 name="q3_category_detail" 
                 value="${escapeHtml(sub.name)}" 
                 required>
          ${escapeHtml(sub.name)}
        </label>
      `;
    });
    
    // ‚úÖ Th√™m l·ª±a ch·ªçn "Kh√°c"
    html += `
      <label>
        <input type="radio" 
               name="q3_category_detail" 
               value="Kh√°c" 
               id="q3_other_radio" 
               required>
        Kh√°c
      </label>
    `;
    
    html += '</div>';
    
    // ‚úÖ Th√™m input "Kh√°c" (·∫©n m·∫∑c ƒë·ªãnh)
    html += `
      <input type="text" 
             id="q3_other_text" 
             class="form-input other-input" 
             name="q3_category_detail_other"
             placeholder="Ghi r√µ danh m·ª•c chi ti·∫øt..."
             style="display:none; margin-top:10px;">
    `;
    
    container.innerHTML = html;
    
    // ‚úÖ Setup toggle cho "Kh√°c"
    setupQ3OtherToggle();
    
  } catch (err) {
    console.error('Error loading sub-categories:', err);
    container.innerHTML = `
      <div class="error-message">
        ‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i danh m·ª•c con. Vui l√≤ng th·ª≠ l·∫°i.
      </div>
      <input type="text" 
             name="q3_category_detail" 
             class="form-input" 
             required
             placeholder="Nh·∫≠p danh m·ª•c chi ti·∫øt...">
    `;
  }
}

// ============ SETUP TOGGLE CHO "KH√ÅC" ·ªû Q3 ============
function setupQ3OtherToggle() {
  const otherRadio = document.getElementById('q3_other_radio');
  const otherInput = document.getElementById('q3_other_text');
  
  if (!otherRadio || !otherInput) return;
  
  // ‚úÖ Khi ch·ªçn "Kh√°c" ‚Üí hi·ªán input
  otherRadio.addEventListener('change', () => {
    if (otherRadio.checked) {
      otherInput.style.display = 'block';
      setTimeout(() => otherInput.focus(), 60);
    }
  });
  
  // ‚úÖ Khi ch·ªçn option kh√°c ‚Üí ·∫©n input
  document.querySelectorAll('input[name="q3_category_detail"]').forEach(radio => {
    if (radio !== otherRadio) {
      radio.addEventListener('change', () => {
        otherInput.style.display = 'none';
        otherInput.value = '';
      });
    }
  });
}

// ============ ATTACH EVENT CHO Q2 ============
// TH√äM SAU h√†m setupQ3OtherToggle()
function attachQ2ChangeEvent() {
  document.querySelectorAll('input[name="q2_category"]').forEach(radio => {
    radio.addEventListener('change', async () => {
      if (radio.checked) {
        const categoryId = radio.value;
        await loadSubCategories(categoryId);
      }
    });
  });
}
async function loadSubCategoriesForCreate(categoryId) {
    const container = document.getElementById('q3_subCategoryContainer');
    if (!container) return;
    
    if (!categoryId || categoryId === 'Kh√°c') {
        container.innerHTML = '<input type="text" name="q3_category_detail" class="form-input" required placeholder="Nh·∫≠p danh m·ª•c chi ti·∫øt...">';
        return;
    }
    
    container.innerHTML = `
        <div class="custom-select-wrapper">
            <div class="custom-select-trigger" id="sub-category-trigger">
                <span id="sub-category-selected">-- Ch·ªçn danh m·ª•c chi ti·∫øt --</span>
                <span>‚ñº</span>
            </div>
            <div class="custom-select-dropdown" id="sub-category-dropdown">
                <div class="custom-select-search">
                    <input type="text" placeholder="üîç T√¨m ki·∫øm..." id="sub-category-search-input">
                </div>
                <div class="custom-select-options" id="sub-category-options">
                    <div class="custom-select-option disabled">ƒêang t·∫£i...</div>
                </div>
            </div>
            <input type="hidden" name="q3_category_detail" id="q3_category_detail_hidden" required>
        </div>
        <input type="text" 
               id="q3_other_text" 
               class="form-input other-input" 
               name="q3_category_detail_other"
               placeholder="Ghi r√µ danh m·ª•c chi ti·∫øt..."
               style="display:none; margin-top:10px;">
    `;
    
    try {
        const response = await fetch(`/api/categories/${categoryId}/sub-categories`, {
            headers: getAuthHeaders()
        });
        
        if (!response.ok) throw new Error('Failed');
        
        const data = await response.json();
        if (!data?.success) throw new Error('Invalid');
        
        const subCategories = data.data || [];
        
        renderSubCategoryOptionsForCreate(subCategories, subCategories);
        
        setupCustomSelectForCreate(
            'sub-category-trigger',
            'sub-category-dropdown',
            'sub-category-search-input',
            'sub-category-options',
            'sub-category-selected',
            'q3_category_detail_hidden',
            null,
            subCategories,
            renderSubCategoryOptionsForCreate,
            (value) => {
                const otherInput = document.getElementById('q3_other_text');
                if (value === 'Kh√°c') {
                    otherInput.style.display = 'block';
                    otherInput.required = true;
                    setTimeout(() => otherInput.focus(), 100);
                } else {
                    otherInput.style.display = 'none';
                    otherInput.required = false;
                    otherInput.value = '';
                }
            }
        );
        
    } catch (err) {
        console.error('Error:', err);
        container.innerHTML = `
            <div class="error-message">‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i danh m·ª•c con</div>
            <input type="text" name="q3_category_detail" class="form-input" required placeholder="Nh·∫≠p danh m·ª•c chi ti·∫øt...">
        `;
    }
}

function renderSubCategoryOptionsForCreate(allSubCategories, filteredSubCategories) {
    const optionsContainer = document.getElementById('sub-category-options');
    
    // ‚úÖ FIX: B·ªè d·∫•u khi so s√°nh
    const searchInput = document.getElementById('sub-category-search-input');
    const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
    const showKhac = !searchTerm || removeDiacritics('kh√°c').includes(removeDiacritics(searchTerm));
    
    if (filteredSubCategories.length === 0 && !showKhac) {
        optionsContainer.innerHTML = '<div class="custom-select-option disabled">‚ùå Kh√¥ng t√¨m th·∫•y</div>';
        return;
    }
    
    let html = '';
    filteredSubCategories.forEach(sub => {
        html += `
            <div class="custom-select-option" 
                 data-value="${escapeHtml(sub.name)}" 
                 data-name="${escapeHtml(sub.name)}">
                ${escapeHtml(sub.name)}
            </div>
        `;
    });
    
    // ‚úÖ CH·ªà TH√äM N·∫æU MATCH
    if (showKhac) {
        html += `
            <div class="custom-select-option" 
                 data-value="Kh√°c" 
                 data-name="Kh√°c">
                Kh√°c
            </div>
        `;
    }
    
    optionsContainer.innerHTML = html;
}

function renderCategories(categories) {
    const container = document.getElementById('q2_categoryGroup'); // ‚úÖ FIXED: ƒê√∫ng ID
    
    if (!categories || categories.length === 0) {
        container.innerHTML = '<p style="color: #6b7280;">Ch∆∞a c√≥ danh m·ª•c n√†o</p>';
        container.insertAdjacentHTML('beforeend', `
          <label>
            <input type="radio" name="q2_category" value="Kh√°c" id="q2_other_radio">
            <span>Kh√°c</span>
          </label>
          <input type="text" id="q2_other_text" class="form-input other-input" 
                 placeholder="Ghi r√µ danh m·ª•c..." style="display:none; margin-top:10px;">
        `);
        setupCategoryOtherToggle(); // ‚úÖ FIXED: Setup ri√™ng cho Q2
        return;
    }
    
    // ‚úÖ FIXED: T·∫°o RADIO (kh√¥ng ph·∫£i checkbox)
    const html = categories.map(cat => `
        <label>
            <input type="radio" name="q2_category" value="${escapeHtml(cat.name)}" required>
            <span>${escapeHtml(cat.name)}</span>
        </label>
    `).join('');
    
    container.innerHTML = html;

    // ‚úÖ FIXED: Th√™m radio "Kh√°c" cho Q2
    container.insertAdjacentHTML('beforeend', `
      <label>
        <input type="radio" name="q2_category" value="Kh√°c" id="q2_other_radio">
        <span>Kh√°c</span>
      </label>
      <input type="text" id="q2_other_text" class="form-input other-input" 
             placeholder="Ghi r√µ danh m·ª•c..." style="display:none; margin-top:10px;">
    `);

    setupCategoryOtherToggle(); // ‚úÖ FIXED
}
function setupCategoryOtherToggle() {
    const otherRadio = document.getElementById('q2_other_radio');
    const otherInput = document.getElementById('q2_other_text');
    if (!otherRadio || !otherInput) return;
    
    // Khi ch·ªçn "Kh√°c" ‚Üí hi·ªán input
    otherRadio.addEventListener('change', () => {
        if (otherRadio.checked) {
            otherInput.style.display = 'block';
            setTimeout(() => otherInput.focus(), 60);
        }
    });
    
    // Khi ch·ªçn option kh√°c ‚Üí ·∫©n input
    document.querySelectorAll('input[name="q2_category"]').forEach(radio => {
        if (radio !== otherRadio) {
            radio.addEventListener('change', () => {
                otherInput.style.display = 'none';
                otherInput.value = '';
            });
        }
    });
}
// ‚úÖ TH√äM H√ÄM L·∫§Y MAX DAYS THEO ROLE
async function getMaxDaysForCurrentUser() {
  try {
    const token = localStorage.getItem('token');
    if (!token) return 360; // Default cho user ch∆∞a ƒëƒÉng nh·∫≠p
    
    const response = await fetch('/api/me', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (!response.ok) return 360;
    
    const data = await response.json();
    const role = data.user?.role || 'user';
    
    return role === 'admin' ? 60 : 360;
  } catch {
    return 360; // Fallback
  }
}
// ‚úÖ H√†m c·∫≠p nh·∫≠t label v√† max days theo role
async function updateDaysUIByRole() {
    const maxDays = await getMaxDaysForCurrentUser();
    const label = document.getElementById('q11_label');
    const input = document.getElementById('q11_program_days');
    const warning = document.getElementById('daysWarning');
    
    if (label) {
        label.textContent = `9. Th·ªùi gian (ng√†y) c·ªßa l·ªô tr√¨nh (15 - ${maxDays} ng√†y) *`;
    }
    
    if (input) {
        input.setAttribute('max', maxDays);
        input.setAttribute('placeholder', `Nh·∫≠p s·ªë ng√†y (15 - ${maxDays})`);
    }
    
    if (warning) {
        warning.textContent = `‚ö†Ô∏è S·ªë ng√†y t·ªëi ƒëa: ${maxDays}. N·∫øu b·∫°n mu·ªën h∆°n ${maxDays} ng√†y, vui l√≤ng t·∫°o th·ªß c√¥ng.`;
    }
}
// ‚úÖ C·∫¨P NH·∫¨T H√ÄM validateDays()
// ‚úÖ C·∫≠p nh·∫≠t h√†m validateDays()
async function validateDays() {
  const daysInput = document.getElementById('q11_program_days');
  const aiBtn = document.getElementById('generateAI');
  const warning = document.getElementById('daysWarning');
  
  if (!daysInput || !aiBtn || !warning) return;
  
  const days = parseInt(daysInput.value);
  const maxDays = await getMaxDaysForCurrentUser(); // ‚úÖ L·∫•y ƒë·ªông
  
  // ‚úÖ TH√äM: N·∫øu input tr·ªëng, ·∫©n warning v√† return
  if (!daysInput.value || daysInput.value.trim() === '') {
    warning.style.display = 'none';
    aiBtn.disabled = true; // V·∫´n disable n√∫t v√¨ ch∆∞a nh·∫≠p
    return;
  }
  
  if (isNaN(days) || days < 15 || days > maxDays) {
    aiBtn.disabled = true;
    warning.style.display = 'block';
    
    if (days > maxDays) {
      warning.textContent = `‚ö†Ô∏è Vui l√≤ng nh·∫≠p s·ªë ng√†y t·ª´ ${maxDays} tr·ªü xu·ªëng.`;
    } else if (days < 15) {
      warning.textContent = '‚ö†Ô∏è Vui l√≤ng nh·∫≠p s·ªë ng√†y t·ª´ 15 tr·ªü l√™n.';
    }
  } else {
    aiBtn.disabled = false;
    warning.style.display = 'none';
  }
}
    function validateMinutes() {
    const minutesInput = document.getElementById('q9_daily_time_input');
    const warning = document.getElementById('minutesWarning');

    if (!minutesInput || !warning) return;

    const minutes = parseInt(minutesInput.value);
    
    // ‚úÖ Ch·ªâ validate khi ƒë√£ nh·∫≠p gi√° tr·ªã
    if (minutesInput.value === '' || minutesInput.value === null) {
        warning.style.display = 'none';
        return;
    }
    
    if (isNaN(minutes) || minutes < 15 || minutes > 720) {
        warning.style.display = 'block';
        if (minutes > 720) {
            warning.textContent = '‚ö†Ô∏è Th·ªùi gian t·ªëi ƒëa l√† 720 ph√∫t (12 gi·ªù).';
        } else if (minutes < 15) {
            warning.textContent = '‚ö†Ô∏è Th·ªùi gian t·ªëi thi·ªÉu l√† 15 ph√∫t.';
        }
    } else {
        warning.style.display = 'none';
    }
}
function updateTotalHours() {
        const daysInput = document.getElementById('q11_program_days');
        const hoursInput = document.querySelector('select[name="q9_daily_time"]');

        if (daysInput && daysInput.value && hoursInput && hoursInput.value) {
            const hours = parseFloat(hoursInput.value.split('-')[0] || '2');
            const total = parseInt(daysInput.value) * hours;
            console.log(`Total hours: ${total}`);
        }
    }
    let aiHistoryId = null;
async function generateRoadmapWithAI() {
    // Run full-form validation first; if errors exist, abort and let validateAllQuestions() alert them
    try {
        const validationErrors = validateAllQuestions();
        if (validationErrors && validationErrors.length > 0) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            return; // stop further processing
        }
    } catch (ve) {
        console.error('Validation function threw:', ve);
        alert('L·ªói khi ki·ªÉm tra form: ' + (ve && ve.message ? ve.message : ve));
        return;
    }

    const generateBtn = document.getElementById('generateAI');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submit-btn-text');

    // Disable buttons
    generateBtn.disabled = true;
    submitBtn.disabled = true;  // Unclickable khi ƒëang generate
    generateBtn.innerHTML = '<div class="loading"><div class="spinner"></div> ƒêang t·∫°o...</div>';
    submitText.innerHTML = '<div class="loading"><div class="spinner"></div> ƒêang ch·ªù AI...</div>';
    
    if (typeof isGenerating !== 'undefined' && isGenerating) return;

    const form = document.getElementById('roadmapForm');
    if (!form) {
        showNotification('Kh√¥ng t√¨m th·∫•y form roadmap.', 'error');
        return;
    }

    const formData = new FormData(form);

    // helpers
    const getField = (fd, name, fallback = '') => {
        const v = fd.get(name);
        return v == null ? fallback : String(v).trim();
    };
    const extractFirstNumber = (str, fallback = 2) => {
        if (!str) return fallback;
        const s = String(str).trim();
        const m = s.match(/(\d+(?:\.\d+)?)/);
        if (m) {
            const num = parseFloat(m[1]);
            if (s.toLowerCase().includes('ph√∫t')) return num / 60;
            return num;
        }
        return fallback;
    };
    const collectChecked = (selectorNames) => {
        const values = [];
        selectorNames.forEach(sel => {
            document.querySelectorAll(sel).forEach(cb => {
                if (cb.checked) values.push(cb.value);
            });
        });
        return values;
    };
    const collectCheckedWithOther = (selectorNames, otherInputId) => {
        const values = [];
        let other = '';
        selectorNames.forEach(sel => {
            document.querySelectorAll(sel).forEach(cb => {
                if (!cb.checked) return;
                if (cb.value === 'Kh√°c' || cb.value === 'Khac' || cb.value === 'Other') {
                    const el = document.getElementById(otherInputId);
                    if (el) other = (el.value || '').trim();
                } else {
                    values.push(cb.value);
                }
            });
        });
        return { values, other };
    };

    // THU TH·∫¨P & X·ª¨ L√ù C√ÅC TR∆Ø·ªúNG (Q1..Q20)
    
    // Q1
    const q1_roadmap_name = getField(formData, 'q1_roadmap_name');

    // Q2
    let q2_category_id = getField(formData, 'q2_category');
    let q2_category = '';
    
    if (q2_category_id === 'Kh√°c' || q2_category_id === 'Khac' || q2_category_id === 'Other') {
      const otherInput = document.getElementById('q2_other_text');
      q2_category = otherInput ? (otherInput.value || '').trim() : '';
    } else {
      const selectedRadio = document.querySelector('input[name="q2_category"]:checked');
      if (selectedRadio) {
        q2_category = selectedRadio.getAttribute('data-category-name') || q2_category_id;
      } else {
        q2_category = q2_category_id;
      }
    }

    // Q3 - X·ª≠ l√Ω danh m·ª•c chi ti·∫øt
    let q3_category_detail = getField(formData, 'q3_category_detail');
    if (q3_category_detail === 'Kh√°c' || q3_category_detail === 'Other') {
        const q3_other = document.getElementById('q3_other_text');
        q3_category_detail = q3_other ? q3_other.value.trim() : '';
    }
    // Q4 main purpose + other
    let q4_main_purpose = getField(formData, 'q4_main_purpose');
    let q4_main_purpose_other = '';
    if (q4_main_purpose === 'Kh√°c' || q4_main_purpose === 'Khac' || q4_main_purpose === 'Other') {
        q4_main_purpose_other = getField(formData, 'q4_main_purpose_other');
    }

    // Q5
    const q5_specific_goal = getField(formData, 'q5_specific_goal');
    const q5_current_job = getField(formData, 'q5_current_job');

    // Q6-Q8
    const q6_learning_duration = getField(formData, 'q6_learning_duration');
    const q7_current_level = getField(formData, 'q7_current_level');
    const q8_skills_text = getField(formData, 'q8_skills_text');

    // Q9-Q11
    const q9_daily_time = getField(formData, 'q9_daily_time');
    const q10_weekly_sessions = getField(formData, 'q10_weekly_sessions');
    const q11_program_days = parseInt(getField(formData, 'q11_program_days') || '0', 10) || 0;

    // Q12..Q16 (checkbox groups with possible "Kh√°c")
    const q12 = collectCheckedWithOther(['input[name="q12_learning_styles[]"]', 'input[name="q12_learning_styles"]'], 'q12_other_text');
    const q12_learning_styles = q12.values;
    const q12_learning_styles_other = q12.other;

    const q13 = collectCheckedWithOther(['input[name="q13_learning_combinations[]"]', 'input[name="q13_learning_combinations"]'], 'q13_other_text');
    const q13_learning_combinations = q13.values;
    const q13_learning_combinations_other = q13.other;

    const q14 = collectCheckedWithOther(['input[name="q14_challenges[]"]', 'input[name="q14_challenges"]'], 'q14_other_text');
    const q14_challenges = q14.values;
    const q14_challenges_other = q14.other;

    const q15 = collectCheckedWithOther(['input[name="q15_motivation[]"]', 'input[name="q15_motivation"]'], 'q15_other_text');
    const q15_motivation = q15.values;
    const q15_motivation_other = q15.other;

    const q16 = collectCheckedWithOther(['input[name="q16_material_types[]"]', 'input[name="q16_material_types"]'], 'q16_other_text');
    const q16_material_types = q16.values;
    const q16_material_types_other = q16.other;

    // Q17-Q19
    const q17_material_language = getField(formData, 'q17_material_language');
    const q18_assessment_types = collectChecked(['input[name="q18_assessment_types[]"]', 'input[name="q18_assessment_types"]']);
    const q19_result_display = collectChecked(['input[name="q19_result_display[]"]', 'input[name="q19_result_display"]']);

    // Q20
    let q20_assessment_frequency = getField(formData, 'q20_assessment_frequency');
    let q20_assessment_frequency_other = '';
    if (q20_assessment_frequency === 'Kh√°c' || q20_assessment_frequency === 'Khac' || q20_assessment_frequency === 'Other') {
        q20_assessment_frequency_other = getField(formData, 'q20_assessment_frequency_other');
    }

    console.log('üîç Validation Check:', {
    q1_roadmap_name, 
    q2_category, 
    q3_category_detail,
    q5_specific_goal, 
    q7_current_level, 
    q9_daily_time,
    q11_program_days
    });

    if (!q1_roadmap_name) throw new Error('‚ùå Vui l√≤ng nh·∫≠p t√™n l·ªô tr√¨nh');
    if (!q2_category) throw new Error('‚ùå Vui l√≤ng ch·ªçn danh m·ª•c');
    if (!q3_category_detail) throw new Error('‚ùå Vui l√≤ng nh·∫≠p danh m·ª•c chi ti·∫øt');
    if (!q5_specific_goal) throw new Error('‚ùå Vui l√≤ng nh·∫≠p m·ª•c ti√™u c·ª• th·ªÉ (Q2)');
    if (!q7_current_level) throw new Error('‚ùå Vui l√≤ng ch·ªçn tr√¨nh ƒë·ªô hi·ªán t·∫°i (Q5)');
    if (!q9_daily_time) throw new Error('‚ùå Vui l√≤ng ch·ªçn th·ªùi gian h·ªçc m·ªói ng√†y (Q7)');
    if (!q11_program_days || q11_program_days < 15 || q11_program_days > 30) {
    throw new Error('‚ùå S·ªë ng√†y ph·∫£i t·ª´ 15 ƒë·∫øn 30 (Q9)');
    }

    // ‚úÖ TH√äM VALIDATION CHO C√ÇU H·ªéI NHI·ªÄU L·ª∞A CH·ªåN
    if (q12_learning_styles.length === 0 && !q12_learning_styles_other) {
        throw new Error('‚ùå Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 ph∆∞∆°ng ph√°p h·ªçc (Q10)');
    }
    if (q13_learning_combinations.length === 0 && !q13_learning_combinations_other) {
        throw new Error('‚ùå Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 k·∫øt h·ª£p h·ªçc (Q11)');
    }
    if (q14_challenges.length === 0 && !q14_challenges_other) {
        throw new Error('‚ùå Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 th√°ch th·ª©c (Q12)');
    }
    if (q15_motivation.length === 0 && !q15_motivation_other) {
        throw new Error('‚ùå Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 ƒë·ªông l·ª±c (Q13)');
    }
    if (q16_material_types.length === 0 && !q16_material_types_other) {
        throw new Error('‚ùå Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 lo·∫°i t√†i li·ªáu (Q14)');
    }
    if (q18_assessment_types.length === 0) {
        throw new Error('‚ùå Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 lo·∫°i ƒë√°nh gi√° (Q16)');
    }
    if (q19_result_display.length === 0) {
        throw new Error('‚ùå Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 c√°ch hi·ªÉn th·ªã k·∫øt qu·∫£ (Q17)');
    }

    console.log('‚úÖ Validation passed!');

    // days limit
    const MAX = (typeof MAX_AI_DAYS !== 'undefined') ? MAX_AI_DAYS : 60;
    if (q11_program_days > MAX) {
        showNotification(`AI ch·ªâ c√≥ th·ªÉ t·∫°o l·ªô tr√¨nh t·ªëi ƒëa ${MAX} ng√†y. Vui l√≤ng gi·∫£m s·ªë ng√†y ho·∫∑c t·∫°o th·ªß c√¥ng.`, 'error');
        generateBtn.disabled = false;
        submitBtn.disabled = false;
        generateBtn.innerHTML = 'ü§ñ T·∫°o l·ªô tr√¨nh v·ªõi AI';
        submitText.innerHTML = 'üéâ T·∫°o L·ªô Tr√¨nh';
        return;
    }

    // UI: b·∫≠t tr·∫°ng th√°i ƒëang t·∫°o
    isGenerating = true;

    try {
        // T·∫°o payload ƒë·∫ßy ƒë·ªß
        const roadmapData = {
            roadmap_name: q1_roadmap_name,
            category: q2_category,
            sub_category: q3_category_detail || null,
            start_level: q7_current_level,
            duration_days: q11_program_days,
            duration_hours: extractFirstNumber(q9_daily_time, 2) * q11_program_days,
            expected_outcome: q5_specific_goal,

            // full Qs
            q1_roadmap_name,
            q2_category,
            q3_category_detail,
            q4_main_purpose,
            q4_main_purpose_other,
            q5_specific_goal,
            q5_current_job,
            q6_learning_duration,
            q7_current_level,
            q8_skills_text,
            q9_daily_time,
            q10_weekly_sessions,
            q11_program_days,
            q12_learning_styles,
            q12_learning_styles_other,
            q13_learning_combinations,
            q13_learning_combinations_other,
            q14_challenges,
            q14_challenges_other,
            q15_motivation,
            q15_motivation_other,
            q16_material_types,
            q16_material_types_other,
            q17_material_language,
            q18_assessment_types,
            q19_result_display,
            q20_assessment_frequency,
            q20_assessment_frequency_other
        };

        // prepare API URL
        const apiBase = (window.location.protocol === 'file:') ? 'http://localhost:5000' : window.location.origin;
        const apiUrl = apiBase.replace(/\/$/, '') + '/api/generate-roadmap-ai';

        // prepare headers
        let headers = {};
        try {
            const h = (typeof getAuthHeaders === 'function') ? getAuthHeaders() : {};
            if (h instanceof Headers) {
                h.set('Content-Type', 'application/json');
                headers = h;
            } else {
                headers = Object.assign({}, h || {}, { 'Content-Type': 'application/json' });
            }
        } catch (err) {
            headers = { 'Content-Type': 'application/json' };
        }

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers,
            body: JSON.stringify(roadmapData)
        });

        console.log('üì° API Response Status:', response.status);
        console.log('üì° API Response OK?:', response.ok);

        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå API Error Response:', errorText);
            alert('L·ªñI API: ' + errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

const result = await response.json().catch(() => ({}));
if (!result || !result.success || !result.data) {
    throw new Error('AI response kh√¥ng h·ª£p l·ªá');
}

// ‚úÖ L∆ØU history_id NGAY SAU KHI VALIDATE
aiHistoryId = result.metadata?.history_id;
console.log('‚úÖ Saved aiHistoryId:', aiHistoryId);

// CLEAR EXISTING DAYS & RENDER AI DAYS
if (typeof dayCount !== 'undefined') dayCount = 0;
const daysContainer = document.getElementById('daysContainer');
if (daysContainer) daysContainer.innerHTML = '';

result.data.forEach((aiDay, index) => {
    const dayData = {
        day_number: aiDay.day_number || aiDay.day || (index + 1),
        study_date: aiDay.study_date || aiDay.study_date_iso || null,
        study_date_iso: aiDay.study_date || aiDay.study_date_iso || null,
        daily_goal: aiDay.daily_goal || aiDay.goal || '',
        learning_content: aiDay.learning_content || aiDay.content || '',
        practice_exercises: aiDay.practice_exercises || aiDay.exercises || '',
        learning_materials: aiDay.learning_materials || aiDay.materials || '',
        study_guide: aiDay.study_guide || '',
        study_duration: (typeof aiDay.study_duration !== 'undefined') ? aiDay.study_duration : (aiDay.hours || 2),
        completion_status: aiDay.completion_status || 'NOT_STARTED'
    };
    
    if (typeof addDay === 'function') {
        addDay(dayData);
    } else {
        const container = document.getElementById('daysContainer');
        if (container) {
            const row = document.createElement('div');
            row.className = 'day-item';
            row.textContent = `Ng√†y ${dayData.day_number}: ${dayData.daily_goal}`;
            container.appendChild(row);
        }
    }
});

// Display analysis
document.getElementById('analysisContent').textContent = result.analysis;
submitBtn.disabled = false;
submitText.innerHTML = 'üéâ T·∫°o L·ªô Tr√¨nh';
showNotification('‚ú® AI ƒë√£ t·∫°o l·ªô tr√¨nh th√†nh c√¥ng! B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a n·∫øu c·∫ßn.', 'success');
    } catch (error) {
        console.error('‚ùå AI ERROR FULL:', error);
        console.error('‚ùå Error message:', error.message);
        console.error('‚ùå Error stack:', error.stack);
        alert('L·ªñI AI: ' + (error.message || 'Unknown error'));
        showNotification(`‚ö†Ô∏è ${error.message || 'C√≥ l·ªói x·∫£y ra khi g·ªçi AI. Vui l√≤ng th·ª≠ l·∫°i.'}`, 'error');
        submitBtn.disabled = false;
        submitText.innerHTML = 'üéâ T·∫°o L·ªô Tr√¨nh';
    } finally {
        isGenerating = false;
        generateBtn.disabled = false;
        generateBtn.innerHTML = 'ü§ñ T·∫°o l·ªô tr√¨nh v·ªõi AI';
        
        if (typeof validateDays === 'function') validateDays();
    }
}
document.getElementById('generateAI').addEventListener('click', generateRoadmapWithAI);
function getVietnamDate() {
  const now = new Date();
  const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
  return new Date(utc + (7 * 60 * 60 * 1000));
}
function addDay(dayData = null) {
    dayCount++;
    const container = document.getElementById('daysContainer');

    if (container.querySelector('p')) {
        container.innerHTML = '';
    }

    // ‚úÖ T√≠nh study_date (ng√†y th·ª±c t·∫ø)
    const today = getVietnamDate();
    const studyDate = getVietnamDate(today);
    studyDate.setDate(today.getDate() + (dayCount - 1));
    const formattedDate = studyDate.toLocaleDateString('vi-VN', { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric' 
    });

    // ‚úÖ Format materials ƒë·ªÉ hi·ªÉn th·ªã multiple links
    let materialsDisplay = '';
    if (dayData?.learning_materials) {
        const links = dayData.learning_materials.split(/[;\n]/).map(l => l.trim()).filter(Boolean);
        materialsDisplay = links.map(link => {
            if (link.match(/^https?:\/\//i)) {
                const domain = new URL(link).hostname.replace(/^www\./, '');
                return `<a href="${escapeHtmlAttr(link)}" target="_blank" style="color: #007bff; display: block; margin: 2px 0;">${domain}</a>`;
            }
            return link;
        }).join('<br>');
    }

    const dayElement = document.createElement('div');
    dayElement.className = 'day-item';
    dayElement.innerHTML = `
        <div class="day-header">
            <div style="display: flex; gap: 15px; align-items: center;">
                <div class="day-number">${dayData?.day_number || dayCount}</div>
                <div style="color: #6b7280; font-size: 0.9rem;">
                    üìÖ ${dayData?.study_date || formattedDate}
                </div>
            </div>
            <button type="button" class="remove-day-btn" onclick="removeDay(this)">‚úï</button>
        </div>
        
        <!-- Hidden field: study_date ISO -->
        <input type="hidden" name="days[${dayCount-1}][study_date]" 
               value="${dayData?.study_date_iso || studyDate.toISOString().split('T')[0]}">
        
        <!-- Hidden field: completion_status -->
        <input type="hidden" name="days[${dayCount-1}][completion_status]" 
               value="${dayData?.completion_status || 'NOT_STARTED'}">
        
        <div class="form-group">
            <label class="form-label">M·ª•c ti√™u ng√†y ${dayData?.day_number || dayCount}</label>
            <input type="text" class="form-input" name="days[${dayCount-1}][goal]" required
                   placeholder="M·ª•c ti√™u c·∫ßn ƒë·∫°t ƒë∆∞·ª£c trong ng√†y n√†y"
                   value="${escapeHtmlAttr(dayData?.daily_goal || '')}">
        </div>
        
        <div class="form-group">
            <label class="form-label">N·ªôi dung h·ªçc t·∫≠p</label>
            <textarea class="form-textarea" name="days[${dayCount-1}][content]" required
                      placeholder="Chi ti·∫øt n·ªôi dung ki·∫øn th·ª©c s·∫Ω h·ªçc">${escapeHtmlAttr(dayData?.learning_content || '')}</textarea>
        </div>
        
        <div class="form-group">
            <label class="form-label">B√†i t·∫≠p th·ª±c h√†nh</label>
            <textarea class="form-textarea" name="days[${dayCount-1}][exercises]"
                      placeholder="B√†i t·∫≠p ƒë·ªÉ r√®n luy·ªán k·ªπ nƒÉng">${escapeHtmlAttr(dayData?.practice_exercises || '')}</textarea>
        </div>
        
        <div class="form-group">
            <label class="form-label">C√¥ng c·ª•/T√†i li·ªáu h·ªçc t·∫≠p</label>
            <input type="text" class="form-input" name="days[${dayCount-1}][materials]"
                   placeholder="C√¥ng c·ª•, t√†i li·ªáu c·∫ßn thi·∫øt (m·ªói link xu·ªëng d√≤ng ho·∫∑c c√°ch nhau b·ªüi d·∫•u ;)"
                   value="${escapeHtmlAttr(dayData?.learning_materials || '')}">
            ${materialsDisplay ? `<div style="margin-top: 8px; padding: 8px; background: #f0f9ff; border-radius: 6px; font-size: 0.85rem;">${materialsDisplay}</div>` : ''}
        </div>
        
        <div class="form-group">
            <label class="form-label">H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</label>
            <textarea class="form-textarea" name="days[${dayCount-1}][study_guide]"
                      placeholder="H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng t√†i li·ªáu v√† c√°ch h·ªçc">${escapeHtmlAttr(dayData?.study_guide || '')}</textarea>
        </div>
        
        <div class="form-group">
            <label class="form-label">Th·ªùi gian h·ªçc (gi·ªù)</label>
            <input type="number" class="form-input" name="days[${dayCount-1}][hours]" required
                   min="0.5" max="12" step="0.5"
                   value="${escapeHtmlAttr(dayData?.study_duration || 2)}">
        </div>
        
        <div class="form-group">
            <label class="form-label">Tr·∫°ng th√°i</label>
            <select class="form-select" name="days[${dayCount-1}][completion_status_display]" disabled>
                <option value="NOT_STARTED" ${(!dayData || dayData.completion_status === 'NOT_STARTED') ? 'selected' : ''}>
                    Ch∆∞a ho√†n th√†nh
                </option>
                <option value="IN_PROGRESS" ${dayData?.completion_status === 'IN_PROGRESS' ? 'selected' : ''}>
                    ƒêang th·ª±c hi·ªán
                </option>
                <option value="COMPLETED" ${dayData?.completion_status === 'COMPLETED' ? 'selected' : ''}>
                    ƒê√£ ho√†n th√†nh
                </option>
                <option value="SKIPPED" ${dayData?.completion_status === 'SKIPPED' ? 'selected' : ''}>
                    Kh√¥ng l√†m
                </option>
            </select>
            <small style="color: #6b7280; font-size: 0.85rem; display: block; margin-top: 5px;">
                ‚ÑπÔ∏è Tr·∫°ng th√°i s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t khi b·∫°n h·ªçc
            </small>
        </div>
    `;

    container.appendChild(dayElement);
}
        function removeDay(button) {
            const dayItem = button.closest('.day-item');
            if (!dayItem) return;
            dayItem.remove();

            const remainingDays = document.querySelectorAll('.day-item');
            if (remainingDays.length === 0) {
                document.getElementById('daysContainer').innerHTML = `
                    <p style="text-align: center; color: #6b7280; padding: 20px;">
                        Ch∆∞a c√≥ ng√†y h·ªçc n√†o. H√£y s·ª≠ d·ª•ng AI ho·∫∑c th√™m th·ªß c√¥ng.
                    </p>
                `;
                dayCount = 0;
            } else {
                remainingDays.forEach((day, index) => {
                    const dayNumber = day.querySelector('.day-number');
                    const inputs = day.querySelectorAll('input, textarea');

                    dayNumber.textContent = index + 1;
                    inputs.forEach(input => {
                        if (input.name) {
                            input.name = input.name.replace(/\[\d+\]/, `[${index}]`);
                        }
                    });
                });
                dayCount = remainingDays.length;
            }
        }

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 10000;
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transform: translateX(400px);
        transition: transform 0.3s ease;
    `;
    
    if (type === 'success') {
        notification.style.background = '#059669';
    } else {
        notification.style.background = '#dc2626';
    }
    
    document.body.appendChild(notification);
    
    // Slide in animation
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Slide out and remove
    setTimeout(() => {
        notification.style.transform = 'translateX(400px)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 5000);
}
document.getElementById('roadmapForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const form = this;
  const submitBtn = document.querySelector('.submit-btn');
  const btnText = document.getElementById('submit-btn-text');

  // UI: disable + loading
  if (submitBtn) submitBtn.disabled = true;
  if (btnText) btnText.innerHTML = '<div class="loading"><div class="spinner"></div> ƒêang t·∫°o...</div>';

  // helpers
  const getField = (fd, name) => {
    const v = fd.get(name);
    return v == null ? '' : String(v).trim();
  };
  const getCheckedList = (names) => {
    // names: array of possible name attributes, e.g. ['q12_learning_styles[]','q12_learning_styles']
    const values = [];
    names.forEach(name => {
      document.querySelectorAll(`input[name="${name}"]:checked`).forEach(cb => values.push(cb.value));
    });
    return values;
  };
  const getCheckedListWithOther = (names, otherInputId) => {
    const vals = [];
    let other = '';
    names.forEach(name => {
      document.querySelectorAll(`input[name="${name}"]:checked`).forEach(cb => {
        if (cb.value === 'Kh√°c' || cb.value === 'Khac' || cb.value === 'Other') {
          const el = document.getElementById(otherInputId);
          other = el ? (el.value || '').trim() : other;
        } else {
          vals.push(cb.value);
        }
      });
    });
    return { values: vals, other: other };
  };
  const extractFirstNumber = (str, fallback = 2) => {
    if (!str) return fallback;
    const s = String(str).trim();
    const m = s.match(/(\d+(?:\.\d+)?)/);
    if (m) {
      const num = parseFloat(m[1]);
      if (s.toLowerCase().includes('ph√∫t')) return num / 60;
      return num;
    }
    return fallback;
  };

  try {
    const formData = new FormData(form);

    // =========================================
    // B∆Ø·ªöC 1: THU TH·∫¨P D·ªÆ LI·ªÜU T·ª™ FORM (Q1..Q20)
    // =========================================

    // Q1
    const q1_roadmap_name = getField(formData, 'q1_roadmap_name');

    // Q2 (category) - SELECT
    let q2_category_id = getField(formData, 'q2_category');
    let q2_category = '';

    if (q2_category_id === 'Kh√°c') {
        const otherInput = document.getElementById('q2_other_text');
        q2_category = otherInput ? otherInput.value.trim() : '';
    } else {
        const select = document.getElementById('q2_category_select');
        const selectedOption = select?.options[select.selectedIndex];
        q2_category = selectedOption?.getAttribute('data-category-name') || q2_category_id;
    }

    // Q3 - X·ª≠ l√Ω "Kh√°c"
    let q3_category_detail = getField(formData, 'q3_category_detail');
    if (q3_category_detail === 'Kh√°c') {
        const q3_other = document.getElementById('q3_other_text');
        q3_category_detail = q3_other ? q3_other.value.trim() : '';
    }
    // Q4 main purpose (radio/select) + other
    let q4_main_purpose = getField(formData, 'q4_main_purpose');
    let q4_main_purpose_other = '';
    if (q4_main_purpose === 'Kh√°c' || q4_main_purpose === 'Khac' || q4_main_purpose === 'Other') {
      q4_main_purpose_other = getField(formData, 'q4_main_purpose_other');
      if (!q4_main_purpose_other) q4_main_purpose_other = '';
    }

    // Q5
    const q5_specific_goal = getField(formData, 'q5_specific_goal');
    const q5_current_job = getField(formData, 'q5_current_job');

    // Q6-Q8
    const q6_learning_duration = getField(formData, 'q6_learning_duration'); // e.g., "3 months"
    const q7_current_level = getField(formData, 'q7_current_level');
    const q8_skills_text = getField(formData, 'q8_skills_text');

    // Q9-Q11
    const q9_daily_time = getField(formData, 'q9_daily_time'); // e.g., "2-3 gi·ªù"
    const q10_weekly_sessions = getField(formData, 'q10_weekly_sessions');
    const q11_program_days = Number(getField(formData, 'q11_program_days')) || 0;

    // Q12 (learning styles) - checkbox array + other
    const q12 = getCheckedListWithOther(['q12_learning_styles[]','q12_learning_styles'], 'q12_other_text');
    const q12_learning_styles = q12.values;
    const q12_learning_styles_other = q12.other;

    // Q13 (learning combinations)
    const q13 = getCheckedListWithOther(['q13_learning_combinations[]','q13_learning_combinations'], 'q13_other_text');
    const q13_learning_combinations = q13.values;
    const q13_learning_combinations_other = q13.other;

    // Q14 (challenges)
    const q14 = getCheckedListWithOther(['q14_challenges[]','q14_challenges'], 'q14_other_text');
    const q14_challenges = q14.values;
    const q14_challenges_other = q14.other;

    // Q15 (motivation)
    const q15 = getCheckedListWithOther(['q15_motivation[]','q15_motivation'], 'q15_other_text');
    const q15_motivation = q15.values;
    const q15_motivation_other = q15.other;

    // Q16 (material types)
    const q16 = getCheckedListWithOther(['q16_material_types[]','q16_material_types'], 'q16_other_text');
    const q16_material_types = q16.values;
    const q16_material_types_other = q16.other;

    // Q17-Q19
    const q17_material_language = getField(formData, 'q17_material_language');

    const q18_assessment_types = getCheckedList(['q18_assessment_types[]','q18_assessment_types']);
    const q19_result_display = getCheckedList(['q19_result_display[]','q19_result_display']);

    // Q20 - assessment frequency (other)
    let q20_assessment_frequency = getField(formData, 'q20_assessment_frequency');
    let q20_assessment_frequency_other = '';
    if (q20_assessment_frequency === 'Kh√°c' || q20_assessment_frequency === 'Khac' || q20_assessment_frequency === 'Other') {
      q20_assessment_frequency_other = getField(formData, 'q20_assessment_frequency_other');
    }

    // =========================================
    // B∆Ø·ªöC 2: VALIDATION C∆† B·∫¢N
    // =========================================
    console.log('üîç Validation Check:', {
      q1_roadmap_name, 
      q2_category, 
      q3_category_detail,
      q5_specific_goal, 
      q7_current_level, 
      q9_daily_time,
      q11_program_days
    });

    if (!q1_roadmap_name) throw new Error('‚ùå Vui l√≤ng nh·∫≠p t√™n l·ªô tr√¨nh ');
    if (!q2_category) throw new Error('‚ùå Vui l√≤ng ch·ªçn danh m·ª•c');
    if (!q3_category_detail) throw new Error('‚ùå Vui l√≤ng nh·∫≠p danh m·ª•c chi ti·∫øt ');
    if (!q5_specific_goal) throw new Error('‚ùå Vui l√≤ng nh·∫≠p m·ª•c ti√™u c·ª• th·ªÉ (Q2)');
    if (!q7_current_level) throw new Error('‚ùå Vui l√≤ng ch·ªçn tr√¨nh ƒë·ªô hi·ªán t·∫°i (Q5)');
    if (!q9_daily_time) throw new Error('‚ùå Vui l√≤ng ch·ªçn th·ªùi gian h·ªçc m·ªói ng√†y (Q7)');
if (!q11_program_days || q11_program_days < 15 || q11_program_days > 30) {
  throw new Error('‚ùå S·ªë ng√†y ph·∫£i t·ª´ 15 ƒë·∫øn 30 (Q9)');
}

    // =========================================
    // B∆Ø·ªöC 3: T·∫†O OBJECT G·ª¨I L√äN SERVER
    // =========================================

    // =========================================
    // B∆Ø·ªöC 4: THU TH·∫¨P DAYS (9 tr∆∞·ªùng m·ªói day)
    // =========================================
    const days = [];
    const dayItems = document.querySelectorAll('.day-item');
    dayItems.forEach((dayItem, idx) => {
      const inputs = dayItem.querySelectorAll('input, textarea, select');
      const dayData = {
        day_number: idx + 1,
        study_date: null,
        completion_status: 'NOT_STARTED',
        daily_goal: '',
        learning_content: '',
        practice_exercises: '',
        learning_materials: '',
        study_guide: '',
        study_duration: 2
      };

      inputs.forEach(input => {
        // match last bracket name like name="day[goal]" -> capture 'goal'
        const m = input.name ? input.name.match(/\[(\w+)\]$/) : null;
        const fieldName = m ? m[1] : (input.name || '');
        if (!fieldName) return;

        const val = (input.type === 'checkbox' || input.type === 'radio') ? (input.checked ? input.value : null) : (input.value || '');

        switch (fieldName) {
          case 'goal':
            dayData.daily_goal = val || dayData.daily_goal;
            break;
          case 'content':
            dayData.learning_content = val || dayData.learning_content;
            break;
          case 'exercises':
            dayData.practice_exercises = val || dayData.practice_exercises;
            break;
          case 'materials':
            dayData.learning_materials = val || dayData.learning_materials;
            break;
          case 'study_guide':
            dayData.study_guide = val || dayData.study_guide;
            break;
          case 'hours':
            dayData.study_duration = parseFloat(val) || dayData.study_duration;
            break;
          case 'study_date':
            dayData.study_date = val || dayData.study_date;
            break;
          case 'completion_status':
            dayData.completion_status = val || dayData.completion_status;
            break;
          default:
            // ignore unknown
            break;
        }
      });

      // only push if minimal useful content
      if ((dayData.daily_goal && dayData.learning_content) || dayData.study_date) {
        days.push(dayData);
      }
    });

    // =========================================
    // T√çNH duration_hours
    // - n·∫øu c√≥ days: t·ªïng study_duration
    // - else: l·∫•y s·ªë ƒë·∫ßu ti√™n trong q9_daily_time √ó q11_program_days
    // =========================================
    let duration_hours = 0;
    if (days.length > 0) {
      duration_hours = days.reduce((s, d) => s + (Number(d.study_duration) || 0), 0);
    } else {
      const hoursPerDay = extractFirstNumber(q9_daily_time, 2);
      duration_hours = hoursPerDay * q11_program_days;
    }
    
    // ‚úÖ Final check for duration_hours
    if (isNaN(duration_hours) || duration_hours <= 0) {
      console.error('‚ùå Duration calculation failed:', {
        q9_daily_time,
        q11_program_days,
        hoursPerDay: extractFirstNumber(q9_daily_time, 2),
        calculated: duration_hours
      });
      throw new Error('‚ùå Kh√¥ng th·ªÉ t√≠nh t·ªïng gi·ªù h·ªçc. Vui l√≤ng ch·ªçn th·ªùi gian h·ªçc m·ªói ng√†y (Q9)');
    }

    // build payload
    const roadmapData = {
      // basic normalized fields
      roadmap_name: q1_roadmap_name,
      category: q2_category,
      sub_category: q3_category_detail || null,
      start_level: q7_current_level,
      duration_days: q11_program_days,
      duration_hours: duration_hours,
      expected_outcome: q5_specific_goal,

      // full Qs for server
      q1_roadmap_name,
      q2_category,
      q3_category_detail,
      q4_main_purpose,
      q4_main_purpose_other,
      q5_specific_goal,
      q5_current_job,
      q6_learning_duration,
      q7_current_level,
      q8_skills_text,
      q9_daily_time,
      q10_weekly_sessions,
      q11_program_days,
      q12_learning_styles,
      q12_learning_styles_other,
      q13_learning_combinations,
      q13_learning_combinations_other,
      q14_challenges,
      q14_challenges_other,
      q15_motivation,
      q15_motivation_other,
      q16_material_types,
      q16_material_types_other,
      q17_material_language,
      q18_assessment_types,
      q19_result_display,
      q20_assessment_frequency,
      q20_assessment_frequency_other
    };

    if (days.length > 0) roadmapData.days = days;

    console.log('üì§ Sending data:', roadmapData);

    // =========================================
    // B∆Ø·ªöC 5: G·ª¨I REQUEST (g·ªôp headers)
    // =========================================
    // getAuthHeaders may return object or Headers instance
    let headers = {};
    try {
      const h = typeof getAuthHeaders === 'function' ? getAuthHeaders() : {};
      if (h instanceof Headers) {
        h.set('Content-Type', 'application/json');
        headers = h;
      } else {
        headers = Object.assign({}, h, { 'Content-Type': 'application/json' });
      }
    } catch (err) {
      headers = { 'Content-Type': 'application/json' };
    }

    const response = await fetch('/api/roadmaps', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        roadmapData: roadmapData,
                        roadmap_analyst: document.getElementById('analysisContent').textContent,
                        history_id: aiHistoryId
                    })
                })

    if (!response.ok) {
      const errData = await response.json().catch(() => ({}));
      throw new Error(errData.error || (`HTTP ${response.status}`));
    }

    const result = await response.json().catch(() => ({}));
    showNotification('‚úÖ L·ªô tr√¨nh ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!', 'success');

    // redirect/close: gi·ªØ h√†nh vi c≈©
    setTimeout(() => {
      if (window.opener) {
        window.opener.location.href = 'path.html';
        window.close();
      } else {
        window.location.href = 'path.html';
      }
    }, 1200);

  } catch (error) {
    console.error('‚ùå Error creating roadmap:', error);
    window.scrollTo({ top: 0, behavior: 'smooth' });
    showNotification(`‚ö†Ô∏è ${error.message || 'C√≥ l·ªói x·∫£y ra khi t·∫°o l·ªô tr√¨nh. Vui l√≤ng th·ª≠ l·∫°i.'}`, 'error');
  } finally {
    if (submitBtn) submitBtn.disabled = false;
    if (btnText) btnText.innerHTML = '&#127881; T·∫°o L·ªô Tr√¨nh';
  }
});

function updateTotalHours() {
    const daysInput = document.querySelector('input[name="q11_program_days"]');
    const minutesInput = document.getElementById('q9_daily_time_input');

    if (daysInput?.value && minutesInput?.value) {
        const minutes = parseInt(minutesInput.value) || 0;
        const hours = minutes / 60;
        const total = parseInt(daysInput.value) * hours;
        //console.log(`‚úÖ Total hours: ${total.toFixed(2)} (${minutes} min = ${hours.toFixed(2)}h/day √ó ${daysInput.value} days)`);
    }
}

const daysInputEl = document.querySelector('input[name="q11_program_days"]');
if (daysInputEl) {
    daysInputEl.addEventListener('input', function() {
        updateTotalHours();
        validateDays();
    });
}

const minutesInputEl = document.getElementById('q9_daily_time_input');
if (minutesInputEl) {
    minutesInputEl.addEventListener('input', function() {
        updateTotalHours();
        validateMinutes(); // ‚úÖ TH√äM D√íNG N√ÄY
    });
}
// ============ MODAL FUNCTIONS ============
    function viewPrompt() {
        const prompt = generatePrompt();
        document.getElementById('promptContent').textContent = prompt;
        document.getElementById('promptModal').classList.add('show');
    }

    function closeModal() {
        document.getElementById('promptModal').classList.remove('show');
    }

    function copyPrompt() {
        const text = document.getElementById('promptContent').textContent || '';
        navigator.clipboard.writeText(text)
            .then(() => alert('‚úÖ ƒê√£ copy prompt v√†o clipboard!'))
            .catch(() => alert('‚ùå Kh√¥ng th·ªÉ copy.'));
    }

// For non-admin users: show the prompt modal so they can view/copy the AI prompt
async function showManualPromptForUser() {
  try {
    const promptEl = document.getElementById('promptContent');
    if (!promptEl) return alert('Kh√¥ng t√¨m th·∫•y v√πng hi·ªÉn th·ªã prompt.');

    // ‚úÖ FIX: G·ªçi API ƒë·ªÉ l·∫•y prompt v·ªõi form data
    const form = document.getElementById('roadmapForm');
    const formData = new FormData(form);
    
    // Thu th·∫≠p data t·ª´ form (t∆∞∆°ng t·ª± logic trong generateRoadmapWithAI)
    const getField = (fd, name, fallback = '') => {
      const v = fd.get(name);
      return v == null ? fallback : String(v).trim();
    };
    
    const collectCheckedWithOther = (selectorNames, otherInputId) => {
      const values = [];
      let other = '';
      selectorNames.forEach(sel => {
        document.querySelectorAll(sel).forEach(cb => {
          if (!cb.checked) return;
          if (cb.value === 'Kh√°c' || cb.value === 'Khac' || cb.value === 'Other') {
            const el = document.getElementById(otherInputId);
            if (el) other = (el.value || '').trim();
          } else {
            values.push(cb.value);
          }
        });
      });
      return { values, other };
    };
    
    const processArrayWithOther = (arr, otherValue) => {
      if (!Array.isArray(arr)) return '';
      const filtered = arr.filter(v => v && v !== 'Kh√°c' && v !== 'AI g·ª£i √Ω');
      if (otherValue && otherValue.trim()) filtered.push(otherValue.trim());
      return filtered.length > 0 ? filtered.join(', ') : 'Ch∆∞a x√°c ƒë·ªãnh';
    };
    let q2_category_id = getField(formData, 'q2_category');
    let q2_category = '';
    
    if (q2_category_id === 'Kh√°c' || q2_category_id === 'Khac' || q2_category_id === 'Other') {
      const otherInput = document.getElementById('q2_other_text');
      q2_category = otherInput ? (otherInput.value || '').trim() : '';
    } else {
      const selectedRadio = document.querySelector('input[name="q2_category"]:checked');
      if (selectedRadio) {
        q2_category = selectedRadio.getAttribute('data-category-name') || q2_category_id;
      } else {
        q2_category = q2_category_id;
      }
    }
    // ‚úÖ Thu th·∫≠p to√†n b·ªô form data
    const finalData = {
      roadmap_name: getField(formData, 'q1_roadmap_name'),
      category: q2_category,
      category_detail: getField(formData, 'q3_category_detail'),
      main_purpose: getField(formData, 'q4_main_purpose'),
      specific_goal: getField(formData, 'q5_specific_goal'),
      current_job: getField(formData, 'q5_current_job'),
      learning_duration: getField(formData, 'q6_learning_duration'),
      current_level: getField(formData, 'q7_current_level'),
      skills_text: getField(formData, 'q8_skills_text'),
      daily_time: getField(formData, 'q9_daily_time'),
      weekly_sessions: getField(formData, 'q10_weekly_sessions'),
      program_days: getField(formData, 'q11_program_days'),
      learning_styles: processArrayWithOther(
        collectCheckedWithOther(['input[name="q12_learning_styles[]"]'], 'q12_other_text').values,
        collectCheckedWithOther(['input[name="q12_learning_styles[]"]'], 'q12_other_text').other
      ),
      learning_combinations: processArrayWithOther(
        collectCheckedWithOther(['input[name="q13_learning_combinations[]"]'], 'q13_other_text').values,
        collectCheckedWithOther(['input[name="q13_learning_combinations[]"]'], 'q13_other_text').other
      ),
      challenges: processArrayWithOther(
        collectCheckedWithOther(['input[name="q14_challenges[]"]'], 'q14_other_text').values,
        collectCheckedWithOther(['input[name="q14_challenges[]"]'], 'q14_other_text').other
      ),
      motivation: processArrayWithOther(
        collectCheckedWithOther(['input[name="q15_motivation[]"]'], 'q15_other_text').values,
        collectCheckedWithOther(['input[name="q15_motivation[]"]'], 'q15_other_text').other
      ),
      material_types: processArrayWithOther(
        collectCheckedWithOther(['input[name="q16_material_types[]"]'], 'q16_other_text').values,
        collectCheckedWithOther(['input[name="q16_material_types[]"]'], 'q16_other_text').other
      ),
      material_language: getField(formData, 'q17_material_language'),
      assessment_types: Array.from(document.querySelectorAll('input[name="q18_assessment_types[]"]:checked')).map(cb => cb.value).join(', '),
      result_display: Array.from(document.querySelectorAll('input[name="q19_result_display[]"]:checked')).map(cb => cb.value).join(', '),
      assessment_frequency: getField(formData, 'q20_assessment_frequency')
    };
    
    // ‚úÖ G·ªçi API v·ªõi form data
    const response = await fetch('/api/get-manual-prompt', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: JSON.stringify({ formData: finalData })
    });
    
    if (!response.ok) {
      throw new Error('Kh√¥ng th·ªÉ l·∫•y prompt t·ª´ server');
    }
    
    const data = await response.json();
    const promptText = data.prompt || 'Prompt ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh. Vui l√≤ng li√™n h·ªá qu·∫£n tr·ªã vi√™n.';
    
    promptEl.textContent = promptText;
    document.getElementById('promptModal').classList.add('show');
    
  } catch (err) {
    console.error('showManualPromptForUser error:', err);
    alert('Kh√¥ng th·ªÉ hi·ªÉn th·ªã prompt: ' + (err && err.message));
  }
}

    // Close modals khi click outside
    window.addEventListener('click', function(e) {
        const promptModal = document.getElementById('promptModal');
        if (e.target === promptModal) closeModal();
    });
window.addEventListener('load', function() {
    const token = localStorage.getItem('token');
    if (!token) {
        alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ t·∫°o l·ªô tr√¨nh h·ªçc');
        window.location.href = 'login.html';
        return;
    }
    loadCategories();
    checkUserRoleAndUpdateUI();
    updateDaysUIByRole();
    validateDays();

    const daysInputEl = document.getElementById('q11_program_days');
    if (daysInputEl) {
        daysInputEl.addEventListener('input', function() {
            updateTotalHours();
            validateDays();
        });
    }

    const hoursInputEl = document.querySelector('select[name="q9_daily_time"]');
    if (hoursInputEl) {
        hoursInputEl.addEventListener('change', updateTotalHours);
    }

    // ‚úÖ TH√äM SAU C√ôNG - ƒë·∫£m b·∫£o ·∫©n t·∫•t c·∫£ "Kh√°c"
    setTimeout(() => {
        ['q2_other_text', 'q4_other_text', 'q12_other_text', 'q13_other_text', 
         'q14_other_text', 'q15_other_text', 'q16_other_text', 'q20_other_text'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
        });
    }, 100);
    setTimeout(() => {
        attachOtherEventsForQ2();
    }, 500);
});

        function escapeHtmlAttr(s) {
            if (s === null || s === undefined) return '';
            return String(s)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }
    // Q4 - Main Purpose
const q4_other_radio = document.getElementById('q4_other_radio');
const q4_other_text = document.getElementById('q4_other_text');
if (q4_other_radio && q4_other_text) {
    q4_other_radio.addEventListener('change', () => {
        if (q4_other_radio.checked) {
            q4_other_text.style.display = 'block';
            setTimeout(() => q4_other_text.focus(), 60);
        }
    });
    document.querySelectorAll('input[name="q4_main_purpose"]').forEach(radio => {
        if (radio !== q4_other_radio) {
            radio.addEventListener('change', () => {
                q4_other_text.style.display = 'none';
                q4_other_text.value = '';
            });
        }
    });
}

// Q12 - Learning Styles
const q12_other_checkbox = document.getElementById('q12_other_checkbox');
const q12_other_text = document.getElementById('q12_other_text');
if (q12_other_checkbox && q12_other_text) {
    q12_other_checkbox.addEventListener('change', () => {
        if (q12_other_checkbox.checked) {
            q12_other_text.style.display = 'block';
            setTimeout(() => q12_other_text.focus(), 60);
        } else {
            q12_other_text.style.display = 'none';
            q12_other_text.value = '';
        }
    });
}

// Q13 - Learning Combinations
const q13_other_checkbox = document.getElementById('q13_other_checkbox');
const q13_other_text = document.getElementById('q13_other_text');
if (q13_other_checkbox && q13_other_text) {
    q13_other_checkbox.addEventListener('change', () => {
        if (q13_other_checkbox.checked) {
            q13_other_text.style.display = 'block';
            setTimeout(() => q13_other_text.focus(), 60);
        } else {
            q13_other_text.style.display = 'none';
            q13_other_text.value = '';
        }
    });
}

// Q14 - Challenges
const q14_other_checkbox = document.getElementById('q14_other_checkbox');
const q14_other_text = document.getElementById('q14_other_text');
if (q14_other_checkbox && q14_other_text) {
    q14_other_checkbox.addEventListener('change', () => {
        if (q14_other_checkbox.checked) {
            q14_other_text.style.display = 'block';
            setTimeout(() => q14_other_text.focus(), 60);
        } else {
            q14_other_text.style.display = 'none';
            q14_other_text.value = '';
        }
    });
}

// Q15 - Motivation
const q15_other_checkbox = document.getElementById('q15_other_checkbox');
const q15_other_text = document.getElementById('q15_other_text');
if (q15_other_checkbox && q15_other_text) {
    q15_other_checkbox.addEventListener('change', () => {
        if (q15_other_checkbox.checked) {
            q15_other_text.style.display = 'block';
            setTimeout(() => q15_other_text.focus(), 60);
        } else {
            q15_other_text.style.display = 'none';
            q15_other_text.value = '';
        }
    });
}

// Q16 - Material Types
const q16_other_checkbox = document.getElementById('q16_other_checkbox');
const q16_other_text = document.getElementById('q16_other_text');
if (q16_other_checkbox && q16_other_text) {
    q16_other_checkbox.addEventListener('change', () => {
        if (q16_other_checkbox.checked) {
            q16_other_text.style.display = 'block';
            setTimeout(() => q16_other_text.focus(), 60);
        } else {
            q16_other_text.style.display = 'none';
            q16_other_text.value = '';
        }
    });
}

// Q20 - Assessment Frequency
const q20_other_radio = document.getElementById('q20_other_radio');
const q20_other_text = document.getElementById('q20_other_text');
if (q20_other_radio && q20_other_text) {
    q20_other_radio.addEventListener('change', () => {
        if (q20_other_radio.checked) {
            q20_other_text.style.display = 'block';
            setTimeout(() => q20_other_text.focus(), 60);
        }
    });
    document.querySelectorAll('input[name="q20_assessment_frequency"]').forEach(radio => {
        if (radio !== q20_other_radio) {
            radio.addEventListener('change', () => {
                q20_other_text.style.display = 'none';
                q20_other_text.value = '';
            });
        }
    });
}

    </script>
    <script src="footer.js"></script>
</body>
</html>
