<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Qu·∫£n Tr·ªã - Con ƒë∆∞·ªùng ƒëam m√™</title>
    <script>
      (function adminAuthCheck(){
      const token = localStorage.getItem('token');
      const storedRole = localStorage.getItem('role');
      if (!token) {
        alert('Vui l√≤ng ƒëƒÉng nh·∫≠p!');
        window.location.replace('login.html');
      } else if (storedRole !== 'admin') {
        alert('B·∫°n kh√¥ng ph·∫£i qu·∫£n tr·ªã!');
        window.location.replace('path.html');
      }
    })();
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    
    <style>
    :root {
        --primary:#007bff;
        --primary-dark: #1e6fe6;
        --muted: #6b7280;
        --bg: #f5f8fb;
        --header-height: 80px;
    }

html, body {
  height: 100%;
  margin: 0;
}

    body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        font-family: 'Inter', sans-serif;
        color: #0f172a;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  overflow-x: hidden;
}

    .fixed-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 80px;
        background: var(--primary);
        box-shadow: 0 6px 20px rgba(14, 30, 37, 0.12);
        z-index: 50;
    }

    /* Layout container - keeps content centered but lets nav expand */
    .bar-inner {
        max-width: 1200px;
        height: 100%;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        box-sizing: border-box;
        gap: 16px;
    }

    /* Brand (left) */
    .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 0 0 auto; /* kh√¥ng co d√£n, gi·ªØ v·ªã tr√≠ b√™n tr√°i */
        min-width: 0;
    }

    .brand-icon {
        width: 48px;
        height: 48px;
        background: rgba(255,255,255,0.2);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 22px;
        flex-shrink: 0;
    }

    .brand-text {
        display: flex;
        flex-direction: column;
        gap: 3px;
        line-height: 1;
        min-width: 0;
    }

    /* Cho ph√©p brand-title v√† brand-sub hi·ªÉn th·ªã 2 d√≤ng (nh∆∞ y√™u c·∫ßu) */
    .brand-title {
        color: white;
        font-size: 20px;
        font-weight: 700;
        white-space: normal;
        word-break: break-word;
        line-height: 1.05;
    }

    .brand-sub {
        color: rgba(255,255,255,0.9);
        font-size: 12px;
        font-weight: 600;
        white-space: normal;
        line-height: 1;
    }

    /* Nav buttons (gi·ªØa) - chi·∫øm kh√¥ng gian c√≤n l·∫°i, gi·ªØ t·∫•t c·∫£ tr√™n 1 h√†ng */
/* Thay th·∫ø .nav-buttons hi·ªán t·∫°i b·∫±ng ƒëo·∫°n n√†y */
.nav-buttons {
    display: flex;
    align-items: center;
    justify-content: flex-start; /* <-- ƒë·∫∑t c√°c n√∫t s√°t v·ªÅ ph√≠a b√™n tr√°i (sau logo) */
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding: 4px 12px 4px 6px;    /* padding-left nh·ªè ƒë·ªÉ t√°ch logo v√† n√∫t */
    min-width: 0;
    white-space: nowrap;          /* gi·ªØ t·∫•t c·∫£ tr√™n 1 h√†ng */
    flex-wrap: nowrap;
}

    .nav-btn {
        background: none;
        color: #fff;
        padding: 6px 12px;
        font-size: 15px;
        font-weight: 600;
        border-radius: 9999px;
        white-space: nowrap;      /* verhindert wrap c·ªßa ch·ªØ trong n√∫t */
        flex-shrink: 0;           /* kh√¥ng thu nh·ªè n√∫t */
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .nav-btn .fa {
        margin-right: 4px;
        opacity: 0.95;
    }

    .nav-btn.active {
        color: #e6f2ff;
        text-decoration: underline;
    }

    /* User area (ph·∫£i) */
    .userInfo {
        color: white;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 0 0 auto; /* gi·ªØ nguy√™n k√≠ch th∆∞·ªõc, kh√¥ng co d√£n */
        min-width: 0;
    }

    /* Buttons chung */
    button {
        font-family: 'Inter', sans-serif;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: none;
        border-radius: 9999px;
        padding: 10px 18px;
        font-size: 15px;
        font-weight: 600;
        background: transparent;
    }

    .login-btn {
        background: white;
        color: #333;
        box-shadow: 0 2px 5px rgba(0,0,0,0.12);
    }

    .login-btn:hover {
        background: #f0f0f0;
    }

    .register-btn {
        background: #28a745;
        color: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.12);
    }

    .register-btn:hover {
        background: #218838;
    }

    .logout-btn {
        background: linear-gradient(135deg, #4b0ee5 0%, #0682d4 100%);
        color: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.12);
    }

    .toApp-btn {
        background: #000;
        color: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.12);
    }

    .admin-btn {
        background: #6f42c1;
        color: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.12);
    }

main {
  flex: 1 0 auto;
  box-sizing: border-box;
  max-width: 1200px;
  width: 100%;
  margin-left: auto;
  margin-right: auto;
  padding-top: calc(var(--header-height) + 20px); /* b√π header + kho·∫£ng c√°ch */
  padding-left: 20px;
  padding-right: 20px;
}
body.has-admin-nav main {
  padding-top: 150px; /* 80px header + 60px admin nav + 10px spacing */
}

    .social-icon {
        width: 36px;
        height: 36px;
        background: #374151;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: all 0.3s ease;
        text-decoration: none;
    }

    .social-icon:hover {
        background: var(--primary);
        transform: translateY(-2px);
    }

    /* Admin page specific styles (kept from admin file) */
    .card {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(20,20,40,0.06);
      border: 1px solid rgba(0,0,0,0.04);
    }

    .small {
      color: #666;
      font-size: 14px;
    }

    .users-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 14px;
    }

    .users-table th,
    .users-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #eef1f5;
      text-align: left;
      vertical-align: middle;
    }

    .users-table thead th {
      background: #f7f9fc;
      font-weight: 700;
      color: #1f2937;
    }

    .actions-cell {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .btn-delete {
      background: #dc3545;
      color: white;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 13px;
    }

    .btn-delete:hover {
      background: #c82333;
    }

    .btn-refresh {
      background: #0d6efd;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      margin-left: 8px;
    }

    .create-btn {
      background: #28a745;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
    }

    .muted {
      color: #6b7280;
      font-size: 13px;
    }

    .users-message {
      margin-top: 12px;
      font-size: 14px;
      color: #374151;
    }

    .history-card {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 12px;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-success {
      background: #dcfdf4;
      color: #065f46;
    }

    .status-fail {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-timeout {
      background: #fef3c7;
      color: #92400e;
    }

    .prompt-editor {
      width: 100%;
      min-height: 400px;
      padding: 15px;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      resize: vertical;
      box-sizing: border-box;
      background: #f9fafb;
    }

    .prompt-preview {
      background: #f3f4f6;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 13px;
      line-height: 1.6;
      max-height: 500px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
    }

    .btn-save {
      background: #10b981;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      margin-right: 10px;
    }

    .btn-reset {
      background: #6b7280;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
    }

    .success-message {
      background: #dcfdf4;
      color: #065f46;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 1px solid #10b981;
    }

    .error-message {
      background: #fee2e2;
      color: #991b1b;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 1px solid #ef4444;
    }

    .json-format {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            border: 2px dashed #d1d5db;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #374151;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }

    .var-badge {
            display: inline-block;
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            font-weight: 600;
            margin: 4px;
        }

    .var-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

    .warning {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #dc2626;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }


/* Details/Summary styling */
details {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 10px;
    background: white;
    margin: 8px 0;
}

details[open] {
    border-color: #007bff;
}

details summary {
    font-weight: 600;
    cursor: pointer;
    user-select: none;
    padding: 5px;
    border-radius: 4px;
    transition: all 0.2s ease;
}

details summary:hover {
    background: #f0f9ff;
    color: #0056b3;
}

details[open] summary {
    margin-bottom: 10px;
    border-bottom: 1px solid #e5e7eb;
    padding-bottom: 10px;
}
/* Th√™m v√†o ph·∫ßn <style> */
details[open] summary::after {
    content: ' ‚ñº';
}

details summary::after {
    content: ' ‚ñ∫';
}

details > div {
    margin-top: 10px;
}
/* Navigation ph·ª• cho admin - d∆∞·ªõi thanh bar */
.admin-nav-container {
    position: fixed;
    top: 80px;
    left: 0;
    width: 100%;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    z-index: 49;
    padding: 12px 0;
    border-bottom: 2px solid #dee2e6;
}

.admin-nav-buttons {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: center; /* ‚úÖ Thay ƒë·ªïi t·ª´ flex-start sang center */
    flex-wrap: wrap;
    gap: 10px;
    padding: 0 20px;
}

.admin-nav-btn {
    background: white;
    color: #007bff;
    padding: 8px 16px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 8px;
    white-space: nowrap;
    flex-shrink: 0;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    border: 2px solid #e5e7eb;
    transition: all 0.2s ease;
    cursor: pointer;
}

.admin-nav-btn:hover {
    background: #007bff;
    color: white;
    border-color: #007bff;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,123,255,0.3);
}

.admin-nav-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.admin-nav-btn .fa {
    font-size: 14px;
}
@media (max-width: 768px) {
    .modal-content {
        width: 98%;
        max-height: 95vh;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .rating-stars {
        font-size: 28px;
    }
}
@media (max-width:820px) {
    .bar-inner {
        flex-direction: column;
        height: auto;
        padding: 15px;
        gap: 10px;
    }

    .fixed-bar {
        height: auto;
    }

    .userInfo {
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .admin-nav-container {
        top: auto;
        position: relative;
    }

    body.has-admin-nav main {
        padding-top: 20px;
        margin-top: 200px;
    }

    .prompt-editor {
        min-height: 240px;
    }

    .nav-buttons {
        overflow-x: visible;
        flex-wrap: wrap;
        justify-content: center;
    }
}
    </style>
    <!-- Preload Font Awesome CSS -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" as="style">
    
    <!-- Load Font Awesome async -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"></noscript>
    
    <!-- Load Google Fonts async with display swap -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;600;700;900&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;600;700;900&display=swap" rel="stylesheet"></noscript>
    
    <!-- Load footer.css async (non-critical) -->
    <link rel="preload" href="footer.css" as="style">
    <link rel="stylesheet" href="footer.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="footer.css"></noscript>
</head>
<body>
    <!-- Header exactly from the first file -->
<div class="fixed-bar">
    <div class="bar-inner">
        <div class="brand">
            <div class="brand-icon">
                <i class="fa-solid fa-graduation-cap"></i>
            </div>
            <div class="brand-text">
                <div class="brand-title">Con ƒë∆∞·ªùng ƒëam m√™</div>
                <div class="brand-sub">AI-Powered Learning Path</div>
            </div>
        </div>
        <div class="nav-buttons" id="mainNavButtons">
        <!-- Buttons ch√≠nh s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
        </div>
        <div id="userArea" class="userInfo">
            <button class="login-btn"><i class="fa-solid fa-right-to-bracket"></i> ƒêƒÉng nh·∫≠p</button>
            <button class="register-btn"><i class="fa-solid fa-user-plus"></i> ƒêƒÉng k√Ω</button>
        </div>
    </div>
</div>

<!-- Navigation buttons ph·ª• CH·ªà CHO ADMIN - D∆Ø·ªöI thanh bar -->
<div class="admin-nav-container" id="adminNavContainer" style="display:none;">
    <div class="admin-nav-buttons" id="adminNavButtons">
    <!-- Admin buttons s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
    </div>
</div>
    <main>
      <div class="card" id="adminCard">
        <h2>üõ†Ô∏è Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h2>
        <p class="small">Hi·ªÉn th·ªã danh s√°ch users, th·ªùi gian ƒëƒÉng k√Ω, x√≥a users.</p>

        <section style="margin-top:14px;">
          <div style="margin-top:10px;">
            <button id="fetchUsersBtn" class="btn-refresh">
              <i class="fa-solid fa-list"></i> L·∫•y danh s√°ch users
            </button>
          </div>

          <div id="usersArea"></div>
          <div id="usersMessage" class="users-message" role="status" aria-live="polite"></div>
        </section>
      </div>

      <section id="aiHistorySection" style="display:none;" class="card">
        <h2>ü§ñ L·ªãch S·ª≠ H·ªèi AI</h2>
        <p class="small">Danh s√°ch t·∫•t c·∫£ c√°c l·∫ßn ng∆∞·ªùi d√πng s·ª≠ d·ª•ng AI ƒë·ªÉ t·∫°o l·ªô tr√¨nh.</p>
        
        <div style="margin: 15px 0;">
          <button id="fetchAIHistoryBtn" class="btn-refresh">
            <i class="fa-solid fa-sync"></i> T·∫£i L·ªãch S·ª≠
          </button>
        </div>
        
        <div id="aiHistoryArea"></div>
        <div id="aiHistoryMessage" role="status" aria-live="polite"></div>
      </section>

      <section id="categoriesSection" style="display:none;" class="card">
        <h2>üìÅ Qu·∫£n L√Ω Danh M·ª•c</h2>
        <p class="small">Qu·∫£n l√Ω danh m·ª•c v√† danh m·ª•c con cho l·ªô tr√¨nh h·ªçc.</p>
        
        <div style="margin: 15px 0;">
          <button id="fetchCategoriesBtn" class="btn-refresh">
            <i class="fa-solid fa-sync"></i> T·∫£i Danh M·ª•c
          </button>
          <button id="createCategoryBtn" class="create-btn" style="margin-left: 10px;">
            <i class="fa-solid fa-plus"></i> Th√™m Danh M·ª•c
          </button>
        </div>
        
        <div id="categoriesArea"></div>
        <div id="categoriesMessage" role="status" aria-live="polite"></div>
      </section>

      <section id="promptSection" style="display:none;" class="card">
        <div class="panel">
              <h2>Bi·∫øn B·∫Øt Bu·ªôc (Kh√¥ng ƒê∆∞·ª£c S·ª≠a)</h2>
              
              <div class="warning">
                  C√°c bi·∫øn d∆∞·ªõi ƒë√¢y l√† b·∫Øt bu·ªôc v√† kh√¥ng ƒë∆∞·ª£c ph√©p x√≥a ho·∫∑c s·ª≠a. N·∫øu x√≥a ho·∫∑c s·ª≠a, Prompt s·∫Ω b·ªã l·ªói khi t·∫°o l·ªô tr√¨nh.
              </div>

              <div class="info-text">
                  T·ªïng c·ªông: <strong>21 bi·∫øn</strong> t·ª´ 18 c√¢u h·ªèi c·ªßa ng∆∞·ªùi d√πng.
              </div>

              <ul class="var-list">
                  <li><span class="var-badge">&lt;CATEGORY&gt;</span></li>
                  <li><span class="var-badge">&lt;SUB_CATEGORY&gt;</span></li>
                  <li><span class="var-badge">&lt;ROADMAP_NAME&gt;</span></li>
                  <li><span class="var-badge">&lt;MAIN_PURPOSE&gt;</span></li>
                  <li><span class="var-badge">&lt;SPECIFIC_GOAL&gt;</span></li>
                  <li><span class="var-badge">&lt;CURRENT_JOB&gt;</span></li>
                  <li><span class="var-badge">&lt;STUDY_TIME&gt;</span></li>
                  <li><span class="var-badge">&lt;CURRENT_LEVEL&gt;</span></li>
                  <li><span class="var-badge">&lt;SKILLS_TO_IMPROVE&gt;</span></li>
                  <li><span class="var-badge">&lt;DAILY_TIME&gt;</span></li>
                  <li><span class="var-badge">&lt;WEEKLY_FREQUENCY&gt;</span></li>
                  <li><span class="var-badge">&lt;TOTAL_DURATION&gt;</span></li>
                  <li><span class="var-badge">&lt;LEARNING_STYLE&gt;</span></li>
                  <li><span class="var-badge">&lt;LEARNING_METHOD&gt;</span></li>
                  <li><span class="var-badge">&lt;DIFFICULTIES&gt;</span></li>
                  <li><span class="var-badge">&lt;MOTIVATION&gt;</span></li>
                  <li><span class="var-badge">&lt;MATERIAL_TYPE&gt;</span></li>
                  <li><span class="var-badge">&lt;MATERIAL_LANGUAGE&gt;</span></li>
                  <li><span class="var-badge">&lt;ASSESSMENT_TYPE&gt;</span></li>
                  <li><span class="var-badge">&lt;RESULT_DISPLAY&gt;</span></li>
                  <li><span class="var-badge">&lt;ASSESSMENT_FREQUENCY&gt;</span></li>
              </ul>
          </div>

          <div class="section-divider"></div>
        <h2>üìù Qu·∫£n L√Ω Prompt Template AI</h2>
        <p class="small">Ch·ªânh s·ª≠a template prompt ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ t·∫°o l·ªô tr√¨nh h·ªçc v·ªõi AI.</p>
        
        <div id="promptMessage" role="status" aria-live="polite"></div>
        
        <div style="margin: 20px 0;">
          <h3>‚úèÔ∏è Ch·ªânh S·ª≠a Prompt</h3>
          <textarea id="promptEditor" class="prompt-editor" placeholder="ƒêang t·∫£i prompt template..."></textarea>
          
          <div style="margin-top: 15px;">
            <button id="savePromptBtn" class="btn-save">
              <i class="fa-solid fa-save"></i> L∆∞u Prompt
            </button>
            <button id="resetPromptBtn" class="btn-reset">
              <i class="fa-solid fa-undo"></i> Kh√¥i Ph·ª•c M·∫∑c ƒê·ªãnh
            </button>
          </div>
        </div>

        <div style="margin: 20px 0;">
          <h3>üëÅÔ∏è N·ªôi Dung Prompt M·∫´u</h3>
          <div id="promptPreview" class="prompt-preview">ƒêang t·∫£i...</div>
        </div>
        <div style="margin: 20px 0;">
          <h3>ƒê·ªãnh d·∫°ng AI tr·∫£ v·ªÅ</h3>
          <div id="jsonFormat" class="json-format"></div>
        </div>
        <!-- ===== PH·∫¶N M·ªöI: PROMPT T·∫†O TH·ª¶ C√îNG ===== -->
        <div style="margin: 20px 0; border-top: 2px solid #e5e7eb; padding-top: 30px;">
          <h2>üìù Prompt Template (T·∫°o Th·ªß C√¥ng)</h2>
          <p class="small">Prompt n√†y s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã cho user non-admin ƒë·ªÉ h·ªç t·ª± h·ªèi AI b√™n ngo√†i.</p>
          
          <div id="manualPromptMessage" role="status" aria-live="polite"></div>
          
          <div style="margin: 20px 0;">
            <h3>‚úèÔ∏è Ch·ªânh S·ª≠a Prompt (T·∫°o Th·ªß C√¥ng)</h3>
            <textarea id="manualPromptEditor" class="prompt-editor" placeholder="ƒêang t·∫£i prompt template..."></textarea>
            
            <div style="margin-top: 15px;">
              <button id="saveManualPromptBtn" class="btn-save">
                <i class="fa-solid fa-save"></i> L∆∞u Prompt Th·ªß C√¥ng
              </button>
              <button id="resetManualPromptBtn" class="btn-reset">
                <i class="fa-solid fa-undo"></i> Kh√¥i Ph·ª•c M·∫∑c ƒê·ªãnh
              </button>
            </div>
          </div>

          <div style="margin: 20px 0;">
            <h3>üëÅÔ∏è N·ªôi Dung Prompt (T·∫°o Th·ªß C√¥ng)</h3>
            <div id="manualPromptPreview" class="prompt-preview">ƒêang t·∫£i...</div>
          </div>
        </div>
      </section>
      <section id="feedbackSection" style="display:none;" class="card">
    <h2>üí¨ Ph·∫£n H·ªìi Ng∆∞·ªùi D√πng</h2>
    <p class="small">Xem v√† ph√¢n t√≠ch ph·∫£n h·ªìi t·ª´ ng∆∞·ªùi d√πng v·ªÅ h·ªá th·ªëng.</p>
    
    <div style="margin: 15px 0;">
        <button id="fetchFeedbackBtn" class="btn-refresh">
            <i class="fa-solid fa-sync"></i> T·∫£i Ph·∫£n H·ªìi
        </button>
        <button id="viewStatsBtn" class="btn-refresh" style="margin-left: 10px;">
            <i class="fa-solid fa-chart-bar"></i> Xem Th·ªëng K√™
        </button>
    </div>
    
    <!-- Statistics Area -->
    <div id="statsArea" style="display:none; background: #f0f9ff; padding: 20px; border-radius: 12px; margin: 20px 0;">
        <h3 style="color: #0369a1; margin-bottom: 15px;">üìä Th·ªëng K√™ Trung B√¨nh</h3>
        <div id="statsContent"></div>
    </div>
    
    <div id="feedbackArea"></div>
    <div id="feedbackMessage" role="status" aria-live="polite"></div>
</section>
    </main>
<div id="footer"></div>
  <script>
    // Header JS exactly from the first file (loadUser + helpers)
    const loginBtn = document.querySelector(".login-btn");
    const registerBtn = document.querySelector(".register-btn");
    const userArea = document.getElementById("userArea");
    const ADMIN_TOKEN = 'admin-token';
    if(!ADMIN_TOKEN) window.location.href = 'login.html';
    // Color schemes for categories (kept from first file though admin page may not use it)
    const categoryColors = [
        { bg: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', icon: 'fa-code' },
        { bg: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', icon: 'fa-globe' },
        { bg: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)', icon: 'fa-palette' },
        { bg: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)', icon: 'fa-calculator' },
        { bg: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)', icon: 'fa-chart-line' },
        { bg: 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)', icon: 'fa-music' }
    ];

    function showAuthButtons() {
        if (loginBtn) loginBtn.style.display = "inline-flex";
        if (registerBtn) registerBtn.style.display = "inline-flex";
        const children = Array.from(userArea.children);
        children.forEach(c => {
            if (!c.classList.contains('login-btn') && !c.classList.contains('register-btn')) {
                try {
                    userArea.removeChild(c);
                } catch (e) {}
            }
        });
    }

    if (loginBtn) {
      loginBtn.addEventListener("click", () => {
          window.location.href = "login.html";
      });
    }

    if (registerBtn) {
      registerBtn.addEventListener("click", () => {
          window.location.href = "register.html";
      });
    }

    function wireLogoutAndNav(logoutEl) {
        if (logoutEl) {
            logoutEl.addEventListener('click', () => {
                localStorage.removeItem('token');
                localStorage.removeItem('role');
                window.location.href = 'main.html';
                if (!document.querySelector('.login-btn')) {
                    const b = document.createElement('button');
                    b.className = 'login-btn';
                    b.innerHTML = '<i class="fa-solid fa-right-to-bracket"></i> ƒêƒÉng nh·∫≠p';
                    b.addEventListener('click', () => window.location.href = 'login.html');
                    userArea.appendChild(b);
                }

                if (!document.querySelector('.register-btn')) {
                    const b2 = document.createElement('button');
                    b2.className = 'register-btn';
                    b2.innerHTML = '<i class="fa-solid fa-user-plus"></i> ƒêƒÉng k√Ω';
                    b2.addEventListener('click', () => window.location.href = 'register.html');
                    userArea.appendChild(b2);
                }

                showAuthButtons();
            });
        }
    }

// T√¨m h√†m loadUser() trong admin.html v√† s·ª≠a l·∫°i:
async function loadUser() {
    const token = localStorage.getItem('token');
    const navButtons = document.getElementById('mainNavButtons');
    
    // Lu√¥n hi·ªÉn th·ªã navigation buttons ch√≠nh
    if (navButtons) {
        navButtons.innerHTML = `
            <button class="nav-btn active" id="btnHome"><i class="fa-solid fa-house"></i> Trang Ch·ªß</button>
            <button class="nav-btn" id="btnPath"><i class="fa-solid fa-route"></i> L·ªô Tr√¨nh H·ªçc</button>
            <button class="nav-btn" id="btnProgress"><i class="fa-solid fa-chart-line"></i> Ti·∫øn ƒê·ªô</button>
        `;
        
        document.getElementById('btnHome').addEventListener('click', () => { window.location.href = 'main.html'; });
        
        document.getElementById('btnPath').addEventListener('click', () => { 
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
            } else {
                window.location.href = 'path.html';
            }
        });
        
        document.getElementById('btnProgress').addEventListener('click', () => { 
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
            } else {
                window.location.href = 'progress.html';
            }
        });
    }
    
    if (!token) {
        showAuthButtons();
        return;
    }

    let name = 'Ng∆∞·ªùi d√πng';
    let serverRole = 'user';

    if (token === ADMIN_TOKEN) {
        name = 'Admin';
        serverRole = 'admin';
        localStorage.setItem('role', 'admin');
    } else {
        try {
            const res = await fetch('/api/me', { headers: { 'Authorization': 'Bearer ' + token }});
            if (!res.ok) { 
                showAuthButtons(); 
                return; 
            }
            const data = await res.json();
            serverRole = (data && (data.role || (data.user && data.user.role))) ? (data.role || data.user.role) : 'user';
            name = (data && data.user && data.user.name) ? data.user.name : 'Ng∆∞·ªùi d√πng';
            localStorage.setItem('role', serverRole);
        } catch (err) {
            console.error(err);
            showAuthButtons();
            return;
        }
    }

    if (document.querySelector('.login-btn')) {
        document.querySelector('.login-btn').style.display = 'none';
    }
    if (document.querySelector('.register-btn')) {
        document.querySelector('.register-btn').style.display = 'none';
    }

    userArea.innerHTML = `
        <span>Xin ch√†o <strong style="color:white;">${name}</strong></span>
        <button id="logout" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i> ƒêƒÉng xu·∫•t</button>
    `;
    const logoutEl = document.getElementById('logout');
    wireLogoutAndNav(logoutEl);

    // Th√™m n√∫t Admin tr√™n thanh bar ch√≠nh
    if (serverRole === 'admin') {
        const adminBtn = document.createElement('button');
        adminBtn.className = 'nav-btn';
        adminBtn.id = 'btnAdmin';
        adminBtn.innerHTML = '<i class="fa-solid fa-user-shield"></i> Qu·∫£n Tr·ªã';
        adminBtn.addEventListener('click', () => { 
            // Hi·ªÉn th·ªã card qu·∫£n l√Ω user
            document.getElementById('adminCard').style.display = 'block';
            document.getElementById('aiHistorySection').style.display = 'none';
            document.getElementById('categoriesSection').style.display = 'none';
            document.getElementById('promptSection').style.display = 'none';
            document.getElementById('feedbackSection').style.display = 'none';
            
            // Update active state
            document.querySelectorAll('.admin-nav-btn').forEach(b => b.classList.remove('active'));
            const btnUsers = document.getElementById('btnUsers');
            if (btnUsers) btnUsers.classList.add('active');
        });
        navButtons.appendChild(adminBtn);
        
        // ‚úÖ HI·ªÇN TH·ªä THANH NAV PH·ª§ CHO ADMIN
        const adminNavContainer = document.getElementById('adminNavContainer');
        const adminNavButtons = document.getElementById('adminNavButtons');
        
        if (adminNavContainer && adminNavButtons) {
            adminNavContainer.style.display = 'block';
            document.body.classList.add('has-admin-nav');
            
            adminNavButtons.innerHTML = `
                <button class="admin-nav-btn active" id="btnUsers"><i class="fa-solid fa-users"></i> Qu·∫£n L√Ω User</button>
                <button class="admin-nav-btn" id="btnAIHistory"><i class="fa-solid fa-robot"></i> L·ªãch S·ª≠ AI</button>
                <button class="admin-nav-btn" id="btnCategories"><i class="fa-solid fa-folder"></i> Danh M·ª•c</button>
                <button class="admin-nav-btn" id="btnPrompt"><i class="fa-solid fa-file-code"></i> Prompt Template</button>
                <button class="admin-nav-btn" id="btnFeedback"><i class="fa-solid fa-comments"></i> Ph·∫£n H·ªìi</button>
            `;
            
            // Event listeners cho c√°c n√∫t admin
            document.getElementById('btnUsers').addEventListener('click', () => {
                document.getElementById('adminCard').style.display = 'block';
                document.getElementById('aiHistorySection').style.display = 'none';
                document.getElementById('categoriesSection').style.display = 'none';
                document.getElementById('promptSection').style.display = 'none';
                document.getElementById('feedbackSection').style.display = 'none';
                
                document.querySelectorAll('.admin-nav-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('btnUsers').classList.add('active');
            });
            
            document.getElementById('btnAIHistory').addEventListener('click', () => {
                document.getElementById('aiHistorySection').style.display = 'block';
                document.getElementById('categoriesSection').style.display = 'none';
                document.getElementById('promptSection').style.display = 'none';
                document.getElementById('adminCard').style.display = 'none';
                document.getElementById('feedbackSection').style.display = 'none';
                
                document.querySelectorAll('.admin-nav-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('btnAIHistory').classList.add('active');
            });
            
            document.getElementById('btnCategories').addEventListener('click', () => {
                document.getElementById('categoriesSection').style.display = 'block';
                document.getElementById('aiHistorySection').style.display = 'none';
                document.getElementById('promptSection').style.display = 'none';
                document.getElementById('adminCard').style.display = 'none';
                document.getElementById('feedbackSection').style.display = 'none';
                
                document.querySelectorAll('.admin-nav-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('btnCategories').classList.add('active');
            });
            
            document.getElementById('btnPrompt').addEventListener('click', () => {
                document.getElementById('promptSection').style.display = 'block';
                document.getElementById('aiHistorySection').style.display = 'none';
                document.getElementById('categoriesSection').style.display = 'none';
                document.getElementById('adminCard').style.display = 'none';
                document.getElementById('feedbackSection').style.display = 'none';
                loadPromptTemplate().catch(()=>{});
                loadManualPromptTemplate().catch(()=>{});
                
                document.querySelectorAll('.admin-nav-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('btnPrompt').classList.add('active');
            });
            
            document.getElementById('btnFeedback').addEventListener('click', () => {
                document.getElementById('feedbackSection').style.display = 'block';
                document.getElementById('promptSection').style.display = 'none';
                document.getElementById('aiHistorySection').style.display = 'none';
                document.getElementById('categoriesSection').style.display = 'none';
                document.getElementById('adminCard').style.display = 'none';
                
                document.querySelectorAll('.admin-nav-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('btnFeedback').classList.add('active');
            });
            document.getElementById('adminCard').style.display = 'block';
            document.getElementById('aiHistorySection').style.display = 'none';
            document.getElementById('categoriesSection').style.display = 'none';
            document.getElementById('promptSection').style.display = 'none';
            document.getElementById('feedbackSection').style.display = 'none';
        }
    }

    // Active state
    const params = new URLSearchParams(window.location.search);
    const page = params.get('page') || 'home';
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    const idMap = { home: 'btnHome', path: 'btnPath', progress: 'btnProgress', admin: 'btnAdmin' };
    const btnId = idMap[page];
    if (btnId) {
        const el = document.getElementById(btnId);
        if (el) el.classList.add('active');
    }
}
    // Load top categories (from first file) - kept but optional for admin
    async function loadTopCategories() {
        try {
            const res = await fetch('/api/categories/top', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });

            if (!res.ok) throw new Error('Failed to load categories');
            
            const categories = await res.json();
            const grid = document.getElementById('categoriesArea');
            if (!grid) return;
            
            grid.innerHTML = '';
            categories.forEach((cat, index) => {
                const colorScheme = categoryColors[index % categoryColors.length];
                const card = document.createElement('div');
                card.className = 'history-card';
                card.onclick = () => {
                    window.location.href = `main_category.html?category=${encodeURIComponent(cat.id)}`;
                };
                
                card.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                      <div>
                        <div style="font-weight:700;font-size:16px;">${escapeHtml(cat.name)}</div>
                        <div style="color:${'var(--muted)'};font-size:13px;">${escapeHtml(cat.description || '')}</div>
                      </div>
                      <div style="text-align:right;color:var(--primary);font-weight:700;">${cat.roadmap_count || (cat.roadmap_count===0?0:'-')}</div>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        } catch (err) {
            console.error('Error loading categories:', err);
        }
    }

    // Initialize header + categories
    loadUser().catch((e)=>console.error(e));
    //loadTopCategories().catch(()=>{});

    // ============ Admin page JS (user management, ai history, categories, prompt) ============
    // The admin logic is preserved from the admin file you provided.

    // Basic admin auth check (also keeps behavior consistent)
    (function adminAuthCheck(){
      const token = localStorage.getItem('token');
      const storedRole = localStorage.getItem('role');
      if (!token) {
        alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c!');
        window.location.replace('login.html');
      } else if (storedRole !== 'admin') {
        alert('B·∫°n kh√¥ng ph·∫£i qu·∫£n tr·ªã!');
        window.location.replace('path.html');
      }
    })();

    // ============ DOM ELEMENTS ============
    const fetchUsersBtn = document.getElementById('fetchUsersBtn');
    const usersArea = document.getElementById('usersArea');
    const usersMessage = document.getElementById('usersMessage');

    const fetchAIHistoryBtn = document.getElementById('fetchAIHistoryBtn');
    const aiHistoryArea = document.getElementById('aiHistoryArea');
    const aiHistoryMessage = document.getElementById('aiHistoryMessage');

    const fetchCategoriesBtn = document.getElementById('fetchCategoriesBtn');
    const createCategoryBtn = document.getElementById('createCategoryBtn');
    const categoriesArea = document.getElementById('categoriesArea');
    const categoriesMessage = document.getElementById('categoriesMessage');

    const promptEditor = document.getElementById('promptEditor');
    const promptPreview = document.getElementById('promptPreview');
    const jsonFormat = document.getElementById('jsonFormat');
    const savePromptBtn = document.getElementById('savePromptBtn');
    const resetPromptBtn = document.getElementById('resetPromptBtn');
    const promptMessage = document.getElementById('promptMessage');

    // Utility
    function fmtDate(iso) {
      try {
        if (!iso) return '-';
        const d = new Date(iso);
        if (isNaN(d)) return iso;
        
        // Convert sang m√∫i gi·ªù Vi·ªát Nam (GMT+7)
        const utc = d.getTime() + (d.getTimezoneOffset() * 60000);
        const vnTime = new Date(utc + (7 * 60 * 60 * 1000));
        return vnTime.toLocaleString('vi-VN');
      } catch (e) {
        return iso;
      }
    }

    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function showMessage(message, type = 'info') {
      if (!promptMessage) return;
      const msgDiv = document.createElement('div');
      msgDiv.className = type === 'success' ? 'success-message' : 'error-message';
      msgDiv.textContent = message;
      
      promptMessage.innerHTML = '';
      promptMessage.appendChild(msgDiv);
      
      setTimeout(() => {
        msgDiv.remove();
      }, 3000);
    }

    // Users
    function renderUsersTable(users) {
      if (!Array.isArray(users) || users.length === 0) {
        usersArea.innerHTML = '<div class="muted">Kh√¥ng c√≥ user n√†o.</div>';
        return;
      }

      const rows = users.map(user => {
        const id = user.id || user._id || user.email;
        const name = user.name || user.username || '-';
        const email = user.email || '-';
        const createdAt = user.created_at || user.createdAt || user.registeredAt || user.registered_at || '';

        return `
          <tr data-id="${escapeHtml(String(id))}">
            <td>${escapeHtml(name)}</td>
            <td>${escapeHtml(email)}</td>
            <td>${escapeHtml(fmtDate(createdAt))}</td>
            <td class="actions-cell">
              <button class="btn-delete" data-id="${escapeHtml(String(id))}"><i class="fa-solid fa-trash"></i> X√≥a</button>
            </td>
          </tr>
        `;
      }).join('');

      usersArea.innerHTML = `
        <table class="users-table" aria-describedby="usersMessage">
          <thead>
            <tr>
              <th>T√™n</th>
              <th>Email</th>
              <th>Th·ªùi gian ƒëƒÉng k√Ω</th>
              <th>H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;

      document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', onDeleteUserClick);
      });
    }

    async function onDeleteUserClick(evt) {
      const id = evt.currentTarget.getAttribute('data-id');
      if (!id) return alert('Kh√¥ng c√≥ id user');
      const row = evt.currentTarget.closest('tr');
      const emailCell = row.querySelector('td:nth-child(2)');
      const email = emailCell ? emailCell.textContent.trim() : '';
      
      if (email === 'a&m!NA!i@gmail.com') {
        alert('Kh√¥ng th·ªÉ x√≥a t√†i kho·∫£n admin!');
        return;
      }

      const ok = confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a user n√†y? H√†nh ƒë·ªông kh√¥ng th·ªÉ ho√†n t√°c.');
      if (!ok) return;

      const token = localStorage.getItem('token');
      usersMessage.textContent = 'ƒêang x√≥a...';
      try {
        const res = await fetch(`/api/users/${encodeURIComponent(id)}`, {
          method: 'DELETE',
          headers: {
            ...(token && { 'Authorization': 'Bearer ' + token }),
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache'
          },
          cache: 'no-store'
        });

        if (res.ok) {
          const row = document.querySelector(`tr[data-id="${CSS.escape(id)}"]`);
          if (row) row.remove();
          usersMessage.textContent = 'X√≥a th√†nh c√¥ng.';
        } else {
          const body = await res.json().catch(() => null);
          const msg = (body && body.message) ? body.message : `X√≥a th·∫•t b·∫°i (status ${res.status}).`;
          usersMessage.textContent = msg;
          alert(msg);
        }
      } catch (err) {
        console.error(err);
        usersMessage.textContent = 'L·ªói m·∫°ng khi x√≥a user.';
        alert('L·ªói m·∫°ng khi x√≥a user.');
      } finally {
        setTimeout(() => { usersMessage.textContent = ''; }, 2500);
      }
    }

    async function fetchUsersFromServerOrFallback() {
      usersMessage.textContent = 'ƒêang t·∫£i danh s√°ch users...';
      fetchUsersBtn.disabled = true;
      try {
        const token = localStorage.getItem('token');
        const res = await fetch('/api/users', {
          headers: {
            ...(token && { 'Authorization': 'Bearer ' + token }),
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache'
          },
          cache: 'no-store'
        });

        if (!res.ok) {
          const body = await res.json().catch(() => null);
          usersMessage.textContent = (body && body.message) ? body.message : `Server tr·∫£ l·ªói (${res.status}). D√πng d·ªØ li·ªáu m·∫´u.`;
          await new Promise(r => setTimeout(r, 600));
          const sample = sampleUsers();
          renderUsersTable(sample);
          return;
        }

        const data = await res.json().catch(() => null);
        const users = data && data.data ? data.data : (Array.isArray(data) ? data : null);
        
        if (!Array.isArray(users)) {
          usersMessage.textContent = 'D·ªØ li·ªáu server kh√¥ng h·ª£p l·ªá. D√πng d·ªØ li·ªáu m·∫´u.';
          const sample = sampleUsers();
          renderUsersTable(sample);
          return;
        }

        renderUsersTable(users);
        usersMessage.textContent = `T·∫£i ${users.length} users.`;
      } catch (err) {
        console.error(err);
        usersMessage.textContent = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi server. Hi·ªÉn th·ªã d·ªØ li·ªáu m·∫´u.';
        const sample = sampleUsers();
        renderUsersTable(sample);
      } finally {
        fetchUsersBtn.disabled = false;
        setTimeout(() => { usersMessage.textContent = ''; }, 2000);
      }
    }

    function sampleUsers() {
      return [
        { id: '1', name: 'Nguy·ªÖn VƒÉn A', email: 'a@example.com', created_at: new Date(Date.now() - 1000 * 60 * 60 * 24 * 90).toISOString() },
        { id: '2', name: 'Tr·∫ßn Th·ªã B', email: 'b@example.com', created_at: new Date(Date.now() - 1000 * 60 * 60 * 24 * 45).toISOString() },
        { id: '3', name: 'L√™ VƒÉn C', email: 'c@example.com', created_at: new Date(Date.now() - 1000 * 60 * 60 * 24 * 10).toISOString() }
      ];
    }

    let fetchClickCount = 0;
    if (fetchUsersBtn) {
      fetchUsersBtn.addEventListener('click', async function() {
        fetchClickCount++;
        if (fetchClickCount % 2 === 1) {
          await fetchUsersFromServerOrFallback();
        } else {
          usersArea.innerHTML = '';
          usersMessage.textContent = 'Danh s√°ch ƒë√£ ƒë√≥ng.';
          setTimeout(() => { usersMessage.textContent = ''; }, 1400);
        }
      });
    }

function toVietnamTime(isoDate) {
  if (!isoDate) return 'N/A';
  const date = new Date(isoDate);
  const utc = date.getTime() + (date.getTimezoneOffset() * 60000);
  const vnTime = new Date(utc + (7 * 60 * 60 * 1000));
  return vnTime.toLocaleString('vi-VN');
}
// AI History
function renderAIHistory(records, total) {
  if (!records || records.length === 0) {
    aiHistoryArea.innerHTML = '<div class="muted">Ch∆∞a c√≥ l·ªãch s·ª≠ n√†o</div>';
    return;
  }
  
  const html = records.map(r => {
    const statusClass = r.status === 'SUCCESS' ? 'status-success' : 
                      r.status === 'FAIL' ? 'status-fail' : 
                      r.status === 'TIMEOUT' ? 'status-timeout' : '';
    
    // ‚úÖ X·ª¨ L√ù PROMPT CONTENT ƒê√öNG
    let promptPreview = '';
    let fullPrompt = '';
    try {
      if (typeof r.prompt_content === 'string') {
        // Th·ª≠ parse JSON
        try {
          const parsed = JSON.parse(r.prompt_content);
          // ∆Øu ti√™n l·∫•y userPrompt, n·∫øu kh√¥ng c√≥ th√¨ stringify c·∫£ object
          fullPrompt = parsed.userPrompt || JSON.stringify(parsed, null, 2);
        } catch (e) {
          // N·∫øu parse l·ªói, d√πng string g·ªëc
          fullPrompt = r.prompt_content;
        }
      } else {
        fullPrompt = JSON.stringify(r.prompt_content, null, 2);
      }
      promptPreview = fullPrompt.substring(0, 200) + (fullPrompt.length > 200 ? '...' : '');
    } catch (e) {
      fullPrompt = String(r.prompt_content || 'N/A');
      promptPreview = fullPrompt.substring(0, 200);
    }
    
    return `
      <div class="history-card">
        <div class="history-header">
          <div>
            <strong>ID #${r.id}</strong> - ${toVietnamTime(r.query_time)}
          </div>
          <span class="status-badge ${statusClass}">${r.status}</span>
        </div>
        <div style="margin-top: 10px;">
          <strong>Ng∆∞·ªùi h·ªèi:</strong> ${escapeHtml(r.username || 'N/A')} (${escapeHtml(r.email || '')})<br>
          
          <!-- ‚úÖ HI·ªÇN TH·ªä M√É L·ªò TR√åNH -->
          <strong>M√£ l·ªô tr√¨nh:</strong> 
          ${r.roadmap_id 
            ? `<a href="path.html?open=${r.roadmap_id}" target="_blank" style="color: #007bff; font-weight: bold; text-decoration: underline;">#${r.roadmap_id}</a>` 
            : '<span style="color: #999; font-style: italic;">Ch∆∞a l∆∞u</span>'
          }
          ${r.roadmap_name ? ` - ${escapeHtml(r.roadmap_name)}` : ''}<br>
          
          ${r.response_tokens ? `<strong>Tokens:</strong> ${r.response_tokens}<br>` : ''}
          ${r.error_message ? `<strong style="color:#dc2625;">L·ªói:</strong> ${escapeHtml(r.error_message)}<br>` : ''}
          
          <!-- ‚úÖ HI·ªÇN TH·ªä PROMPT CONTENT (R√öT G·ªåN) -->
          <br><details style="margin-top: 8px;">
            <summary style="cursor: pointer; color: #007bff; font-weight: 600; padding: 8px; background: #f0f9ff; border-radius: 6px;">
              üîç Xem Prompt (${promptPreview.length} / ${fullPrompt.length} k√Ω t·ª±)
            </summary>
            <div style="margin-top: 10px; padding: 15px; background: #f5f5f5; border-radius: 8px; max-height: 500px; overflow-y: auto; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.6;">
              ${escapeHtml(fullPrompt)}
            </div>
          </details>
        </div>
      </div>
    `;
  }).join('');
  
  aiHistoryArea.innerHTML = `<div style="margin-bottom:15px;"><strong>T·ªïng: ${total} b·∫£n ghi</strong></div>` + html;
}
    let fetchAIClickCount = 0;
    if (fetchAIHistoryBtn) {
      fetchAIHistoryBtn.addEventListener('click', async function() {
        fetchAIClickCount++;
        
        if (fetchAIClickCount % 2 === 1) {
          aiHistoryMessage.textContent = 'ƒêang t·∫£i...';
          fetchAIHistoryBtn.disabled = true;
          
          try {
            const token = localStorage.getItem('token');
            const res = await fetch('/api/admin/ai-history', {
              headers: { 
                'Authorization': 'Bearer ' + token,
                'Cache-Control': 'no-cache'
              }
            });
            
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            
            const data = await res.json();
            renderAIHistory(data.data, data.total);
            aiHistoryMessage.textContent = `ƒê√£ t·∫£i ${data.data.length} b·∫£n ghi`;
          } catch (err) {
            console.error(err);
            aiHistoryMessage.textContent = 'L·ªói khi t·∫£i l·ªãch s·ª≠';
            aiHistoryArea.innerHTML = '<div class="muted">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</div>';
          } finally {
            fetchAIHistoryBtn.disabled = false;
            setTimeout(() => { aiHistoryMessage.textContent = ''; }, 2500);
          }
        } else {
          aiHistoryArea.innerHTML = '';
          aiHistoryMessage.textContent = 'Danh s√°ch ƒë√£ ƒë√≥ng.';
          setTimeout(() => { aiHistoryMessage.textContent = ''; }, 1400);
        }
      });
    }

    // Categories
    function renderCategories(categories) {
      if (!categories || categories.length === 0) {
        categoriesArea.innerHTML = '<div class="muted">Ch∆∞a c√≥ danh m·ª•c n√†o</div>';
        return;
      }
      
      const html = categories.map(cat => {
        const subCats = cat.sub_categories || [];
        return `
          <div class="history-card">
            <div class="history-header">
              <div>
                <strong style="font-size: 16px;">${escapeHtml(cat.name)}</strong><br>
                <span style="color: #6b7280; font-size: 13px;">${escapeHtml(cat.description || '')}</span>
              </div>
              <div>
                <button class="btn-refresh" onclick="addSubCategory(${cat.id}, '${escapeHtml(cat.name)}')" style="margin-right: 5px;">
                  <i class="fa-solid fa-plus"></i> Th√™m con
                </button>
                <button class="btn-delete" onclick="deleteCategory(${cat.id}, '${escapeHtml(cat.name)}')">
                  <i class="fa-solid fa-trash"></i> X√≥a
                </button>
              </div>
            </div>
            ${subCats.length > 0 ? `
              <div style="margin-top: 10px; padding-left: 20px;">
                <strong>Danh m·ª•c con:</strong>
                <ul style="margin: 5px 0 0 20px;">
                  ${subCats.map(sub => `
                    <li style="margin: 5px 0;">
                      ${escapeHtml(sub.name)}
                      <button class="btn-delete" onclick="deleteSubCategory(${sub.id})" style="margin-left: 10px; padding: 2px 8px; font-size: 11px;">
                        X√≥a
                      </button>
                    </li>
                  `).join('')}
                </ul>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
      
      categoriesArea.innerHTML = html;
    }

    async function loadCategories() {
      categoriesMessage.textContent = 'ƒêang t·∫£i...';
      fetchCategoriesBtn.disabled = true;
      
      try {
        const token = localStorage.getItem('token');
        const res = await fetch('/api/categories', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        
        if (!res.ok) {
          throw new Error(`HTTP error! Status: ${res.status} - ${res.statusText}`);
        }
        
        const data = await res.json();
        
        if (!data?.success || !Array.isArray(data.data)) {
          throw new Error('D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá t·ª´ server');
        }
        
        renderCategories(data.data);
        categoriesMessage.textContent = `ƒê√£ t·∫£i ${data.data.length} danh m·ª•c`;
      } catch (err) {
        console.error('L·ªói t·∫£i danh m·ª•c:', err.message || err);
        categoriesMessage.textContent = `L·ªói khi t·∫£i danh m·ª•c: ${err.message || 'Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.'}`;
        categoriesArea.innerHTML = '<div class="muted">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</div>';
      } finally {
        fetchCategoriesBtn.disabled = false;
        setTimeout(() => { categoriesMessage.textContent = ''; }, 2500);
      }
    }

    let fetchCatClickCount = 0;
    if (fetchCategoriesBtn) {
      fetchCategoriesBtn.addEventListener('click', async function() {
        fetchCatClickCount++;
        
        if (fetchCatClickCount % 2 === 1) {
          await loadCategories();
        } else {
          categoriesArea.innerHTML = '';
          categoriesMessage.textContent = 'Danh s√°ch ƒë√£ ƒë√≥ng.';
          setTimeout(() => { categoriesMessage.textContent = ''; }, 1400);
        }
      });
    }

    if (createCategoryBtn) {
      createCategoryBtn.addEventListener('click', () => {
        const name = prompt('T√™n danh m·ª•c m·ªõi:');
        if (!name || !name.trim()) return;
        
        const description = prompt('M√¥ t·∫£ (c√≥ th·ªÉ ƒë·ªÉ tr·ªëng):');
        createCategory(name.trim(), description?.trim());
      });
    }

    async function createCategory(name, description) {
      try {
        const token = localStorage.getItem('token');
        const res = await fetch('/api/admin/categories', {
          method: 'POST',
          headers: { 
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ name, description })
        });
        
        const data = await res.json();
        
        if (data.success) {
          alert('‚úÖ ' + data.message);
          if (fetchCatClickCount % 2 === 1) {
            loadCategories();
          }
        } else if (token !== ADMIN_TOKEN) {
          alert('Token ƒë√£ h·∫øt h·∫°n, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!');
        }
          else {
          alert('‚ùå ' + data.error);
        }
      } catch (err) {
        console.error(err);
        alert('L·ªói khi t·∫°o danh m·ª•c');
      }
    }

    window.addSubCategory = async function(categoryId, categoryName) {
      const name = prompt(`T√™n danh m·ª•c con cho "${categoryName}":`);
      if (!name || !name.trim()) return;
      
      const description = prompt('M√¥ t·∫£ (c√≥ th·ªÉ ƒë·ªÉ tr·ªëng):');
      
      try {
        const token = localStorage.getItem('token');
        const res = await fetch('/api/admin/sub-categories', {
          method: 'POST',
          headers: { 
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ 
            category_id: categoryId, 
            name: name.trim(), 
            description: description?.trim() 
          })
        });
        
        const data = await res.json();
        
        if (data.success) {
          alert('‚úÖ ' + data.message);
          if (fetchCatClickCount % 2 === 1) {
            loadCategories();
          }
        } else {
          alert('‚ùå ' + data.error);
        }
      } catch (err) {
        console.error(err);
        alert('L·ªói khi t·∫°o danh m·ª•c con');
      }
    };

    window.deleteCategory = async function(id, name) {
      if (!confirm(`X√≥a danh m·ª•c "${name}"?\n\nC·∫£nh b√°o: T·∫•t c·∫£ danh m·ª•c con c≈©ng s·∫Ω b·ªã x√≥a!`)) return;
      
      try {
        const token = localStorage.getItem('token');
        const res = await fetch(`/api/admin/categories/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        
        const data = await res.json();
        
        if (data.success) {
          alert('‚úÖ ' + data.message);
          if (fetchCatClickCount % 2 === 1) {
            loadCategories();
          }
        } else {
          alert('‚ùå ' + data.error);
        }
      } catch (err) {
        console.error(err);
        alert('L·ªói khi x√≥a danh m·ª•c');
      }
    };

    window.deleteSubCategory = async function(id) {
      if (!confirm('X√≥a danh m·ª•c con n√†y?')) return;
      
      try {
        const token = localStorage.getItem('token');
        const res = await fetch(`/api/admin/sub-categories/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        
        const data = await res.json();
        
        if (data.success) {
          alert('‚úÖ ' + data.message);
          if (fetchCatClickCount % 2 === 1) {
            loadCategories();
          }
        } else {
          alert('‚ùå ' + data.error);
        }
      } catch (err) {
        console.error(err);
        alert('L·ªói khi x√≥a');
      }
    };

    // Prompt Template Management
// THAY TH·∫æ ph·∫ßn loadPromptTemplate (kho·∫£ng d√≤ng 1500)
async function loadPromptTemplate() {
  try {
    if (promptEditor) promptEditor.disabled = true;
    if (promptEditor) promptEditor.value = 'ƒêang t·∫£i...';
    if (promptPreview) promptPreview.textContent = 'ƒêang t·∫£i...';
    if (jsonFormat) jsonFormat.textContent = 'ƒêang t·∫£i...';
    
    const res = await fetch('/api/admin/prompt', {
     method: 'POST',
     headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token')}`
     },
    });
    
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    
    const data = await res.json();
    
    if (data.success && data.data) {
      const promptContent = data.data.prompt_template || '';
      const jsonFormatContent = data.data.json_format_response || '';
      
      if (promptEditor) promptEditor.value = promptContent;
      if (promptPreview) promptPreview.textContent = promptContent;
      
      // ‚úÖ ∆Øu ti√™n json_format_response t·ª´ DB, n·∫øu kh√¥ng c√≥ th√¨ extract t·ª´ prompt
      if (jsonFormatContent) {
        if (jsonFormat) jsonFormat.textContent = jsonFormatContent;
      } else {
        // Fallback: extract t·ª´ prompt
        const extractedJson = extractJsonFromPrompt(promptContent);
        if (extractedJson && jsonFormat) {
          jsonFormat.textContent = extractedJson;
        }
      }
    } else {
      throw new Error('Kh√¥ng th·ªÉ t·∫£i prompt template');
    }
  } catch (err) {
    console.error(err);
    const token = localStorage.getItem('token');
    if (token !== ADMIN_TOKEN) {
      showMessage('Token ƒë√£ h·∫øt h·∫°n, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!', 'error');
    } else {
      showMessage('L·ªói khi t·∫£i prompt template: ' + err.message, 'error');
    }
    if (promptEditor) promptEditor.value = '';
    if (promptPreview) promptPreview.textContent = 'Kh√¥ng th·ªÉ t·∫£i prompt template';
  } finally {
    if (promptEditor) promptEditor.disabled = false;
  }
}
// Thay th·∫ø h√†m extractJsonFromPrompt() (d√≤ng ~1550)
function extractJsonFromPrompt(promptText) {
  try {
    // ‚úÖ ƒê∆†N GI·∫¢N: Ch·ªâ t√¨m ```json ... ```
    const jsonMatch = promptText.match(/```json\s*([\s\S]*?)\s*```/);
    
    if (jsonMatch && jsonMatch[1]) {
      const jsonStr = jsonMatch[1].trim();
      
      // Validate JSON format (optional - c√≥ th·ªÉ b·ªè n·∫øu mu·ªën)
      try {
        JSON.parse(jsonStr);
        return jsonStr;
      } catch (e) {
        console.warn('Invalid JSON syntax:', e.message);
        // ‚úÖ V·∫™N TR·∫¢ V·ªÄ d√π JSON l·ªói (ƒë·ªÉ l∆∞u v√†o DB)
        return jsonStr;
      }
    }
    
    // ‚ùå Kh√¥ng t√¨m th·∫•y ```json
    return null;
    
  } catch (e) {
    console.error('Error extracting JSON:', e);
    return null;
  }
}
// ============ MANUAL PROMPT TEMPLATE FUNCTIONS ============
    async function loadManualPromptTemplate() {
      try {
        if (manualPromptEditor) manualPromptEditor.disabled = true;
        if (manualPromptEditor) manualPromptEditor.value = 'ƒêang t·∫£i...';
        if (manualPromptPreview) manualPromptPreview.textContent = 'ƒêang t·∫£i...';
        
        const res = await fetch('/api/admin/manual-prompt', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
        });
        
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        
        const data = await res.json();
        
        if (data.success && data.data) {
          if (manualPromptEditor) manualPromptEditor.value = data.data.manual_prompt_template || '';
          if (manualPromptPreview) manualPromptPreview.textContent = data.data.manual_prompt_template || '';
        } else {
          throw new Error('Kh√¥ng th·ªÉ t·∫£i manual prompt template');
        }
      } catch (err) {
        console.error(err);
        const token = localStorage.getItem('token');
        if (token !== ADMIN_TOKEN) {
          showManualPromptMessage('Token ƒë√£ h·∫øt h·∫°n, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!', 'error');
        } else {
          showManualPromptMessage('L·ªói khi t·∫£i manual prompt template: ' + err.message, 'error');
        }
        if (manualPromptEditor) manualPromptEditor.value = '';
        if (manualPromptPreview) manualPromptPreview.textContent = 'Kh√¥ng th·ªÉ t·∫£i manual prompt template';
      } finally {
        if (manualPromptEditor) manualPromptEditor.disabled = false;
      }
    }

    function showManualPromptMessage(message, type = 'info') {
      const manualPromptMessage = document.getElementById('manualPromptMessage');
      if (!manualPromptMessage) return;
      const msgDiv = document.createElement('div');
      msgDiv.className = type === 'success' ? 'success-message' : 'error-message';
      msgDiv.textContent = message;
      
      manualPromptMessage.innerHTML = '';
      manualPromptMessage.appendChild(msgDiv);
      
      setTimeout(() => {
        msgDiv.remove();
      }, 3000);
    }

    const manualPromptEditor = document.getElementById('manualPromptEditor');
    const manualPromptPreview = document.getElementById('manualPromptPreview');
    const saveManualPromptBtn = document.getElementById('saveManualPromptBtn');
    const resetManualPromptBtn = document.getElementById('resetManualPromptBtn');

    if (saveManualPromptBtn) {
      saveManualPromptBtn.addEventListener('click', async function() {
        const content = manualPromptEditor.value.trim();
        
        if (!content) {
          showManualPromptMessage('Prompt kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng', 'error');
          return;
        }
        
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën l∆∞u prompt th·ªß c√¥ng n√†y?')) return;
        
        saveManualPromptBtn.disabled = true;
        saveManualPromptBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang l∆∞u...';
        
        try {
          const res = await fetch('/api/admin/manual-prompt/save', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({
              manualPromptContent: content
            })
          });
          
          const data = await res.json();
          
          if (data.success) {
            showManualPromptMessage('‚úÖ Manual Prompt ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!', 'success');
            manualPromptPreview.textContent = content;
          } else {
            throw new Error(data.error || 'L·ªói khi l∆∞u manual prompt');
          }
        } catch (err) {
          console.error(err);
          showManualPromptMessage('‚ùå ' + err.message, 'error');
        } finally {
          saveManualPromptBtn.disabled = false;
          saveManualPromptBtn.innerHTML = '<i class="fa-solid fa-save"></i> L∆∞u Prompt Th·ªß C√¥ng';
        }
      });
    }

if (resetManualPromptBtn) {
  resetManualPromptBtn.addEventListener('click', async function() {
    if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën kh√¥i ph·ª•c prompt th·ªß c√¥ng v·ªÅ m·∫∑c ƒë·ªãnh? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) return;
    
    resetManualPromptBtn.disabled = true;
    resetManualPromptBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang kh√¥i ph·ª•c...';
    
    try {
      const token = localStorage.getItem('token');
      const res = await fetch('/api/admin/manual-prompt/reset', {
        method: 'POST',
        headers: { 
          'Authorization': 'Bearer ' + token
        }
      });
      
      const data = await res.json();
      
      if (data.success) {
        showManualPromptMessage('‚úÖ ƒê√£ kh√¥i ph·ª•c manual prompt m·∫∑c ƒë·ªãnh!', 'success');
        
        // ‚úÖ UPDATE C·∫¢ EDITOR V√Ä PREVIEW
        const manualPromptContent = data.data.manual_prompt_template;
        
        if (manualPromptEditor) manualPromptEditor.value = manualPromptContent;
        if (manualPromptPreview) manualPromptPreview.textContent = manualPromptContent;
        
      } else {
        throw new Error(data.error || 'L·ªói khi kh√¥i ph·ª•c manual prompt');
      }
    } catch (err) {
      console.error(err);
      showManualPromptMessage('‚ùå ' + err.message, 'error');
    } finally {
      resetManualPromptBtn.disabled = false;
      resetManualPromptBtn.innerHTML = '<i class="fa-solid fa-undo"></i> Kh√¥i Ph·ª•c M·∫∑c ƒê·ªãnh';
    }
  });
}

    if (manualPromptEditor) {
      manualPromptEditor.addEventListener('input', function() {
        if (manualPromptPreview) manualPromptPreview.textContent = this.value;
      });
    }
// THAY TH·∫æ ph·∫ßn savePromptBtn.addEventListener (kho·∫£ng d√≤ng 1700)
// Trong savePromptBtn.addEventListener (d√≤ng ~1700)
if (savePromptBtn) {
  savePromptBtn.addEventListener('click', async function() {
    const content = promptEditor.value.trim();
    
    if (!content) {
      showMessage('Prompt kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng', 'error');
      return;
    }
    
    // ‚úÖ Ch·ªâ check c√≥ ```json kh√¥ng
    if (!content.includes('```json')) {
      showMessage('‚ùå Prompt ph·∫£i c√≥ ph·∫ßn ```json ƒë·ªÉ ƒë·ªãnh d·∫°ng output!', 'error');
      return;
    }
    
    // Extract JSON
    const extractedJson = extractJsonFromPrompt(content);
    
    if (!extractedJson) {
      showMessage('‚ùå Kh√¥ng th·ªÉ extract JSON t·ª´ ```json block!', 'error');
      return;
    }
    
    if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën l∆∞u prompt n√†y?')) return;
    
    savePromptBtn.disabled = true;
    savePromptBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang l∆∞u...';
    
    try {
      const res = await fetch('/api/admin/prompt/save', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify({
          promptContent: content,
          jsonFormat: extractedJson
        })
      });
      
      const data = await res.json();
      
      if (data.success) {
        showMessage('‚úÖ Prompt ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!', 'success');
        promptPreview.textContent = content;
        jsonFormat.textContent = extractedJson;
      } else {
        throw new Error(data.error || 'L·ªói khi l∆∞u prompt');
      }
    } catch (err) {
      console.error(err);
      showMessage('‚ùå ' + err.message, 'error');
    } finally {
      savePromptBtn.disabled = false;
      savePromptBtn.innerHTML = '<i class="fa-solid fa-save"></i> L∆∞u Prompt';
    }
  });
}

if (resetPromptBtn) {
  resetPromptBtn.addEventListener('click', async function() {
    if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën kh√¥i ph·ª•c prompt v·ªÅ m·∫∑c ƒë·ªãnh? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) return;
    
    resetPromptBtn.disabled = true;
    resetPromptBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang kh√¥i ph·ª•c...';
    
    try {
      const token = localStorage.getItem('token');
      const res = await fetch('/api/admin/prompt-template/reset', {
        method: 'POST',
        headers: { 
          'Authorization': 'Bearer ' + token
        }
      });
      
      const data = await res.json();
      
if (data.success) {
  showMessage('‚úÖ ƒê√£ kh√¥i ph·ª•c prompt m·∫∑c ƒë·ªãnh!', 'success');
  
  const promptContent = data.data.prompt_template;
  const jsonFormatContent = data.data.json_format_response;
  
  // Update 3 ch·ªó
  if (promptEditor) promptEditor.value = promptContent;
  if (promptPreview) promptPreview.textContent = promptContent;
  
  // ‚úÖ UPDATE JSON v·ªõi logic fallback
  if (jsonFormat) {
    if (jsonFormatContent) {
      jsonFormat.textContent = jsonFormatContent;
    } else {
      const extractedJson = extractJsonFromPrompt(promptContent);
      if (extractedJson) {
        jsonFormat.textContent = extractedJson;
      }
    }
  }
}else {
        throw new Error(data.error || 'L·ªói khi kh√¥i ph·ª•c prompt');
      }
    } catch (err) {
      console.error(err);
      showMessage('‚ùå ' + err.message, 'error');
    } finally {
      resetPromptBtn.disabled = false;
      resetPromptBtn.innerHTML = '<i class="fa-solid fa-undo"></i> Kh√¥i Ph·ª•c M·∫∑c ƒê·ªãnh';
    }
  });
}

// Th√™m SAU ph·∫ßn event listener hi·ªán t·∫°i c·ªßa promptEditor (kho·∫£ng d√≤ng 1800)
if (promptEditor) {
  promptEditor.addEventListener('input', function() {
    if (promptPreview) promptPreview.textContent = this.value;
    
    // ‚úÖ TH√äM ƒêO·∫†N N√ÄY - Auto extract v√† update JSON format
    const extractedJson = extractJsonFromPrompt(this.value);
    if (extractedJson && jsonFormat) {
      jsonFormat.textContent = extractedJson;
    }
  });
}
    // Feedback Management
function renderFeedbackList(feedbacks) {
  if (!feedbacks || feedbacks.length === 0) {
    feedbackArea.innerHTML = '<div class="muted">Ch∆∞a c√≥ ph·∫£n h·ªìi n√†o</div>';
    return;
  }
  
  const criteriaNames = [
    'Ph√π h·ª£p n·ªôi dung',
    'H·ªØu √≠ch h·ªçc li·ªáu',
    'D·ªÖ hi·ªÉu, d·ªÖ √°p d·ª•ng',
    'Th·ª±c t·∫ø & ·ª©ng d·ª•ng',
    'C√° nh√¢n h√≥a',
    'Duy tr√¨ ƒë·ªông l·ª±c',
    'Tr·∫£i nghi·ªám t·ªïng th·ªÉ',
    'Ti·ªán l·ª£i ng∆∞·ªùi d√πng'
  ];
  
  const html = feedbacks.map(f => {
    const avgRating = (
      (f.rating_1 + f.rating_2 + f.rating_3 + f.rating_4 + 
       f.rating_5 + f.rating_6 + f.rating_7 + f.rating_8) / 8
    ).toFixed(1);
    
    return `
      <div class="history-card" data-feedback-id="${f.feedback_id}">
        <div class="history-header">
          <div>
            <strong>ID #${f.feedback_id}</strong> - ${new Date(f.created_at).toLocaleString('vi-VN')}
          </div>
          <div style="display: flex; gap: 10px; align-items: center;">
            <span class="status-badge status-success">‚≠ê ${avgRating}/5</span>
            <button class="btn-delete" onclick="deleteFeedback(${f.feedback_id})" style="padding: 6px 12px;">
              <i class="fa-solid fa-trash"></i> X√≥a
            </button>
          </div>
        </div>
        <div style="margin-top: 10px;">
          <strong>Ng∆∞·ªùi d√πng:</strong> ${escapeHtml(f.user_name || 'N/A')} (${escapeHtml(f.user_email || '')})<br><br>
          
          <details style="margin-top: 12px;">
            <summary style="cursor: pointer; font-weight: 600; color: #007bff; padding: 10px; background: #f0f9ff; border-radius: 6px; user-select: none;">
              üìä Xem Chi Ti·∫øt ƒê√°nh Gi√°
            </summary>
            <div style="margin-top: 10px; padding: 15px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
              ${criteriaNames.map((name, i) => `
                <div style="margin: 8px 0;">
                  <strong>${i + 1}. ${name}:</strong> 
                  ${'‚≠ê'.repeat(f[`rating_${i + 1}`])}${'‚òÜ'.repeat(5 - f[`rating_${i + 1}`])}
                  (${f[`rating_${i + 1}`]}/5)
                </div>
              `).join('')}
            </div>
          
          ${f.question_1 ? `<br><strong>üí° ƒêi·ªÉm th√≠ch nh·∫•t:</strong><br>${escapeHtml(f.question_1)}<br>` : ''}
          ${f.question_2 ? `<br><strong>‚ö†Ô∏è Kh√≥ khƒÉn g·∫∑p ph·∫£i:</strong><br>${escapeHtml(f.question_2)}<br>` : ''}
          ${f.question_3 ? `<br><strong>üöÄ ƒê·ªÅ xu·∫•t c·∫£i thi·ªán:</strong><br>${escapeHtml(f.question_3)}` : ''}
          
          </details>
        </div>
      </div>
    `;
  }).join('');
  
  feedbackArea.innerHTML = html;
}

// Th√™m h√†m x√≥a feedback m·ªõi
window.deleteFeedback = async function(feedbackId) {
  if (!confirm(`X√≥a ph·∫£n h·ªìi #${feedbackId}?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) return;
  
  try {
    const token = localStorage.getItem('token');
    const res = await fetch(`/api/admin/feedback/${feedbackId}`, {
      method: 'DELETE',
      headers: { 'Authorization': 'Bearer ' + token }
    });
    
    const data = await res.json();
    
    if (data.success) {
      // X√≥a card kh·ªèi DOM
      const card = document.querySelector(`[data-feedback-id="${feedbackId}"]`);
      if (card) card.remove();
      
      // Reload stats n·∫øu ƒëang hi·ªÉn th·ªã
      if (statsArea.style.display === 'block') {
        const statsRes = await fetch('/api/admin/feedback/stats', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const statsData = await statsRes.json();
        renderFeedbackStats(statsData.data);
      }
      
      showNotification('‚úÖ ƒê√£ x√≥a ph·∫£n h·ªìi th√†nh c√¥ng!', 'success');
    } else {
      throw new Error(data.error || 'L·ªói khi x√≥a');
    }
  } catch (err) {
    console.error(err);
    showNotification('‚ùå ' + err.message, 'error');
  }
};

function renderFeedbackStats(stats) {
  if (!stats) return;
  
  const criteriaNames = [
    'Ph√π h·ª£p n·ªôi dung',
    'H·ªØu √≠ch h·ªçc li·ªáu',
    'D·ªÖ hi·ªÉu, d·ªÖ √°p d·ª•ng',
    'Th·ª±c t·∫ø & ·ª©ng d·ª•ng',
    'C√° nh√¢n h√≥a',
    'Duy tr√¨ ƒë·ªông l·ª±c',
    'Tr·∫£i nghi·ªám t·ªïng th·ªÉ',
    'Ti·ªán l·ª£i ng∆∞·ªùi d√πng'
  ];
  
  const avgTotal = (
    (parseFloat(stats.avg_rating_1) + parseFloat(stats.avg_rating_2) + 
     parseFloat(stats.avg_rating_3) + parseFloat(stats.avg_rating_4) +
     parseFloat(stats.avg_rating_5) + parseFloat(stats.avg_rating_6) +
     parseFloat(stats.avg_rating_7) + parseFloat(stats.avg_rating_8)) / 8
  ).toFixed(2);
  
  const html = `
    <div style="margin-bottom: 20px;">
      <strong>T·ªïng s·ªë ph·∫£n h·ªìi:</strong> ${stats.total_feedback}<br>
      <strong>ƒê√°nh gi√° trung b√¨nh t·ªïng th·ªÉ:</strong> ‚≠ê ${avgTotal}/5
    </div>
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
      ${criteriaNames.map((name, i) => {
        const avg = parseFloat(stats[`avg_rating_${i + 1}`]).toFixed(2);
        const percent = (avg / 5) * 100;
        return `
          <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb;">
            <div style="font-weight: 600; margin-bottom: 8px;">${i + 1}. ${name}</div>
            <div style="font-size: 1.5rem; color: #007bff; font-weight: 700;">‚≠ê ${avg}/5</div>
            <div style="background: #e5e7eb; height: 8px; border-radius: 4px; margin-top: 8px; overflow: hidden;">
              <div style="background: linear-gradient(90deg, #007bff, #007bff); height: 100%; width: ${percent}%;"></div>
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `;
  
  statsContent.innerHTML = html;
  statsArea.style.display = 'block';
}
let fetchFeedbackClickCount = 0;
// X√≥a ho·∫∑c comment d√≤ng n√†y:
// let fetchFeedbackClickCount = 0;

if (fetchFeedbackBtn) {
  fetchFeedbackBtn.addEventListener('click', async function() {
    // Ki·ªÉm tra tr·∫°ng th√°i th·ª±c t·∫ø thay v√¨ d√πng bi·∫øn ƒë·∫øm
    const isCurrentlyShowing = feedbackArea.innerHTML.trim() !== '';
    
    if (!isCurrentlyShowing) {
      // M·ªü danh s√°ch feedback
      feedbackMessage.textContent = 'ƒêang t·∫£i...';
      fetchFeedbackBtn.disabled = true;
      
      try {
        const token = localStorage.getItem('token');
        const res = await fetch('/api/admin/feedback', {
          headers: { 
            'Authorization': 'Bearer ' + token,
            'Cache-Control': 'no-cache'
          }
        });
        
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        
        const data = await res.json();
        renderFeedbackList(data.data);
        feedbackMessage.textContent = `ƒê√£ t·∫£i ${data.data.length} ph·∫£n h·ªìi`;
        
        // ·∫®n stats khi m·ªü feedback list
        statsArea.style.display = 'none';
      } catch (err) {
        console.error(err);
        feedbackMessage.textContent = 'L·ªói khi t·∫£i ph·∫£n h·ªìi';
        feedbackArea.innerHTML = '<div class="muted">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</div>';
      } finally {
        fetchFeedbackBtn.disabled = false;
        setTimeout(() => { feedbackMessage.textContent = ''; }, 2500);
      }
    } else {
      // ƒê√≥ng danh s√°ch feedback
      feedbackArea.innerHTML = '';
      feedbackMessage.textContent = 'Danh s√°ch ƒë√£ ƒë√≥ng.';
      setTimeout(() => { feedbackMessage.textContent = ''; }, 1400);
      
      // ·∫®n stats khi ƒë√≥ng feedback list
      statsArea.style.display = 'none';
    }
  });
}
if (viewStatsBtn) {
  viewStatsBtn.addEventListener('click', async function() {
    statsArea.style.display = statsArea.style.display === 'none' ? 'block' : 'none';
    
    if (statsArea.style.display === 'block') {
      // ·∫®N danh s√°ch feedback khi m·ªü stats
      feedbackArea.innerHTML = '';
      
      viewStatsBtn.disabled = true;
      viewStatsBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang t·∫£i...';
      
      try {
        const token = localStorage.getItem('token');
        const res = await fetch('/api/admin/feedback/stats', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        
        const data = await res.json();
        renderFeedbackStats(data.data);
      } catch (err) {
        console.error(err);
        statsContent.innerHTML = '<div class="muted">Kh√¥ng th·ªÉ t·∫£i th·ªëng k√™</div>';
      } finally {
        viewStatsBtn.disabled = false;
        viewStatsBtn.innerHTML = '<i class="fa-solid fa-chart-bar"></i> Xem Th·ªëng K√™';
      }
    }
  });
}
  </script>
  <script src="footer.js"></script>
</body>
</html>
